var CodeMirror,jQuery;!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).CodeMirror=e()}(this,function(){"use strict";var t=navigator.userAgent,e=navigator.platform,u=/gecko\/\d/i.test(t),i=/MSIE \d/.test(t),n=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(t),r=/Edge\/(\d+)/.exec(t),_=i||n||r,v=_&&(i?document.documentMode||6:+(r||n)[1]),p=!r&&/WebKit\//.test(t),n=p&&/Qt\/\d+\.\d+/.test(t),s=!r&&/Chrome\//.test(t),f=/Opera\//.test(t),h=/Apple Computer/.test(navigator.vendor),o=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(t),c=/PhantomJS/.test(t),a=h&&(/Mobile\/\w+/.test(t)||2<navigator.maxTouchPoints),l=/Android/.test(t),d=a||l||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(t),g=a||/Mac/.test(e),m=/\bCrOS\b/.test(t),b=/win/i.test(e),t=f&&t.match(/Version\/(\d*\.\d*)/);(t=t&&Number(t[1]))&&15<=t&&(p=!(f=!1));var y=g&&(n||f&&(null==t||t<12.11)),x=u||_&&9<=v;function C(t){return new RegExp("(^|\\s)"+t+"(?:$|\\s)\\s*")}var w,k=function(t,e){var i=t.className,n=C(e).exec(i);n&&(e=i.slice(n.index+n[0].length),t.className=i.slice(0,n.index)+(e?n[1]+e:""))};function T(t){for(var e=t.childNodes.length;0<e;--e)t.removeChild(t.firstChild);return t}function S(t,e){return T(t).appendChild(e)}function E(t,e,i,n){var r=document.createElement(t);if(i&&(r.className=i),n&&(r.style.cssText=n),"string"==typeof e)r.appendChild(document.createTextNode(e));else if(e)for(var s=0;s<e.length;++s)r.appendChild(e[s]);return r}function L(t,e,i,n){n=E(t,e,i,n);return n.setAttribute("role","presentation"),n}function A(t,e){if(3==e.nodeType&&(e=e.parentNode),t.contains)return t.contains(e);do{if(11==e.nodeType&&(e=e.host),e==t)return!0}while(e=e.parentNode)}function N(){var e;try{e=document.activeElement}catch(t){e=document.body||null}for(;e&&e.shadowRoot&&e.shadowRoot.activeElement;)e=e.shadowRoot.activeElement;return e}function $(t,e){var i=t.className;C(e).test(i)||(t.className+=(i?" ":"")+e)}function M(t,e){for(var i=t.split(" "),n=0;n<i.length;n++)i[n]&&!C(i[n]).test(e)&&(e+=" "+i[n]);return e}w=document.createRange?function(t,e,i,n){var r=document.createRange();return r.setEnd(n||t,i),r.setStart(t,e),r}:function(t,e,i){var n=document.body.createTextRange();try{n.moveToElementText(t.parentNode)}catch(t){return n}return n.collapse(!0),n.moveEnd("character",i),n.moveStart("character",e),n};var D=function(t){t.select()};function I(t){var e=Array.prototype.slice.call(arguments,1);return function(){return t.apply(null,e)}}function F(t,e,i){for(var n in e=e||{},t)!t.hasOwnProperty(n)||!1===i&&e.hasOwnProperty(n)||(e[n]=t[n]);return e}function O(t,e,i,n,r){null==e&&-1==(e=t.search(/[^\s\u00a0]/))&&(e=t.length);for(var s=n||0,o=r||0;;){var a=t.indexOf("\t",s);if(a<0||e<=a)return o+(e-s);o+=a-s,o+=i-o%i,s=a+1}}a?D=function(t){t.selectionStart=0,t.selectionEnd=t.value.length}:_&&(D=function(t){try{t.select()}catch(t){}});var B=function(){this.id=null,this.f=null,this.time=0,this.handler=I(this.onTimeout,this)};function H(t,e){for(var i=0;i<t.length;++i)if(t[i]==e)return i;return-1}B.prototype.onTimeout=function(t){t.id=0,t.time<=+new Date?t.f():setTimeout(t.handler,t.time-+new Date)},B.prototype.set=function(t,e){this.f=e;e=+new Date+t;(!this.id||e<this.time)&&(clearTimeout(this.id),this.id=setTimeout(this.handler,t),this.time=e)};var R=50,P={toString:function(){return"CodeMirror.Pass"}},W={scroll:!1},z={origin:"*mouse"},j={origin:"+move"};function U(t,e,i){for(var n=0,r=0;;){var s=t.indexOf("\t",n);-1==s&&(s=t.length);var o=s-n;if(s==t.length||e<=r+o)return n+Math.min(o,e-r);if(r+=s-n,n=s+1,e<=(r+=i-r%i))return n}}var K=[""];function q(t){for(;K.length<=t;)K.push(V(K)+" ");return K[t]}function V(t){return t[t.length-1]}function G(t,e){for(var i=[],n=0;n<t.length;n++)i[n]=e(t[n],n);return i}function X(){}function Y(t,e){t=Object.create?Object.create(t):(X.prototype=t,new X);return e&&F(e,t),t}var Q=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;function Z(t){return/\w/.test(t)||""<t&&(t.toUpperCase()!=t.toLowerCase()||Q.test(t))}function J(t,e){return e?!!(-1<e.source.indexOf("\\w")&&Z(t))||e.test(t):Z(t)}function tt(t){for(var e in t)if(t.hasOwnProperty(e)&&t[e])return;return 1}var et=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;function it(t){return 768<=t.charCodeAt(0)&&et.test(t)}function nt(t,e,i){for(;(i<0?0<e:e<t.length)&&it(t.charAt(e));)e+=i;return e}function rt(t,e,i){for(var n=i<e?-1:1;;){if(e==i)return e;var r=(e+i)/2,r=n<0?Math.ceil(r):Math.floor(r);if(r==e)return t(r)?e:i;t(r)?i=r:e=r+n}}var st=null;function ot(t,e,i){var n;st=null;for(var r=0;r<t.length;++r){var s=t[r];if(s.from<e&&s.to>e)return r;s.to==e&&(s.from!=s.to&&"before"==i?n=r:st=r),s.from==e&&(s.from!=s.to&&"before"!=i?n=r:st=r)}return null!=n?n:st}var at,lt,ct,ht,dt,ut,pt,ft=(at="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",lt="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111",ct=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,ht=/[stwN]/,dt=/[LRr]/,ut=/[Lb1n]/,pt=/[1n]/,function(t,e){var i="ltr"==e?"L":"R";if(0==t.length||"ltr"==e&&!ct.test(t))return!1;for(var n,r=t.length,s=[],o=0;o<r;++o)s.push((n=t.charCodeAt(o))<=247?at.charAt(n):1424<=n&&n<=1524?"R":1536<=n&&n<=1785?lt.charAt(n-1536):1774<=n&&n<=2220?"r":8192<=n&&n<=8203?"w":8204==n?"b":"L");for(var a=0,l=i;a<r;++a){var c=s[a];"m"==c?s[a]=l:l=c}for(var h=0,d=i;h<r;++h){var u=s[h];"1"==u&&"r"==d?s[h]="n":dt.test(u)&&"r"==(d=u)&&(s[h]="R")}for(var p=1,f=s[0];p<r-1;++p){var g=s[p];"+"==g&&"1"==f&&"1"==s[p+1]?s[p]="1":","!=g||f!=s[p+1]||"1"!=f&&"n"!=f||(s[p]=f),f=g}for(var m=0;m<r;++m){var v=s[m];if(","==v)s[m]="N";else if("%"==v){for(var b=void 0,b=m+1;b<r&&"%"==s[b];++b);for(var y=m&&"!"==s[m-1]||b<r&&"1"==s[b]?"1":"N",_=m;_<b;++_)s[_]=y;m=b-1}}for(var x=0,C=i;x<r;++x){var w=s[x];"L"==C&&"1"==w?s[x]="L":dt.test(w)&&(C=w)}for(var k=0;k<r;++k)if(ht.test(s[k])){for(var T=void 0,T=k+1;T<r&&ht.test(s[T]);++T);for(var S="L"==(k?s[k-1]:i),E=S==("L"==(T<r?s[T]:i))?S?"L":"R":i,L=k;L<T;++L)s[L]=E;k=T-1}for(var A,N=[],$=0;$<r;)if(ut.test(s[$])){var M=$;for(++$;$<r&&ut.test(s[$]);++$);N.push(new gt(0,M,$))}else{var D=$,I=N.length,F="rtl"==e?1:0;for(++$;$<r&&"L"!=s[$];++$);for(var O=D;O<$;)if(pt.test(s[O])){D<O&&(N.splice(I,0,new gt(1,D,O)),I+=F);var B=O;for(++O;O<$&&pt.test(s[O]);++O);N.splice(I,0,new gt(2,B,O)),I+=F,D=O}else++O;D<$&&N.splice(I,0,new gt(1,D,$))}return"ltr"==e&&(1==N[0].level&&(A=t.match(/^\s+/))&&(N[0].from=A[0].length,N.unshift(new gt(0,0,A[0].length))),1==V(N).level&&(A=t.match(/\s+$/))&&(V(N).to-=A[0].length,N.push(new gt(0,r-A[0].length,r)))),"rtl"==e?N.reverse():N});function gt(t,e,i){this.level=t,this.from=e,this.to=i}function mt(t,e){var i=t.order;return null==i&&(i=t.order=ft(t.text,e)),i}var vt=[],bt=function(t,e,i){t.addEventListener?t.addEventListener(e,i,!1):t.attachEvent?t.attachEvent("on"+e,i):(t=t._handlers||(t._handlers={}))[e]=(t[e]||vt).concat(i)};function yt(t,e){return t._handlers&&t._handlers[e]||vt}function _t(t,e,i){var n;t.removeEventListener?t.removeEventListener(e,i,!1):t.detachEvent?t.detachEvent("on"+e,i):!(t=(n=t._handlers)&&n[e])||-1<(i=H(t,i))&&(n[e]=t.slice(0,i).concat(t.slice(i+1)))}function xt(t,e){var i=yt(t,e);if(i.length)for(var n=Array.prototype.slice.call(arguments,2),r=0;r<i.length;++r)i[r].apply(null,n)}function Ct(t,e,i){return"string"==typeof e&&(e={type:e,preventDefault:function(){this.defaultPrevented=!0}}),xt(t,i||e.type,t,e),Lt(e)||e.codemirrorIgnore}function wt(t){var e=t._handlers&&t._handlers.cursorActivity;if(e)for(var i=t.curOp.cursorActivityHandlers||(t.curOp.cursorActivityHandlers=[]),n=0;n<e.length;++n)-1==H(i,e[n])&&i.push(e[n])}function kt(t,e){return 0<yt(t,e).length}function Tt(t){t.prototype.on=function(t,e){bt(this,t,e)},t.prototype.off=function(t,e){_t(this,t,e)}}function St(t){t.preventDefault?t.preventDefault():t.returnValue=!1}function Et(t){t.stopPropagation?t.stopPropagation():t.cancelBubble=!0}function Lt(t){return null!=t.defaultPrevented?t.defaultPrevented:0==t.returnValue}function At(t){St(t),Et(t)}function Nt(t){return t.target||t.srcElement}function $t(t){var e=t.which;return null==e&&(1&t.button?e=1:2&t.button?e=3:4&t.button&&(e=2)),g&&t.ctrlKey&&1==e&&(e=3),e}var Mt,Dt,It=function(){if(_&&v<9)return!1;var t=E("div");return"draggable"in t||"dragDrop"in t}();var Ft=3!="\n\nb".split(/\n/).length?function(t){for(var e=0,i=[],n=t.length;e<=n;){var r=t.indexOf("\n",e);-1==r&&(r=t.length);var s=t.slice(e,"\r"==t.charAt(r-1)?r-1:r),o=s.indexOf("\r");-1!=o?(i.push(s.slice(0,o)),e+=o+1):(i.push(s),e=r+1)}return i}:function(t){return t.split(/\r\n?|\n/)},Ot=window.getSelection?function(t){try{return t.selectionStart!=t.selectionEnd}catch(t){return!1}}:function(t){var e;try{e=t.ownerDocument.selection.createRange()}catch(t){}return!(!e||e.parentElement()!=t)&&0!=e.compareEndPoints("StartToEnd",e)},Bt="oncopy"in(n=E("div"))||(n.setAttribute("oncopy","return;"),"function"==typeof n.oncopy),Ht=null;var Rt={},Pt={};function Wt(t){if("string"==typeof t&&Pt.hasOwnProperty(t))t=Pt[t];else if(t&&"string"==typeof t.name&&Pt.hasOwnProperty(t.name)){var e=Pt[t.name];"string"==typeof e&&(e={name:e}),(t=Y(e,t)).name=e.name}else{if("string"==typeof t&&/^[\w\-]+\/[\w\-]+\+xml$/.test(t))return Wt("application/xml");if("string"==typeof t&&/^[\w\-]+\/[\w\-]+\+json$/.test(t))return Wt("application/json")}return"string"==typeof t?{name:t}:t||{name:"null"}}function zt(t,e){e=Wt(e);var i=Rt[e.name];if(!i)return zt(t,"text/plain");var n=i(t,e);if(jt.hasOwnProperty(e.name)){var r,s=jt[e.name];for(r in s)s.hasOwnProperty(r)&&(n.hasOwnProperty(r)&&(n["_"+r]=n[r]),n[r]=s[r])}if(n.name=e.name,e.helperType&&(n.helperType=e.helperType),e.modeProps)for(var o in e.modeProps)n[o]=e.modeProps[o];return n}var jt={};function Ut(t,e){F(e,jt.hasOwnProperty(t)?jt[t]:jt[t]={})}function Kt(t,e){if(!0===e)return e;if(t.copyState)return t.copyState(e);var i,n={};for(i in e){var r=e[i];r instanceof Array&&(r=r.concat([])),n[i]=r}return n}function qt(t,e){for(var i;t.innerMode&&(i=t.innerMode(e))&&i.mode!=t;)e=i.state,t=i.mode;return i||{mode:t,state:e}}function Vt(t,e,i){return!t.startState||t.startState(e,i)}var Gt=function(t,e,i){this.pos=this.start=0,this.string=t,this.tabSize=e||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=i};function Xt(t,e){if((e-=t.first)<0||e>=t.size)throw new Error("There is no line "+(e+t.first)+" in the document.");for(var i=t;!i.lines;)for(var n=0;;++n){var r=i.children[n],s=r.chunkSize();if(e<s){i=r;break}e-=s}return i.lines[e]}function Yt(t,e,i){var n=[],r=e.line;return t.iter(e.line,i.line+1,function(t){t=t.text;r==i.line&&(t=t.slice(0,i.ch)),r==e.line&&(t=t.slice(e.ch)),n.push(t),++r}),n}function Qt(t,e,i){var n=[];return t.iter(e,i,function(t){n.push(t.text)}),n}function Zt(t,e){var i=e-t.height;if(i)for(var n=t;n;n=n.parent)n.height+=i}function Jt(t){if(null==t.parent)return null;for(var e=t.parent,i=H(e.lines,t),n=e.parent;n;n=(e=n).parent)for(var r=0;n.children[r]!=e;++r)i+=n.children[r].chunkSize();return i+e.first}function te(t,e){var i=t.first;t:do{for(var n=0;n<t.children.length;++n){var r=t.children[n],s=r.height;if(e<s){t=r;continue t}e-=s,i+=r.chunkSize()}return i}while(!t.lines);for(var o=0;o<t.lines.length;++o){var a=t.lines[o].height;if(e<a)break;e-=a}return i+o}function ee(t,e){return e>=t.first&&e<t.first+t.size}function ie(t,e){return String(t.lineNumberFormatter(e+t.firstLineNumber))}function ne(t,e,i){if(void 0===i&&(i=null),!(this instanceof ne))return new ne(t,e,i);this.line=t,this.ch=e,this.sticky=i}function re(t,e){return t.line-e.line||t.ch-e.ch}function se(t,e){return t.sticky==e.sticky&&0==re(t,e)}function oe(t){return ne(t.line,t.ch)}function ae(t,e){return re(t,e)<0?e:t}function le(t,e){return re(t,e)<0?t:e}function ce(t,e){return Math.max(t.first,Math.min(e,t.first+t.size-1))}function he(t,e){if(e.line<t.first)return ne(t.first,0);var i=t.first+t.size-1;return e.line>i?ne(i,Xt(t,i).text.length):(t=Xt(t,(i=e).line).text.length,null==(e=i.ch)||t<e?ne(i.line,t):e<0?ne(i.line,0):i)}function de(t,e){for(var i=[],n=0;n<e.length;n++)i[n]=he(t,e[n]);return i}Gt.prototype.eol=function(){return this.pos>=this.string.length},Gt.prototype.sol=function(){return this.pos==this.lineStart},Gt.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},Gt.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},Gt.prototype.eat=function(t){var e=this.string.charAt(this.pos),t="string"==typeof t?e==t:e&&(t.test?t.test(e):t(e));if(t)return++this.pos,e},Gt.prototype.eatWhile=function(t){for(var e=this.pos;this.eat(t););return this.pos>e},Gt.prototype.eatSpace=function(){for(var t=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>t},Gt.prototype.skipToEnd=function(){this.pos=this.string.length},Gt.prototype.skipTo=function(t){t=this.string.indexOf(t,this.pos);if(-1<t)return this.pos=t,!0},Gt.prototype.backUp=function(t){this.pos-=t},Gt.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=O(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?O(this.string,this.lineStart,this.tabSize):0)},Gt.prototype.indentation=function(){return O(this.string,null,this.tabSize)-(this.lineStart?O(this.string,this.lineStart,this.tabSize):0)},Gt.prototype.match=function(t,e,i){if("string"!=typeof t){var n=this.string.slice(this.pos).match(t);return n&&0<n.index?null:(n&&!1!==e&&(this.pos+=n[0].length),n)}n=function(t){return i?t.toLowerCase():t};if(n(this.string.substr(this.pos,t.length))==n(t))return!1!==e&&(this.pos+=t.length),!0},Gt.prototype.current=function(){return this.string.slice(this.start,this.pos)},Gt.prototype.hideFirstChars=function(t,e){this.lineStart+=t;try{return e()}finally{this.lineStart-=t}},Gt.prototype.lookAhead=function(t){var e=this.lineOracle;return e&&e.lookAhead(t)},Gt.prototype.baseToken=function(){var t=this.lineOracle;return t&&t.baseToken(this.pos)};var ue=function(t,e){this.state=t,this.lookAhead=e},pe=function(t,e,i,n){this.state=e,this.doc=t,this.line=i,this.maxLookAhead=n||0,this.baseTokens=null,this.baseTokenPos=1};function fe(e,i,n,t){var l=[e.state.modeGen],r={};we(e,i.text,e.doc.mode,n,function(t,e){return l.push(t,e)},r,t);for(var c=n.state,s=0;s<e.state.overlays.length;++s)!function(t){n.baseTokens=l;var s=e.state.overlays[t],o=1,a=0;n.state=!0,we(e,i.text,s.mode,n,function(t,e){for(var i=o;a<t;){var n=l[o];t<n&&l.splice(o,1,t,l[o+1],n),o+=2,a=Math.min(t,n)}if(e)if(s.opaque)l.splice(i,o-i,t,"overlay "+e),o=i+2;else for(;i<o;i+=2){var r=l[i+1];l[i+1]=(r?r+" ":"")+"overlay "+e}},r),n.state=c,n.baseTokens=null,n.baseTokenPos=1}(s);return{styles:l,classes:r.bgClass||r.textClass?r:null}}function ge(t,e,i){var n,r,s;return e.styles&&e.styles[0]==t.state.modeGen||(n=me(t,Jt(e)),r=e.text.length>t.options.maxHighlightLength&&Kt(t.doc.mode,n.state),s=fe(t,e,n),r&&(n.state=r),e.stateAfter=n.save(!r),e.styles=s.styles,s.classes?e.styleClasses=s.classes:e.styleClasses&&(e.styleClasses=null),i===t.doc.highlightFrontier&&(t.doc.modeFrontier=Math.max(t.doc.modeFrontier,++t.doc.highlightFrontier))),e.styles}function me(i,n,t){var e=i.doc,r=i.display;if(!e.mode.startState)return new pe(e,!0,n);var s=function(t,e,i){for(var n,r,s=t.doc,o=i?-1:e-(t.doc.mode.innerMode?1e3:100),a=e;o<a;--a){if(a<=s.first)return s.first;var l=Xt(s,a-1),c=l.stateAfter;if(c&&(!i||a+(c instanceof ue?c.lookAhead:0)<=s.modeFrontier))return a;l=O(l.text,null,t.options.tabSize);(null==r||l<n)&&(r=a-1,n=l)}return r}(i,n,t),o=s>e.first&&Xt(e,s-1).stateAfter,a=o?pe.fromSaved(e,o,s):new pe(e,Vt(e.mode),s);return e.iter(s,n,function(t){ve(i,t.text,a);var e=a.line;t.stateAfter=e==n-1||e%5==0||e>=r.viewFrom&&e<r.viewTo?a.save():null,a.nextLine()}),t&&(e.modeFrontier=a.line),a}function ve(t,e,i,n){var r=t.doc.mode,s=new Gt(e,t.options.tabSize,i);for(s.start=s.pos=n||0,""==e&&be(r,i.state);!s.eol();)ye(r,s,i.state),s.start=s.pos}function be(t,e){if(t.blankLine)return t.blankLine(e);if(t.innerMode){e=qt(t,e);return e.mode.blankLine?e.mode.blankLine(e.state):void 0}}function ye(t,e,i,n){for(var r=0;r<10;r++){n&&(n[0]=qt(t,i).mode);var s=t.token(e,i);if(e.pos>e.start)return s}throw new Error("Mode "+t.name+" failed to advance stream.")}pe.prototype.lookAhead=function(t){var e=this.doc.getLine(this.line+t);return null!=e&&t>this.maxLookAhead&&(this.maxLookAhead=t),e},pe.prototype.baseToken=function(t){if(!this.baseTokens)return null;for(;this.baseTokens[this.baseTokenPos]<=t;)this.baseTokenPos+=2;var e=this.baseTokens[this.baseTokenPos+1];return{type:e&&e.replace(/( |^)overlay .*/,""),size:this.baseTokens[this.baseTokenPos]-t}},pe.prototype.nextLine=function(){this.line++,0<this.maxLookAhead&&this.maxLookAhead--},pe.fromSaved=function(t,e,i){return e instanceof ue?new pe(t,Kt(t.mode,e.state),i,e.lookAhead):new pe(t,Kt(t.mode,e),i)},pe.prototype.save=function(t){t=!1!==t?Kt(this.doc.mode,this.state):this.state;return 0<this.maxLookAhead?new ue(t,this.maxLookAhead):t};var _e=function(t,e,i){this.start=t.start,this.end=t.pos,this.string=t.current(),this.type=e||null,this.state=i};function xe(t,e,i,n){var r,s,o=t.doc,a=o.mode,l=Xt(o,(e=he(o,e)).line),c=me(t,e.line,i),h=new Gt(l.text,t.options.tabSize,c);for(n&&(s=[]);(n||h.pos<e.ch)&&!h.eol();)h.start=h.pos,r=ye(a,h,c.state),n&&s.push(new _e(h,r,Kt(o.mode,c.state)));return n?s:new _e(h,r,c.state)}function Ce(t,e){if(t)for(;;){var i=t.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!i)break;t=t.slice(0,i.index)+t.slice(i.index+i[0].length);var n=i[1]?"bgClass":"textClass";null==e[n]?e[n]=i[2]:new RegExp("(?:^|\\s)"+i[2]+"(?:$|\\s)").test(e[n])||(e[n]+=" "+i[2])}return t}function we(t,e,i,n,r,s,o){var a=i.flattenSpans;null==a&&(a=t.options.flattenSpans);var l=0,c=null,h=new Gt(e,t.options.tabSize,n),d=t.options.addModeClass&&[null];for(""==e&&Ce(be(i,n.state),s);!h.eol();){var u,p=h.pos>t.options.maxHighlightLength?(a=!1,o&&ve(t,e,n,h.pos),h.pos=e.length,null):Ce(ye(i,h,n.state,d),s);if(!d||(u=d[0].name)&&(p="m-"+(p?u+" "+p:u)),!a||c!=p){for(;l<h.start;)r(l=Math.min(h.start,l+5e3),c);c=p}h.start=h.pos}for(;l<h.pos;){var f=Math.min(h.pos,l+5e3);r(f,c),l=f}}var ke=!1,Te=!1;function Se(t,e,i){this.marker=t,this.from=e,this.to=i}function Ee(t,e){if(t)for(var i=0;i<t.length;++i){var n=t[i];if(n.marker==e)return n}}function Le(t,e){if(e.full)return null;var i=ee(t,e.from.line)&&Xt(t,e.from.line).markedSpans,n=ee(t,e.to.line)&&Xt(t,e.to.line).markedSpans;if(!i&&!n)return null;var r=e.from.ch,s=e.to.ch,t=0==re(e.from,e.to),o=function(t,e,i){var n;if(t)for(var r=0;r<t.length;++r){var s,o=t[r],a=o.marker;!(null==o.from||(a.inclusiveLeft?o.from<=e:o.from<e))&&(o.from!=e||"bookmark"!=a.type||i&&o.marker.insertLeft)||(s=null==o.to||(a.inclusiveRight?o.to>=e:o.to>e),(n=n||[]).push(new Se(a,o.from,s?null:o.to)))}return n}(i,r,t),a=function(t,e,i){var n;if(t)for(var r=0;r<t.length;++r){var s,o=t[r],a=o.marker;!(null==o.to||(a.inclusiveRight?o.to>=e:o.to>e))&&(o.from!=e||"bookmark"!=a.type||i&&!o.marker.insertLeft)||(s=null==o.from||(a.inclusiveLeft?o.from<=e:o.from<e),(n=n||[]).push(new Se(a,s?null:o.from-e,null==o.to?null:o.to-e)))}return n}(n,s,t),l=1==e.text.length,c=V(e.text).length+(l?r:0);if(o)for(var h=0;h<o.length;++h){var d,u=o[h];null==u.to&&((d=Ee(a,u.marker))?l&&(u.to=null==d.to?null:d.to+c):u.to=r)}if(a)for(var p=0;p<a.length;++p){var f=a[p];null!=f.to&&(f.to+=c),null==f.from?Ee(o,f.marker)||(f.from=c,l&&(o=o||[]).push(f)):(f.from+=c,l&&(o=o||[]).push(f))}o=o&&Ae(o),a&&a!=o&&(a=Ae(a));var g=[o];if(!l){var m,v=e.text.length-2;if(0<v&&o)for(var b=0;b<o.length;++b)null==o[b].to&&(m=m||[]).push(new Se(o[b].marker,null,null));for(var y=0;y<v;++y)g.push(m);g.push(a)}return g}function Ae(t){for(var e=0;e<t.length;++e){var i=t[e];null!=i.from&&i.from==i.to&&!1!==i.marker.clearWhenEmpty&&t.splice(e--,1)}return t.length?t:null}function Ne(t){var e=t.markedSpans;if(e){for(var i=0;i<e.length;++i)e[i].marker.detachLine(t);t.markedSpans=null}}function $e(t,e){if(e){for(var i=0;i<e.length;++i)e[i].marker.attachLine(t);t.markedSpans=e}}function Me(t){return t.inclusiveLeft?-1:0}function De(t){return t.inclusiveRight?1:0}function Ie(t,e){var i=t.lines.length-e.lines.length;if(0!=i)return i;var n=t.find(),r=e.find(),i=re(n.from,r.from)||Me(t)-Me(e);if(i)return-i;r=re(n.to,r.to)||De(t)-De(e);return r||e.id-t.id}function Fe(t,e){var i,n=Te&&t.markedSpans;if(n)for(var r,s=0;s<n.length;++s)(r=n[s]).marker.collapsed&&null==(e?r.from:r.to)&&(!i||Ie(i,r.marker)<0)&&(i=r.marker);return i}function Oe(t){return Fe(t,!0)}function Be(t){return Fe(t,!1)}function He(t,e,i,n,r){var e=Xt(t,e),s=Te&&e.markedSpans;if(s)for(var o=0;o<s.length;++o){var a=s[o];if(a.marker.collapsed){var l=a.marker.find(0),c=re(l.from,i)||Me(a.marker)-Me(r),h=re(l.to,n)||De(a.marker)-De(r);if(!(0<=c&&h<=0||c<=0&&0<=h)&&(c<=0&&(a.marker.inclusiveRight&&r.inclusiveLeft?0<=re(l.to,i):0<re(l.to,i))||0<=c&&(a.marker.inclusiveRight&&r.inclusiveLeft?re(l.from,n)<=0:re(l.from,n)<0)))return 1}}}function Re(t){for(var e;e=Oe(t);)t=e.find(-1,!0).line;return t}function Pe(t,e){var i=Xt(t,e),t=Re(i);return i==t?e:Jt(t)}function We(t,e){if(e>t.lastLine())return e;var i,n=Xt(t,e);if(!ze(t,n))return e;for(;i=Be(n);)n=i.find(1,!0).line;return Jt(n)+1}function ze(t,e){var i=Te&&e.markedSpans;if(i)for(var n,r=0;r<i.length;++r)if((n=i[r]).marker.collapsed){if(null==n.from)return!0;if(!n.marker.widgetNode&&0==n.from&&n.marker.inclusiveLeft&&function t(e,i,n){if(null==n.to){var r=n.marker.find(1,!0);return t(e,r.line,Ee(r.line.markedSpans,n.marker))}if(n.marker.inclusiveRight&&n.to==i.text.length)return!0;for(var s=void 0,o=0;o<i.markedSpans.length;++o)if((s=i.markedSpans[o]).marker.collapsed&&!s.marker.widgetNode&&s.from==n.to&&(null==s.to||s.to!=n.from)&&(s.marker.inclusiveLeft||n.marker.inclusiveRight)&&t(e,i,s))return!0}(t,e,n))return!0}}function je(t){for(var e=0,i=(t=Re(t)).parent,n=0;n<i.lines.length;++n){var r=i.lines[n];if(r==t)break;e+=r.height}for(var s=i.parent;s;s=(i=s).parent)for(var o=0;o<s.children.length;++o){var a=s.children[o];if(a==i)break;e+=a.height}return e}function Ue(t){if(0==t.height)return 0;for(var e,i=t.text.length,n=t;e=Oe(n);){var r=e.find(0,!0),n=r.from.line;i+=r.from.ch-r.to.ch}for(n=t;e=Be(n);){var s=e.find(0,!0);i-=n.text.length-s.from.ch,i+=(n=s.to.line).text.length-s.to.ch}return i}function Ke(t){var i=t.display,t=t.doc;i.maxLine=Xt(t,t.first),i.maxLineLength=Ue(i.maxLine),i.maxLineChanged=!0,t.iter(function(t){var e=Ue(t);e>i.maxLineLength&&(i.maxLineLength=e,i.maxLine=t)})}var qe=function(t,e,i){this.text=t,$e(this,e),this.height=i?i(this):1};qe.prototype.lineNo=function(){return Jt(this)},Tt(qe);var Ve={},Ge={};function Xe(t,e){if(!t||/^\s*$/.test(t))return null;e=e.addModeClass?Ge:Ve;return e[t]||(e[t]=t.replace(/\S+/g,"cm-$&"))}function Ye(t,e){var i=L("span",null,null,p?"padding-right: .1px":null),n={pre:L("pre",[i],"CodeMirror-line"),content:i,col:0,pos:0,cm:t,trailingSpace:!1,splitSpaces:t.getOption("lineWrapping")};e.measure={};for(var r=0;r<=(e.rest?e.rest.length:0);r++){var s=r?e.rest[r-1]:e.line,o=void 0;n.pos=0,n.addToken=Ze,function(t){if(null!=Dt)return Dt;var e=S(t,document.createTextNode("AخA")),i=w(e,0,1).getBoundingClientRect(),e=w(e,1,2).getBoundingClientRect();return T(t),i&&i.left!=i.right&&(Dt=e.right-i.right<3)}(t.display.measure)&&(o=mt(s,t.doc.direction))&&(n.addToken=function(d,u){return function(t,e,i,n,r,s,o){i=i?i+" cm-force-border":"cm-force-border";for(var a=t.pos,l=a+e.length;;){for(var c=void 0,h=0;h<u.length&&!((c=u[h]).to>a&&c.from<=a);h++);if(c.to>=l)return d(t,e,i,n,r,s,o);d(t,e.slice(0,c.to-a),i,n,null,s,o),n=null,e=e.slice(c.to-a),a=c.to}}}(n.addToken,o)),n.map=[],function(t,e,i){var n=t.markedSpans,r=t.text,s=0;if(n)for(var o,a,l,c,h,d,u,p=r.length,f=0,g=1,m="",v=0;;){if(v==f){l=c=h=a="",d=u=null,v=1/0;for(var b=[],y=void 0,_=0;_<n.length;++_){var x=n[_],C=x.marker;if("bookmark"==C.type&&x.from==f&&C.widgetNode)b.push(C);else if(x.from<=f&&(null==x.to||x.to>f||C.collapsed&&x.to==f&&x.from==f)){if(null!=x.to&&x.to!=f&&v>x.to&&(v=x.to,c=""),C.className&&(l+=" "+C.className),C.css&&(a=(a?a+";":"")+C.css),C.startStyle&&x.from==f&&(h+=" "+C.startStyle),C.endStyle&&x.to==v&&(y=y||[]).push(C.endStyle,x.to),C.title&&((u=u||{}).title=C.title),C.attributes)for(var w in C.attributes)(u=u||{})[w]=C.attributes[w];C.collapsed&&(!d||Ie(d.marker,C)<0)&&(d=x)}else x.from>f&&v>x.from&&(v=x.from)}if(y)for(var k=0;k<y.length;k+=2)y[k+1]==v&&(c+=" "+y[k]);if(!d||d.from==f)for(var T=0;T<b.length;++T)Je(e,0,b[T]);if(d&&(d.from||0)==f){if(Je(e,(null==d.to?p+1:d.to)-f,d.marker,null==d.from),null==d.to)return;d.to==f&&(d=!1)}}if(p<=f)break;for(var S=Math.min(p,v);;){if(m){var E,L=f+m.length;if(d||(E=S<L?m.slice(0,S-f):m,e.addToken(e,E,o?o+l:l,h,f+E.length==v?c:"",a,u)),S<=L){m=m.slice(S-f),f=S;break}f=L,h=""}m=r.slice(s,s=i[g++]),o=Xe(i[g++],e.cm.options)}}else for(var A=1;A<i.length;A+=2)e.addToken(e,r.slice(s,s=i[A]),Xe(i[A+1],e.cm.options))}(s,n,ge(t,s,e!=t.display.externalMeasured&&Jt(s))),s.styleClasses&&(s.styleClasses.bgClass&&(n.bgClass=M(s.styleClasses.bgClass,n.bgClass||"")),s.styleClasses.textClass&&(n.textClass=M(s.styleClasses.textClass,n.textClass||""))),0==n.map.length&&n.map.push(0,0,n.content.appendChild(function(t){null==Mt&&(e=E("span","​"),S(t,E("span",[e,document.createTextNode("x")])),0!=t.firstChild.offsetHeight&&(Mt=e.offsetWidth<=1&&2<e.offsetHeight&&!(_&&v<8)));var e=Mt?E("span","​"):E("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px");return e.setAttribute("cm-text",""),e}(t.display.measure))),0==r?(e.measure.map=n.map,e.measure.cache={}):((e.measure.maps||(e.measure.maps=[])).push(n.map),(e.measure.caches||(e.measure.caches=[])).push({}))}return p&&(i=n.content.lastChild,(/\bcm-tab\b/.test(i.className)||i.querySelector&&i.querySelector(".cm-tab"))&&(n.content.className="cm-tab-wrap-hack")),xt(t,"renderLine",t,e.line,n.pre),n.pre.className&&(n.textClass=M(n.pre.className,n.textClass||"")),n}function Qe(t){var e=E("span","•","cm-invalidchar");return e.title="\\u"+t.charCodeAt(0).toString(16),e.setAttribute("aria-label",e.title),e}function Ze(t,e,i,n,r,s,o){if(e){var a,l=t.splitSpaces?function(t,e){if(1<t.length&&!/  /.test(t))return t;for(var i=e,n="",r=0;r<t.length;r++){var s=t.charAt(r);" "!=s||!i||r!=t.length-1&&32!=t.charCodeAt(r+1)||(s=" "),n+=s,i=" "==s}return n}(e,t.trailingSpace):e,c=t.cm.state.specialChars,h=!1;if(c.test(e)){a=document.createDocumentFragment();for(var d=0;;){c.lastIndex=d;var u=c.exec(e),p=u?u.index-d:e.length-d;if(p&&(f=document.createTextNode(l.slice(d,d+p)),_&&v<9?a.appendChild(E("span",[f])):a.appendChild(f),t.map.push(t.pos,t.pos+p,f),t.col+=p,t.pos+=p),!u)break;d+=1+p;var f=void 0;"\t"==u[0]?(p=(p=t.cm.options.tabSize)-t.col%p,(f=a.appendChild(E("span",q(p),"cm-tab"))).setAttribute("role","presentation"),f.setAttribute("cm-text","\t"),t.col+=p):("\r"==u[0]||"\n"==u[0]?(f=a.appendChild(E("span","\r"==u[0]?"␍":"␤","cm-invalidchar"))).setAttribute("cm-text",u[0]):((f=t.cm.options.specialCharPlaceholder(u[0])).setAttribute("cm-text",u[0]),_&&v<9?a.appendChild(E("span",[f])):a.appendChild(f)),t.col+=1),t.map.push(t.pos,t.pos+1,f),t.pos++}}else t.col+=e.length,a=document.createTextNode(l),t.map.push(t.pos,t.pos+e.length,a),_&&v<9&&(h=!0),t.pos+=e.length;if(t.trailingSpace=32==l.charCodeAt(e.length-1),i||n||r||h||s||o){i=i||"";n&&(i+=n),r&&(i+=r);var g=E("span",[a],i,s);if(o)for(var m in o)o.hasOwnProperty(m)&&"style"!=m&&"class"!=m&&g.setAttribute(m,o[m]);return t.content.appendChild(g)}t.content.appendChild(a)}}function Je(t,e,i,n){var r=!n&&i.widgetNode;r&&t.map.push(t.pos,t.pos+e,r),!n&&t.cm.display.input.needsContentAttribute&&(r=r||t.content.appendChild(document.createElement("span"))).setAttribute("cm-marker",i.id),r&&(t.cm.display.input.setUneditable(r),t.content.appendChild(r)),t.pos+=e,t.trailingSpace=!1}function ti(t,e,i){this.line=e,this.rest=function(t){for(var e,i;e=Be(t);)t=e.find(1,!0).line,(i=i||[]).push(t);return i}(e),this.size=this.rest?Jt(V(this.rest))-i+1:1,this.node=this.text=null,this.hidden=ze(t,e)}function ei(t,e,i){for(var n=[],r=e;r<i;r=o){var s=new ti(t.doc,Xt(t.doc,r),r),o=r+s.size;n.push(s)}return n}var ii=null;function ni(t,e){var i=t.ownsGroup;if(i)try{!function(t){var e=t.delayedCallbacks,i=0;do{for(;i<e.length;i++)e[i].call(null);for(var n=0;n<t.ops.length;n++){var r=t.ops[n];if(r.cursorActivityHandlers)for(;r.cursorActivityCalled<r.cursorActivityHandlers.length;)r.cursorActivityHandlers[r.cursorActivityCalled++].call(null,r.cm)}}while(i<e.length)}(i)}finally{ii=null,e(i)}}var ri=null;function si(t,e){var i=yt(t,e);if(i.length){var n,r=Array.prototype.slice.call(arguments,2);ii?n=ii.delayedCallbacks:ri?n=ri:(n=ri=[],setTimeout(oi,0));for(var s=0;s<i.length;++s)!function(t){n.push(function(){return i[t].apply(null,r)})}(s)}}function oi(){var t=ri;ri=null;for(var e=0;e<t.length;++e)t[e]()}function ai(t,e,i,n){for(var r,s,o,a,l=0;l<e.changes.length;l++){var c=e.changes[l];"text"==c?(r=t,a=o=void 0,o=(s=e).text.className,a=ci(r,s),s.text==s.node&&(s.node=a.pre),s.text.parentNode.replaceChild(a.pre,s.text),s.text=a.pre,a.bgClass!=s.bgClass||a.textClass!=s.textClass?(s.bgClass=a.bgClass,s.textClass=a.textClass,hi(r,s)):o&&(s.text.className=o)):"gutter"==c?di(t,e,i,n):"class"==c?hi(t,e):"widget"==c&&function(t,e,i){e.alignable&&(e.alignable=null);for(var n=C("CodeMirror-linewidget"),r=e.node.firstChild,s=void 0;r;r=s)s=r.nextSibling,n.test(r.className)&&e.node.removeChild(r);ui(t,e,i)}(t,e,n)}e.changes=null}function li(t){return t.node==t.text&&(t.node=E("div",null,null,"position: relative"),t.text.parentNode&&t.text.parentNode.replaceChild(t.node,t.text),t.node.appendChild(t.text),_&&v<8&&(t.node.style.zIndex=2)),t.node}function ci(t,e){var i=t.display.externalMeasured;return i&&i.line==e.line?(t.display.externalMeasured=null,e.measure=i.measure,i.built):Ye(t,e)}function hi(t,e){var i,n;i=t,(n=(r=e).bgClass?r.bgClass+" "+(r.line.bgClass||""):r.line.bgClass)&&(n+=" CodeMirror-linebackground"),r.background?n?r.background.className=n:(r.background.parentNode.removeChild(r.background),r.background=null):n&&(t=li(r),r.background=t.insertBefore(E("div",null,n),t.firstChild),i.display.input.setUneditable(r.background)),e.line.wrapClass?li(e).className=e.line.wrapClass:e.node!=e.text&&(e.node.className="");var r=e.textClass?e.textClass+" "+(e.line.textClass||""):e.line.textClass;e.text.className=r||""}function di(t,e,i,n){e.gutter&&(e.node.removeChild(e.gutter),e.gutter=null),e.gutterBackground&&(e.node.removeChild(e.gutterBackground),e.gutterBackground=null),e.line.gutterClass&&(s=li(e),e.gutterBackground=E("div",null,"CodeMirror-gutter-background "+e.line.gutterClass,"left: "+(t.options.fixedGutter?n.fixedPos:-n.gutterTotalWidth)+"px; width: "+n.gutterTotalWidth+"px"),t.display.input.setUneditable(e.gutterBackground),s.insertBefore(e.gutterBackground,e.text));var r=e.line.gutterMarkers;if(t.options.lineNumbers||r){var s=li(e),o=e.gutter=E("div",null,"CodeMirror-gutter-wrapper","left: "+(t.options.fixedGutter?n.fixedPos:-n.gutterTotalWidth)+"px");if(o.setAttribute("aria-hidden","true"),t.display.input.setUneditable(o),s.insertBefore(o,e.text),e.line.gutterClass&&(o.className+=" "+e.line.gutterClass),!t.options.lineNumbers||r&&r["CodeMirror-linenumbers"]||(e.lineNumber=o.appendChild(E("div",ie(t.options,i),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+n.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+t.display.lineNumInnerWidth+"px"))),r)for(var a=0;a<t.display.gutterSpecs.length;++a){var l=t.display.gutterSpecs[a].className,c=r.hasOwnProperty(l)&&r[l];c&&o.appendChild(E("div",[c],"CodeMirror-gutter-elt","left: "+n.gutterLeft[l]+"px; width: "+n.gutterWidth[l]+"px"))}}}function ui(t,e,i){if(pi(t,e.line,e,i,!0),e.rest)for(var n=0;n<e.rest.length;n++)pi(t,e.rest[n],e,i,!1)}function pi(t,e,i,n,r){if(e.widgets)for(var s,o,a,l,c=li(i),h=0,d=e.widgets;h<d.length;++h){var u=d[h],p=E("div",[u.node],"CodeMirror-linewidget"+(u.className?" "+u.className:""));u.handleMouseEvents||p.setAttribute("cm-ignore-events","true"),o=p,a=i,l=n,(s=u).noHScroll&&((a.alignable||(a.alignable=[])).push(o),a=l.wrapperWidth,o.style.left=l.fixedPos+"px",s.coverGutter||(a-=l.gutterTotalWidth,o.style.paddingLeft=l.gutterTotalWidth+"px"),o.style.width=a+"px"),s.coverGutter&&(o.style.zIndex=5,o.style.position="relative",s.noHScroll||(o.style.marginLeft=-l.gutterTotalWidth+"px")),t.display.input.setUneditable(p),r&&u.above?c.insertBefore(p,i.gutter||i.text):c.appendChild(p),si(u,"redraw")}}function fi(t){if(null!=t.height)return t.height;var e,i=t.doc.cm;return i?(A(document.body,t.node)||(e="position: relative;",t.coverGutter&&(e+="margin-left: -"+i.display.gutters.offsetWidth+"px;"),t.noHScroll&&(e+="width: "+i.display.wrapper.clientWidth+"px;"),S(i.display.measure,E("div",[t.node],null,e))),t.height=t.node.parentNode.offsetHeight):0}function gi(t,e){for(var i=Nt(e);i!=t.wrapper;i=i.parentNode)if(!i||1==i.nodeType&&"true"==i.getAttribute("cm-ignore-events")||i.parentNode==t.sizer&&i!=t.mover)return 1}function mi(t){return t.lineSpace.offsetTop}function vi(t){return t.mover.offsetHeight-t.lineSpace.offsetHeight}function bi(t){if(t.cachedPaddingH)return t.cachedPaddingH;var e=S(t.measure,E("pre","x","CodeMirror-line-like")),e=window.getComputedStyle?window.getComputedStyle(e):e.currentStyle,e={left:parseInt(e.paddingLeft),right:parseInt(e.paddingRight)};return isNaN(e.left)||isNaN(e.right)||(t.cachedPaddingH=e),e}function yi(t){return R-t.display.nativeBarWidth}function _i(t){return t.display.scroller.clientWidth-yi(t)-t.display.barWidth}function xi(t){return t.display.scroller.clientHeight-yi(t)-t.display.barHeight}function Ci(t,e,i){if(t.line==e)return{map:t.measure.map,cache:t.measure.cache};for(var n=0;n<t.rest.length;n++)if(t.rest[n]==e)return{map:t.measure.maps[n],cache:t.measure.caches[n]};for(var r=0;r<t.rest.length;r++)if(Jt(t.rest[r])>i)return{map:t.measure.maps[r],cache:t.measure.caches[r],before:!0}}function wi(t,e,i,n){return Si(t,Ti(t,e),i,n)}function ki(t,e){if(e>=t.display.viewFrom&&e<t.display.viewTo)return t.display.view[Ji(t,e)];t=t.display.externalMeasured;return t&&e>=t.lineN&&e<t.lineN+t.size?t:void 0}function Ti(t,e){var i,n,r=Jt(e),s=ki(t,r);s&&!s.text?s=null:s&&s.changes&&(ai(t,s,r,Gi(t)),t.curOp.forceUpdate=!0),s||(i=t,t=Jt(n=Re(n=e)),(n=i.display.externalMeasured=new ti(i.doc,n,t)).lineN=t,t=n.built=Ye(i,n),n.text=t.pre,S(i.display.lineMeasure,t.pre),s=n);r=Ci(s,e,r);return{line:e,view:s,rect:null,map:r.map,cache:r.cache,before:r.before,hasHeights:!1}}function Si(t,e,i,n,r){e.before&&(i=-1);var s,o=i+(n||"");return e.cache.hasOwnProperty(o)?s=e.cache[o]:(e.rect||(e.rect=e.view.text.getBoundingClientRect()),e.hasHeights||(function(t,e,i){var n=t.options.lineWrapping,t=n&&_i(t);if(!e.measure.heights||n&&e.measure.width!=t){var r=e.measure.heights=[];if(n){e.measure.width=t;for(var s=e.text.firstChild.getClientRects(),o=0;o<s.length-1;o++){var a=s[o],l=s[o+1];2<Math.abs(a.bottom-l.bottom)&&r.push((a.bottom+l.top)/2-i.top)}}r.push(i.bottom-i.top)}}(t,e.view,e.rect),e.hasHeights=!0),(s=function(t,e,i,n){var r,s=Ai(e.map,i,n),o=s.node,a=s.start,l=s.end,c=s.collapse;if(3==o.nodeType){for(var h=0;h<4;h++){for(;a&&it(e.line.text.charAt(s.coverStart+a));)--a;for(;s.coverStart+l<s.coverEnd&&it(e.line.text.charAt(s.coverStart+l));)++l;if((r=_&&v<9&&0==a&&l==s.coverEnd-s.coverStart?o.parentNode.getBoundingClientRect():function(t,e){var i=Li;if("left"==e)for(var n=0;n<t.length&&(i=t[n]).left==i.right;n++);else for(var r=t.length-1;0<=r&&(i=t[r]).left==i.right;r--);return i}(w(o,a,l).getClientRects(),n)).left||r.right||0==a)break;l=a,--a,c="right"}_&&v<11&&(r=function(t,e){if(!window.screen||null==screen.logicalXDPI||screen.logicalXDPI==screen.deviceXDPI||!function(t){if(null!=Ht)return Ht;var t=(e=S(t,E("span","x"))).getBoundingClientRect(),e=w(e,0,1).getBoundingClientRect();return Ht=1<Math.abs(t.left-e.left)}(t))return e;var i=screen.logicalXDPI/screen.deviceXDPI,t=screen.logicalYDPI/screen.deviceYDPI;return{left:e.left*i,right:e.right*i,top:e.top*t,bottom:e.bottom*t}}(t.display.measure,r))}else 0<a&&(c=n="right"),r=t.options.lineWrapping&&1<(g=o.getClientRects()).length?g["right"==n?g.length-1:0]:o.getBoundingClientRect();!(_&&v<9)||a||r&&(r.left||r.right)||(m=o.parentNode.getClientRects()[0],r=m?{left:m.left,right:m.left+Vi(t.display),top:m.top,bottom:m.bottom}:Li);for(var d=r.top-e.rect.top,i=r.bottom-e.rect.top,u=(d+i)/2,p=e.view.measure.heights,f=0;f<p.length-1&&!(u<p[f]);f++);var g=f?p[f-1]:0,m=p[f],m={left:("right"==c?r.right:r.left)-e.rect.left,right:("left"==c?r.left:r.right)-e.rect.left,top:g,bottom:m};r.left||r.right||(m.bogus=!0);t.options.singleCursorHeightPerLine||(m.rtop=d,m.rbottom=i);return m}(t,e,i,n)).bogus||(e.cache[o]=s)),{left:s.left,right:s.right,top:r?s.rtop:s.top,bottom:r?s.rbottom:s.bottom}}var Ei,Li={left:0,right:0,top:0,bottom:0};function Ai(t,e,i){for(var n,r,s,o,a,l,c=0;c<t.length;c+=3)if(a=t[c],l=t[c+1],e<a?(r=0,s=1,o="left"):e<l?s=(r=e-a)+1:(c==t.length-3||e==l&&t[c+3]>e)&&(r=(s=l-a)-1,l<=e&&(o="right")),null!=r){if(n=t[c+2],a==l&&i==(n.insertLeft?"left":"right")&&(o=i),"left"==i&&0==r)for(;c&&t[c-2]==t[c-3]&&t[c-1].insertLeft;)n=t[2+(c-=3)],o="left";if("right"==i&&r==l-a)for(;c<t.length-3&&t[c+3]==t[c+4]&&!t[c+5].insertLeft;)n=t[(c+=3)+2],o="right";break}return{node:n,start:r,end:s,collapse:o,coverStart:a,coverEnd:l}}function Ni(t){if(t.measure&&(t.measure.cache={},t.measure.heights=null,t.rest))for(var e=0;e<t.rest.length;e++)t.measure.caches[e]={}}function $i(t){t.display.externalMeasure=null,T(t.display.lineMeasure);for(var e=0;e<t.display.view.length;e++)Ni(t.display.view[e])}function Mi(t){$i(t),t.display.cachedCharWidth=t.display.cachedTextHeight=t.display.cachedPaddingH=null,t.options.lineWrapping||(t.display.maxLineChanged=!0),t.display.lineNumChars=null}function Di(){return s&&l?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function Ii(){return s&&l?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function Fi(t){var e=0;if(t.widgets)for(var i=0;i<t.widgets.length;++i)t.widgets[i].above&&(e+=fi(t.widgets[i]));return e}function Oi(t,e,i,n,r){if(r||(r=Fi(e),i.top+=r,i.bottom+=r),"line"==n)return i;n=n||"local";e=je(e);return"local"==n?e+=mi(t.display):e-=t.display.viewOffset,"page"!=n&&"window"!=n||(e+=(t=t.display.lineSpace.getBoundingClientRect()).top+("window"==n?0:Ii()),n=t.left+("window"==n?0:Di()),i.left+=n,i.right+=n),i.top+=e,i.bottom+=e,i}function Bi(t,e,i){if("div"==i)return e;var n=e.left,e=e.top;"page"==i?(n-=Di(),e-=Ii()):"local"!=i&&i||(n+=(i=t.display.sizer.getBoundingClientRect()).left,e+=i.top);t=t.display.lineSpace.getBoundingClientRect();return{left:n-t.left,top:e-t.top}}function Hi(t,e,i,n,r){return Oi(t,n=n||Xt(t.doc,e.line),wi(t,n,e.ch,r),i)}function Ri(i,t,n,r,s,o){function a(t,e){t=Si(i,s,t,e?"right":"left",o);return e?t.left=t.right:t.right=t.left,Oi(i,r,t,n)}r=r||Xt(i.doc,t.line),s=s||Ti(i,r);var l=mt(r,i.doc.direction),e=t.ch,c=t.sticky;if(e>=r.text.length?(e=r.text.length,c="before"):e<=0&&(e=0,c="after"),!l)return a("before"==c?e-1:e,"before"==c);function h(t,e,i){return a(i?t-1:t,1==l[e].level!=i)}var d=ot(l,e,c),t=st,d=h(e,d,"before"==c);return null!=t&&(d.other=h(e,t,"before"!=c)),d}function Pi(t,e){var i=0;e=he(t.doc,e),t.options.lineWrapping||(i=Vi(t.display)*e.ch);e=Xt(t.doc,e.line),t=je(e)+mi(t.display);return{left:i,right:i,top:t,bottom:t+e.height}}function Wi(t,e,i,n,r){i=ne(t,e,i);return i.xRel=r,n&&(i.outside=n),i}function zi(t,e,i){var n=t.doc;if((i+=t.display.viewOffset)<0)return Wi(n.first,0,null,-1,-1);var r=te(n,i),s=n.first+n.size-1;if(s<r)return Wi(n.first+n.size-1,Xt(n,s).text.length,null,1,1);e<0&&(e=0);for(var o=Xt(n,r);;){var a=function(i,t,e,n,r){r-=je(t);var s=Ti(i,t),o=Fi(t),a=0,l=t.text.length,c=!0,h=mt(t,i.doc.direction);h&&(p=(i.options.lineWrapping?function(t,e,i,n,r,s,o){var o=ji(t,e,n,o),a=o.begin,l=o.end;/\s/.test(e.text.charAt(l-1))&&l--;for(var c=null,h=null,d=0;d<r.length;d++){var u,p=r[d];p.from>=l||p.to<=a||(u=1!=p.level,u=Si(t,n,u?Math.min(l,p.to)-1:Math.max(a,p.from)).right,u=u<s?s-u+1e9:u-s,(!c||u<h)&&(c=p,h=u))}c=c||r[r.length-1];c.from<a&&(c={from:a,to:c.to,level:c.level});c.to>l&&(c={from:c.from,to:l,level:c.level});return c}:function(i,n,r,s,o,a,l){var t=rt(function(t){var e=o[t],t=1!=e.level;return Ki(Ri(i,ne(r,t?e.to:e.from,t?"before":"after"),"line",n,s),a,l,!0)},0,o.length-1),e=o[t];{var c;0<t&&(c=1!=e.level,Ki(c=Ri(i,ne(r,c?e.from:e.to,c?"after":"before"),"line",n,s),a,l,!0)&&c.top>l&&(e=o[t-1]))}return e})(i,t,e,s,h,n,r),c=1!=p.level,a=c?p.from:p.to-1,l=c?p.to:p.from-1);var d=null,u=null,h=rt(function(t){var e=Si(i,s,t);return e.top+=o,e.bottom+=o,Ki(e,n,r,!1)&&(e.top<=r&&e.left<=n&&(d=t,u=e),1)},a,l),p=!1;{var f,g;u?(f=n-u.left<u.right-n,h=d+((g=f==c)?0:1),g=g?"after":"before",f=f?u.left:u.right):(c||h!=l&&h!=a||h++,g=0==h||h!=t.text.length&&Si(i,s,h-(c?1:0)).bottom+o<=r==c?"after":"before",c=Ri(i,ne(e,h,g),"line",t,s),f=c.left,p=r<c.top?-1:r>=c.bottom?1:0)}return h=nt(t.text,h,1),Wi(e,h,g,p,n-f)}(t,o,r,e,i),l=function(t,e){var i,n=Te&&t.markedSpans;if(n)for(var r=0;r<n.length;++r){var s=n[r];s.marker.collapsed&&(null==s.from||s.from<e)&&(null==s.to||s.to>e)&&(!i||Ie(i,s.marker)<0)&&(i=s.marker)}return i}(o,a.ch+(0<a.xRel||0<a.outside?1:0));if(!l)return a;l=l.find(1);if(l.line==r)return l;o=Xt(n,r=l.line)}}function ji(e,t,i,n){n-=Fi(t);var r=t.text.length,t=rt(function(t){return Si(e,i,t-1).bottom<=n},r,0);return{begin:t,end:r=rt(function(t){return Si(e,i,t).top>n},t,r)}}function Ui(t,e,i,n){return ji(t,e,i=i||Ti(t,e),Oi(t,e,Si(t,i,n),"line").top)}function Ki(t,e,i,n){return!(t.bottom<=i)&&(t.top>i||(n?t.left:t.right)>e)}function qi(t){if(null!=t.cachedTextHeight)return t.cachedTextHeight;if(null==Ei){Ei=E("pre",null,"CodeMirror-line-like");for(var e=0;e<49;++e)Ei.appendChild(document.createTextNode("x")),Ei.appendChild(E("br"));Ei.appendChild(document.createTextNode("x"))}S(t.measure,Ei);var i=Ei.offsetHeight/50;return 3<i&&(t.cachedTextHeight=i),T(t.measure),i||1}function Vi(t){if(null!=t.cachedCharWidth)return t.cachedCharWidth;var e=E("span","xxxxxxxxxx"),i=E("pre",[e],"CodeMirror-line-like");S(t.measure,i);e=e.getBoundingClientRect(),e=(e.right-e.left)/10;return 2<e&&(t.cachedCharWidth=e),e||10}function Gi(t){for(var e=t.display,i={},n={},r=e.gutters.clientLeft,s=e.gutters.firstChild,o=0;s;s=s.nextSibling,++o){var a=t.display.gutterSpecs[o].className;i[a]=s.offsetLeft+s.clientLeft+r,n[a]=s.clientWidth}return{fixedPos:Xi(e),gutterTotalWidth:e.gutters.offsetWidth,gutterLeft:i,gutterWidth:n,wrapperWidth:e.wrapper.clientWidth}}function Xi(t){return t.scroller.getBoundingClientRect().left-t.sizer.getBoundingClientRect().left}function Yi(n){var r=qi(n.display),s=n.options.lineWrapping,o=s&&Math.max(5,n.display.scroller.clientWidth/Vi(n.display)-3);return function(t){if(ze(n.doc,t))return 0;var e=0;if(t.widgets)for(var i=0;i<t.widgets.length;i++)t.widgets[i].height&&(e+=t.widgets[i].height);return s?e+(Math.ceil(t.text.length/o)||1)*r:e+r}}function Qi(t){var e=t.doc,i=Yi(t);e.iter(function(t){var e=i(t);e!=t.height&&Zt(t,e)})}function Zi(t,e,i,n){var r=t.display;if(!i&&"true"==Nt(e).getAttribute("cm-not-content"))return null;var s,o,a=r.lineSpace.getBoundingClientRect();try{s=e.clientX-a.left,o=e.clientY-a.top}catch(t){return null}var l,r=zi(t,s,o);return n&&0<r.xRel&&(l=Xt(t.doc,r.line).text).length==r.ch&&(l=O(l,l.length,t.options.tabSize)-l.length,r=ne(r.line,Math.max(0,Math.round((s-bi(t.display).left)/Vi(t.display))-l))),r}function Ji(t,e){if(e>=t.display.viewTo)return null;if((e-=t.display.viewFrom)<0)return null;for(var i=t.display.view,n=0;n<i.length;n++)if((e-=i[n].size)<0)return n}function tn(t,e,i,n){null==e&&(e=t.doc.first),null==i&&(i=t.doc.first+t.doc.size),n=n||0;var r,s,o=t.display;n&&i<o.viewTo&&(null==o.updateLineNumbers||o.updateLineNumbers>e)&&(o.updateLineNumbers=e),t.curOp.viewChanged=!0,e>=o.viewTo?Te&&Pe(t.doc,e)<o.viewTo&&nn(t):i<=o.viewFrom?Te&&We(t.doc,i+n)>o.viewFrom?nn(t):(o.viewFrom+=n,o.viewTo+=n):e<=o.viewFrom&&i>=o.viewTo?nn(t):e<=o.viewFrom?(r=rn(t,i,i+n,1))?(o.view=o.view.slice(r.index),o.viewFrom=r.lineN,o.viewTo+=n):nn(t):i>=o.viewTo?(s=rn(t,e,e,-1))?(o.view=o.view.slice(0,s.index),o.viewTo=s.lineN):nn(t):(r=rn(t,e,e,-1),s=rn(t,i,i+n,1),r&&s?(o.view=o.view.slice(0,r.index).concat(ei(t,r.lineN,s.lineN)).concat(o.view.slice(s.index)),o.viewTo+=n):nn(t));t=o.externalMeasured;t&&(i<t.lineN?t.lineN+=n:e<t.lineN+t.size&&(o.externalMeasured=null))}function en(t,e,i){t.curOp.viewChanged=!0;var n=t.display,r=t.display.externalMeasured;r&&e>=r.lineN&&e<r.lineN+r.size&&(n.externalMeasured=null),e<n.viewFrom||e>=n.viewTo||(null==(e=n.view[Ji(t,e)]).node||-1==H(e=e.changes||(e.changes=[]),i)&&e.push(i))}function nn(t){t.display.viewFrom=t.display.viewTo=t.doc.first,t.display.view=[],t.display.viewOffset=0}function rn(t,e,i,n){var r,s=Ji(t,e),o=t.display.view;if(!Te||i==t.doc.first+t.doc.size)return{index:s,lineN:i};for(var a=t.display.viewFrom,l=0;l<s;l++)a+=o[l].size;if(a!=e){if(0<n){if(s==o.length-1)return null;r=a+o[s].size-e,s++}else r=a-e;e+=r,i+=r}for(;Pe(t.doc,i)!=i;){if(s==(n<0?0:o.length-1))return null;i+=n*o[s-(n<0?1:0)].size,s+=n}return{index:s,lineN:i}}function sn(t){for(var e=t.display.view,i=0,n=0;n<e.length;n++){var r=e[n];r.hidden||r.node&&!r.changes||++i}return i}function on(t){t.display.input.showSelection(t.display.input.prepareSelection())}function an(t,e){void 0===e&&(e=!0);for(var i,n,r=t.doc,s={},o=s.cursors=document.createDocumentFragment(),a=s.selection=document.createDocumentFragment(),l=0;l<r.sel.ranges.length;l++)!e&&l==r.sel.primIndex||((i=r.sel.ranges[l]).from().line>=t.display.viewTo||i.to().line<t.display.viewFrom||(((n=i.empty())||t.options.showCursorWhenSelecting)&&ln(t,i.head,o),n||function(r,t,e){var i=r.display,s=r.doc,o=document.createDocumentFragment(),n=bi(r.display),w=n.left,k=Math.max(i.sizerWidth,_i(r)-i.sizer.offsetLeft)-n.right,T="ltr"==s.direction;function S(t,e,i,n){e<0&&(e=0),e=Math.round(e),n=Math.round(n),o.appendChild(E("div",null,"CodeMirror-selected","position: absolute; left: "+t+"px;\n                             top: "+e+"px; width: "+(null==i?k-t:i)+"px;\n                             height: "+(n-e)+"px"))}function a(i,g,m){var v,b,n=Xt(s,i),y=n.text.length;function _(t,e){return Hi(r,ne(i,t),"div",n,e)}function x(t,e,i){t=Ui(r,n,null,t),e="ltr"==e==("after"==i)?"left":"right";return _("after"==i?t.begin:t.end-(/\s/.test(n.text.charAt(t.end-1))?2:1),e)[e]}var C=mt(n,s.direction);return function(t,e,i,n){if(!t)return n(e,i,"ltr",0);for(var r=!1,s=0;s<t.length;++s){var o=t[s];(o.from<i&&o.to>e||e==i&&o.to==e)&&(n(Math.max(o.from,e),Math.min(o.to,i),1==o.level?"rtl":"ltr",s),r=!0)}r||n(e,i,"ltr")}(C,g||0,null==m?y:m,function(t,e,i,n){var r,s,o,a,l="ltr"==i,c=_(t,l?"left":"right"),h=_(e-1,l?"right":"left"),d=null==g&&0==t,u=null==m&&e==y,p=0==n,f=!C||n==C.length-1;h.top-c.top<=3?(r=(T?u:d)&&f,n=(T?d:u)&&p?w:(l?c:h).left,r=r?k:(l?h:c).right,S(n,c.top,r-n,c.bottom)):(i=l?(s=T&&d&&p?w:c.left,o=T?k:x(t,i,"before"),a=T?w:x(e,i,"after"),T&&u&&f?k:h.right):(s=T?x(t,i,"before"):w,o=!T&&d&&p?k:c.right,a=!T&&u&&f?w:h.left,T?x(e,i,"after"):k),S(s,c.top,o-s,c.bottom),c.bottom<h.top&&S(w,c.bottom,null,h.top),S(a,h.top,i-a,h.bottom)),(!v||cn(c,v)<0)&&(v=c),cn(h,v)<0&&(v=h),(!b||cn(c,b)<0)&&(b=c),cn(h,b)<0&&(b=h)}),{start:v,end:b}}var l=t.from(),i=t.to();l.line==i.line?a(l.line,l.ch,i.ch):(n=Xt(s,l.line),t=Xt(s,i.line),t=Re(n)==Re(t),n=a(l.line,l.ch,t?n.text.length+1:null).end,i=a(i.line,t?0:null,i.ch).start,t&&(n.top<i.top-2?(S(n.right,n.top,null,n.bottom),S(w,i.top,i.left,i.bottom)):S(n.right,n.top,i.left-n.right,n.bottom)),n.bottom<i.top&&S(w,n.bottom,null,i.top)),e.appendChild(o)}(t,i,a)));return s}function ln(t,e,i){var n=Ri(t,e,"div",null,null,!t.options.singleCursorHeightPerLine),r=i.appendChild(E("div"," ","CodeMirror-cursor"));r.style.left=n.left+"px",r.style.top=n.top+"px",r.style.height=Math.max(0,n.bottom-n.top)*t.options.cursorHeight+"px",!/\bcm-fat-cursor\b/.test(t.getWrapperElement().className)||0<(e=Hi(t,e,"div",null,null)).right-e.left&&(r.style.width=e.right-e.left+"px"),n.other&&((i=i.appendChild(E("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"))).style.display="",i.style.left=n.other.left+"px",i.style.top=n.other.top+"px",i.style.height=.85*(n.other.bottom-n.other.top)+"px")}function cn(t,e){return t.top-e.top||t.left-e.left}function hn(t){var e,i;t.state.focused&&(e=t.display,clearInterval(e.blinker),i=!0,e.cursorDiv.style.visibility="",0<t.options.cursorBlinkRate?e.blinker=setInterval(function(){t.hasFocus()||fn(t),e.cursorDiv.style.visibility=(i=!i)?"":"hidden"},t.options.cursorBlinkRate):t.options.cursorBlinkRate<0&&(e.cursorDiv.style.visibility="hidden"))}function dn(t){t.hasFocus()||(t.display.input.focus(),t.state.focused||pn(t))}function un(t){t.state.delayingBlurEvent=!0,setTimeout(function(){t.state.delayingBlurEvent&&(t.state.delayingBlurEvent=!1,t.state.focused&&fn(t))},100)}function pn(t,e){t.state.delayingBlurEvent&&!t.state.draggingText&&(t.state.delayingBlurEvent=!1),"nocursor"!=t.options.readOnly&&(t.state.focused||(xt(t,"focus",t,e),t.state.focused=!0,$(t.display.wrapper,"CodeMirror-focused"),t.curOp||t.display.selForContextMenu==t.doc.sel||(t.display.input.reset(),p&&setTimeout(function(){return t.display.input.reset(!0)},20)),t.display.input.receivedFocus()),hn(t))}function fn(t,e){t.state.delayingBlurEvent||(t.state.focused&&(xt(t,"blur",t,e),t.state.focused=!1,k(t.display.wrapper,"CodeMirror-focused")),clearInterval(t.display.blinker),setTimeout(function(){t.state.focused||(t.display.shift=!1)},150))}function gn(t){for(var e=t.display,i=e.lineDiv.offsetTop,n=Math.max(0,e.scroller.getBoundingClientRect().top),r=e.lineDiv.getBoundingClientRect().top,s=0,o=0;o<e.view.length;o++){var a,l=e.view[o],c=t.options.lineWrapping,h=void 0,d=0;if(!l.hidden){r+=l.line.height,_&&v<8?(h=(a=l.node.offsetTop+l.node.offsetHeight)-i,i=a):(h=(u=l.node.getBoundingClientRect()).bottom-u.top,!c&&l.text.firstChild&&(d=l.text.firstChild.getBoundingClientRect().right-u.left-1));var u=l.line.height-h;if((.005<u||u<-.005)&&(r<n&&(s-=u),Zt(l.line,h),mn(l.line),l.rest))for(var p=0;p<l.rest.length;p++)mn(l.rest[p]);d>t.display.sizerWidth&&((d=Math.ceil(d/Vi(t.display)))>t.display.maxLineLength&&(t.display.maxLineLength=d,t.display.maxLine=l.line,t.display.maxLineChanged=!0))}}2<Math.abs(s)&&(e.scroller.scrollTop+=s)}function mn(t){if(t.widgets)for(var e=0;e<t.widgets.length;++e){var i=t.widgets[e],n=i.node.parentNode;n&&(i.height=n.offsetHeight)}}function vn(t,e,i){var n=i&&null!=i.top?Math.max(0,i.top):t.scroller.scrollTop,n=Math.floor(n-mi(t)),r=i&&null!=i.bottom?i.bottom:n+t.wrapper.clientHeight,s=te(e,n),n=te(e,r);return i&&i.ensure&&(r=i.ensure.from.line,i=i.ensure.to.line,r<s?n=te(e,je(Xt(e,s=r))+t.wrapper.clientHeight):Math.min(i,e.lastLine())>=n&&(s=te(e,je(Xt(e,i))-t.wrapper.clientHeight),n=i)),{from:s,to:Math.max(n,s+1)}}function bn(t,e){var i=t.display,n=qi(t.display);e.top<0&&(e.top=0);var r=(t.curOp&&null!=t.curOp.scrollTop?t.curOp:i.scroller).scrollTop,s=xi(t),o={};e.bottom-e.top>s&&(e.bottom=e.top+s);var a=t.doc.height+vi(i),l=e.top<n,n=e.bottom>a-n;e.top<r?o.scrollTop=l?0:e.top:e.bottom>r+s&&((c=Math.min(e.top,(n?a:e.bottom)-s))!=r&&(o.scrollTop=c));var r=t.options.fixedGutter?0:i.gutters.offsetWidth,c=t.curOp&&null!=t.curOp.scrollLeft?t.curOp.scrollLeft:i.scroller.scrollLeft-r,t=_i(t)-i.gutters.offsetWidth,i=e.right-e.left>t;return i&&(e.right=e.left+t),e.left<10?o.scrollLeft=0:e.left<c?o.scrollLeft=Math.max(0,e.left+r-(i?0:10)):e.right>t+c-3&&(o.scrollLeft=e.right+(i?0:10)-t),o}function yn(t,e){null!=e&&(Cn(t),t.curOp.scrollTop=(null==t.curOp.scrollTop?t.doc:t.curOp).scrollTop+e)}function _n(t){Cn(t);var e=t.getCursor();t.curOp.scrollToPos={from:e,to:e,margin:t.options.cursorScrollMargin}}function xn(t,e,i){null==e&&null==i||Cn(t),null!=e&&(t.curOp.scrollLeft=e),null!=i&&(t.curOp.scrollTop=i)}function Cn(t){var e=t.curOp.scrollToPos;e&&(t.curOp.scrollToPos=null,wn(t,Pi(t,e.from),Pi(t,e.to),e.margin))}function wn(t,e,i,n){n=bn(t,{left:Math.min(e.left,i.left),top:Math.min(e.top,i.top)-n,right:Math.max(e.right,i.right),bottom:Math.max(e.bottom,i.bottom)+n});xn(t,n.scrollLeft,n.scrollTop)}function kn(t,e){Math.abs(t.doc.scrollTop-e)<2||(u||Un(t,{top:e}),Tn(t,e,!0),u&&Un(t),Rn(t,100))}function Tn(t,e,i){e=Math.max(0,Math.min(t.display.scroller.scrollHeight-t.display.scroller.clientHeight,e)),t.display.scroller.scrollTop==e&&!i||(t.doc.scrollTop=e,t.display.scrollbars.setScrollTop(e),t.display.scroller.scrollTop!=e&&(t.display.scroller.scrollTop=e))}function Sn(t,e,i,n){e=Math.max(0,Math.min(e,t.display.scroller.scrollWidth-t.display.scroller.clientWidth)),(i?e==t.doc.scrollLeft:Math.abs(t.doc.scrollLeft-e)<2)&&!n||(t.doc.scrollLeft=e,Vn(t),t.display.scroller.scrollLeft!=e&&(t.display.scroller.scrollLeft=e),t.display.scrollbars.setScrollLeft(e))}function En(t){var e=t.display,i=e.gutters.offsetWidth,n=Math.round(t.doc.height+vi(t.display));return{clientHeight:e.scroller.clientHeight,viewHeight:e.wrapper.clientHeight,scrollWidth:e.scroller.scrollWidth,clientWidth:e.scroller.clientWidth,viewWidth:e.wrapper.clientWidth,barLeft:t.options.fixedGutter?i:0,docHeight:n,scrollHeight:n+yi(t)+e.barHeight,nativeBarWidth:e.nativeBarWidth,gutterWidth:i}}t=function(t,e,i){this.cm=i;var n=this.vert=E("div",[E("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),r=this.horiz=E("div",[E("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");n.tabIndex=r.tabIndex=-1,t(n),t(r),bt(n,"scroll",function(){n.clientHeight&&e(n.scrollTop,"vertical")}),bt(r,"scroll",function(){r.clientWidth&&e(r.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,_&&v<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};t.prototype.update=function(t){var e,i=t.scrollWidth>t.clientWidth+1,n=t.scrollHeight>t.clientHeight+1,r=t.nativeBarWidth;return n?(this.vert.style.display="block",this.vert.style.bottom=i?r+"px":"0",e=t.viewHeight-(i?r:0),this.vert.firstChild.style.height=Math.max(0,t.scrollHeight-t.clientHeight+e)+"px"):(this.vert.style.display="",this.vert.firstChild.style.height="0"),i?(this.horiz.style.display="block",this.horiz.style.right=n?r+"px":"0",this.horiz.style.left=t.barLeft+"px",e=t.viewWidth-t.barLeft-(n?r:0),this.horiz.firstChild.style.width=Math.max(0,t.scrollWidth-t.clientWidth+e)+"px"):(this.horiz.style.display="",this.horiz.firstChild.style.width="0"),!this.checkedZeroWidth&&0<t.clientHeight&&(0==r&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:n?r:0,bottom:i?r:0}},t.prototype.setScrollLeft=function(t){this.horiz.scrollLeft!=t&&(this.horiz.scrollLeft=t),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},t.prototype.setScrollTop=function(t){this.vert.scrollTop!=t&&(this.vert.scrollTop=t),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},t.prototype.zeroWidthHack=function(){var t=g&&!o?"12px":"18px";this.horiz.style.height=this.vert.style.width=t,this.horiz.style.pointerEvents=this.vert.style.pointerEvents="none",this.disableHoriz=new B,this.disableVert=new B},t.prototype.enableZeroWidthBar=function(i,n,r){i.style.pointerEvents="auto",n.set(1e3,function t(){var e=i.getBoundingClientRect();("vert"==r?document.elementFromPoint(e.right-1,(e.top+e.bottom)/2):document.elementFromPoint((e.right+e.left)/2,e.bottom-1))!=i?i.style.pointerEvents="none":n.set(1e3,t)})},t.prototype.clear=function(){var t=this.horiz.parentNode;t.removeChild(this.horiz),t.removeChild(this.vert)};n=function(){};function Ln(t,e){e=e||En(t);var i=t.display.barWidth,n=t.display.barHeight;An(t,e);for(var r=0;r<4&&i!=t.display.barWidth||n!=t.display.barHeight;r++)i!=t.display.barWidth&&t.options.lineWrapping&&gn(t),An(t,En(t)),i=t.display.barWidth,n=t.display.barHeight}function An(t,e){var i=t.display,n=i.scrollbars.update(e);i.sizer.style.paddingRight=(i.barWidth=n.right)+"px",i.sizer.style.paddingBottom=(i.barHeight=n.bottom)+"px",i.heightForcer.style.borderBottom=n.bottom+"px solid transparent",n.right&&n.bottom?(i.scrollbarFiller.style.display="block",i.scrollbarFiller.style.height=n.bottom+"px",i.scrollbarFiller.style.width=n.right+"px"):i.scrollbarFiller.style.display="",n.bottom&&t.options.coverGutterNextToScrollbar&&t.options.fixedGutter?(i.gutterFiller.style.display="block",i.gutterFiller.style.height=n.bottom+"px",i.gutterFiller.style.width=e.gutterWidth+"px"):i.gutterFiller.style.display=""}n.prototype.update=function(){return{bottom:0,right:0}},n.prototype.setScrollLeft=function(){},n.prototype.setScrollTop=function(){},n.prototype.clear=function(){};var Nn={native:t,null:n};function $n(i){i.display.scrollbars&&(i.display.scrollbars.clear(),i.display.scrollbars.addClass&&k(i.display.wrapper,i.display.scrollbars.addClass)),i.display.scrollbars=new Nn[i.options.scrollbarStyle](function(t){i.display.wrapper.insertBefore(t,i.display.scrollbarFiller),bt(t,"mousedown",function(){i.state.focused&&setTimeout(function(){return i.display.input.focus()},0)}),t.setAttribute("cm-not-content","true")},function(t,e){("horizontal"==e?Sn:kn)(i,t)},i),i.display.scrollbars.addClass&&$(i.display.wrapper,i.display.scrollbars.addClass)}var Mn=0;function Dn(t){t.curOp={cm:t,viewChanged:!1,startHeight:t.doc.height,forceUpdate:!1,updateInput:0,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++Mn,markArrays:null},t=t.curOp,ii?ii.ops.push(t):t.ownsGroup=ii={ops:[t],delayedCallbacks:[]}}function In(t){t=t.curOp;t&&ni(t,function(o){for(var t=0;t<o.ops.length;t++)o.ops[t].cm.curOp=null;!function(){for(var t=o.ops,e=0;e<t.length;e++)!function(t){var e=t.cm,i=e.display;(function(t){var e=t.display;!e.scrollbarsClipped&&e.scroller.offsetWidth&&(e.nativeBarWidth=e.scroller.offsetWidth-e.scroller.clientWidth,e.heightForcer.style.height=yi(t)+"px",e.sizer.style.marginBottom=-e.nativeBarWidth+"px",e.sizer.style.borderRightWidth=yi(t)+"px",e.scrollbarsClipped=!0)})(e),t.updateMaxLine&&Ke(e),t.mustUpdate=t.viewChanged||t.forceUpdate||null!=t.scrollTop||t.scrollToPos&&(t.scrollToPos.from.line<i.viewFrom||t.scrollToPos.to.line>=i.viewTo)||i.maxLineChanged&&e.options.lineWrapping,t.update=t.mustUpdate&&new Wn(e,t.mustUpdate&&{top:t.scrollTop,ensure:t.scrollToPos},t.forceUpdate)}(t[e]);for(var i=0;i<t.length;i++)!function(t){t.updatedDisplay=t.mustUpdate&&zn(t.cm,t.update)}(t[i]);for(var n=0;n<t.length;n++)!function(t){var e=t.cm,i=e.display;t.updatedDisplay&&gn(e),t.barMeasure=En(e),i.maxLineChanged&&!e.options.lineWrapping&&(t.adjustWidthTo=wi(e,i.maxLine,i.maxLine.text.length).left+3,e.display.sizerWidth=t.adjustWidthTo,t.barMeasure.scrollWidth=Math.max(i.scroller.clientWidth,i.sizer.offsetLeft+t.adjustWidthTo+yi(e)+e.display.barWidth),t.maxScrollLeft=Math.max(0,i.sizer.offsetLeft+t.adjustWidthTo-_i(e))),(t.updatedDisplay||t.selectionChanged)&&(t.preparedSelection=i.input.prepareSelection())}(t[n]);for(var r=0;r<t.length;r++)!function(t){var e=t.cm;null!=t.adjustWidthTo&&(e.display.sizer.style.minWidth=t.adjustWidthTo+"px",t.maxScrollLeft<e.doc.scrollLeft&&Sn(e,Math.min(e.display.scroller.scrollLeft,t.maxScrollLeft),!0),e.display.maxLineChanged=!1);var i=t.focus&&t.focus==N();t.preparedSelection&&e.display.input.showSelection(t.preparedSelection,i),!t.updatedDisplay&&t.startHeight==e.doc.height||Ln(e,t.barMeasure),t.updatedDisplay&&qn(e,t.barMeasure),t.selectionChanged&&hn(e),e.state.focused&&t.updateInput&&e.display.input.reset(t.typing),i&&dn(t.cm)}(t[r]);for(var s=0;s<t.length;s++)!function(t){var e,i=t.cm,n=i.display,r=i.doc;t.updatedDisplay&&jn(i,t.update),null==n.wheelStartX||null==t.scrollTop&&null==t.scrollLeft&&!t.scrollToPos||(n.wheelStartX=n.wheelStartY=null),null!=t.scrollTop&&Tn(i,t.scrollTop,t.forceScroll),null!=t.scrollLeft&&Sn(i,t.scrollLeft,!0,!0),t.scrollToPos&&(e=function(t,e,i,n){null==n&&(n=0),t.options.lineWrapping||e!=i||(i="before"==e.sticky?ne(e.line,e.ch+1,"before"):e,e=e.ch?ne(e.line,"before"==e.sticky?e.ch-1:e.ch,"after"):e);for(var r=0;r<5;r++){var s,o=!1,a=Ri(t,e),l=i&&i!=e?Ri(t,i):a,c=bn(t,s={left:Math.min(a.left,l.left),top:Math.min(a.top,l.top)-n,right:Math.max(a.left,l.left),bottom:Math.max(a.bottom,l.bottom)+n}),a=t.doc.scrollTop,l=t.doc.scrollLeft;if(null!=c.scrollTop&&(kn(t,c.scrollTop),1<Math.abs(t.doc.scrollTop-a)&&(o=!0)),null!=c.scrollLeft&&(Sn(t,c.scrollLeft),1<Math.abs(t.doc.scrollLeft-l)&&(o=!0)),!o)break}return s}(i,he(r,t.scrollToPos.from),he(r,t.scrollToPos.to),t.scrollToPos.margin),function(t,e){var i,n,r;Ct(t,"scrollCursorIntoView")||(n=(i=t.display).sizer.getBoundingClientRect(),r=null,e.top+n.top<0?r=!0:e.bottom+n.top>(window.innerHeight||document.documentElement.clientHeight)&&(r=!1),null==r||c||(e=E("div","​",null,"position: absolute;\n                         top: "+(e.top-i.viewOffset-mi(t.display))+"px;\n                         height: "+(e.bottom-e.top+yi(t)+i.barHeight)+"px;\n                         left: "+e.left+"px; width: "+Math.max(2,e.right-e.left)+"px;"),t.display.lineSpace.appendChild(e),e.scrollIntoView(r),t.display.lineSpace.removeChild(e)))}(i,e));var s=t.maybeHiddenMarkers,o=t.maybeUnhiddenMarkers;if(s)for(var a=0;a<s.length;++a)s[a].lines.length||xt(s[a],"hide");if(o)for(var l=0;l<o.length;++l)o[l].lines.length&&xt(o[l],"unhide");n.wrapper.offsetHeight&&(r.scrollTop=i.display.scroller.scrollTop),t.changeObjs&&xt(i,"changes",i,t.changeObjs),t.update&&t.update.finish()}(t[s])}()})}function Fn(t,e){if(t.curOp)return e();Dn(t);try{return e()}finally{In(t)}}function On(t,e){return function(){if(t.curOp)return e.apply(t,arguments);Dn(t);try{return e.apply(t,arguments)}finally{In(t)}}}function Bn(t){return function(){if(this.curOp)return t.apply(this,arguments);Dn(this);try{return t.apply(this,arguments)}finally{In(this)}}}function Hn(e){return function(){var t=this.cm;if(!t||t.curOp)return e.apply(this,arguments);Dn(t);try{return e.apply(this,arguments)}finally{In(t)}}}function Rn(t,e){t.doc.highlightFrontier<t.display.viewTo&&t.state.highlight.set(e,I(Pn,t))}function Pn(o){var a,l,c,h=o.doc;h.highlightFrontier>=o.display.viewTo||(a=+new Date+o.options.workTime,l=me(o,h.highlightFrontier),c=[],h.iter(l.line,Math.min(h.first+h.size,o.display.viewTo+500),function(t){if(l.line>=o.display.viewFrom){var e=t.styles,i=t.text.length>o.options.maxHighlightLength?Kt(h.mode,l.state):null,n=fe(o,t,l,!0);i&&(l.state=i),t.styles=n.styles;i=t.styleClasses,n=n.classes;n?t.styleClasses=n:i&&(t.styleClasses=null);for(var r=!e||e.length!=t.styles.length||i!=n&&(!i||!n||i.bgClass!=n.bgClass||i.textClass!=n.textClass),s=0;!r&&s<e.length;++s)r=e[s]!=t.styles[s];r&&c.push(l.line),t.stateAfter=l.save(),l.nextLine()}else t.text.length<=o.options.maxHighlightLength&&ve(o,t.text,l),t.stateAfter=l.line%5==0?l.save():null,l.nextLine();if(+new Date>a)return Rn(o,o.options.workDelay),!0}),h.highlightFrontier=l.line,h.modeFrontier=Math.max(h.modeFrontier,l.line),c.length&&Fn(o,function(){for(var t=0;t<c.length;t++)en(o,c[t],"text")}))}var Wn=function(t,e,i){var n=t.display;this.viewport=e,this.visible=vn(n,t.doc,e),this.editorIsHidden=!n.wrapper.offsetWidth,this.wrapperHeight=n.wrapper.clientHeight,this.wrapperWidth=n.wrapper.clientWidth,this.oldDisplayWidth=_i(t),this.force=i,this.dims=Gi(t),this.events=[]};function zn(t,e){var i=t.display,n=t.doc;if(e.editorIsHidden)return nn(t),!1;if(!e.force&&e.visible.from>=i.viewFrom&&e.visible.to<=i.viewTo&&(null==i.updateLineNumbers||i.updateLineNumbers>=i.viewTo)&&i.renderedView==i.view&&0==sn(t))return!1;Gn(t)&&(nn(t),e.dims=Gi(t));var r=n.first+n.size,s=Math.max(e.visible.from-t.options.viewportMargin,n.first),o=Math.min(r,e.visible.to+t.options.viewportMargin);i.viewFrom<s&&s-i.viewFrom<20&&(s=Math.max(n.first,i.viewFrom)),i.viewTo>o&&i.viewTo-o<20&&(o=Math.min(r,i.viewTo)),Te&&(s=Pe(t.doc,s),o=We(t.doc,o));var a=s!=i.viewFrom||o!=i.viewTo||i.lastWrapHeight!=e.wrapperHeight||i.lastWrapWidth!=e.wrapperWidth;n=s,r=o,0==(o=(s=t).display).view.length||n>=o.viewTo||r<=o.viewFrom?(o.view=ei(s,n,r),o.viewFrom=n):(o.viewFrom>n?o.view=ei(s,n,o.viewFrom).concat(o.view):o.viewFrom<n&&(o.view=o.view.slice(Ji(s,n))),o.viewFrom=n,o.viewTo<r?o.view=o.view.concat(ei(s,o.viewTo,r)):o.viewTo>r&&(o.view=o.view.slice(0,Ji(s,r)))),o.viewTo=r,i.viewOffset=je(Xt(t.doc,i.viewFrom)),t.display.mover.style.top=i.viewOffset+"px";s=sn(t);if(!a&&0==s&&!e.force&&i.renderedView==i.view&&(null==i.updateLineNumbers||i.updateLineNumbers>=i.viewTo))return!1;o=function(t){if(t.hasFocus())return null;var e=N();if(!e||!A(t.display.lineDiv,e))return null;var i={activeElt:e};return!window.getSelection||(e=window.getSelection()).anchorNode&&e.extend&&A(t.display.lineDiv,e.anchorNode)&&(i.anchorNode=e.anchorNode,i.anchorOffset=e.anchorOffset,i.focusNode=e.focusNode,i.focusOffset=e.focusOffset),i}(t);return 4<s&&(i.lineDiv.style.display="none"),function(i,t,e){var n=i.display,r=i.options.lineNumbers,s=n.lineDiv,o=s.firstChild;function a(t){var e=t.nextSibling;return p&&g&&i.display.currentWheelTarget==t?t.style.display="none":t.parentNode.removeChild(t),e}for(var l=n.view,c=n.viewFrom,h=0;h<l.length;h++){var d=l[h];if(!d.hidden)if(d.node&&d.node.parentNode==s){for(;o!=d.node;)o=a(o);var u=r&&null!=t&&t<=c&&d.lineNumber;d.changes&&(-1<H(d.changes,"gutter")&&(u=!1),ai(i,d,c,e)),u&&(T(d.lineNumber),d.lineNumber.appendChild(document.createTextNode(ie(i.options,c)))),o=d.node.nextSibling}else{u=function(t,e,i,n){var r=ci(t,e);return e.text=e.node=r.pre,r.bgClass&&(e.bgClass=r.bgClass),r.textClass&&(e.textClass=r.textClass),hi(t,e),di(t,e,i,n),ui(t,e,n),e.node}(i,d,c,e);s.insertBefore(u,o)}c+=d.size}for(;o;)o=a(o)}(t,i.updateLineNumbers,e.dims),4<s&&(i.lineDiv.style.display=""),i.renderedView=i.view,(r=o)&&r.activeElt&&r.activeElt!=N()&&(r.activeElt.focus(),!/^(INPUT|TEXTAREA)$/.test(r.activeElt.nodeName)&&r.anchorNode&&A(document.body,r.anchorNode)&&A(document.body,r.focusNode)&&(s=window.getSelection(),(o=document.createRange()).setEnd(r.anchorNode,r.anchorOffset),o.collapse(!1),s.removeAllRanges(),s.addRange(o),s.extend(r.focusNode,r.focusOffset))),T(i.cursorDiv),T(i.selectionDiv),i.gutters.style.height=i.sizer.style.minHeight=0,a&&(i.lastWrapHeight=e.wrapperHeight,i.lastWrapWidth=e.wrapperWidth,Rn(t,400)),!(i.updateLineNumbers=null)}function jn(t,e){for(var i=e.viewport,n=!0;;n=!1){if(n&&t.options.lineWrapping&&e.oldDisplayWidth!=_i(t))n&&(e.visible=vn(t.display,t.doc,i));else if(i&&null!=i.top&&(i={top:Math.min(t.doc.height+vi(t.display)-xi(t),i.top)}),e.visible=vn(t.display,t.doc,i),e.visible.from>=t.display.viewFrom&&e.visible.to<=t.display.viewTo)break;if(!zn(t,e))break;gn(t);var r=En(t);on(t),Ln(t,r),qn(t,r),e.force=!1}e.signal(t,"update",t),t.display.viewFrom==t.display.reportedViewFrom&&t.display.viewTo==t.display.reportedViewTo||(e.signal(t,"viewportChange",t,t.display.viewFrom,t.display.viewTo),t.display.reportedViewFrom=t.display.viewFrom,t.display.reportedViewTo=t.display.viewTo)}function Un(t,e){var i=new Wn(t,e);zn(t,i)&&(gn(t),jn(t,i),e=En(t),on(t),Ln(t,e),qn(t,e),i.finish())}function Kn(t){var e=t.gutters.offsetWidth;t.sizer.style.marginLeft=e+"px",si(t,"gutterChanged",t)}function qn(t,e){t.display.sizer.style.minHeight=e.docHeight+"px",t.display.heightForcer.style.top=e.docHeight+"px",t.display.gutters.style.height=e.docHeight+t.display.barHeight+yi(t)+"px"}function Vn(t){var e=t.display,i=e.view;if(e.alignWidgets||e.gutters.firstChild&&t.options.fixedGutter){for(var n=Xi(e)-e.scroller.scrollLeft+t.doc.scrollLeft,r=e.gutters.offsetWidth,s=n+"px",o=0;o<i.length;o++)if(!i[o].hidden){t.options.fixedGutter&&(i[o].gutter&&(i[o].gutter.style.left=s),i[o].gutterBackground&&(i[o].gutterBackground.style.left=s));var a=i[o].alignable;if(a)for(var l=0;l<a.length;l++)a[l].style.left=s}t.options.fixedGutter&&(e.gutters.style.left=n+r+"px")}}function Gn(t){if(t.options.lineNumbers){var e=t.doc,i=ie(t.options,e.first+e.size-1),n=t.display;if(i.length!=n.lineNumChars){var r=n.measure.appendChild(E("div",[E("div",i)],"CodeMirror-linenumber CodeMirror-gutter-elt")),e=r.firstChild.offsetWidth,r=r.offsetWidth-e;return n.lineGutter.style.width="",n.lineNumInnerWidth=Math.max(e,n.lineGutter.offsetWidth-r)+1,n.lineNumWidth=n.lineNumInnerWidth+r,n.lineNumChars=n.lineNumInnerWidth?i.length:-1,n.lineGutter.style.width=n.lineNumWidth+"px",Kn(t.display),1}}}function Xn(t,e){for(var i=[],n=!1,r=0;r<t.length;r++){var s=t[r],o=null;if("string"!=typeof s&&(o=s.style,s=s.className),"CodeMirror-linenumbers"==s){if(!e)continue;n=!0}i.push({className:s,style:o})}return e&&!n&&i.push({className:"CodeMirror-linenumbers",style:null}),i}function Yn(t){var e=t.gutters,i=t.gutterSpecs;T(e),t.lineGutter=null;for(var n=0;n<i.length;++n){var r=i[n],s=r.className,o=r.style,r=e.appendChild(E("div",null,"CodeMirror-gutter "+s));o&&(r.style.cssText=o),"CodeMirror-linenumbers"==s&&((t.lineGutter=r).style.width=(t.lineNumWidth||1)+"px")}e.style.display=i.length?"":"none",Kn(t)}function Qn(t){Yn(t.display),tn(t),Vn(t)}function Zn(t,e,i,n){var r=this;this.input=i,r.scrollbarFiller=E("div",null,"CodeMirror-scrollbar-filler"),r.scrollbarFiller.setAttribute("cm-not-content","true"),r.gutterFiller=E("div",null,"CodeMirror-gutter-filler"),r.gutterFiller.setAttribute("cm-not-content","true"),r.lineDiv=L("div",null,"CodeMirror-code"),r.selectionDiv=E("div",null,null,"position: relative; z-index: 1"),r.cursorDiv=E("div",null,"CodeMirror-cursors"),r.measure=E("div",null,"CodeMirror-measure"),r.lineMeasure=E("div",null,"CodeMirror-measure"),r.lineSpace=L("div",[r.measure,r.lineMeasure,r.selectionDiv,r.cursorDiv,r.lineDiv],null,"position: relative; outline: none");var s=L("div",[r.lineSpace],"CodeMirror-lines");r.mover=E("div",[s],null,"position: relative"),r.sizer=E("div",[r.mover],"CodeMirror-sizer"),r.sizerWidth=null,r.heightForcer=E("div",null,null,"position: absolute; height: "+R+"px; width: 1px;"),r.gutters=E("div",null,"CodeMirror-gutters"),r.lineGutter=null,r.scroller=E("div",[r.sizer,r.heightForcer,r.gutters],"CodeMirror-scroll"),r.scroller.setAttribute("tabIndex","-1"),r.wrapper=E("div",[r.scrollbarFiller,r.gutterFiller,r.scroller],"CodeMirror"),r.wrapper.setAttribute("translate","no"),_&&v<8&&(r.gutters.style.zIndex=-1,r.scroller.style.paddingRight=0),p||u&&d||(r.scroller.draggable=!0),t&&(t.appendChild?t.appendChild(r.wrapper):t(r.wrapper)),r.viewFrom=r.viewTo=e.first,r.reportedViewFrom=r.reportedViewTo=e.first,r.view=[],r.renderedView=null,r.externalMeasured=null,r.viewOffset=0,r.lastWrapHeight=r.lastWrapWidth=0,r.updateLineNumbers=null,r.nativeBarWidth=r.barHeight=r.barWidth=0,r.scrollbarsClipped=!1,r.lineNumWidth=r.lineNumInnerWidth=r.lineNumChars=null,r.alignWidgets=!1,r.cachedCharWidth=r.cachedTextHeight=r.cachedPaddingH=null,r.maxLine=null,r.maxLineLength=0,r.maxLineChanged=!1,r.wheelDX=r.wheelDY=r.wheelStartX=r.wheelStartY=null,r.shift=!1,r.selForContextMenu=null,r.activeTouch=null,r.gutterSpecs=Xn(n.gutters,n.lineNumbers),Yn(r),i.init(r)}Wn.prototype.signal=function(t,e){kt(t,e)&&this.events.push(arguments)},Wn.prototype.finish=function(){for(var t=0;t<this.events.length;t++)xt.apply(null,this.events[t])};var Jn=0,tr=null;function er(t){var e=t.wheelDeltaX,i=t.wheelDeltaY;return null==e&&t.detail&&t.axis==t.HORIZONTAL_AXIS&&(e=t.detail),null==i&&t.detail&&t.axis==t.VERTICAL_AXIS?i=t.detail:null==i&&(i=t.wheelDelta),{x:e,y:i}}function ir(t){t=er(t);return t.x*=tr,t.y*=tr,t}function nr(t,e){var i=er(e),n=i.x,r=i.y,s=tr;0===e.deltaMode&&(n=e.deltaX,r=e.deltaY,s=1);var o=t.display,a=o.scroller,l=a.scrollWidth>a.clientWidth,i=a.scrollHeight>a.clientHeight;if(n&&l||r&&i){if(r&&g&&p)t:for(var c=e.target,h=o.view;c!=a;c=c.parentNode)for(var d=0;d<h.length;d++)if(h[d].node==c){t.display.currentWheelTarget=c;break t}if(n&&!u&&!f&&null!=s)return r&&i&&kn(t,Math.max(0,a.scrollTop+r*s)),Sn(t,Math.max(0,a.scrollLeft+n*s)),(!r||r&&i)&&St(e),void(o.wheelStartX=null);r&&null!=s&&(l=r*s,s=(i=t.doc.scrollTop)+o.wrapper.clientHeight,l<0?i=Math.max(0,i+l-50):s=Math.min(t.doc.height,s+l+50),Un(t,{top:i,bottom:s})),Jn<20&&0!==e.deltaMode&&(null==o.wheelStartX?(o.wheelStartX=a.scrollLeft,o.wheelStartY=a.scrollTop,o.wheelDX=n,o.wheelDY=r,setTimeout(function(){var t,e;null!=o.wheelStartX&&(e=a.scrollLeft-o.wheelStartX,e=(t=a.scrollTop-o.wheelStartY)&&o.wheelDY&&t/o.wheelDY||e&&o.wheelDX&&e/o.wheelDX,o.wheelStartX=o.wheelStartY=null,e&&(tr=(tr*Jn+e)/(Jn+1),++Jn))},200)):(o.wheelDX+=n,o.wheelDY+=r))}}_?tr=-.53:u?tr=15:s?tr=-.7:h&&(tr=-1/3);var rr=function(t,e){this.ranges=t,this.primIndex=e};rr.prototype.primary=function(){return this.ranges[this.primIndex]},rr.prototype.equals=function(t){if(t==this)return!0;if(t.primIndex!=this.primIndex||t.ranges.length!=this.ranges.length)return!1;for(var e=0;e<this.ranges.length;e++){var i=this.ranges[e],n=t.ranges[e];if(!se(i.anchor,n.anchor)||!se(i.head,n.head))return!1}return!0},rr.prototype.deepCopy=function(){for(var t=[],e=0;e<this.ranges.length;e++)t[e]=new sr(oe(this.ranges[e].anchor),oe(this.ranges[e].head));return new rr(t,this.primIndex)},rr.prototype.somethingSelected=function(){for(var t=0;t<this.ranges.length;t++)if(!this.ranges[t].empty())return!0;return!1},rr.prototype.contains=function(t,e){e=e||t;for(var i=0;i<this.ranges.length;i++){var n=this.ranges[i];if(0<=re(e,n.from())&&re(t,n.to())<=0)return i}return-1};var sr=function(t,e){this.anchor=t,this.head=e};function or(t,e,i){var n=t&&t.options.selectionsMayTouch,t=e[i];e.sort(function(t,e){return re(t.from(),e.from())}),i=H(e,t);for(var r=1;r<e.length;r++){var s,o=e[r],a=e[r-1],l=re(a.to(),o.from());(n&&!o.empty()?0<l:0<=l)&&(s=le(a.from(),o.from()),l=ae(a.to(),o.to()),a=a.empty()?o.from()==o.head:a.from()==a.head,r<=i&&--i,e.splice(--r,2,new sr(a?l:s,a?s:l)))}return new rr(e,i)}function ar(t,e){return new rr([new sr(t,e||t)],0)}function lr(t){return t.text?ne(t.from.line+t.text.length-1,V(t.text).length+(1==t.text.length?t.from.ch:0)):t.to}function cr(t,e){if(re(t,e.from)<0)return t;if(re(t,e.to)<=0)return lr(e);var i=t.line+e.text.length-(e.to.line-e.from.line)-1,n=t.ch;return t.line==e.to.line&&(n+=lr(e).ch-e.to.ch),ne(i,n)}function hr(t,e){for(var i=[],n=0;n<t.sel.ranges.length;n++){var r=t.sel.ranges[n];i.push(new sr(cr(r.anchor,e),cr(r.head,e)))}return or(t.cm,i,t.sel.primIndex)}function dr(t,e,i){return t.line==e.line?ne(i.line,t.ch-e.ch+i.ch):ne(i.line+(t.line-e.line),t.ch)}function ur(t){t.doc.mode=zt(t.options,t.doc.modeOption),pr(t)}function pr(t){t.doc.iter(function(t){t.stateAfter&&(t.stateAfter=null),t.styles&&(t.styles=null)}),t.doc.modeFrontier=t.doc.highlightFrontier=t.doc.first,Rn(t,100),t.state.modeGen++,t.curOp&&tn(t)}function fr(t,e){return 0==e.from.ch&&0==e.to.ch&&""==V(e.text)&&(!t.cm||t.cm.options.wholeLineUpdateBefore)}function gr(t,s,e,o){function r(t){return e?e[t]:null}function i(t,e,i){var n,r;n=e,r=i,e=o,(i=t).text=n,i.stateAfter&&(i.stateAfter=null),i.styles&&(i.styles=null),null!=i.order&&(i.order=null),Ne(i),$e(i,r),(e=e?e(i):1)!=i.height&&Zt(i,e),si(t,"change",t,s)}function n(t,e){for(var i=[],n=t;n<e;++n)i.push(new qe(h[n],r(n),o));return i}var a,l=s.from,c=s.to,h=s.text,d=Xt(t,l.line),u=Xt(t,c.line),p=V(h),f=r(h.length-1),g=c.line-l.line;s.full?(t.insert(0,n(0,h.length)),t.remove(h.length,t.size-h.length)):fr(t,s)?(a=n(0,h.length-1),i(u,u.text,f),g&&t.remove(l.line,g),a.length&&t.insert(l.line,a)):d==u?1==h.length?i(d,d.text.slice(0,l.ch)+p+d.text.slice(c.ch),f):((a=n(1,h.length-1)).push(new qe(p+d.text.slice(c.ch),f,o)),i(d,d.text.slice(0,l.ch)+h[0],r(0)),t.insert(l.line+1,a)):1==h.length?(i(d,d.text.slice(0,l.ch)+h[0]+u.text.slice(c.ch),r(0)),t.remove(l.line+1,g)):(i(d,d.text.slice(0,l.ch)+h[0],r(0)),i(u,p+u.text.slice(c.ch),f),f=n(1,h.length-1),1<g&&t.remove(l.line+1,g-1),t.insert(l.line+1,f)),si(t,"change",t,s)}function mr(t,a,l){!function t(e,i,n){if(e.linked)for(var r=0;r<e.linked.length;++r){var s,o=e.linked[r];o.doc!=i&&(s=n&&o.sharedHist,l&&!s||(a(o.doc,s),t(o.doc,e,s)))}}(t,null,!0)}function vr(t,e){if(e.cm)throw new Error("This document is already in use.");Qi((t.doc=e).cm=t),ur(t),br(t),t.options.direction=e.direction,t.options.lineWrapping||Ke(t),t.options.mode=e.modeOption,tn(t)}function br(t){("rtl"==t.doc.direction?$:k)(t.display.lineDiv,"CodeMirror-rtl")}function yr(t){this.done=[],this.undone=[],this.undoDepth=t?t.undoDepth:1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=t?t.maxGeneration:1}function _r(t,e){var i={from:oe(e.from),to:lr(e),text:Yt(t,e.from,e.to)};return Tr(t,i,e.from.line,e.to.line+1),mr(t,function(t){return Tr(t,i,e.from.line,e.to.line+1),0},!0),i}function xr(t){for(;t.length;){if(!V(t).ranges)break;t.pop()}}function Cr(t,e,i,n){var r=t.history;r.undone.length=0;var s,o,a=+new Date;if((r.lastOp==n||r.lastOrigin==e.origin&&e.origin&&("+"==e.origin.charAt(0)&&r.lastModTime>a-(t.cm?t.cm.options.historyEventDelay:500)||"*"==e.origin.charAt(0)))&&(s=(l=r).lastOp==n?(xr(l.done),V(l.done)):l.done.length&&!V(l.done).ranges?V(l.done):1<l.done.length&&!l.done[l.done.length-2].ranges?(l.done.pop(),V(l.done)):void 0))o=V(s.changes),0==re(e.from,e.to)&&0==re(e.from,o.to)?o.to=lr(e):s.changes.push(_r(t,e));else{var l=V(r.done);for(l&&l.ranges||kr(t.sel,r.done),s={changes:[_r(t,e)],generation:r.generation},r.done.push(s);r.done.length>r.undoDepth;)r.done.shift(),r.done[0].ranges||r.done.shift()}r.done.push(i),r.generation=++r.maxGeneration,r.lastModTime=r.lastSelTime=a,r.lastOp=r.lastSelOp=n,r.lastOrigin=r.lastSelOrigin=e.origin,o||xt(t,"historyAdded")}function wr(t,e,i,n){var r,s,o,a=t.history,l=n&&n.origin;i==a.lastSelOp||l&&a.lastSelOrigin==l&&(a.lastModTime==a.lastSelTime&&a.lastOrigin==l||(r=t,s=l,o=V(a.done),t=e,"*"==(s=s.charAt(0))||"+"==s&&o.ranges.length==t.ranges.length&&o.somethingSelected()==t.somethingSelected()&&new Date-r.history.lastSelTime<=(r.cm?r.cm.options.historyEventDelay:500)))?a.done[a.done.length-1]=e:kr(e,a.done),a.lastSelTime=+new Date,a.lastSelOrigin=l,a.lastSelOp=i,n&&!1!==n.clearRedo&&xr(a.undone)}function kr(t,e){var i=V(e);i&&i.ranges&&i.equals(t)||e.push(t)}function Tr(e,i,t,n){var r=i["spans_"+e.id],s=0;e.iter(Math.max(e.first,t),Math.min(e.first+e.size,n),function(t){t.markedSpans&&((r=r||(i["spans_"+e.id]={}))[s]=t.markedSpans),++s})}function Sr(t,e){var i=e["spans_"+t.id];if(!i)return null;for(var n=[],r=0;r<e.text.length;++r)n.push(function(t){if(!t)return null;for(var e,i=0;i<t.length;++i)t[i].marker.explicitlyCleared?e=e||t.slice(0,i):e&&e.push(t[i]);return e?e.length?e:null:t}(i[r]));return n}function Er(t,e){var i=Sr(t,e),n=Le(t,e);if(!i)return n;if(!n)return i;for(var r=0;r<i.length;++r){var s=i[r],o=n[r];if(s&&o)t:for(var a=0;a<o.length;++a){for(var l=o[a],c=0;c<s.length;++c)if(s[c].marker==l.marker)continue t;s.push(l)}else o&&(i[r]=o)}return i}function Lr(t,e,i){for(var n=[],r=0;r<t.length;++r){var s=t[r];if(s.ranges)n.push(i?rr.prototype.deepCopy.call(s):s);else{var o=s.changes,a=[];n.push({changes:a});for(var l=0;l<o.length;++l){var c,h=o[l];if(a.push({from:h.from,to:h.to,text:h.text}),e)for(var d in h)(c=d.match(/^spans_(\d+)$/))&&-1<H(e,Number(c[1]))&&(V(a)[d]=h[d],delete h[d])}}}return n}function Ar(t,e,i,n){if(n){n=t.anchor;return i&&((t=re(e,n)<0)!=re(i,n)<0?(n=e,e=i):t!=re(e,i)<0&&(e=i)),new sr(n,e)}return new sr(i||e,e)}function Nr(t,e,i,n,r){null==r&&(r=t.cm&&(t.cm.display.shift||t.extend)),Fr(t,new rr([Ar(t.sel.primary(),e,i,r)],0),n)}function $r(t,e,i){for(var n=[],r=t.cm&&(t.cm.display.shift||t.extend),s=0;s<t.sel.ranges.length;s++)n[s]=Ar(t.sel.ranges[s],e[s],null,r);Fr(t,or(t.cm,n,t.sel.primIndex),i)}function Mr(t,e,i,n){var r=t.sel.ranges.slice(0);r[e]=i,Fr(t,or(t.cm,r,t.sel.primIndex),n)}function Dr(t,e,i,n){Fr(t,ar(e,i),n)}function Ir(t,e,i){var n=t.history.done,r=V(n);r&&r.ranges?Or(t,n[n.length-1]=e,i):Fr(t,e,i)}function Fr(t,e,i){Or(t,e,i),wr(t,t.sel,t.cm?t.cm.curOp.id:NaN,i)}function Or(t,e,i){var n,r;(kt(t,"beforeSelectionChange")||t.cm&&kt(t.cm,"beforeSelectionChange"))&&(n=t,r=i,r={ranges:(s=e).ranges,update:function(t){this.ranges=[];for(var e=0;e<t.length;e++)this.ranges[e]=new sr(he(n,t[e].anchor),he(n,t[e].head))},origin:r&&r.origin},xt(n,"beforeSelectionChange",n,r),n.cm&&xt(n.cm,"beforeSelectionChange",n.cm,r),e=r.ranges!=s.ranges?or(n.cm,r.ranges,r.ranges.length-1):s);var s=i&&i.bias||(re(e.primary().head,t.sel.primary().head)<0?-1:1);Br(t,Rr(t,e,s,!0)),i&&!1===i.scroll||!t.cm||"nocursor"==t.cm.getOption("readOnly")||_n(t.cm)}function Br(t,e){e.equals(t.sel)||(t.sel=e,t.cm&&(t.cm.curOp.updateInput=1,t.cm.curOp.selectionChanged=!0,wt(t.cm)),si(t,"cursorActivity",t))}function Hr(t){Br(t,Rr(t,t.sel,null,!1))}function Rr(t,e,i,n){for(var r,s=0;s<e.ranges.length;s++){var o=e.ranges[s],a=e.ranges.length==t.sel.ranges.length&&t.sel.ranges[s],l=Wr(t,o.anchor,a&&a.anchor,i,n),a=Wr(t,o.head,a&&a.head,i,n);!r&&l==o.anchor&&a==o.head||((r=r||e.ranges.slice(0,s))[s]=new sr(l,a))}return r?or(t.cm,r,e.primIndex):e}function Pr(t,e,i,n,r){var s=Xt(t,e.line);if(s.markedSpans)for(var o=0;o<s.markedSpans.length;++o){var a=s.markedSpans[o],l=a.marker,c="selectLeft"in l?!l.selectLeft:l.inclusiveLeft,h="selectRight"in l?!l.selectRight:l.inclusiveRight;if((null==a.from||(c?a.from<=e.ch:a.from<e.ch))&&(null==a.to||(h?a.to>=e.ch:a.to>e.ch))){if(r&&(xt(l,"beforeCursorEnter"),l.explicitlyCleared)){if(s.markedSpans){--o;continue}break}if(l.atomic){if(i){var d=l.find(n<0?1:-1),a=void 0;if((n<0?h:c)&&(d=zr(t,d,-n,d&&d.line==e.line?s:null)),d&&d.line==e.line&&(a=re(d,i))&&(n<0?a<0:0<a))return Pr(t,d,e,n,r)}l=l.find(n<0?-1:1);return(n<0?c:h)&&(l=zr(t,l,n,l.line==e.line?s:null)),l?Pr(t,l,e,n,r):null}}}return e}function Wr(t,e,i,n,r){n=n||1,n=Pr(t,e,i,n,r)||!r&&Pr(t,e,i,n,!0)||Pr(t,e,i,-n,r)||!r&&Pr(t,e,i,-n,!0);return n||(t.cantEdit=!0,ne(t.first,0))}function zr(t,e,i,n){return i<0&&0==e.ch?e.line>t.first?he(t,ne(e.line-1)):null:0<i&&e.ch==(n||Xt(t,e.line)).text.length?e.line<t.first+t.size-1?ne(e.line+1,0):null:new ne(e.line,e.ch+i)}function jr(t){t.setSelection(ne(t.firstLine(),0),ne(t.lastLine()),W)}function Ur(r,t,e){var s={canceled:!1,from:t.from,to:t.to,text:t.text,origin:t.origin,cancel:function(){return s.canceled=!0}};return e&&(s.update=function(t,e,i,n){t&&(s.from=he(r,t)),e&&(s.to=he(r,e)),i&&(s.text=i),void 0!==n&&(s.origin=n)}),xt(r,"beforeChange",r,s),r.cm&&xt(r.cm,"beforeChange",r.cm,s),s.canceled?(r.cm&&(r.cm.curOp.updateInput=2),null):{from:s.from,to:s.to,text:s.text,origin:s.origin}}function Kr(t,e,i){if(t.cm){if(!t.cm.curOp)return On(t.cm,Kr)(t,e,i);if(t.cm.state.suppressEdits)return}if(!(kt(t,"beforeChange")||t.cm&&kt(t.cm,"beforeChange"))||(e=Ur(t,e,!0))){var n=ke&&!i&&function(t,e,i){var n=null;if(t.iter(e.line,i.line+1,function(t){if(t.markedSpans)for(var e=0;e<t.markedSpans.length;++e){var i=t.markedSpans[e].marker;!i.readOnly||n&&-1!=H(n,i)||(n=n||[]).push(i)}}),!n)return null;for(var r=[{from:e,to:i}],s=0;s<n.length;++s)for(var o=n[s],a=o.find(0),l=0;l<r.length;++l){var c,h,d,u=r[l];re(u.to,a.from)<0||0<re(u.from,a.to)||(c=[l,1],h=re(u.from,a.from),d=re(u.to,a.to),(h<0||!o.inclusiveLeft&&!h)&&c.push({from:u.from,to:a.from}),(0<d||!o.inclusiveRight&&!d)&&c.push({from:a.to,to:u.to}),r.splice.apply(r,c),l+=c.length-3)}return r}(t,e.from,e.to);if(n)for(var r=n.length-1;0<=r;--r)qr(t,{from:n[r].from,to:n[r].to,text:r?[""]:e.text,origin:e.origin});else qr(t,e)}}function qr(t,i){var e,n;1==i.text.length&&""==i.text[0]&&0==re(i.from,i.to)||(e=hr(t,i),Cr(t,i,e,t.cm?t.cm.curOp.id:NaN),Xr(t,i,e,Le(t,i)),n=[],mr(t,function(t,e){e||-1!=H(n,t.history)||(Jr(t.history,i),n.push(t.history)),Xr(t,i,null,Le(t,i))}))}function Vr(r,s,t){var e=r.cm&&r.cm.state.suppressEdits;if(!e||t){for(var o,i=r.history,n=r.sel,a="undo"==s?i.done:i.undone,l="undo"==s?i.undone:i.done,c=0;c<a.length&&(o=a[c],t?!o.ranges||o.equals(r.sel):o.ranges);c++);if(c!=a.length){for(i.lastOrigin=i.lastSelOrigin=null;;){if(!(o=a.pop()).ranges){if(e)return void a.push(o);break}if(kr(o,l),t&&!o.equals(r.sel))return void Fr(r,o,{clearRedo:!1});n=o}var h=[];kr(n,l),l.push({changes:h,generation:i.generation}),i.generation=o.generation||++i.maxGeneration;for(var d=kt(r,"beforeChange")||r.cm&&kt(r.cm,"beforeChange"),u=o.changes.length-1;0<=u;--u){var p=function(t){var i=o.changes[t];if(i.origin=s,d&&!Ur(r,i,!1))return a.length=0,{};h.push(_r(r,i));var e=t?hr(r,i):V(a);Xr(r,i,e,Er(r,i)),!t&&r.cm&&r.cm.scrollIntoView({from:i.from,to:lr(i)});var n=[];mr(r,function(t,e){e||-1!=H(n,t.history)||(Jr(t.history,i),n.push(t.history)),Xr(t,i,null,Er(t,i))})}(u);if(p)return p.v}}}}function Gr(t,e){if(0!=e&&(t.first+=e,t.sel=new rr(G(t.sel.ranges,function(t){return new sr(ne(t.anchor.line+e,t.anchor.ch),ne(t.head.line+e,t.head.ch))}),t.sel.primIndex),t.cm)){tn(t.cm,t.first,t.first-e,e);for(var i=t.cm.display,n=i.viewFrom;n<i.viewTo;n++)en(t.cm,n,"gutter")}}function Xr(t,e,i,n){if(t.cm&&!t.cm.curOp)return On(t.cm,Xr)(t,e,i,n);var r,s,o,a,l,c,h,d,u;e.to.line<t.first?Gr(t,e.text.length-1-(e.to.line-e.from.line)):e.from.line>t.lastLine()||(e.from.line<t.first&&(Gr(t,h=e.text.length-1-(t.first-e.from.line)),e={from:ne(t.first,0),to:ne(e.to.line+h,e.to.ch),text:[V(e.text)],origin:e.origin}),u=t.lastLine(),e.to.line>u&&(e={from:e.from,to:ne(u,Xt(t,u).text.length),text:[e.text[0]],origin:e.origin}),e.removed=Yt(t,e.from,e.to),i=i||hr(t,e),t.cm?(r=t.cm,s=e,o=n,a=r.doc,l=r.display,c=s.from,h=s.to,d=!1,u=c.line,r.options.lineWrapping||(u=Jt(Re(Xt(a,c.line))),a.iter(u,h.line+1,function(t){if(t==l.maxLine)return d=!0})),-1<a.sel.contains(s.from,s.to)&&wt(r),gr(a,s,o,Yi(r)),r.options.lineWrapping||(a.iter(u,c.line+s.text.length,function(t){var e=Ue(t);e>l.maxLineLength&&(l.maxLine=t,l.maxLineLength=e,l.maxLineChanged=!0,d=!1)}),d&&(r.curOp.updateMaxLine=!0)),function(t,e){if(t.modeFrontier=Math.min(t.modeFrontier,e),!(t.highlightFrontier<e-10)){for(var i=t.first,n=e-1;i<n;n--){var r=Xt(t,n).stateAfter;if(r&&(!(r instanceof ue)||n+r.lookAhead<e)){i=n+1;break}}t.highlightFrontier=Math.min(t.highlightFrontier,i)}}(a,c.line),Rn(r,400),u=s.text.length-(h.line-c.line)-1,s.full?tn(r):c.line!=h.line||1!=s.text.length||fr(r.doc,s)?tn(r,c.line,h.line+1,u):en(r,c.line,"text"),a=kt(r,"changes"),((u=kt(r,"change"))||a)&&(s={from:c,to:h,text:s.text,removed:s.removed,origin:s.origin},u&&si(r,"change",r,s),a&&(r.curOp.changeObjs||(r.curOp.changeObjs=[])).push(s)),r.display.selForContextMenu=null):gr(t,e,n),Or(t,i,W),t.cantEdit&&Wr(t,ne(t.firstLine(),0))&&(t.cantEdit=!1))}function Yr(t,e,i,n,r){var s;re(n=n||i,i)<0&&(i=(s=[n,i])[0],n=s[1]),"string"==typeof e&&(e=t.splitLines(e)),Kr(t,{from:i,to:n,text:e,origin:r})}function Qr(t,e,i,n){i<t.line?t.line+=n:e<t.line&&(t.line=e,t.ch=0)}function Zr(t,e,i,n){for(var r=0;r<t.length;++r){var s=t[r],o=!0;if(s.ranges){s.copied||((s=t[r]=s.deepCopy()).copied=!0);for(var a=0;a<s.ranges.length;a++)Qr(s.ranges[a].anchor,e,i,n),Qr(s.ranges[a].head,e,i,n)}else{for(var l=0;l<s.changes.length;++l){var c=s.changes[l];if(i<c.from.line)c.from=ne(c.from.line+n,c.from.ch),c.to=ne(c.to.line+n,c.to.ch);else if(e<=c.to.line){o=!1;break}}o||(t.splice(0,r+1),r=0)}}}function Jr(t,e){var i=e.from.line,n=e.to.line,e=e.text.length-(n-i)-1;Zr(t.done,i,n,e),Zr(t.undone,i,n,e)}function ts(t,e,i,n){var r=e,s=e;return"number"==typeof e?s=Xt(t,ce(t,e)):r=Jt(e),null==r?null:(n(s,r)&&t.cm&&en(t.cm,r,i),s)}function es(t){this.lines=t,this.parent=null;for(var e=0,i=0;i<t.length;++i)t[i].parent=this,e+=t[i].height;this.height=e}function is(t){this.children=t;for(var e=0,i=0,n=0;n<t.length;++n){var r=t[n];e+=r.chunkSize(),i+=r.height,r.parent=this}this.size=e,this.height=i,this.parent=null}sr.prototype.from=function(){return le(this.anchor,this.head)},sr.prototype.to=function(){return ae(this.anchor,this.head)},sr.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch},es.prototype={chunkSize:function(){return this.lines.length},removeInner:function(t,e){for(var i,n=t,r=t+e;n<r;++n){var s=this.lines[n];this.height-=s.height,(i=s).parent=null,Ne(i),si(s,"delete")}this.lines.splice(t,e)},collapse:function(t){t.push.apply(t,this.lines)},insertInner:function(t,e,i){this.height+=i,this.lines=this.lines.slice(0,t).concat(e).concat(this.lines.slice(t));for(var n=0;n<e.length;++n)e[n].parent=this},iterN:function(t,e,i){for(var n=t+e;t<n;++t)if(i(this.lines[t]))return!0}},is.prototype={chunkSize:function(){return this.size},removeInner:function(t,e){this.size-=e;for(var i,n=0;n<this.children.length;++n){var r=this.children[n],s=r.chunkSize();if(t<s){var o=Math.min(e,s-t),a=r.height;if(r.removeInner(t,o),this.height-=a-r.height,s==o&&(this.children.splice(n--,1),r.parent=null),0==(e-=o))break;t=0}else t-=s}this.size-e<25&&(1<this.children.length||!(this.children[0]instanceof es))&&(i=[],this.collapse(i),this.children=[new es(i)],this.children[0].parent=this)},collapse:function(t){for(var e=0;e<this.children.length;++e)this.children[e].collapse(t)},insertInner:function(t,e,i){this.size+=e.length,this.height+=i;for(var n=0;n<this.children.length;++n){var r=this.children[n],s=r.chunkSize();if(t<=s){if(r.insertInner(t,e,i),r.lines&&50<r.lines.length){for(var o=r.lines.length%25+25,a=o;a<r.lines.length;){var l=new es(r.lines.slice(a,a+=25));r.height-=l.height,this.children.splice(++n,0,l),l.parent=this}r.lines=r.lines.slice(0,o),this.maybeSpill()}break}t-=s}},maybeSpill:function(){if(!(this.children.length<=10)){var t=this;do{var e,i=new is(t.children.splice(t.children.length-5,5))}while(t.parent?(t.size-=i.size,t.height-=i.height,e=H(t.parent.children,t),t.parent.children.splice(e+1,0,i)):(((e=new is(t.children)).parent=t).children=[e,i],t=e),i.parent=t.parent,10<t.children.length);t.parent.maybeSpill()}},iterN:function(t,e,i){for(var n=0;n<this.children.length;++n){var r=this.children[n],s=r.chunkSize();if(t<s){var o=Math.min(e,s-t);if(r.iterN(t,o,i))return!0;if(0==(e-=o))break;t=0}else t-=s}}};function ns(t,e,i){if(i)for(var n in i)i.hasOwnProperty(n)&&(this[n]=i[n]);this.doc=t,this.node=e}function rs(t,e,i){je(e)<(t.curOp&&t.curOp.scrollTop||t.doc.scrollTop)&&yn(t,i)}ns.prototype.clear=function(){var t=this.doc.cm,e=this.line.widgets,i=this.line,n=Jt(i);if(null!=n&&e){for(var r=0;r<e.length;++r)e[r]==this&&e.splice(r--,1);e.length||(i.widgets=null);var s=fi(this);Zt(i,Math.max(0,i.height-s)),t&&(Fn(t,function(){rs(t,i,-s),en(t,n,"widget")}),si(t,"lineWidgetCleared",t,this,n))}},ns.prototype.changed=function(){var t=this,e=this.height,i=this.doc.cm,n=this.line;this.height=null;var r=fi(this)-e;r&&(ze(this.doc,n)||Zt(n,n.height+r),i&&Fn(i,function(){i.curOp.forceUpdate=!0,rs(i,n,r),si(i,"lineWidgetChanged",i,t,Jt(n))}))},Tt(ns);var ss=0,os=function(t,e){this.lines=[],this.type=e,this.doc=t,this.id=++ss};function as(n,r,s,t,e){if(t&&t.shared)return function(t,i,n,r,s){(r=F(r)).shared=!1;var o=[as(t,i,n,r,s)],a=o[0],l=r.widgetNode;return mr(t,function(t){l&&(r.widgetNode=l.cloneNode(!0)),o.push(as(t,he(t,i),he(t,n),r,s));for(var e=0;e<t.linked.length;++e)if(t.linked[e].isParent)return;a=V(o)}),new ls(o,a)}(n,r,s,t,e);if(n.cm&&!n.cm.curOp)return On(n.cm,as)(n,r,s,t,e);var o=new os(n,e),e=re(r,s);if(t&&F(t,o,!1),0<e||0==e&&!1!==o.clearWhenEmpty)return o;if(o.replacedWith&&(o.collapsed=!0,o.widgetNode=L("span",[o.replacedWith],"CodeMirror-widget"),t.handleMouseEvents||o.widgetNode.setAttribute("cm-ignore-events","true"),t.insertLeft&&(o.widgetNode.insertLeft=!0)),o.collapsed){if(He(n,r.line,r,s,o)||r.line!=s.line&&He(n,s.line,r,s,o))throw new Error("Inserting collapsed marker partially overlapping an existing one");Te=!0}o.addToHistory&&Cr(n,{from:r,to:s,origin:"markText"},n.sel,NaN);var a,l=r.line,c=n.cm;if(n.iter(l,s.line+1,function(t){var e,i;c&&o.collapsed&&!c.options.lineWrapping&&Re(t)==c.display.maxLine&&(a=!0),o.collapsed&&l!=r.line&&Zt(t,0),e=t,i=new Se(o,l==r.line?r.ch:null,l==s.line?s.ch:null),(t=(t=n.cm&&n.cm.curOp)&&window.WeakSet&&(t.markedSpans||(t.markedSpans=new WeakSet)))&&t.has(e.markedSpans)?e.markedSpans.push(i):(e.markedSpans=e.markedSpans?e.markedSpans.concat([i]):[i],t&&t.add(e.markedSpans)),i.marker.attachLine(e),++l}),o.collapsed&&n.iter(r.line,s.line+1,function(t){ze(n,t)&&Zt(t,0)}),o.clearOnEnter&&bt(o,"beforeCursorEnter",function(){return o.clear()}),o.readOnly&&(ke=!0,(n.history.done.length||n.history.undone.length)&&n.clearHistory()),o.collapsed&&(o.id=++ss,o.atomic=!0),c){if(a&&(c.curOp.updateMaxLine=!0),o.collapsed)tn(c,r.line,s.line+1);else if(o.className||o.startStyle||o.endStyle||o.css||o.attributes||o.title)for(var i=r.line;i<=s.line;i++)en(c,i,"text");o.atomic&&Hr(c.doc),si(c,"markerAdded",c,o)}return o}os.prototype.clear=function(){if(!this.explicitlyCleared){var t,e=this.doc.cm,i=e&&!e.curOp;i&&Dn(e),!kt(this,"clear")||(t=this.find())&&si(this,"clear",t.from,t.to);for(var n=null,r=null,s=0;s<this.lines.length;++s){var o=this.lines[s],a=Ee(o.markedSpans,this);e&&!this.collapsed?en(e,Jt(o),"text"):e&&(null!=a.to&&(r=Jt(o)),null!=a.from&&(n=Jt(o))),o.markedSpans=function(t,e){for(var i,n=0;n<t.length;++n)t[n]!=e&&(i=i||[]).push(t[n]);return i}(o.markedSpans,a),null==a.from&&this.collapsed&&!ze(this.doc,o)&&e&&Zt(o,qi(e.display))}if(e&&this.collapsed&&!e.options.lineWrapping)for(var l=0;l<this.lines.length;++l){var c=Re(this.lines[l]),h=Ue(c);h>e.display.maxLineLength&&(e.display.maxLine=c,e.display.maxLineLength=h,e.display.maxLineChanged=!0)}null!=n&&e&&this.collapsed&&tn(e,n,r+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,e&&Hr(e.doc)),e&&si(e,"markerCleared",e,this,n,r),i&&In(e),this.parent&&this.parent.clear()}},os.prototype.find=function(t,e){var i,n;null==t&&"bookmark"==this.type&&(t=1);for(var r=0;r<this.lines.length;++r){var s=this.lines[r],o=Ee(s.markedSpans,this);if(null!=o.from&&(i=ne(e?s:Jt(s),o.from),-1==t))return i;if(null!=o.to&&(n=ne(e?s:Jt(s),o.to),1==t))return n}return i&&{from:i,to:n}},os.prototype.changed=function(){var i=this,n=this.find(-1,!0),r=this,s=this.doc.cm;n&&s&&Fn(s,function(){var t=n.line,e=Jt(n.line),e=ki(s,e);e&&(Ni(e),s.curOp.selectionChanged=s.curOp.forceUpdate=!0),s.curOp.updateMaxLine=!0,ze(r.doc,t)||null==r.height||(e=r.height,r.height=null,(e=fi(r)-e)&&Zt(t,t.height+e)),si(s,"markerChanged",s,i)})},os.prototype.attachLine=function(t){var e;!this.lines.length&&this.doc.cm&&((e=this.doc.cm.curOp).maybeHiddenMarkers&&-1!=H(e.maybeHiddenMarkers,this)||(e.maybeUnhiddenMarkers||(e.maybeUnhiddenMarkers=[])).push(this)),this.lines.push(t)},os.prototype.detachLine=function(t){this.lines.splice(H(this.lines,t),1),!this.lines.length&&this.doc.cm&&((t=this.doc.cm.curOp).maybeHiddenMarkers||(t.maybeHiddenMarkers=[])).push(this)},Tt(os);var ls=function(t,e){this.markers=t,this.primary=e;for(var i=0;i<t.length;++i)t[i].parent=this};function cs(t){return t.findMarks(ne(t.first,0),t.clipPos(ne(t.lastLine())),function(t){return t.parent})}function hs(r){for(var s=0;s<r.length;s++)!function(){var t=r[s],e=[t.primary.doc];mr(t.primary.doc,function(t){return e.push(t)});for(var i=0;i<t.markers.length;i++){var n=t.markers[i];-1==H(e,n.doc)&&(n.parent=null,t.markers.splice(i--,1))}}()}ls.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var t=0;t<this.markers.length;++t)this.markers[t].clear();si(this,"clear")}},ls.prototype.find=function(t,e){return this.primary.find(t,e)},Tt(ls);var ds=0,us=function(t,e,i,n,r){if(!(this instanceof us))return new us(t,e,i,n,r);null==i&&(i=0),is.call(this,[new es([new qe("",null)])]),this.first=i,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1;i=ne(this.modeFrontier=this.highlightFrontier=i,0);this.sel=ar(i),this.history=new yr(null),this.id=++ds,this.modeOption=e,this.lineSep=n,this.direction="rtl"==r?"rtl":"ltr",this.extend=!1,"string"==typeof t&&(t=this.splitLines(t)),gr(this,{from:i,to:i,text:t}),Fr(this,ar(i),W)};us.prototype=Y(is.prototype,{constructor:us,iter:function(t,e,i){i?this.iterN(t-this.first,e-t,i):this.iterN(this.first,this.first+this.size,t)},insert:function(t,e){for(var i=0,n=0;n<e.length;++n)i+=e[n].height;this.insertInner(t-this.first,e,i)},remove:function(t,e){this.removeInner(t-this.first,e)},getValue:function(t){var e=Qt(this,this.first,this.first+this.size);return!1===t?e:e.join(t||this.lineSeparator())},setValue:Hn(function(t){var e=ne(this.first,0),i=this.first+this.size-1;Kr(this,{from:e,to:ne(i,Xt(this,i).text.length),text:this.splitLines(t),origin:"setValue",full:!0},!0),this.cm&&xn(this.cm,0,0),Fr(this,ar(e),W)}),replaceRange:function(t,e,i,n){Yr(this,t,e=he(this,e),i=i?he(this,i):e,n)},getRange:function(t,e,i){e=Yt(this,he(this,t),he(this,e));return!1===i?e:""===i?e.join(""):e.join(i||this.lineSeparator())},getLine:function(t){t=this.getLineHandle(t);return t&&t.text},getLineHandle:function(t){if(ee(this,t))return Xt(this,t)},getLineNumber:Jt,getLineHandleVisualStart:function(t){return"number"==typeof t&&(t=Xt(this,t)),Re(t)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(t){return he(this,t)},getCursor:function(t){var e=this.sel.primary(),e=null==t||"head"==t?e.head:"anchor"==t?e.anchor:"end"==t||"to"==t||!1===t?e.to():e.from();return e},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:Hn(function(t,e,i){Dr(this,he(this,"number"==typeof t?ne(t,e||0):t),null,i)}),setSelection:Hn(function(t,e,i){Dr(this,he(this,t),he(this,e||t),i)}),extendSelection:Hn(function(t,e,i){Nr(this,he(this,t),e&&he(this,e),i)}),extendSelections:Hn(function(t,e){$r(this,de(this,t),e)}),extendSelectionsBy:Hn(function(t,e){$r(this,de(this,G(this.sel.ranges,t)),e)}),setSelections:Hn(function(t,e,i){if(t.length){for(var n=[],r=0;r<t.length;r++)n[r]=new sr(he(this,t[r].anchor),he(this,t[r].head||t[r].anchor));null==e&&(e=Math.min(t.length-1,this.sel.primIndex)),Fr(this,or(this.cm,n,e),i)}}),addSelection:Hn(function(t,e,i){var n=this.sel.ranges.slice(0);n.push(new sr(he(this,t),he(this,e||t))),Fr(this,or(this.cm,n,n.length-1),i)}),getSelection:function(t){for(var e=this.sel.ranges,i=0;i<e.length;i++)var n=Yt(this,e[i].from(),e[i].to()),r=r?r.concat(n):n;return!1===t?r:r.join(t||this.lineSeparator())},getSelections:function(t){for(var e=[],i=this.sel.ranges,n=0;n<i.length;n++){var r=Yt(this,i[n].from(),i[n].to());!1!==t&&(r=r.join(t||this.lineSeparator())),e[n]=r}return e},replaceSelection:function(t,e,i){for(var n=[],r=0;r<this.sel.ranges.length;r++)n[r]=t;this.replaceSelections(n,e,i||"+input")},replaceSelections:Hn(function(t,e,i){for(var n=[],r=this.sel,s=0;s<r.ranges.length;s++){var o=r.ranges[s];n[s]={from:o.from(),to:o.to(),text:this.splitLines(t[s]),origin:i}}for(var e=e&&"end"!=e&&function(t,e,i){for(var n=[],r=c=ne(t.first,0),s=0;s<e.length;s++){var o=e[s],a=dr(o.from,c,r),l=dr(lr(o),c,r),c=o.to,r=l;"around"==i?(o=re((o=t.sel.ranges[s]).head,o.anchor)<0,n[s]=new sr(o?l:a,o?a:l)):n[s]=new sr(a,a)}return new rr(n,t.sel.primIndex)}(this,n,e),a=n.length-1;0<=a;a--)Kr(this,n[a]);e?Ir(this,e):this.cm&&_n(this.cm)}),undo:Hn(function(){Vr(this,"undo")}),redo:Hn(function(){Vr(this,"redo")}),undoSelection:Hn(function(){Vr(this,"undo",!0)}),redoSelection:Hn(function(){Vr(this,"redo",!0)}),setExtending:function(t){this.extend=t},getExtending:function(){return this.extend},historySize:function(){for(var t=this.history,e=0,i=0,n=0;n<t.done.length;n++)t.done[n].ranges||++e;for(var r=0;r<t.undone.length;r++)t.undone[r].ranges||++i;return{undo:e,redo:i}},clearHistory:function(){var e=this;this.history=new yr(this.history),mr(this,function(t){return t.history=e.history},!0)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(t){return t&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(t){return this.history.generation==(t||this.cleanGeneration)},getHistory:function(){return{done:Lr(this.history.done),undone:Lr(this.history.undone)}},setHistory:function(t){var e=this.history=new yr(this.history);e.done=Lr(t.done.slice(0),null,!0),e.undone=Lr(t.undone.slice(0),null,!0)},setGutterMarker:Hn(function(t,i,n){return ts(this,t,"gutter",function(t){var e=t.gutterMarkers||(t.gutterMarkers={});return!(e[i]=n)&&tt(e)&&(t.gutterMarkers=null),1})}),clearGutter:Hn(function(e){var i=this;this.iter(function(t){t.gutterMarkers&&t.gutterMarkers[e]&&ts(i,t,"gutter",function(){return t.gutterMarkers[e]=null,tt(t.gutterMarkers)&&(t.gutterMarkers=null),1})})}),lineInfo:function(t){var e;if("number"==typeof t){if(!ee(this,t))return null;if(!(t=Xt(this,e=t)))return null}else if(null==(e=Jt(t)))return null;return{line:e,handle:t,text:t.text,gutterMarkers:t.gutterMarkers,textClass:t.textClass,bgClass:t.bgClass,wrapClass:t.wrapClass,widgets:t.widgets}},addLineClass:Hn(function(t,i,n){return ts(this,t,"gutter"==i?"gutter":"class",function(t){var e="text"==i?"textClass":"background"==i?"bgClass":"gutter"==i?"gutterClass":"wrapClass";if(t[e]){if(C(n).test(t[e]))return;t[e]+=" "+n}else t[e]=n;return 1})}),removeLineClass:Hn(function(t,s,o){return ts(this,t,"gutter"==s?"gutter":"class",function(t){var e="text"==s?"textClass":"background"==s?"bgClass":"gutter"==s?"gutterClass":"wrapClass",i=t[e];if(i){if(null==o)t[e]=null;else{var n=i.match(C(o));if(!n)return;var r=n.index+n[0].length;t[e]=i.slice(0,n.index)+(n.index&&r!=i.length?" ":"")+i.slice(r)||null}return 1}})}),addLineWidget:Hn(function(t,e,i){return t=t,r=new ns(n=this,e,i),(s=n.cm)&&r.noHScroll&&(s.display.alignWidgets=!0),ts(n,t,"widget",function(t){var e=t.widgets||(t.widgets=[]);return null==r.insertAt?e.push(r):e.splice(Math.min(e.length,Math.max(0,r.insertAt)),0,r),r.line=t,s&&!ze(n,t)&&(e=je(t)<n.scrollTop,Zt(t,t.height+fi(r)),e&&yn(s,r.height),s.curOp.forceUpdate=!0),1}),s&&si(s,"lineWidgetAdded",s,r,"number"==typeof t?t:Jt(t)),r;var n,r,s}),removeLineWidget:function(t){t.clear()},markText:function(t,e,i){return as(this,he(this,t),he(this,e),i,i&&i.type||"range")},setBookmark:function(t,e){e={replacedWith:e&&(null==e.nodeType?e.widget:e),insertLeft:e&&e.insertLeft,clearWhenEmpty:!1,shared:e&&e.shared,handleMouseEvents:e&&e.handleMouseEvents};return as(this,t=he(this,t),t,e,"bookmark")},findMarksAt:function(t){var e=[],i=Xt(this,(t=he(this,t)).line).markedSpans;if(i)for(var n=0;n<i.length;++n){var r=i[n];(null==r.from||r.from<=t.ch)&&(null==r.to||r.to>=t.ch)&&e.push(r.marker.parent||r.marker)}return e},findMarks:function(r,s,o){r=he(this,r),s=he(this,s);var a=[],l=r.line;return this.iter(r.line,s.line+1,function(t){var e=t.markedSpans;if(e)for(var i=0;i<e.length;i++){var n=e[i];null!=n.to&&l==r.line&&r.ch>=n.to||null==n.from&&l!=r.line||null!=n.from&&l==s.line&&n.from>=s.ch||o&&!o(n.marker)||a.push(n.marker.parent||n.marker)}++l}),a},getAllMarks:function(){var n=[];return this.iter(function(t){var e=t.markedSpans;if(e)for(var i=0;i<e.length;++i)null!=e[i].from&&n.push(e[i].marker)}),n},posFromIndex:function(e){var i,n=this.first,r=this.lineSeparator().length;return this.iter(function(t){t=t.text.length+r;if(e<t)return i=e,!0;e-=t,++n}),he(this,ne(n,i))},indexFromPos:function(t){var e=(t=he(this,t)).ch;if(t.line<this.first||t.ch<0)return 0;var i=this.lineSeparator().length;return this.iter(this.first,t.line,function(t){e+=t.text.length+i}),e},copy:function(t){var e=new us(Qt(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return e.scrollTop=this.scrollTop,e.scrollLeft=this.scrollLeft,e.sel=this.sel,e.extend=!1,t&&(e.history.undoDepth=this.history.undoDepth,e.setHistory(this.getHistory())),e},linkedDoc:function(t){t=t||{};var e=this.first,i=this.first+this.size;null!=t.from&&t.from>e&&(e=t.from),null!=t.to&&t.to<i&&(i=t.to);e=new us(Qt(this,e,i),t.mode||this.modeOption,e,this.lineSep,this.direction);return t.sharedHist&&(e.history=this.history),(this.linked||(this.linked=[])).push({doc:e,sharedHist:t.sharedHist}),e.linked=[{doc:this,isParent:!0,sharedHist:t.sharedHist}],function(t,e){for(var i=0;i<e.length;i++){var n=e[i],r=n.find(),s=t.clipPos(r.from),r=t.clipPos(r.to);re(s,r)&&(r=as(t,s,r,n.primary,n.primary.type),n.markers.push(r),r.parent=n)}}(e,cs(this)),e},unlinkDoc:function(t){if(t instanceof co&&(t=t.doc),this.linked)for(var e=0;e<this.linked.length;++e)if(this.linked[e].doc==t){this.linked.splice(e,1),t.unlinkDoc(this),hs(cs(this));break}var i;t.history==this.history&&(i=[t.id],mr(t,function(t){return i.push(t.id)},!0),t.history=new yr(null),t.history.done=Lr(this.history.done,i),t.history.undone=Lr(this.history.undone,i))},iterLinkedDocs:function(t){mr(this,t)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(t){return this.lineSep?t.split(this.lineSep):Ft(t)},lineSeparator:function(){return this.lineSep||"\n"},setDirection:Hn(function(t){var e;"rtl"!=t&&(t="ltr"),t!=this.direction&&(this.direction=t,this.iter(function(t){return t.order=null}),this.cm&&Fn(e=this.cm,function(){br(e),tn(e)}))})}),us.prototype.eachLine=us.prototype.iter;var ps=0;function fs(t){var n=this;if(gs(n),!Ct(n,t)&&!gi(n.display,t)){St(t),_&&(ps=+new Date);var e=Zi(n,t,!0),i=t.dataTransfer.files;if(e&&!n.isReadOnly())if(i&&i.length&&window.FileReader&&window.File)for(var r=i.length,s=Array(r),o=0,a=function(){++o==r&&On(n,function(){var t={from:e=he(n.doc,e),to:e,text:n.doc.splitLines(s.filter(function(t){return null!=t}).join(n.doc.lineSeparator())),origin:"paste"};Kr(n.doc,t),Ir(n.doc,ar(he(n.doc,e),he(n.doc,lr(t))))})()},l=0;l<i.length;l++)!function(t,e){var i;n.options.allowDropFileTypes&&-1==H(n.options.allowDropFileTypes,t.type)?a():((i=new FileReader).onerror=a,i.onload=function(){var t=i.result;/[\x00-\x08\x0e-\x1f]{2}/.test(t)||(s[e]=t),a()},i.readAsText(t))}(i[l],l);else{if(n.state.draggingText&&-1<n.doc.sel.contains(e))return n.state.draggingText(t),void setTimeout(function(){return n.display.input.focus()},20);try{var c,h=t.dataTransfer.getData("Text");if(h){if(n.state.draggingText&&!n.state.draggingText.copy&&(c=n.listSelections()),Or(n.doc,ar(e,e)),c)for(var d=0;d<c.length;++d)Yr(n.doc,"",c[d].anchor,c[d].head,"drag");n.replaceSelection(h,"around","paste"),n.display.input.focus()}}catch(t){}}}}function gs(t){t.display.dragCursor&&(t.display.lineSpace.removeChild(t.display.dragCursor),t.display.dragCursor=null)}function ms(e){if(document.getElementsByClassName){for(var t=document.getElementsByClassName("CodeMirror"),i=[],n=0;n<t.length;n++){var r=t[n].CodeMirror;r&&i.push(r)}i.length&&i[0].operation(function(){for(var t=0;t<i.length;t++)e(i[t])})}}var vs=!1;function bs(){var t;vs||(bt(window,"resize",function(){null==t&&(t=setTimeout(function(){t=null,ms(ys)},100))}),bt(window,"blur",function(){return ms(fn)}),vs=!0)}function ys(t){var e=t.display;e.cachedCharWidth=e.cachedTextHeight=e.cachedPaddingH=null,e.scrollbarsClipped=!1,t.setSize()}for(var _s={3:"Pause",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",145:"ScrollLock",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",224:"Mod",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},xs=0;xs<10;xs++)_s[xs+48]=_s[xs+96]=String(xs);for(var Cs=65;Cs<=90;Cs++)_s[Cs]=String.fromCharCode(Cs);for(var ws=1;ws<=12;ws++)_s[ws+111]=_s[ws+63235]="F"+ws;var ks={};function Ts(t){var e,i,n,r,s=t.split(/-(?!$)/);t=s[s.length-1];for(var o=0;o<s.length-1;o++){var a=s[o];if(/^(cmd|meta|m)$/i.test(a))r=!0;else if(/^a(lt)?$/i.test(a))e=!0;else if(/^(c|ctrl|control)$/i.test(a))i=!0;else{if(!/^s(hift)?$/i.test(a))throw new Error("Unrecognized modifier name: "+a);n=!0}}return e&&(t="Alt-"+t),i&&(t="Ctrl-"+t),r&&(t="Cmd-"+t),n&&(t="Shift-"+t),t}function Ss(t){var e,i,n={};for(e in t)if(t.hasOwnProperty(e)){var r=t[e];if(!/^(name|fallthrough|(de|at)tach)$/.test(e))if("..."!=r){for(var s=G(e.split(" "),Ts),o=0;o<s.length;o++){var a=void 0,l=void 0,a=o==s.length-1?(l=s.join(" "),r):(l=s.slice(0,o+1).join(" "),"..."),c=n[l];if(c){if(c!=a)throw new Error("Inconsistent bindings for "+l)}else n[l]=a}delete t[e]}else delete t[e]}for(i in n)t[i]=n[i];return t}function Es(t,e,i,n){var r=(e=$s(e)).call?e.call(t,n):e[t];if(!1===r)return"nothing";if("..."===r)return"multi";if(null!=r&&i(r))return"handled";if(e.fallthrough){if("[object Array]"!=Object.prototype.toString.call(e.fallthrough))return Es(t,e.fallthrough,i,n);for(var s=0;s<e.fallthrough.length;s++){var o=Es(t,e.fallthrough[s],i,n);if(o)return o}}}function Ls(t){t="string"==typeof t?t:_s[t.keyCode];return"Ctrl"==t||"Alt"==t||"Shift"==t||"Mod"==t}function As(t,e,i){var n=t;return e.altKey&&"Alt"!=n&&(t="Alt-"+t),(y?e.metaKey:e.ctrlKey)&&"Ctrl"!=n&&(t="Ctrl-"+t),(y?e.ctrlKey:e.metaKey)&&"Mod"!=n&&(t="Cmd-"+t),!i&&e.shiftKey&&"Shift"!=n&&(t="Shift-"+t),t}function Ns(t,e){if(f&&34==t.keyCode&&t.char)return!1;var i=_s[t.keyCode];return null!=i&&!t.altGraphKey&&(3==t.keyCode&&t.code&&(i=t.code),As(i,t,e))}function $s(t){return"string"==typeof t?ks[t]:t}function Ms(e,t){for(var i=e.doc.sel.ranges,n=[],r=0;r<i.length;r++){for(var s=t(i[r]);n.length&&re(s.from,V(n).to)<=0;){var o=n.pop();if(re(o.from,s.from)<0){s.from=o.from;break}}n.push(s)}Fn(e,function(){for(var t=n.length-1;0<=t;t--)Yr(e.doc,"",n[t].from,n[t].to,"+delete");_n(e)})}function Ds(t,e,i){i=nt(t.text,e+i,i);return i<0||i>t.text.length?null:i}function Is(t,e,i){t=Ds(t,e.ch,i);return null==t?null:new ne(e.line,t,i<0?"after":"before")}function Fs(t,e,i,n,r){if(t){"rtl"==e.doc.direction&&(r=-r);var s=mt(i,e.doc.direction);if(s){var o,a,l,t=r<0?V(s):s[0],s=r<0==(1==t.level)?"after":"before";return 0<t.level||"rtl"==e.doc.direction?(o=Ti(e,i),a=r<0?i.text.length-1:0,l=Si(e,o,a).top,a=rt(function(t){return Si(e,o,t).top==l},r<0==(1==t.level)?t.from:t.to-1,a),"before"==s&&(a=Ds(i,a,1))):a=r<0?t.to:t.from,new ne(n,a,s)}}return new ne(n,r<0?i.text.length:0,r<0?"before":"after")}function Os(e,i,a,t){var l=mt(i,e.doc.direction);if(!l)return Is(i,a,t);a.ch>=i.text.length?(a.ch=i.text.length,a.sticky="before"):a.ch<=0&&(a.ch=0,a.sticky="after");var n=ot(l,a.ch,a.sticky),r=l[n];if("ltr"==e.doc.direction&&r.level%2==0&&(0<t?r.to>a.ch:r.from<a.ch))return Is(i,a,t);function c(t,e){return Ds(i,t instanceof ne?t.ch:t,e)}function s(t){return e.options.lineWrapping?(o=o||Ti(e,i),Ui(e,i,o,t)):{begin:0,end:i.text.length}}var o,h=s("before"==a.sticky?c(a,-1):a.ch);if("rtl"==e.doc.direction||1==r.level){var d=1==r.level==t<0,u=c(a,d?1:-1);if(null!=u&&(d?u<=r.to&&u<=h.end:u>=r.from&&u>=h.begin)){var p=d?"before":"after";return new ne(a.line,u,p)}}p=function(t,e,i){for(var n=function(t,e){return e?new ne(a.line,c(t,1),"before"):new ne(a.line,t,"after")};0<=t&&t<l.length;t+=e){var r=l[t],s=0<e==(1!=r.level),o=s?i.begin:c(i.end,-1);if(r.from<=o&&o<r.to)return n(o,s);if(o=s?r.from:c(r.to,-1),i.begin<=o&&o<i.end)return n(o,s)}},n=p(n+t,t,h);if(n)return n;h=0<t?h.end:c(h.begin,-1);return null==h||0<t&&h==i.text.length||!(n=p(0<t?0:l.length-1,t,s(h)))?null:n}ks.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},ks.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},ks.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},ks.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},ks.default=g?ks.macDefault:ks.pcDefault;var Bs={selectAll:jr,singleSelection:function(t){return t.setSelection(t.getCursor("anchor"),t.getCursor("head"),W)},killLine:function(i){return Ms(i,function(t){if(t.empty()){var e=Xt(i.doc,t.head.line).text.length;return t.head.ch==e&&t.head.line<i.lastLine()?{from:t.head,to:ne(t.head.line+1,0)}:{from:t.head,to:ne(t.head.line,e)}}return{from:t.from(),to:t.to()}})},deleteLine:function(e){return Ms(e,function(t){return{from:ne(t.from().line,0),to:he(e.doc,ne(t.to().line+1,0))}})},delLineLeft:function(t){return Ms(t,function(t){return{from:ne(t.from().line,0),to:t.from()}})},delWrappedLineLeft:function(i){return Ms(i,function(t){var e=i.charCoords(t.head,"div").top+5;return{from:i.coordsChar({left:0,top:e},"div"),to:t.from()}})},delWrappedLineRight:function(i){return Ms(i,function(t){var e=i.charCoords(t.head,"div").top+5,e=i.coordsChar({left:i.display.lineDiv.offsetWidth+100,top:e},"div");return{from:t.from(),to:e}})},undo:function(t){return t.undo()},redo:function(t){return t.redo()},undoSelection:function(t){return t.undoSelection()},redoSelection:function(t){return t.redoSelection()},goDocStart:function(t){return t.extendSelection(ne(t.firstLine(),0))},goDocEnd:function(t){return t.extendSelection(ne(t.lastLine()))},goLineStart:function(e){return e.extendSelectionsBy(function(t){return Hs(e,t.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(e){return e.extendSelectionsBy(function(t){return Rs(e,t.head)},{origin:"+move",bias:1})},goLineEnd:function(e){return e.extendSelectionsBy(function(t){return function(t,e){var i=Xt(t.doc,e),n=function(t){for(var e;e=Be(t);)t=e.find(1,!0).line;return t}(i);n!=i&&(e=Jt(n));return Fs(!0,t,i,e,-1)}(e,t.head.line)},{origin:"+move",bias:-1})},goLineRight:function(e){return e.extendSelectionsBy(function(t){t=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:t},"div")},j)},goLineLeft:function(e){return e.extendSelectionsBy(function(t){t=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:0,top:t},"div")},j)},goLineLeftSmart:function(i){return i.extendSelectionsBy(function(t){var e=i.cursorCoords(t.head,"div").top+5,e=i.coordsChar({left:0,top:e},"div");return e.ch<i.getLine(e.line).search(/\S/)?Rs(i,t.head):e},j)},goLineUp:function(t){return t.moveV(-1,"line")},goLineDown:function(t){return t.moveV(1,"line")},goPageUp:function(t){return t.moveV(-1,"page")},goPageDown:function(t){return t.moveV(1,"page")},goCharLeft:function(t){return t.moveH(-1,"char")},goCharRight:function(t){return t.moveH(1,"char")},goColumnLeft:function(t){return t.moveH(-1,"column")},goColumnRight:function(t){return t.moveH(1,"column")},goWordLeft:function(t){return t.moveH(-1,"word")},goGroupRight:function(t){return t.moveH(1,"group")},goGroupLeft:function(t){return t.moveH(-1,"group")},goWordRight:function(t){return t.moveH(1,"word")},delCharBefore:function(t){return t.deleteH(-1,"codepoint")},delCharAfter:function(t){return t.deleteH(1,"char")},delWordBefore:function(t){return t.deleteH(-1,"word")},delWordAfter:function(t){return t.deleteH(1,"word")},delGroupBefore:function(t){return t.deleteH(-1,"group")},delGroupAfter:function(t){return t.deleteH(1,"group")},indentAuto:function(t){return t.indentSelection("smart")},indentMore:function(t){return t.indentSelection("add")},indentLess:function(t){return t.indentSelection("subtract")},insertTab:function(t){return t.replaceSelection("\t")},insertSoftTab:function(t){for(var e=[],i=t.listSelections(),n=t.options.tabSize,r=0;r<i.length;r++){var s=i[r].from(),s=O(t.getLine(s.line),s.ch,n);e.push(q(n-s%n))}t.replaceSelections(e)},defaultTab:function(t){t.somethingSelected()?t.indentSelection("add"):t.execCommand("insertTab")},transposeChars:function(o){return Fn(o,function(){for(var t,e,i,n=o.listSelections(),r=[],s=0;s<n.length;s++)n[s].empty()&&(t=n[s].head,(e=Xt(o.doc,t.line).text)&&(t.ch==e.length&&(t=new ne(t.line,t.ch-1)),0<t.ch?(t=new ne(t.line,t.ch+1),o.replaceRange(e.charAt(t.ch-1)+e.charAt(t.ch-2),ne(t.line,t.ch-2),t,"+transpose")):t.line>o.doc.first&&((i=Xt(o.doc,t.line-1).text)&&(t=new ne(t.line,1),o.replaceRange(e.charAt(0)+o.doc.lineSeparator()+i.charAt(i.length-1),ne(t.line-1,i.length-1),t,"+transpose")))),r.push(new sr(t,t)));o.setSelections(r)})},newlineAndIndent:function(n){return Fn(n,function(){for(var t=n.listSelections(),e=t.length-1;0<=e;e--)n.replaceRange(n.doc.lineSeparator(),t[e].anchor,t[e].head,"+input");t=n.listSelections();for(var i=0;i<t.length;i++)n.indentLine(t[i].from().line,null,!0);_n(n)})},openLine:function(t){return t.replaceSelection("\n","start")},toggleOverwrite:function(t){return t.toggleOverwrite()}};function Hs(t,e){var i=Xt(t.doc,e),n=Re(i);return n!=i&&(e=Jt(n)),Fs(!0,t,n,e,1)}function Rs(t,e){var i=Hs(t,e.line),n=Xt(t.doc,i.line),t=mt(n,t.doc.direction);if(t&&0!=t[0].level)return i;n=Math.max(i.ch,n.text.search(/\S/)),e=e.line==i.line&&e.ch<=n&&e.ch;return ne(i.line,e?0:n,i.sticky)}function Ps(t,e,i){if("string"==typeof e&&!(e=Bs[e]))return!1;t.display.input.ensurePolled();var n=t.display.shift,r=!1;try{t.isReadOnly()&&(t.state.suppressEdits=!0),i&&(t.display.shift=!1),r=e(t)!=P}finally{t.display.shift=n,t.state.suppressEdits=!1}return r}var Ws=new B;function zs(t,e,i,n){var r=t.state.keySeq;if(r){if(Ls(e))return"handled";if(/\'$/.test(e)?t.state.keySeq=null:Ws.set(50,function(){t.state.keySeq==r&&(t.state.keySeq=null,t.display.input.reset())}),js(t,r+" "+e,i,n))return!0}return js(t,e,i,n)}function js(t,e,i,n){n=function(t,e,i){for(var n=0;n<t.state.keyMaps.length;n++){var r=Es(e,t.state.keyMaps[n],i,t);if(r)return r}return t.options.extraKeys&&Es(e,t.options.extraKeys,i,t)||Es(e,t.options.keyMap,i,t)}(t,e,n);return"multi"==n&&(t.state.keySeq=e),"handled"==n&&si(t,"keyHandled",t,e,i),"handled"!=n&&"multi"!=n||(St(i),hn(t)),!!n}function Us(e,t){var i=Ns(t,!0);return!!i&&(t.shiftKey&&!e.state.keySeq?zs(e,"Shift-"+i,t,function(t){return Ps(e,t,!0)})||zs(e,i,t,function(t){if("string"==typeof t?/^go[A-Z]/.test(t):t.motion)return Ps(e,t)}):zs(e,i,t,function(t){return Ps(e,t)}))}var Ks=null;function qs(t){var e,i,n,r=this;function s(t){18!=t.keyCode&&t.altKey||(k(n,"CodeMirror-crosshair"),_t(document,"keyup",s),_t(document,"mouseover",s))}t.target&&t.target!=r.display.input.getField()||(r.curOp.focus=N(),Ct(r,t)||(_&&v<11&&27==t.keyCode&&(t.returnValue=!1),e=t.keyCode,r.display.shift=16==e||t.shiftKey,i=Us(r,t),f&&(Ks=i?e:null,!i&&88==e&&!Bt&&(g?t.metaKey:t.ctrlKey)&&r.replaceSelection("",null,"cut")),u&&!g&&!i&&46==e&&t.shiftKey&&!t.ctrlKey&&document.execCommand&&document.execCommand("cut"),18!=e||/\bCodeMirror-crosshair\b/.test(r.display.lineDiv.className)||($(n=r.display.lineDiv,"CodeMirror-crosshair"),bt(document,"keyup",s),bt(document,"mouseover",s))))}function Vs(t){16==t.keyCode&&(this.doc.sel.shift=!1),Ct(this,t)}function Gs(t){var e=this;if(!(t.target&&t.target!=e.display.input.getField()||gi(e.display,t)||Ct(e,t)||t.ctrlKey&&!t.altKey||g&&t.metaKey)){var i,n=t.keyCode,r=t.charCode;if(f&&n==Ks)return Ks=null,void St(t);f&&(!t.which||t.which<10)&&Us(e,t)||"\b"!=(r=String.fromCharCode(null==r?n:r))&&(zs(i=e,"'"+r+"'",t,function(t){return Ps(i,t,!0)})||e.display.input.onKeyPress(t))}}var Xs,Ys,Qs=function(t,e,i){this.time=t,this.pos=e,this.button=i};function Zs(t){var e,i,n,r,s,o=this,a=o.display;Ct(o,t)||a.activeTouch&&a.input.supportsTouch()||(a.input.ensurePolled(),a.shift=t.shiftKey,gi(a,t)?p||(a.scroller.draggable=!1,setTimeout(function(){return a.scroller.draggable=!0},100)):eo(o,t)||(e=Zi(o,t),i=$t(t),r=e?(n=e,r=i,s=+new Date,Ys&&Ys.compare(s,n,r)?(Xs=Ys=null,"triple"):Xs&&Xs.compare(s,n,r)?(Ys=new Qs(s,n,r),Xs=null,"double"):(Xs=new Qs(s,n,r),Ys=null,"single")):"single",window.focus(),1==i&&o.state.selectingText&&o.state.selectingText(t),e&&function(i,t,n,e,r){var s="Click";"double"==e?s="Double"+s:"triple"==e&&(s="Triple"+s);return zs(i,As(s=(1==t?"Left":2==t?"Middle":"Right")+s,r),r,function(t){if("string"==typeof t&&(t=Bs[t]),!t)return!1;var e=!1;try{i.isReadOnly()&&(i.state.suppressEdits=!0),e=t(i,n)!=P}finally{i.state.suppressEdits=!1}return e})}(o,i,e,r,t)||(1==i?e?function(t,e,i,n){_?setTimeout(I(dn,t),0):t.curOp.focus=N();var r,s=function(t,e,i){var n=t.getOption("configureMouse"),r=n?n(t,e,i):{};null==r.unit&&(n=m?i.shiftKey&&i.metaKey:i.altKey,r.unit=n?"rectangle":"single"==e?"char":"double"==e?"word":"line");null!=r.extend&&!t.doc.extend||(r.extend=t.doc.extend||i.shiftKey);null==r.addNew&&(r.addNew=g?i.metaKey:i.ctrlKey);null==r.moveOnDrag&&(r.moveOnDrag=!(g?i.altKey:i.ctrlKey));return r}(t,i,n),o=t.doc.sel;(t.options.dragDrop&&It&&!t.isReadOnly()&&"single"==i&&-1<(r=o.contains(e))&&(re((r=o.ranges[r]).from(),e)<0||0<e.xRel)&&(0<re(r.to(),e)||e.xRel<0)?function(e,i,n,r){var s=e.display,o=!1,a=On(e,function(t){p&&(s.scroller.draggable=!1),e.state.draggingText=!1,e.state.delayingBlurEvent&&(e.hasFocus()?e.state.delayingBlurEvent=!1:un(e)),_t(s.wrapper.ownerDocument,"mouseup",a),_t(s.wrapper.ownerDocument,"mousemove",l),_t(s.scroller,"dragstart",c),_t(s.scroller,"drop",a),o||(St(t),r.addNew||Nr(e.doc,n,null,null,r.extend),p&&!h||_&&9==v?setTimeout(function(){s.wrapper.ownerDocument.body.focus({preventScroll:!0}),s.input.focus()},20):s.input.focus())}),l=function(t){o=o||10<=Math.abs(i.clientX-t.clientX)+Math.abs(i.clientY-t.clientY)},c=function(){return o=!0};p&&(s.scroller.draggable=!0),(e.state.draggingText=a).copy=!r.moveOnDrag,bt(s.wrapper.ownerDocument,"mouseup",a),bt(s.wrapper.ownerDocument,"mousemove",l),bt(s.scroller,"dragstart",c),bt(s.scroller,"drop",a),e.state.delayingBlurEvent=!0,setTimeout(function(){return s.input.focus()},20),s.scroller.dragDrop&&s.scroller.dragDrop()}:function(u,t,p,f){_&&un(u);var o=u.display,g=u.doc;St(t);var m,v,b=g.sel,e=b.ranges;f.addNew&&!f.extend?(v=g.sel.contains(p),m=-1<v?e[v]:new sr(p,p)):(m=g.sel.primary(),v=g.sel.primIndex),"rectangle"==f.unit?(f.addNew||(m=new sr(p,p)),p=Zi(u,t,!0,!0),v=-1):(t=Js(u,p,f.unit),m=f.extend?Ar(m,t.anchor,t.head,f.extend):t),f.addNew?-1==v?(v=e.length,Fr(g,or(u,e.concat([m]),v),{scroll:!1,origin:"*mouse"})):1<e.length&&e[v].empty()&&"char"==f.unit&&!f.extend?(Fr(g,or(u,e.slice(0,v).concat(e.slice(v+1)),0),{scroll:!1,origin:"*mouse"}),b=g.sel):Mr(g,v,m,z):(Fr(g,new rr([m],v=0),z),b=g.sel);var y=p;function a(t){if(0!=re(y,t))if(y=t,"rectangle"==f.unit){for(var e=[],i=u.options.tabSize,n=O(Xt(g,p.line).text,p.ch,i),r=O(Xt(g,t.line).text,t.ch,i),s=Math.min(n,r),o=Math.max(n,r),a=Math.min(p.line,t.line),l=Math.min(u.lastLine(),Math.max(p.line,t.line));a<=l;a++){var c=Xt(g,a).text,h=U(c,s,i);s==o?e.push(new sr(ne(a,h),ne(a,h))):c.length>h&&e.push(new sr(ne(a,h),ne(a,U(c,o,i))))}e.length||e.push(new sr(p,p)),Fr(g,or(u,b.ranges.slice(0,v).concat(e),v),{origin:"*mouse",scroll:!1}),u.scrollIntoView(t)}else{var d,n=m,r=Js(u,t,f.unit),t=n.anchor,t=0<re(r.anchor,t)?(d=r.head,le(n.from(),r.anchor)):(d=r.anchor,ae(n.to(),r.head)),r=b.ranges.slice(0);r[v]=function(t,e){var i=e.anchor,n=e.head,r=Xt(t.doc,i.line);if(0==re(i,n)&&i.sticky==n.sticky)return e;var s=mt(r);if(!s)return e;var o=ot(s,i.ch,i.sticky),a=s[o];if(a.from!=i.ch&&a.to!=i.ch)return e;r=o+(a.from==i.ch==(1!=a.level)?0:1);if(0==r||r==s.length)return e;l=n.line!=i.line?0<(n.line-i.line)*("ltr"==t.doc.direction?1:-1):(t=ot(s,n.ch,n.sticky),l=t-o||(n.ch-i.ch)*(1==a.level?-1:1),t==r-1||t==r?l<0:0<l);var r=s[r+(l?-1:0)],l=l==(1==r.level),r=l?r.from:r.to,l=l?"after":"before";return i.ch==r&&i.sticky==l?e:new sr(new ne(i.line,r,l),n)}(u,new sr(he(g,t),d)),Fr(g,or(u,r,v),z)}}var l=o.wrapper.getBoundingClientRect(),c=0;function i(t){u.state.selectingText=!1,c=1/0,t&&(St(t),o.input.focus()),_t(o.wrapper.ownerDocument,"mousemove",n),_t(o.wrapper.ownerDocument,"mouseup",r),g.history.lastSelOrigin=null}var n=On(u,function(t){(0!==t.buttons&&$t(t)?function t(e){var i,n,r=++c,s=Zi(u,e,!0,"rectangle"==f.unit);s&&(0!=re(s,y)?(u.curOp.focus=N(),a(s),i=vn(o,g),(s.line>=i.to||s.line<i.from)&&setTimeout(On(u,function(){c==r&&t(e)}),150)):(n=e.clientY<l.top?-20:e.clientY>l.bottom?20:0)&&setTimeout(On(u,function(){c==r&&(o.scroller.scrollTop+=n,t(e))}),50))}:i)(t)}),r=On(u,i);u.state.selectingText=r,bt(o.wrapper.ownerDocument,"mousemove",n),bt(o.wrapper.ownerDocument,"mouseup",r)})(t,n,e,s)}(o,e,r,t):Nt(t)==a.scroller&&St(t):2==i?(e&&Nr(o.doc,e),setTimeout(function(){return a.input.focus()},20)):3==i&&(x?o.display.input.onContextMenu(t):un(o)))))}function Js(t,e,i){if("char"==i)return new sr(e,e);if("word"==i)return t.findWordAt(e);if("line"==i)return new sr(ne(e.line,0),he(t.doc,ne(e.line+1,0)));e=i(t,e);return new sr(e.from,e.to)}function to(t,e,i,n){var r,s;if(e.touches)r=e.touches[0].clientX,s=e.touches[0].clientY;else try{r=e.clientX,s=e.clientY}catch(t){return!1}if(r>=Math.floor(t.display.gutters.getBoundingClientRect().right))return!1;n&&St(e);var o=t.display,n=o.lineDiv.getBoundingClientRect();if(s>n.bottom||!kt(t,i))return Lt(e);s-=n.top-o.viewOffset;for(var a=0;a<t.display.gutterSpecs.length;++a){var l=o.gutters.childNodes[a];if(l&&l.getBoundingClientRect().right>=r)return xt(t,i,t,te(t.doc,s),t.display.gutterSpecs[a].className,e),Lt(e)}}function eo(t,e){return to(t,e,"gutterClick",!0)}function io(t,e){var i,n;gi(t.display,e)||(n=e,kt(i=t,"gutterContextMenu")&&to(i,n,"gutterContextMenu",!1))||Ct(t,e,"contextmenu")||x||t.display.input.onContextMenu(e)}function no(t){t.display.wrapper.className=t.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+t.options.theme.replace(/(^|\s)\s*/g," cm-s-"),Mi(t)}Qs.prototype.compare=function(t,e,i){return this.time+400>t&&0==re(e,this.pos)&&i==this.button};var ro={toString:function(){return"CodeMirror.Init"}},so={},oo={};function ao(t,e,i){!e!=!(i&&i!=ro)&&(i=t.display.dragFunctions,(e=e?bt:_t)(t.display.scroller,"dragstart",i.start),e(t.display.scroller,"dragenter",i.enter),e(t.display.scroller,"dragover",i.over),e(t.display.scroller,"dragleave",i.leave),e(t.display.scroller,"drop",i.drop))}function lo(t){t.options.lineWrapping?($(t.display.wrapper,"CodeMirror-wrap"),t.display.sizer.style.minWidth="",t.display.sizerWidth=null):(k(t.display.wrapper,"CodeMirror-wrap"),Ke(t)),Qi(t),tn(t),Mi(t),setTimeout(function(){return Ln(t)},100)}function co(t,e){var i=this;if(!(this instanceof co))return new co(t,e);this.options=e=e?F(e):{},F(so,e,!1);var n=e.value;"string"==typeof n?n=new us(n,e.mode,null,e.lineSeparator,e.direction):e.mode&&(n.modeOption=e.mode),this.doc=n;var r,s=new co.inputStyles[e.inputStyle](this),s=this.display=new Zn(t,n,s,e);for(r in no(s.wrapper.CodeMirror=this),e.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),$n(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:-1,cutIncoming:-1,selectingText:!1,draggingText:!1,highlight:new B,keySeq:null,specialChars:null},e.autofocus&&!d&&s.input.focus(),_&&v<11&&setTimeout(function(){return i.display.input.reset(!0)},20),function(n){var r=n.display;bt(r.scroller,"mousedown",On(n,Zs)),bt(r.scroller,"dblclick",_&&v<11?On(n,function(t){var e;Ct(n,t)||(!(e=Zi(n,t))||eo(n,t)||gi(n.display,t)||(St(t),e=n.findWordAt(e),Nr(n.doc,e.anchor,e.head)))}):function(t){return Ct(n,t)||St(t)}),bt(r.scroller,"contextmenu",function(t){return io(n,t)}),bt(r.input.getField(),"contextmenu",function(t){r.scroller.contains(t.target)||io(n,t)});var i,s={end:0};function o(){r.activeTouch&&(i=setTimeout(function(){return r.activeTouch=null},1e3),(s=r.activeTouch).end=+new Date)}function a(t,e){if(null==e.left)return 1;var i=e.left-t.left,t=e.top-t.top;return 400<i*i+t*t}bt(r.scroller,"touchstart",function(t){var e;Ct(n,t)||function(t){if(1==t.touches.length){t=t.touches[0];return t.radiusX<=1&&t.radiusY<=1}}(t)||eo(n,t)||(r.input.ensurePolled(),clearTimeout(i),e=+new Date,r.activeTouch={start:e,moved:!1,prev:e-s.end<=300?s:null},1==t.touches.length&&(r.activeTouch.left=t.touches[0].pageX,r.activeTouch.top=t.touches[0].pageY))}),bt(r.scroller,"touchmove",function(){r.activeTouch&&(r.activeTouch.moved=!0)}),bt(r.scroller,"touchend",function(t){var e,i=r.activeTouch;i&&!gi(r,t)&&null!=i.left&&!i.moved&&new Date-i.start<300&&(e=n.coordsChar(r.activeTouch,"page"),e=!i.prev||a(i,i.prev)?new sr(e,e):!i.prev.prev||a(i,i.prev.prev)?n.findWordAt(e):new sr(ne(e.line,0),he(n.doc,ne(e.line+1,0))),n.setSelection(e.anchor,e.head),n.focus(),St(t)),o()}),bt(r.scroller,"touchcancel",o),bt(r.scroller,"scroll",function(){r.scroller.clientHeight&&(kn(n,r.scroller.scrollTop),Sn(n,r.scroller.scrollLeft,!0),xt(n,"scroll",n))}),bt(r.scroller,"mousewheel",function(t){return nr(n,t)}),bt(r.scroller,"DOMMouseScroll",function(t){return nr(n,t)}),bt(r.wrapper,"scroll",function(){return r.wrapper.scrollTop=r.wrapper.scrollLeft=0}),r.dragFunctions={enter:function(t){Ct(n,t)||At(t)},over:function(t){var e,i;Ct(n,t)||((i=Zi(e=n,i=t))&&(ln(e,i,i=document.createDocumentFragment()),e.display.dragCursor||(e.display.dragCursor=E("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),e.display.lineSpace.insertBefore(e.display.dragCursor,e.display.cursorDiv)),S(e.display.dragCursor,i)),At(t))},start:function(t){return e=n,i=t,void(_&&(!e.state.draggingText||+new Date-ps<100)?At(i):Ct(e,i)||gi(e.display,i)||(i.dataTransfer.setData("Text",e.getSelection()),i.dataTransfer.effectAllowed="copyMove",i.dataTransfer.setDragImage&&!h&&((t=E("img",null,null,"position: fixed; left: 0; top: 0;")).src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",f&&(t.width=t.height=1,e.display.wrapper.appendChild(t),t._top=t.offsetTop),i.dataTransfer.setDragImage(t,0,0),f&&t.parentNode.removeChild(t))));var e,i},drop:On(n,fs),leave:function(t){Ct(n,t)||gs(n)}};var t=r.input.getField();bt(t,"keyup",function(t){return Vs.call(n,t)}),bt(t,"keydown",On(n,qs)),bt(t,"keypress",On(n,Gs)),bt(t,"focus",function(t){return pn(n,t)}),bt(t,"blur",function(t){return fn(n,t)})}(this),bs(),Dn(this),this.curOp.forceUpdate=!0,vr(this,n),e.autofocus&&!d||this.hasFocus()?setTimeout(function(){i.hasFocus()&&!i.state.focused&&pn(i)},20):fn(this),oo)oo.hasOwnProperty(r)&&oo[r](this,e[r],ro);Gn(this),e.finishInit&&e.finishInit(this);for(var o=0;o<ho.length;++o)ho[o](this);In(this),p&&e.lineWrapping&&"optimizelegibility"==getComputedStyle(s.lineDiv).textRendering&&(s.lineDiv.style.textRendering="auto")}co.defaults=so,co.optionHandlers=oo;var ho=[];function uo(t,e,i,n){var r,s=t.doc;null==i&&(i="add"),"smart"==i&&(s.mode.indent?r=me(t,e).state:i="prev");var o=t.options.tabSize,a=Xt(s,e),l=O(a.text,null,o);a.stateAfter&&(a.stateAfter=null);var c,h=a.text.match(/^\s*/)[0];if(n||/\S/.test(a.text)){if("smart"==i&&((c=s.mode.indent(r,a.text.slice(h.length),a.text))==P||150<c)){if(!n)return;i="prev"}}else c=0,i="not";"prev"==i?c=e>s.first?O(Xt(s,e-1).text,null,o):0:"add"==i?c=l+t.options.indentUnit:"subtract"==i?c=l-t.options.indentUnit:"number"==typeof i&&(c=l+i),c=Math.max(0,c);var d="",u=0;if(t.options.indentWithTabs)for(var p=Math.floor(c/o);p;--p)u+=o,d+="\t";if(u<c&&(d+=q(c-u)),d!=h)return Yr(s,d,ne(e,0),ne(e,h.length),"+input"),!(a.stateAfter=null);for(var f=0;f<s.sel.ranges.length;f++){var g=s.sel.ranges[f];if(g.head.line==e&&g.head.ch<h.length){g=ne(e,h.length);Mr(s,f,new sr(g,g));break}}}co.defineInitHook=function(t){return ho.push(t)};var po=null;function fo(t){po=t}function go(t,e,i,n,r){var s=t.doc;t.display.shift=!1,n=n||s.sel;var o=+new Date-200,a="paste"==r||t.state.pasteIncoming>o,l=Ft(e),c=null;if(a&&1<n.ranges.length)if(po&&po.text.join("\n")==e){if(n.ranges.length%po.text.length==0){c=[];for(var h=0;h<po.text.length;h++)c.push(s.splitLines(po.text[h]))}}else l.length==n.ranges.length&&t.options.pasteLinesPerSelection&&(c=G(l,function(t){return[t]}));for(var d=t.curOp.updateInput,u=n.ranges.length-1;0<=u;u--){var p=n.ranges[u],f=p.from(),g=p.to();p.empty()&&(i&&0<i?f=ne(f.line,f.ch-i):t.state.overwrite&&!a?g=ne(g.line,Math.min(Xt(s,g.line).text.length,g.ch+V(l).length)):a&&po&&po.lineWise&&po.text.join("\n")==l.join("\n")&&(f=g=ne(f.line,0)));g={from:f,to:g,text:c?c[u%c.length]:l,origin:r||(a?"paste":t.state.cutIncoming>o?"cut":"+input")};Kr(t.doc,g),si(t,"inputRead",t,g)}e&&!a&&vo(t,e),_n(t),t.curOp.updateInput<2&&(t.curOp.updateInput=d),t.curOp.typing=!0,t.state.pasteIncoming=t.state.cutIncoming=-1}function mo(t,e){var i=t.clipboardData&&t.clipboardData.getData("Text");return i&&(t.preventDefault(),e.isReadOnly()||e.options.disableInput||Fn(e,function(){return go(e,i,0,null,"paste")}),1)}function vo(t,e){if(t.options.electricChars&&t.options.smartIndent)for(var i=t.doc.sel,n=i.ranges.length-1;0<=n;n--){var r=i.ranges[n];if(!(100<r.head.ch||n&&i.ranges[n-1].head.line==r.head.line)){var s=t.getModeAt(r.head),o=!1;if(s.electricChars){for(var a=0;a<s.electricChars.length;a++)if(-1<e.indexOf(s.electricChars.charAt(a))){o=uo(t,r.head.line,"smart");break}}else s.electricInput&&s.electricInput.test(Xt(t.doc,r.head.line).text.slice(0,r.head.ch))&&(o=uo(t,r.head.line,"smart"));o&&si(t,"electricInput",t,r.head.line)}}}function bo(t){for(var e=[],i=[],n=0;n<t.doc.sel.ranges.length;n++){var r=t.doc.sel.ranges[n].head.line,r={anchor:ne(r,0),head:ne(r+1,0)};i.push(r),e.push(t.getRange(r.anchor,r.head))}return{text:e,ranges:i}}function yo(t,e,i,n){t.setAttribute("autocorrect",i?"":"off"),t.setAttribute("autocapitalize",n?"":"off"),t.setAttribute("spellcheck",!!e)}function _o(){var t=E("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; min-height: 1em; outline: none"),e=E("div",[t],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return p?t.style.width="1000px":t.setAttribute("wrap","off"),a&&(t.style.border="1px solid black"),yo(t),e}function xo(r,s,o,a,l){var t=s,e=o,c=Xt(r,s.line),h=l&&"rtl"==r.direction?-o:o;function i(t){var e,i,n;if(null==(i="codepoint"==a?(e=c.text.charCodeAt(s.ch+(0<o?0:-1)),isNaN(e)?null:(i=0<o?55296<=e&&e<56320:56320<=e&&e<57343,new ne(s.line,Math.max(0,Math.min(c.text.length,s.ch+o*(i?2:1))),-o))):l?Os(r.cm,c,s,o):Is(c,s,o))){if(t||(n=s.line+h)<r.first||n>=r.first+r.size||(s=new ne(n,s.ch,s.sticky),!(c=Xt(r,n))))return;s=Fs(l,r.cm,c,s.line,h)}else s=i;return 1}if("char"==a||"codepoint"==a)i();else if("column"==a)i(!0);else if("word"==a||"group"==a)for(var n=null,d="group"==a,u=r.cm&&r.cm.getHelper(s,"wordChars"),p=!0;!(o<0)||i(!p);p=!1){var f=c.text.charAt(s.ch)||"\n",f=J(f,u)?"w":d&&"\n"==f?"n":!d||/\s/.test(f)?null:"p";if(!d||p||f||(f="s"),n&&n!=f){o<0&&(o=1,i(),s.sticky="after");break}if(f&&(n=f),0<o&&!i(!p))break}e=Wr(r,s,t,e,!0);return se(t,e)&&(e.hitSide=!0),e}function Co(t,e,i,n){var r,s,o,a=t.doc,l=e.left;for("page"==n?(r=Math.min(t.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),r=Math.max(r-.5*qi(t.display),3),s=(0<i?e.bottom:e.top)+i*r):"line"==n&&(s=0<i?e.bottom+3:e.top-3);(o=zi(t,l,s)).outside;){if(i<0?s<=0:s>=a.height){o.hitSide=!0;break}s+=5*i}return o}t=function(t){this.cm=t,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new B,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};function wo(t,e){var i=ki(t,e.line);if(!i||i.hidden)return null;var n=Xt(t.doc,e.line),i=Ci(i,n,e.line),n=mt(n,t.doc.direction),t="left";n&&(t=ot(n,e.ch)%2?"right":"left");t=Ai(i.map,e.ch,t);return t.offset="right"==t.collapse?t.end:t.start,t}function ko(t,e){return e&&(t.bad=!0),t}function To(t,e,i){var n;if(e==t.display.lineDiv){if(!(n=t.display.lineDiv.childNodes[i]))return ko(t.clipPos(ne(t.display.viewTo-1)),!0);e=null,i=0}else for(n=e;;n=n.parentNode){if(!n||n==t.display.lineDiv)return null;if(n.parentNode&&n.parentNode==t.display.lineDiv)break}for(var r=0;r<t.display.view.length;r++){var s=t.display.view[r];if(s.node==n)return function(c,t,e){var i=c.text.firstChild,n=!1;if(!t||!A(i,t))return ko(ne(Jt(c.line),0),!0);if(t==i&&(n=!0,t=i.childNodes[e],e=0,!t)){var r=c.rest?V(c.rest):c.line;return ko(ne(Jt(r),r.text.length),n)}var r=3==t.nodeType?t:null,s=t;r||1!=t.childNodes.length||3!=t.firstChild.nodeType||(r=t.firstChild,e=e&&r.nodeValue.length);for(;s.parentNode!=i;)s=s.parentNode;var h=c.measure,d=h.maps;function o(t,e,i){for(var n=-1;n<(d?d.length:0);n++)for(var r=n<0?h.map:d[n],s=0;s<r.length;s+=3){var o=r[s+2];if(o==t||o==e){var a=Jt(n<0?c.line:c.rest[n]),l=r[s]+i;return(i<0||o!=t)&&(l=r[s+(i?1:0)]),ne(a,l)}}}var a=o(r,s,e);if(a)return ko(a,n);for(var l=s.nextSibling,u=r?r.nodeValue.length-e:0;l;l=l.nextSibling){if(a=o(l,l.firstChild,0))return ko(ne(a.line,a.ch-u),n);u+=l.textContent.length}for(var p=s.previousSibling,f=e;p;p=p.previousSibling){if(a=o(p,p.firstChild,-1))return ko(ne(a.line,a.ch+f),n);f+=p.textContent.length}}(s,e,i)}}t.prototype.init=function(t){var e=this,s=this,o=s.cm,a=s.div=t.lineDiv;function l(t){for(var e=t.target;e;e=e.parentNode){if(e==a)return 1;if(/\bCodeMirror-(?:line)?widget\b/.test(e.className))break}}function i(t){if(l(t)&&!Ct(o,t)){if(o.somethingSelected())fo({lineWise:!1,text:o.getSelections()}),"cut"==t.type&&o.replaceSelection("",null,"cut");else{if(!o.options.lineWiseCopyCut)return;var e=bo(o);fo({lineWise:!0,text:e.text}),"cut"==t.type&&o.operation(function(){o.setSelections(e.ranges,0,W),o.replaceSelection("",null,"cut")})}if(t.clipboardData){t.clipboardData.clearData();var i=po.text.join("\n");if(t.clipboardData.setData("Text",i),t.clipboardData.getData("Text")==i)return void t.preventDefault()}var n=_o(),t=n.firstChild;o.display.lineSpace.insertBefore(n,o.display.lineSpace.firstChild),t.value=po.text.join("\n");var r=N();D(t),setTimeout(function(){o.display.lineSpace.removeChild(n),r.focus(),r==a&&s.showPrimarySelection()},50)}}a.contentEditable=!0,yo(a,o.options.spellcheck,o.options.autocorrect,o.options.autocapitalize),bt(a,"paste",function(t){!l(t)||Ct(o,t)||mo(t,o)||v<=11&&setTimeout(On(o,function(){return e.updateFromDOM()}),20)}),bt(a,"compositionstart",function(t){e.composing={data:t.data,done:!1}}),bt(a,"compositionupdate",function(t){e.composing||(e.composing={data:t.data,done:!1})}),bt(a,"compositionend",function(t){e.composing&&(t.data!=e.composing.data&&e.readFromDOMSoon(),e.composing.done=!0)}),bt(a,"touchstart",function(){return s.forceCompositionEnd()}),bt(a,"input",function(){e.composing||e.readFromDOMSoon()}),bt(a,"copy",i),bt(a,"cut",i)},t.prototype.screenReaderLabelChanged=function(t){t?this.div.setAttribute("aria-label",t):this.div.removeAttribute("aria-label")},t.prototype.prepareSelection=function(){var t=an(this.cm,!1);return t.focus=N()==this.div,t},t.prototype.showSelection=function(t,e){t&&this.cm.display.view.length&&((t.focus||e)&&this.showPrimarySelection(),this.showMultipleSelections(t))},t.prototype.getSelection=function(){return this.cm.display.wrapper.ownerDocument.getSelection()},t.prototype.showPrimarySelection=function(){var t=this.getSelection(),e=this.cm,i=e.doc.sel.primary(),n=i.from(),r=i.to();if(e.display.viewTo==e.display.viewFrom||n.line>=e.display.viewTo||r.line<e.display.viewFrom)t.removeAllRanges();else{var s=To(e,t.anchorNode,t.anchorOffset),i=To(e,t.focusNode,t.focusOffset);if(!s||s.bad||!i||i.bad||0!=re(le(s,i),n)||0!=re(ae(s,i),r)){var i=e.display.view,o=n.line>=e.display.viewFrom&&wo(e,n)||{node:i[0].measure.map[2],offset:0},a=r.line<e.display.viewTo&&wo(e,r);if(a||(a={node:(c=(c=i[i.length-1].measure).maps?c.maps[c.maps.length-1]:c.map)[c.length-1],offset:c[c.length-2]-c[c.length-3]}),o&&a){var l,c=t.rangeCount&&t.getRangeAt(0);try{l=w(o.node,o.offset,a.offset,a.node)}catch(t){}l&&(!u&&e.state.focused?(t.collapse(o.node,o.offset),l.collapsed||(t.removeAllRanges(),t.addRange(l))):(t.removeAllRanges(),t.addRange(l)),c&&null==t.anchorNode?t.addRange(c):u&&this.startGracePeriod()),this.rememberSelection()}else t.removeAllRanges()}}},t.prototype.startGracePeriod=function(){var t=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){t.gracePeriod=!1,t.selectionChanged()&&t.cm.operation(function(){return t.cm.curOp.selectionChanged=!0})},20)},t.prototype.showMultipleSelections=function(t){S(this.cm.display.cursorDiv,t.cursors),S(this.cm.display.selectionDiv,t.selection)},t.prototype.rememberSelection=function(){var t=this.getSelection();this.lastAnchorNode=t.anchorNode,this.lastAnchorOffset=t.anchorOffset,this.lastFocusNode=t.focusNode,this.lastFocusOffset=t.focusOffset},t.prototype.selectionInEditor=function(){var t=this.getSelection();if(!t.rangeCount)return!1;t=t.getRangeAt(0).commonAncestorContainer;return A(this.div,t)},t.prototype.focus=function(){"nocursor"!=this.cm.options.readOnly&&(this.selectionInEditor()&&N()==this.div||this.showSelection(this.prepareSelection(),!0),this.div.focus())},t.prototype.blur=function(){this.div.blur()},t.prototype.getField=function(){return this.div},t.prototype.supportsTouch=function(){return!0},t.prototype.receivedFocus=function(){var t=this,e=this;this.selectionInEditor()?setTimeout(function(){return t.pollSelection()},20):Fn(this.cm,function(){return e.cm.curOp.selectionChanged=!0}),this.polling.set(this.cm.options.pollInterval,function t(){e.cm.state.focused&&(e.pollSelection(),e.polling.set(e.cm.options.pollInterval,t))})},t.prototype.selectionChanged=function(){var t=this.getSelection();return t.anchorNode!=this.lastAnchorNode||t.anchorOffset!=this.lastAnchorOffset||t.focusNode!=this.lastFocusNode||t.focusOffset!=this.lastFocusOffset},t.prototype.pollSelection=function(){if(null==this.readDOMTimeout&&!this.gracePeriod&&this.selectionChanged()){var t,e,i=this.getSelection(),n=this.cm;if(l&&s&&this.cm.display.gutterSpecs.length&&function(t){for(var e=t;e;e=e.parentNode)if(/CodeMirror-gutter-wrapper/.test(e.className))return!0;return!1}(i.anchorNode))return this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),void this.focus();this.composing||(this.rememberSelection(),t=To(n,i.anchorNode,i.anchorOffset),e=To(n,i.focusNode,i.focusOffset),t&&e&&Fn(n,function(){Fr(n.doc,ar(t,e),W),(t.bad||e.bad)&&(n.curOp.selectionChanged=!0)}))}},t.prototype.pollContent=function(){null!=this.readDOMTimeout&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var t,e=this.cm,i=e.display,n=e.doc.sel.primary(),r=n.from(),n=n.to();if(0==r.ch&&r.line>e.firstLine()&&(r=ne(r.line-1,Xt(e.doc,r.line-1).length)),n.ch==Xt(e.doc,n.line).text.length&&n.line<e.lastLine()&&(n=ne(n.line+1,0)),r.line<i.viewFrom||n.line>i.viewTo-1)return!1;m=r.line==i.viewFrom||0==(m=Ji(e,r.line))?(t=Jt(i.view[0].line),i.view[0].node):(t=Jt(i.view[m].line),i.view[m-1].node.nextSibling);var s,n=Ji(e,n.line),n=n==i.view.length-1?(s=i.viewTo-1,i.lineDiv.lastChild):(s=Jt(i.view[n+1].line)-1,i.view[n+1].node.previousSibling);if(!m)return!1;for(var o=e.doc.splitLines(function(o,t,e,a,l){var i="",c=!1,h=o.doc.lineSeparator(),d=!1;function u(){c&&(i+=h,d&&(i+=h),c=d=!1)}function p(t){t&&(u(),i+=t)}for(;!function t(e){if(1==e.nodeType){var i=e.getAttribute("cm-text");if(i)p(i);else if(i=e.getAttribute("cm-marker"))(i=o.findMarks(ne(a,0),ne(l+1,0),(s=+i,function(t){return t.id==s}))).length&&(n=i[0].find(0))&&p(Yt(o.doc,n.from,n.to).join(h));else if("false"!=e.getAttribute("contenteditable")){var n=/^(pre|div|p|li|table|br)$/i.test(e.nodeName);if(/^br$/i.test(e.nodeName)||0!=e.textContent.length){n&&u();for(var r=0;r<e.childNodes.length;r++)t(e.childNodes[r]);/^(pre|p)$/i.test(e.nodeName)&&(d=!0),n&&(c=!0)}}}else 3==e.nodeType&&p(e.nodeValue.replace(/\u200b/g,"").replace(/\u00a0/g," "));var s}(t),t!=e;)t=t.nextSibling,d=!1;return i}(e,m,n,t,s)),a=Yt(e.doc,ne(t,0),ne(s,Xt(e.doc,s).text.length));1<o.length&&1<a.length;)if(V(o)==V(a))o.pop(),a.pop(),s--;else{if(o[0]!=a[0])break;o.shift(),a.shift(),t++}for(var l=0,c=0,h=o[0],d=a[0],u=Math.min(h.length,d.length);l<u&&h.charCodeAt(l)==d.charCodeAt(l);)++l;for(var p=V(o),f=V(a),g=Math.min(p.length-(1==o.length?l:0),f.length-(1==a.length?l:0));c<g&&p.charCodeAt(p.length-c-1)==f.charCodeAt(f.length-c-1);)++c;if(1==o.length&&1==a.length&&t==r.line)for(;l&&l>r.ch&&p.charCodeAt(p.length-c-1)==f.charCodeAt(f.length-c-1);)l--,c++;o[o.length-1]=p.slice(0,p.length-c).replace(/^\u200b+/,""),o[0]=o[0].slice(l).replace(/\u200b+$/,"");var m=ne(t,l),n=ne(s,a.length?V(a).length-c:0);return 1<o.length||o[0]||re(m,n)?(Yr(e.doc,o,m,n,"+input"),!0):void 0},t.prototype.ensurePolled=function(){this.forceCompositionEnd()},t.prototype.reset=function(){this.forceCompositionEnd()},t.prototype.forceCompositionEnd=function(){this.composing&&(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},t.prototype.readFromDOMSoon=function(){var t=this;null==this.readDOMTimeout&&(this.readDOMTimeout=setTimeout(function(){if(t.readDOMTimeout=null,t.composing){if(!t.composing.done)return;t.composing=null}t.updateFromDOM()},80))},t.prototype.updateFromDOM=function(){var t=this;!this.cm.isReadOnly()&&this.pollContent()||Fn(this.cm,function(){return tn(t.cm)})},t.prototype.setUneditable=function(t){t.contentEditable="false"},t.prototype.onKeyPress=function(t){0==t.charCode||this.composing||(t.preventDefault(),this.cm.isReadOnly()||On(this.cm,go)(this.cm,String.fromCharCode(null==t.charCode?t.keyCode:t.charCode),0))},t.prototype.readOnlyChanged=function(t){this.div.contentEditable=String("nocursor"!=t)},t.prototype.onContextMenu=function(){},t.prototype.resetPosition=function(){},t.prototype.needsContentAttribute=!0;var So,Eo,Lo,Ao,No,n=function(t){this.cm=t,this.prevInput="",this.pollingFast=!1,this.polling=new B,this.hasSelection=!1,this.composing=null};function $o(t,e,n,i){So.defaults[t]=e,n&&(Eo[t]=i?function(t,e,i){i!=ro&&n(t,e,i)}:n)}n.prototype.init=function(i){var t=this,n=this,r=this.cm;this.createField(i);var s=this.textarea;function e(t){if(!Ct(r,t)){if(r.somethingSelected())fo({lineWise:!1,text:r.getSelections()});else{if(!r.options.lineWiseCopyCut)return;var e=bo(r);fo({lineWise:!0,text:e.text}),"cut"==t.type?r.setSelections(e.ranges,null,W):(n.prevInput="",s.value=e.text.join("\n"),D(s))}"cut"==t.type&&(r.state.cutIncoming=+new Date)}}i.wrapper.insertBefore(this.wrapper,i.wrapper.firstChild),a&&(s.style.width="0px"),bt(s,"input",function(){_&&9<=v&&t.hasSelection&&(t.hasSelection=null),n.poll()}),bt(s,"paste",function(t){Ct(r,t)||mo(t,r)||(r.state.pasteIncoming=+new Date,n.fastPoll())}),bt(s,"cut",e),bt(s,"copy",e),bt(i.scroller,"paste",function(t){if(!gi(i,t)&&!Ct(r,t)){if(!s.dispatchEvent)return r.state.pasteIncoming=+new Date,void n.focus();var e=new Event("paste");e.clipboardData=t.clipboardData,s.dispatchEvent(e)}}),bt(i.lineSpace,"selectstart",function(t){gi(i,t)||St(t)}),bt(s,"compositionstart",function(){var t=r.getCursor("from");n.composing&&n.composing.range.clear(),n.composing={start:t,range:r.markText(t,r.getCursor("to"),{className:"CodeMirror-composing"})}}),bt(s,"compositionend",function(){n.composing&&(n.poll(),n.composing.range.clear(),n.composing=null)})},n.prototype.createField=function(t){this.wrapper=_o(),this.textarea=this.wrapper.firstChild},n.prototype.screenReaderLabelChanged=function(t){t?this.textarea.setAttribute("aria-label",t):this.textarea.removeAttribute("aria-label")},n.prototype.prepareSelection=function(){var t,e=this.cm,i=e.display,n=e.doc,r=an(e);return e.options.moveInputWithCursor&&(t=Ri(e,n.sel.primary().head,"div"),e=i.wrapper.getBoundingClientRect(),n=i.lineDiv.getBoundingClientRect(),r.teTop=Math.max(0,Math.min(i.wrapper.clientHeight-10,t.top+n.top-e.top)),r.teLeft=Math.max(0,Math.min(i.wrapper.clientWidth-10,t.left+n.left-e.left))),r},n.prototype.showSelection=function(t){var e=this.cm.display;S(e.cursorDiv,t.cursors),S(e.selectionDiv,t.selection),null!=t.teTop&&(this.wrapper.style.top=t.teTop+"px",this.wrapper.style.left=t.teLeft+"px")},n.prototype.reset=function(t){var e,i;this.contextMenuPending||this.composing||((e=this.cm).somethingSelected()?(this.prevInput="",i=e.getSelection(),this.textarea.value=i,e.state.focused&&D(this.textarea),_&&9<=v&&(this.hasSelection=i)):t||(this.prevInput=this.textarea.value="",_&&9<=v&&(this.hasSelection=null)))},n.prototype.getField=function(){return this.textarea},n.prototype.supportsTouch=function(){return!1},n.prototype.focus=function(){if("nocursor"!=this.cm.options.readOnly&&(!d||N()!=this.textarea))try{this.textarea.focus()}catch(t){}},n.prototype.blur=function(){this.textarea.blur()},n.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},n.prototype.receivedFocus=function(){this.slowPoll()},n.prototype.slowPoll=function(){var t=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){t.poll(),t.cm.state.focused&&t.slowPoll()})},n.prototype.fastPoll=function(){var e=!1,i=this;i.pollingFast=!0,i.polling.set(20,function t(){i.poll()||e?(i.pollingFast=!1,i.slowPoll()):(e=!0,i.polling.set(60,t))})},n.prototype.poll=function(){var t=this,e=this.cm,i=this.textarea,n=this.prevInput;if(this.contextMenuPending||!e.state.focused||Ot(i)&&!n&&!this.composing||e.isReadOnly()||e.options.disableInput||e.state.keySeq)return!1;var r=i.value;if(r==n&&!e.somethingSelected())return!1;if(_&&9<=v&&this.hasSelection===r||g&&/[\uf700-\uf7ff]/.test(r))return e.display.input.reset(),!1;if(e.doc.sel==e.display.selForContextMenu){var s=r.charCodeAt(0);if(8203!=s||n||(n="​"),8666==s)return this.reset(),this.cm.execCommand("undo")}for(var o=0,a=Math.min(n.length,r.length);o<a&&n.charCodeAt(o)==r.charCodeAt(o);)++o;return Fn(e,function(){go(e,r.slice(o),n.length-o,null,t.composing?"*compose":null),1e3<r.length||-1<r.indexOf("\n")?i.value=t.prevInput="":t.prevInput=r,t.composing&&(t.composing.range.clear(),t.composing.range=e.markText(t.composing.start,e.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},n.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},n.prototype.onKeyPress=function(){_&&9<=v&&(this.hasSelection=null),this.fastPoll()},n.prototype.onContextMenu=function(t){var i=this,n=i.cm,r=n.display,s=i.textarea;i.contextMenuPending&&i.contextMenuPending();var o,a,e,l,c=Zi(n,t),h=r.scroller.scrollTop;function d(){var t,e;null!=s.selectionStart&&(e="​"+((t=n.somethingSelected())?s.value:""),s.value="⇚",s.value=e,i.prevInput=t?"":"​",s.selectionStart=1,s.selectionEnd=e.length,r.selForContextMenu=n.doc.sel)}function u(){var t,e;i.contextMenuPending==u&&(i.contextMenuPending=!1,i.wrapper.style.cssText=a,s.style.cssText=o,_&&v<9&&r.scrollbars.setScrollTop(r.scroller.scrollTop=h),null!=s.selectionStart&&((!_||_&&v<9)&&d(),t=0,e=function(){r.selForContextMenu==n.doc.sel&&0==s.selectionStart&&0<s.selectionEnd&&"​"==i.prevInput?On(n,jr)(n):t++<10?r.detectingSelectAll=setTimeout(e,500):(r.selForContextMenu=null,r.input.reset())},r.detectingSelectAll=setTimeout(e,200)))}c&&!f&&(n.options.resetSelectionOnContextMenu&&-1==n.doc.sel.contains(c)&&On(n,Fr)(n.doc,ar(c),W),o=s.style.cssText,a=i.wrapper.style.cssText,c=i.wrapper.offsetParent.getBoundingClientRect(),i.wrapper.style.cssText="position: static",s.style.cssText="position: absolute; width: 30px; height: 30px;\n      top: "+(t.clientY-c.top-5)+"px; left: "+(t.clientX-c.left-5)+"px;\n      z-index: 1000; background: "+(_?"rgba(255, 255, 255, .05)":"transparent")+";\n      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);",p&&(e=window.scrollY),r.input.focus(),p&&window.scrollTo(null,e),r.input.reset(),n.somethingSelected()||(s.value=i.prevInput=" "),i.contextMenuPending=u,r.selForContextMenu=n.doc.sel,clearTimeout(r.detectingSelectAll),_&&9<=v&&d(),x?(At(t),l=function(){_t(window,"mouseup",l),setTimeout(u,20)},bt(window,"mouseup",l)):setTimeout(u,50))},n.prototype.readOnlyChanged=function(t){t||this.reset(),this.textarea.disabled="nocursor"==t,this.textarea.readOnly=!!t},n.prototype.setUneditable=function(){},n.prototype.needsContentAttribute=!1,Eo=(So=co).optionHandlers,So.defineOption=$o,So.Init=ro,$o("value","",function(t,e){return t.setValue(e)},!0),$o("mode",null,function(t,e){t.doc.modeOption=e,ur(t)},!0),$o("indentUnit",2,ur,!0),$o("indentWithTabs",!1),$o("smartIndent",!0),$o("tabSize",4,function(t){pr(t),Mi(t),tn(t)},!0),$o("lineSeparator",null,function(t,n){if(t.doc.lineSep=n){var r=[],s=t.doc.first;t.doc.iter(function(t){for(var e=0;;){var i=t.text.indexOf(n,e);if(-1==i)break;e=i+n.length,r.push(ne(s,i))}s++});for(var e=r.length-1;0<=e;e--)Yr(t.doc,n,r[e],ne(r[e].line,r[e].ch+n.length))}}),$o("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b\u200e\u200f\u2028\u2029\ufeff\ufff9-\ufffc]/g,function(t,e,i){t.state.specialChars=new RegExp(e.source+(e.test("\t")?"":"|\t"),"g"),i!=ro&&t.refresh()}),$o("specialCharPlaceholder",Qe,function(t){return t.refresh()},!0),$o("electricChars",!0),$o("inputStyle",d?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),$o("spellcheck",!1,function(t,e){return t.getInputField().spellcheck=e},!0),$o("autocorrect",!1,function(t,e){return t.getInputField().autocorrect=e},!0),$o("autocapitalize",!1,function(t,e){return t.getInputField().autocapitalize=e},!0),$o("rtlMoveVisually",!b),$o("wholeLineUpdateBefore",!0),$o("theme","default",function(t){no(t),Qn(t)},!0),$o("keyMap","default",function(t,e,i){e=$s(e),i=i!=ro&&$s(i);i&&i.detach&&i.detach(t,e),e.attach&&e.attach(t,i||null)}),$o("extraKeys",null),$o("configureMouse",null),$o("lineWrapping",!1,lo,!0),$o("gutters",[],function(t,e){t.display.gutterSpecs=Xn(e,t.options.lineNumbers),Qn(t)},!0),$o("fixedGutter",!0,function(t,e){t.display.gutters.style.left=e?Xi(t.display)+"px":"0",t.refresh()},!0),$o("coverGutterNextToScrollbar",!1,function(t){return Ln(t)},!0),$o("scrollbarStyle","native",function(t){$n(t),Ln(t),t.display.scrollbars.setScrollTop(t.doc.scrollTop),t.display.scrollbars.setScrollLeft(t.doc.scrollLeft)},!0),$o("lineNumbers",!1,function(t,e){t.display.gutterSpecs=Xn(t.options.gutters,e),Qn(t)},!0),$o("firstLineNumber",1,Qn,!0),$o("lineNumberFormatter",function(t){return t},Qn,!0),$o("showCursorWhenSelecting",!1,on,!0),$o("resetSelectionOnContextMenu",!0),$o("lineWiseCopyCut",!0),$o("pasteLinesPerSelection",!0),$o("selectionsMayTouch",!1),$o("readOnly",!1,function(t,e){"nocursor"==e&&(fn(t),t.display.input.blur()),t.display.input.readOnlyChanged(e)}),$o("screenReaderLabel",null,function(t,e){e=""===e?null:e,t.display.input.screenReaderLabelChanged(e)}),$o("disableInput",!1,function(t,e){e||t.display.input.reset()},!0),$o("dragDrop",!0,ao),$o("allowDropFileTypes",null),$o("cursorBlinkRate",530),$o("cursorScrollMargin",0),$o("cursorHeight",1,on,!0),$o("singleCursorHeightPerLine",!0,on,!0),$o("workTime",100),$o("workDelay",100),$o("flattenSpans",!0,pr,!0),$o("addModeClass",!1,pr,!0),$o("pollInterval",100),$o("undoDepth",200,function(t,e){return t.doc.history.undoDepth=e}),$o("historyEventDelay",1250),$o("viewportMargin",10,function(t){return t.refresh()},!0),$o("maxHighlightLength",1e4,pr,!0),$o("moveInputWithCursor",!0,function(t,e){e||t.display.input.resetPosition()}),$o("tabindex",null,function(t,e){return t.display.input.getField().tabIndex=e||""}),$o("autofocus",null),$o("direction","ltr",function(t,e){return t.doc.setDirection(e)},!0),$o("phrases",null),Ao=(Lo=co).optionHandlers,No=Lo.helpers={},Lo.prototype={constructor:Lo,focus:function(){window.focus(),this.display.input.focus()},setOption:function(t,e){var i=this.options,n=i[t];i[t]==e&&"mode"!=t||(i[t]=e,Ao.hasOwnProperty(t)&&On(this,Ao[t])(this,e,n),xt(this,"optionChange",this,t))},getOption:function(t){return this.options[t]},getDoc:function(){return this.doc},addKeyMap:function(t,e){this.state.keyMaps[e?"push":"unshift"]($s(t))},removeKeyMap:function(t){for(var e=this.state.keyMaps,i=0;i<e.length;++i)if(e[i]==t||e[i].name==t)return e.splice(i,1),!0},addOverlay:Bn(function(t,e){var i=t.token?t:Lo.getMode(this.options,t);if(i.startState)throw new Error("Overlays may not be stateful.");!function(t,e,i){for(var n=0,r=i(e);n<t.length&&i(t[n])<=r;)n++;t.splice(n,0,e)}(this.state.overlays,{mode:i,modeSpec:t,opaque:e&&e.opaque,priority:e&&e.priority||0},function(t){return t.priority}),this.state.modeGen++,tn(this)}),removeOverlay:Bn(function(t){for(var e=this.state.overlays,i=0;i<e.length;++i){var n=e[i].modeSpec;if(n==t||"string"==typeof t&&n.name==t)return e.splice(i,1),this.state.modeGen++,void tn(this)}}),indentLine:Bn(function(t,e,i){"string"!=typeof e&&"number"!=typeof e&&(e=null==e?this.options.smartIndent?"smart":"prev":e?"add":"subtract"),ee(this.doc,t)&&uo(this,t,e,i)}),indentSelection:Bn(function(t){for(var e=this.doc.sel.ranges,i=-1,n=0;n<e.length;n++){var r=e[n];if(r.empty())r.head.line>i&&(uo(this,r.head.line,t,!0),i=r.head.line,n==this.doc.sel.primIndex&&_n(this));else{for(var s=r.from(),o=r.to(),r=Math.max(i,s.line),i=Math.min(this.lastLine(),o.line-(o.ch?0:1))+1,a=r;a<i;++a)uo(this,a,t);r=this.doc.sel.ranges;0==s.ch&&e.length==r.length&&0<r[n].from().ch&&Mr(this.doc,n,new sr(s,r[n].to()),W)}}}),getTokenAt:function(t,e){return xe(this,t,e)},getLineTokens:function(t,e){return xe(this,ne(t),e,!0)},getTokenTypeAt:function(t){t=he(this.doc,t);var e,i=ge(this,Xt(this.doc,t.line)),n=0,r=(i.length-1)/2,s=t.ch;if(0==s)e=i[2];else for(;;){var o=n+r>>1;if((o?i[2*o-1]:0)>=s)r=o;else{if(!(i[2*o+1]<s)){e=i[2*o+2];break}n=1+o}}t=e?e.indexOf("overlay "):-1;return t<0?e:0==t?null:e.slice(0,t-1)},getModeAt:function(t){var e=this.doc.mode;return e.innerMode?Lo.innerMode(e,this.getTokenAt(t).state).mode:e},getHelper:function(t,e){return this.getHelpers(t,e)[0]},getHelpers:function(t,e){var i=[];if(!No.hasOwnProperty(e))return i;var n=No[e],r=this.getModeAt(t);if("string"==typeof r[e])n[r[e]]&&i.push(n[r[e]]);else if(r[e])for(var s=0;s<r[e].length;s++){var o=n[r[e][s]];o&&i.push(o)}else r.helperType&&n[r.helperType]?i.push(n[r.helperType]):n[r.name]&&i.push(n[r.name]);for(var a=0;a<n._global.length;a++){var l=n._global[a];l.pred(r,this)&&-1==H(i,l.val)&&i.push(l.val)}return i},getStateAfter:function(t,e){var i=this.doc;return me(this,(t=ce(i,null==t?i.first+i.size-1:t))+1,e).state},cursorCoords:function(t,e){var i=this.doc.sel.primary(),i=null==t?i.head:"object"==typeof t?he(this.doc,t):t?i.from():i.to();return Ri(this,i,e||"page")},charCoords:function(t,e){return Hi(this,he(this.doc,t),e||"page")},coordsChar:function(t,e){return zi(this,(t=Bi(this,t,e||"page")).left,t.top)},lineAtHeight:function(t,e){return t=Bi(this,{top:t,left:0},e||"page").top,te(this.doc,t+this.display.viewOffset)},heightAtLine:function(t,e,i){var n,r=!1,t="number"==typeof t?(n=this.doc.first+this.doc.size-1,t<this.doc.first?t=this.doc.first:n<t&&(t=n,r=!0),Xt(this.doc,t)):t;return Oi(this,t,{top:0,left:0},e||"page",i||r).top+(r?this.doc.height-je(t):0)},defaultTextHeight:function(){return qi(this.display)},defaultCharWidth:function(){return Vi(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(t,e,i,n,r){var s,o,a=this.display,l=(t=Ri(this,he(this.doc,t))).bottom,c=t.left;e.style.position="absolute",e.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(e),a.sizer.appendChild(e),"over"==n?l=t.top:"above"!=n&&"near"!=n||(s=Math.max(a.wrapper.clientHeight,this.doc.height),o=Math.max(a.sizer.clientWidth,a.lineSpace.clientWidth),("above"==n||t.bottom+e.offsetHeight>s)&&t.top>e.offsetHeight?l=t.top-e.offsetHeight:t.bottom+e.offsetHeight<=s&&(l=t.bottom),c+e.offsetWidth>o&&(c=o-e.offsetWidth)),e.style.top=l+"px",e.style.left=e.style.right="","right"==r?(c=a.sizer.clientWidth-e.offsetWidth,e.style.right="0px"):("left"==r?c=0:"middle"==r&&(c=(a.sizer.clientWidth-e.offsetWidth)/2),e.style.left=c+"px"),i&&(i=this,e={left:c,top:l,right:c+e.offsetWidth,bottom:l+e.offsetHeight},null!=(e=bn(i,e)).scrollTop&&kn(i,e.scrollTop),null!=e.scrollLeft&&Sn(i,e.scrollLeft))},triggerOnKeyDown:Bn(qs),triggerOnKeyPress:Bn(Gs),triggerOnKeyUp:Vs,triggerOnMouseDown:Bn(Zs),execCommand:function(t){if(Bs.hasOwnProperty(t))return Bs[t].call(null,this)},triggerElectric:Bn(function(t){vo(this,t)}),findPosH:function(t,e,i,n){var r=1;e<0&&(r=-1,e=-e);for(var s=he(this.doc,t),o=0;o<e&&!(s=xo(this.doc,s,r,i,n)).hitSide;++o);return s},moveH:Bn(function(e,i){var n=this;this.extendSelectionsBy(function(t){return n.display.shift||n.doc.extend||t.empty()?xo(n.doc,t.head,e,i,n.options.rtlMoveVisually):e<0?t.from():t.to()},j)}),deleteH:Bn(function(i,n){var t=this.doc.sel,r=this.doc;t.somethingSelected()?r.replaceSelection("",null,"+delete"):Ms(this,function(t){var e=xo(r,t.head,i,n,!1);return i<0?{from:e,to:t.head}:{from:t.head,to:e}})}),findPosV:function(t,e,i,n){var r=1,s=n;e<0&&(r=-1,e=-e);for(var o=he(this.doc,t),a=0;a<e;++a){var l=Ri(this,o,"div");if(null==s?s=l.left:l.left=s,(o=Co(this,l,r,i)).hitSide)break}return o},moveV:Bn(function(n,r){var s=this,o=this.doc,a=[],l=!this.display.shift&&!o.extend&&o.sel.somethingSelected();if(o.extendSelectionsBy(function(t){if(l)return n<0?t.from():t.to();var e=Ri(s,t.head,"div");null!=t.goalColumn&&(e.left=t.goalColumn),a.push(e.left);var i=Co(s,e,n,r);return"page"==r&&t==o.sel.primary()&&yn(s,Hi(s,i,"div").top-e.top),i},j),a.length)for(var t=0;t<o.sel.ranges.length;t++)o.sel.ranges[t].goalColumn=a[t]}),findWordAt:function(t){var e=Xt(this.doc,t.line).text,i=t.ch,n=t.ch;if(e){var r=this.getHelper(t,"wordChars");"before"!=t.sticky&&n!=e.length||!i?++n:--i;for(var s=e.charAt(i),o=J(s,r)?function(t){return J(t,r)}:/\s/.test(s)?function(t){return/\s/.test(t)}:function(t){return!/\s/.test(t)&&!J(t)};0<i&&o(e.charAt(i-1));)--i;for(;n<e.length&&o(e.charAt(n));)++n}return new sr(ne(t.line,i),ne(t.line,n))},toggleOverwrite:function(t){null!=t&&t==this.state.overwrite||(((this.state.overwrite=!this.state.overwrite)?$:k)(this.display.cursorDiv,"CodeMirror-overwrite"),xt(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==N()},isReadOnly:function(){return!(!this.options.readOnly&&!this.doc.cantEdit)},scrollTo:Bn(function(t,e){xn(this,t,e)}),getScrollInfo:function(){var t=this.display.scroller;return{left:t.scrollLeft,top:t.scrollTop,height:t.scrollHeight-yi(this)-this.display.barHeight,width:t.scrollWidth-yi(this)-this.display.barWidth,clientHeight:xi(this),clientWidth:_i(this)}},scrollIntoView:Bn(function(t,e){var i;null==t?(t={from:this.doc.sel.primary().head,to:null},null==e&&(e=this.options.cursorScrollMargin)):"number"==typeof t?t={from:ne(t,0),to:null}:null==t.from&&(t={from:t,to:null}),t.to||(t.to=t.from),t.margin=e||0,null!=t.from.line?(i=t,Cn(e=this),e.curOp.scrollToPos=i):wn(this,t.from,t.to,t.margin)}),setSize:Bn(function(t,e){function i(t){return"number"==typeof t||/^\d+$/.test(String(t))?t+"px":t}var n=this;null!=t&&(this.display.wrapper.style.width=i(t)),null!=e&&(this.display.wrapper.style.height=i(e)),this.options.lineWrapping&&$i(this);var r=this.display.viewFrom;this.doc.iter(r,this.display.viewTo,function(t){if(t.widgets)for(var e=0;e<t.widgets.length;e++)if(t.widgets[e].noHScroll){en(n,r,"widget");break}++r}),this.curOp.forceUpdate=!0,xt(this,"refresh",this)}),operation:function(t){return Fn(this,t)},startOperation:function(){return Dn(this)},endOperation:function(){return In(this)},refresh:Bn(function(){var t=this.display.cachedTextHeight;tn(this),this.curOp.forceUpdate=!0,Mi(this),xn(this,this.doc.scrollLeft,this.doc.scrollTop),Kn(this.display),(null==t||.5<Math.abs(t-qi(this.display))||this.options.lineWrapping)&&Qi(this),xt(this,"refresh",this)}),swapDoc:Bn(function(t){var e=this.doc;return e.cm=null,this.state.selectingText&&this.state.selectingText(),vr(this,t),Mi(this),this.display.input.reset(),xn(this,t.scrollLeft,t.scrollTop),this.curOp.forceScroll=!0,si(this,"swapDoc",this,e),e}),phrase:function(t){var e=this.options.phrases;return e&&Object.prototype.hasOwnProperty.call(e,t)?e[t]:t},getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},Tt(Lo),Lo.registerHelper=function(t,e,i){No.hasOwnProperty(t)||(No[t]=Lo[t]={_global:[]}),No[t][e]=i},Lo.registerGlobalHelper=function(t,e,i,n){Lo.registerHelper(t,e,n),No[t]._global.push({pred:i,val:n})};var Mo,Do,Io="iter insert remove copy getEditor constructor".split(" ");for(Mo in us.prototype)us.prototype.hasOwnProperty(Mo)&&H(Io,Mo)<0&&(co.prototype[Mo]=function(t){return function(){return t.apply(this.doc,arguments)}}(us.prototype[Mo]));return Tt(us),co.inputStyles={textarea:n,contenteditable:t},co.defineMode=function(t){co.defaults.mode||"null"==t||(co.defaults.mode=t),function(t,e){2<arguments.length&&(e.dependencies=Array.prototype.slice.call(arguments,2)),Rt[t]=e}.apply(this,arguments)},co.defineMIME=function(t,e){Pt[t]=e},co.defineMode("null",function(){return{token:function(t){return t.skipToEnd()}}}),co.defineMIME("text/plain","null"),co.defineExtension=function(t,e){co.prototype[t]=e},co.defineDocExtension=function(t,e){us.prototype[t]=e},co.fromTextArea=function(e,i){var t;function n(){e.value=a.getValue()}if(i=i?F(i):{},i.value=e.value,!i.tabindex&&e.tabIndex&&(i.tabindex=e.tabIndex),!i.placeholder&&e.placeholder&&(i.placeholder=e.placeholder),null==i.autofocus&&(t=N(),i.autofocus=t==e||null!=e.getAttribute("autofocus")&&t==document.body),e.form&&(bt(e.form,"submit",n),!i.leaveSubmitMethodAlone)){var r=e.form,s=r.submit;try{var o=r.submit=function(){n(),r.submit=s,r.submit(),r.submit=o}}catch(t){}}i.finishInit=function(t){t.save=n,t.getTextArea=function(){return e},t.toTextArea=function(){t.toTextArea=isNaN,n(),e.parentNode.removeChild(t.getWrapperElement()),e.style.display="",e.form&&(_t(e.form,"submit",n),i.leaveSubmitMethodAlone||"function"!=typeof e.form.submit||(e.form.submit=s))}},e.style.display="none";var a=co(function(t){return e.parentNode.insertBefore(t,e.nextSibling)},i);return a},(Do=co).off=_t,Do.on=bt,Do.wheelEventPixels=ir,Do.Doc=us,Do.splitLines=Ft,Do.countColumn=O,Do.findColumn=U,Do.isWordChar=Z,Do.Pass=P,Do.signal=xt,Do.Line=qe,Do.changeEnd=lr,Do.scrollbarModel=Nn,Do.Pos=ne,Do.cmpPos=re,Do.modes=Rt,Do.mimeModes=Pt,Do.resolveMode=Wt,Do.getMode=zt,Do.modeExtensions=jt,Do.extendMode=Ut,Do.copyState=Kt,Do.startState=Vt,Do.innerMode=qt,Do.commands=Bs,Do.keyMap=ks,Do.keyName=Ns,Do.isModifierKey=Ls,Do.lookupKey=Es,Do.normalizeKeyMap=Ss,Do.StringStream=Gt,Do.SharedTextMarker=ls,Do.TextMarker=os,Do.LineWidget=ns,Do.e_preventDefault=St,Do.e_stopPropagation=Et,Do.e_stop=At,Do.addClass=$,Do.contains=A,Do.rmClass=k,Do.keyNames=_s,co.version="5.63.3",co}),function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],t):t(CodeMirror)}(function(s){"use strict";function o(t,e){clearTimeout(e.timeout),s.off(window,"mouseup",e.hurry),s.off(window,"keyup",e.hurry)}s.defineOption("autoRefresh",!1,function(t,e){function i(){n.display.wrapper.offsetHeight?(o(0,r),n.display.lastWrapHeight!=n.display.wrapper.clientHeight&&n.refresh()):r.timeout=setTimeout(i,r.delay)}var n,r;t.state.autoRefresh&&(o(0,t.state.autoRefresh),t.state.autoRefresh=null),e&&0==t.display.wrapper.offsetHeight&&((r=(n=t).state.autoRefresh={delay:e.delay||250}).timeout=setTimeout(i,r.delay),r.hurry=function(){clearTimeout(r.timeout),r.timeout=setTimeout(i,50)},s.on(window,"mouseup",r.hurry),s.on(window,"keyup",r.hurry))})}),function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],t):t(CodeMirror)}(function(e){"use strict";e.overlayMode=function(n,r,s){return{startState:function(){return{base:e.startState(n),overlay:e.startState(r),basePos:0,baseCur:null,overlayPos:0,overlayCur:null,streamSeen:null}},copyState:function(t){return{base:e.copyState(n,t.base),overlay:e.copyState(r,t.overlay),basePos:t.basePos,baseCur:null,overlayPos:t.overlayPos,overlayCur:null}},token:function(t,e){return(t!=e.streamSeen||Math.min(e.basePos,e.overlayPos)<t.start)&&(e.streamSeen=t,e.basePos=e.overlayPos=t.start),t.start==e.basePos&&(e.baseCur=n.token(t,e.base),e.basePos=t.pos),t.start==e.overlayPos&&(t.pos=t.start,e.overlayCur=r.token(t,e.overlay),e.overlayPos=t.pos),t.pos=Math.min(e.basePos,e.overlayPos),null==e.overlayCur?e.baseCur:null!=e.baseCur&&e.overlay.combineTokens||s&&null==e.overlay.combineTokens?e.baseCur+" "+e.overlayCur:e.overlayCur},indent:n.indent&&function(t,e,i){return n.indent(t.base,e,i)},electricChars:n.electricChars,innerMode:function(t){return{state:t.base,mode:n}},blankLine:function(t){var e,i;return n.blankLine&&(e=n.blankLine(t.base)),r.blankLine&&(i=r.blankLine(t.overlay)),null==i?e:s&&null!=e?e+" "+i:i}}}}),function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("../../addon/mode/multiplex")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../../addon/mode/multiplex"],t):t(CodeMirror)}(function(n){"use strict";n.defineMode("twig:inner",function(){var n=["and","as","autoescape","endautoescape","block","do","endblock","else","elseif","extends","for","endfor","embed","endembed","filter","endfilter","flush","from","if","endif","in","is","include","import","not","or","set","spaceless","endspaceless","with","endwith","trans","endtrans","blocktrans","endblocktrans","macro","endmacro","use","verbatim","endverbatim"],r=/^[+\-*&%=<>!?|~^]/,s=/^[:\[\(\{]/,o=["true","false","null","empty","defined","divisibleby","divisible by","even","odd","iterable","sameas","same as"],a=/^(\d[+\-\*\/])?\d+(\.\d+)?/;return n=new RegExp("(("+n.join(")|(")+"))\\b"),o=new RegExp("(("+o.join(")|(")+"))\\b"),{startState:function(){return{}},token:function(t,e){var i=t.peek();if(e.incomment)return t.skipTo("#}")?(t.eatWhile(/\#|}/),e.incomment=!1):t.skipToEnd(),"comment";if(e.intag){if(e.operator){if(e.operator=!1,t.match(o))return"atom";if(t.match(a))return"number"}if(e.sign){if(e.sign=!1,t.match(o))return"atom";if(t.match(a))return"number"}if(e.instring)return i==e.instring&&(e.instring=!1),t.next(),"string";if("'"==i||'"'==i)return e.instring=i,t.next(),"string";if(t.match(e.intag+"}")||t.eat("-")&&t.match(e.intag+"}"))return e.intag=!1,"tag";if(t.match(r))return e.operator=!0,"operator";if(t.match(s))e.sign=!0;else if(t.eat(" ")||t.sol()){if(t.match(n))return"keyword";if(t.match(o))return"atom";if(t.match(a))return"number";t.sol()&&t.next()}else t.next();return"variable"}if(t.eat("{")){if(t.eat("#"))return e.incomment=!0,t.skipTo("#}")?(t.eatWhile(/\#|}/),e.incomment=!1):t.skipToEnd(),"comment";if(i=t.eat(/\{|%/))return"{"==(e.intag=i)&&(e.intag="}"),t.eat("-"),"tag"}t.next()}}}),n.defineMode("twig",function(t,e){var i=n.getMode(t,"twig:inner");return e&&e.base?n.multiplexingMode(n.getMode(t,e.base),{open:/\{[{#%]/,close:/[}#%]\}/,mode:i,parseDelimiters:!0}):i}),n.defineMIME("text/x-twig","twig")}),function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],t):t(CodeMirror)}(function(k){"use strict";var T={autoSelfClosers:{area:!0,base:!0,br:!0,col:!0,command:!0,embed:!0,frame:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0,menuitem:!0},implicitlyClosed:{dd:!0,li:!0,optgroup:!0,option:!0,p:!0,rp:!0,rt:!0,tbody:!0,td:!0,tfoot:!0,th:!0,tr:!0},contextGrabbers:{dd:{dd:!0,dt:!0},dt:{dd:!0,dt:!0},li:{li:!0},option:{option:!0,optgroup:!0},optgroup:{optgroup:!0},p:{address:!0,article:!0,aside:!0,blockquote:!0,dir:!0,div:!0,dl:!0,fieldset:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,menu:!0,nav:!0,ol:!0,p:!0,pre:!0,section:!0,table:!0,ul:!0},rp:{rp:!0,rt:!0},rt:{rp:!0,rt:!0},tbody:{tbody:!0,tfoot:!0},td:{td:!0,th:!0},tfoot:{tbody:!0},th:{td:!0,th:!0},thead:{tbody:!0,tfoot:!0},tr:{tr:!0}},doNotIndent:{pre:!0},allowUnquoted:!0,allowMissing:!0,caseFold:!0},S={autoSelfClosers:{},implicitlyClosed:{},contextGrabbers:{},doNotIndent:{},allowUnquoted:!1,allowMissing:!1,allowMissingTagName:!1,caseFold:!1};k.defineMode("xml",function(t,e){var i,s,o,a=t.indentUnit,l={},n=e.htmlMode?T:S;for(i in n)l[i]=n[i];for(i in e)l[i]=e[i];function c(e,i){function t(t){return(i.tokenize=t)(e,i)}var n=e.next();if("<"==n)return e.eat("!")?e.eat("[")?e.match("CDATA[")?t(r("atom","]]>")):null:e.match("--")?t(r("comment","--\x3e")):e.match("DOCTYPE",!0,!0)?(e.eatWhile(/[\w\._\-]/),t(function n(r){return function(t,e){for(var i;null!=(i=t.next());){if("<"==i)return e.tokenize=n(r+1),e.tokenize(t,e);if(">"==i){if(1!=r)return e.tokenize=n(r-1),e.tokenize(t,e);e.tokenize=c;break}}return"meta"}}(1))):null:e.eat("?")?(e.eatWhile(/[\w\._\-]/),i.tokenize=r("meta","?>"),"meta"):(s=e.eat("/")?"closeTag":"openTag",i.tokenize=h,"tag bracket");if("&"!=n)return e.eatWhile(/[^&<]/),null;n=e.eat("#")?e.eat("x")?e.eatWhile(/[a-fA-F\d]/)&&e.eat(";"):e.eatWhile(/[\d]/)&&e.eat(";"):e.eatWhile(/[\w\.\-:]/)&&e.eat(";");return n?"atom":"error"}function h(t,e){var i=t.next();if(">"==i||"/"==i&&t.eat(">"))return e.tokenize=c,s=">"==i?"endTag":"selfcloseTag","tag bracket";if("="==i)return s="equals",null;if("<"!=i)return/[\'\"]/.test(i)?(e.tokenize=(n=i,r.isInAttribute=!0,r),e.stringStartCol=t.column(),e.tokenize(t,e)):(t.match(/^[^\s\u00a0=<>\"\']*[^\s\u00a0=<>\"\'\/]/),"word");e.tokenize=c,e.state=g,e.tagName=e.tagStart=null;var n,e=e.tokenize(t,e);return e?e+" tag error":"tag error";function r(t,e){for(;!t.eol();)if(t.next()==n){e.tokenize=h;break}return"string"}}function r(i,n){return function(t,e){for(;!t.eol();){if(t.match(n)){e.tokenize=c;break}t.next()}return i}}function d(t){return t&&t.toLowerCase()}function u(t,e,i){this.prev=t.context,this.tagName=e||"",this.indent=t.indented,this.startOfLine=i,(l.doNotIndent.hasOwnProperty(e)||t.context&&t.context.noIndent)&&(this.noIndent=!0)}function p(t){t.context&&(t.context=t.context.prev)}function f(t,e){for(var i;;){if(!t.context)return;if(i=t.context.tagName,!l.contextGrabbers.hasOwnProperty(d(i))||!l.contextGrabbers[d(i)].hasOwnProperty(d(e)))return;p(t)}}function g(t,e,i){return"openTag"==t?(i.tagStart=e.column(),m):"closeTag"==t?v:g}function m(t,e,i){return"word"==t?(i.tagName=e.current(),o="tag",_):l.allowMissingTagName&&"endTag"==t?(o="tag bracket",_(t,0,i)):(o="error",m)}function v(t,e,i){if("word"!=t)return l.allowMissingTagName&&"endTag"==t?(o="tag bracket",b(t,0,i)):(o="error",y);e=e.current();return i.context&&i.context.tagName!=e&&l.implicitlyClosed.hasOwnProperty(d(i.context.tagName))&&p(i),i.context&&i.context.tagName==e||!1===l.matchClosing?(o="tag",b):(o="tag error",y)}function b(t,e,i){return"endTag"!=t?(o="error",b):(p(i),g)}function y(t,e,i){return o="error",b(t,0,i)}function _(t,e,i){if("word"==t)return o="attribute",x;if("endTag"!=t&&"selfcloseTag"!=t)return o="error",_;var n=i.tagName,r=i.tagStart;return i.tagName=i.tagStart=null,"selfcloseTag"==t||l.autoSelfClosers.hasOwnProperty(d(n))?f(i,n):(f(i,n),i.context=new u(i,n,r==i.indented)),g}function x(t,e,i){return"equals"==t?C:(l.allowMissing||(o="error"),_(t,0,i))}function C(t,e,i){return"string"==t?w:"word"==t&&l.allowUnquoted?(o="string",_):(o="error",_(t,0,i))}function w(t,e,i){return"string"==t?w:_(t,0,i)}return c.isInText=!0,{startState:function(t){var e={tokenize:c,state:g,indented:t||0,tagName:null,tagStart:null,context:null};return null!=t&&(e.baseIndent=t),e},token:function(t,e){if(!e.tagName&&t.sol()&&(e.indented=t.indentation()),t.eatSpace())return null;s=null;var i=e.tokenize(t,e);return(i||s)&&"comment"!=i&&(o=null,e.state=e.state(s||i,t,e),o&&(i="error"==o?i+" error":o)),i},indent:function(t,e,i){var n=t.context;if(t.tokenize.isInAttribute)return t.tagStart==t.indented?t.stringStartCol+1:t.indented+a;if(n&&n.noIndent)return k.Pass;if(t.tokenize!=h&&t.tokenize!=c)return i?i.match(/^(\s*)/)[0].length:0;if(t.tagName)return!1!==l.multilineTagIndentPastTag?t.tagStart+t.tagName.length+2:t.tagStart+a*(l.multilineTagIndentFactor||1);if(l.alignCDATA&&/<!\[CDATA\[/.test(e))return 0;var r=e&&/^<(\/)?([\w_:\.-]*)/.exec(e);if(r&&r[1])for(;n;){if(n.tagName==r[2]){n=n.prev;break}if(!l.implicitlyClosed.hasOwnProperty(d(n.tagName)))break;n=n.prev}else if(r)for(;n;){var s=l.contextGrabbers[d(n.tagName)];if(!s||!s.hasOwnProperty(d(r[2])))break;n=n.prev}for(;n&&n.prev&&!n.startOfLine;)n=n.prev;return n?n.indent+a:t.baseIndent||0},electricInput:/<\/[\s\w:]+>$/,blockCommentStart:"\x3c!--",blockCommentEnd:"--\x3e",configuration:l.htmlMode?"html":"xml",helperType:l.htmlMode?"html":"xml",skipAttribute:function(t){t.state==C&&(t.state=_)},xmlCurrentTag:function(t){return t.tagName?{name:t.tagName,close:"closeTag"==t.type}:null},xmlCurrentContext:function(t){for(var e=[],i=t.context;i;i=i.prev)e.push(i.tagName);return e.reverse()}}}),k.defineMIME("text/xml","xml"),k.defineMIME("application/xml","xml"),k.mimeModes.hasOwnProperty("text/html")||k.defineMIME("text/html",{name:"xml",htmlMode:!0})}),function(c){function h(i){"use strict";var n;this.addButton=function(t,e){n||(n=c("<div>",{class:"redactor-toolbar-wrapper sp-z-50"}).append(c("<div>",{class:"redactor-toolbar"})),i.prepend(n));t=c("<a/>",{class:"re-button re-button-icon re-"+t,href:"#",title:e.title||"",role:"button",alt:e.title||""});return e.icon&&t.html(e.icon),n.find(".redactor-toolbar").append(t),t}}function d(t){"use strict";var e=new App.mergefields({editor:t.editor,show_tickets:t.show_tickets,show_organisations:t.show_organisations,show_canned_responses:t.show_canned_responses,syntaxEmailTemplate:t.syntaxEmailTemplate});e.init(),t.toolbar.addButton("mergefields",{title:App.mergefields.translations.en.merge_fields,icon:App.mergefields.icon}).on("click",function(t){Swal.fire({title:App.mergefields.translations.en.merge_fields,html:c("<div/>",{style:"text-align: initial"}).append(App.mergefields.modalContent),showCancelButton:!0,showCloseButton:!0,showConfirmButton:!1,showClass:{popup:"swal2-noanimation",backdrop:"swal2-noanimation"},hideClass:{popup:"",backdrop:""},willOpen:function(){e.appendMergeFields(c(Swal.getContent())).on("mergefield:inserted",function(){Swal.close()})}})})}function e(i,n){"use strict";var r,s={toolbar:!1,codemirror:CodeMirror.options},o=c(i),a=this,l="codemirror-box";this.container=function(){return o.next("."+l)},this.codemirror=function(){return r},function(){o=c(i);var t,e=c.extend(!0,s,n);r=CodeMirror.fromTextArea(i,e.codemirror),t=c("<div/>",{class:l}),o.next(".CodeMirror").wrapAll(t),e.toolbar&&d({toolbar:new h(a.container()),editor:a,show_tickets:n.mergeFields.tickets,show_organisations:n.mergeFields.organisations,show_canned_responses:n.mergeFields.canned_responses,syntaxEmailTemplate:n.mergeFields.syntaxEmailTemplate})}()}c.fn.sourcecode=function(t){return c(this).each(function(){c(this)[0].sourcecode=new e(c(this)[0],t)})}}($,(window,document)),void 0===CodeMirror&&(CodeMirror=void 0),void 0===jQuery&&(jQuery=void 0),function(){var i={settings:{},post:function(t){return new n("post",t)},get:function(t){return new n("get",t)},request:function(t,e){return new n(t,e)}},n=function(t,e){t={method:t,url:"",before:function(){},success:function(){},error:function(){},data:!1,async:!0,headers:{}};this.p=this.extend(t,e),this.p=this.extend(this.p,i.settings),this.p.method=this.p.method.toUpperCase(),this.prepareData(),this.xhr=new XMLHttpRequest,this.xhr.open(this.p.method,this.p.url,this.p.async),this.setHeaders(),!1!==("function"!=typeof this.p.before||this.p.before(this.xhr))&&this.send()};function h(t,e){return this.parse(t,e)}n.prototype={extend:function(t,e){if(e)for(var i in e)t[i]=e[i];return t},prepareData:function(){-1===["POST","PUT"].indexOf(this.p.method)||this.isFormData()||(this.p.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"!=typeof this.p.data||this.isFormData()||(this.p.data=this.toParams(this.p.data)),"GET"===this.p.method&&(this.p.url=this.p.data?this.p.url+"?"+this.p.data:this.p.url)},setHeaders:function(){for(var t in this.xhr.setRequestHeader("X-Requested-With",this.p.headers["X-Requested-With"]||"XMLHttpRequest"),this.p.headers)this.xhr.setRequestHeader(t,this.p.headers[t])},isFormData:function(){return void 0!==window.FormData&&this.p.data instanceof window.FormData},isComplete:function(){return!(this.xhr.status<200||300<=this.xhr.status&&304!==this.xhr.status)},send:function(){this.p.async?(this.xhr.onload=this.loaded.bind(this),this.xhr.send(this.p.data)):(this.xhr.send(this.p.data),this.loaded.call(this))},loaded:function(){var t;this.isComplete()?(t=this.parseResponse(),"function"==typeof this.p.success&&this.p.success(t,this.xhr)):(t=this.parseResponse(),"function"==typeof this.p.error&&this.p.error(t,this.xhr,this.xhr.status))},parseResponse:function(){var t=this.xhr.response,e=this.parseJson(t);return e||t},parseJson:function(t){try{var e=JSON.parse(t);if(e&&"object"==typeof e)return e}catch(t){}return!1},toParams:function(e){return Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")}};var r=[0],s="data"+(new Date).getTime(),o="is-hidden",a="is-hidden-mobile";function f(t,e){return l(t,e,[].slice.call(arguments,2))}h.ready=function(t){"loading"!==document.readyState?t():document.addEventListener("DOMContentLoaded",t)},h.prototype={get sdom(){return!0},get length(){return this.nodes.length},parse:function(t,e){var i;if(t){if(t.sdom)return this.nodes=t.nodes,t;i="string"!=typeof t?t.nodeType&&11===t.nodeType?t.childNodes:t.nodeType||t===window?[t]:t:/^\s*<(\w+|!)[^>]*>/.test(t)?this.create(t):this._query(t,e)}else i=[];this.nodes=this._slice(i)},create:function(t){if(/^<(\w+)\s*\/?>(?:<\/\1>|)$/.test(t))return[document.createElement(RegExp.$1)];var e=[],i=document.createElement("div"),n=i.childNodes;i.innerHTML=t;for(var r=0,s=n.length;r<s;r++)e.push(n[r]);return e},add:function(t){this.nodes=this.nodes.concat(this._toArray(t))},get:function(t){return this.nodes[t||0]||!1},getAll:function(){return this.nodes},eq:function(t){return new h(this.nodes[t])},first:function(){return new h(this.nodes[0])},last:function(){return new h(this.nodes[this.nodes.length-1])},contents:function(){return this.get().childNodes},each:function(t){for(var e=this.nodes.length,i=0;i<e;i++)t.call(this,this.nodes[i].sdom?this.nodes[i].get():this.nodes[i],i);return this},is:function(t){return 0<this.filter(t).length},filter:function(e){var t;return void 0===e?this:(t="function"==typeof e?e:function(t){return e instanceof Node?e===t:e&&e.sdom?-1!==e.nodes.indexOf(t):(t.matches=t.matches||t.msMatchesSelector||t.webkitMatchesSelector,1===t.nodeType&&t.matches(e||"*"))},new h(this.nodes.filter(t)))},not:function(e){return this.filter(function(t){return!new h(t).is(e||!0)})},find:function(n){var r=[];return this.each(function(t){for(var e=this._query(n||"*",t),i=0;i<e.length;i++)r.push(e[i])}),new h(r)},children:function(t){var n=[];return this.each(function(t){if(t.children)for(var e=t.children,i=0;i<e.length;i++)n.push(e[i])}),new h(n).filter(t)},parent:function(t){var e=[];return this.each(function(t){t.parentNode&&e.push(t.parentNode)}),new h(e).filter(t)},parents:function(i,n){n=this._getContext(n);var r=[];return this.each(function(t){for(var e=t.parentNode;e&&e!==n;)i&&!new h(e).is(i)||r.push(e),e=e.parentNode}),new h(r)},closest:function(e,i){i=this._getContext(i),e=e.sdom?e.get():e;var n=[],r=e&&e.nodeType;return this.each(function(t){do{if(r&&t===e||new h(t).is(e))return n.push(t)}while((t=t.parentNode)&&t!==i)}),new h(n)},next:function(t){return this._getSibling(t,"nextSibling")},nextElement:function(t){return this._getSibling(t,"nextElementSibling")},prev:function(t){return this._getSibling(t,"previousSibling")},prevElement:function(t){return this._getSibling(t,"previousElementSibling")},css:function(n,r){if(void 0!==r||"object"==typeof n)return this.each(function(t){var e,i={};for(e in"object"==typeof n?i=n:i[n]=r,i)t.style&&(t.style[e]=i[e])});var t=this.get();return"width"===n||"height"===n?t.style?this._getHeightOrWidth(n,t,!1)+"px":void 0:t.style?getComputedStyle(t,null)[n]:void 0},attr:function(n,r,s){if(s=s?"data-":"",void 0!==r||"object"==typeof n)return this.each(function(t){var e,i={};for(e in"object"==typeof n?i=n:i[n]=r,i)3!==t.nodeType&&("checked"===e?t.checked=i[e]:t.setAttribute(s+e,i[e]))});var t=this.get();return t&&3!==t.nodeType?"checked"===n?t.checked:this._getBooleanFromStr(t.getAttribute(s+n)):void 0},data:function(t,e){if(void 0!==t)return this.attr(t,e,!0);function i(t){return t[1].toUpperCase()}var n,r,s,o=/^data-(.+)$/,a=this.get().attributes,l={};for(n in a)a[n]&&o.test(a[n].nodeName)&&(r=a[n].nodeName.match(o)[1],s=a[n].value,r=r.replace(/-([a-z])/g,i),s=this._isObjectString(s)?this._toObject(s):this._isNumber(s)?parseFloat(s):this._getBooleanFromStr(s),l[r]=s);return l},val:function(e){if(void 0!==e)return this.each(function(t){t.value=e});var t=this.get();return t.type&&"checkbox"===t.type?t.checked:t.value},removeAttr:function(t){return this.each(function(e){t.split(" ").forEach(function(t){3!==e.nodeType&&e.removeAttribute(t)})})},removeData:function(t){return this.each(function(e){t.split(" ").forEach(function(t){3!==e.nodeType&&e.removeAttribute("data-"+t)})})},dataset:function(e,i){return this.each(function(t){r[this.dataindex(t)][e]=i})},dataget:function(t){return r[this.dataindex(this.get())][t]},dataindex:function(t){var e=t[s],i=r.length;return e||(e=t[s]=i,r[e]={}),e},addClass:function(t){return this._eachClass(t,"add")},removeClass:function(t){return this._eachClass(t,"remove")},toggleClass:function(t){return this._eachClass(t,"toggle")},hasClass:function(e){return this.nodes.some(function(t){return!!t.classList&&t.classList.contains(e)})},empty:function(){return this.each(function(t){t.innerHTML=""})},html:function(t){return void 0===t?this.get().innerHTML||"":this.empty().append(t)},text:function(e){return void 0===e?this.get().textContent||"":this.each(function(t){t.textContent=e})},after:function(t){return this._inject(t,function(t,e){if("string"==typeof t)e.insertAdjacentHTML("afterend",t);else if(null!==e.parentNode)for(var i=t instanceof Node?[t]:this._toArray(t).reverse(),n=0;n<i.length;n++)e.parentNode.insertBefore(i[n],e.nextSibling);return e})},before:function(t){return this._inject(t,function(t,e){if("string"==typeof t)e.insertAdjacentHTML("beforebegin",t);else for(var i=t instanceof Node?[t]:this._toArray(t),n=0;n<i.length;n++)e.parentNode.insertBefore(i[n],e);return e})},append:function(t){return this._inject(t,function(t,e){if("string"==typeof t||"number"==typeof t)e.insertAdjacentHTML("beforeend",t);else for(var i=t instanceof Node?[t]:this._toArray(t),n=0;n<i.length;n++)e.appendChild(i[n]);return e})},prepend:function(t){return this._inject(t,function(t,e){if("string"==typeof t||"number"==typeof t)e.insertAdjacentHTML("afterbegin",t);else for(var i=t instanceof Node?[t]:this._toArray(t).reverse(),n=0;n<i.length;n++)e.insertBefore(i[n],e.firstChild);return e})},wrap:function(t){return this._inject(t,function(t,e){t="string"==typeof t||"number"==typeof t?this.create(t)[0]:t instanceof Node?t:this._toArray(t)[0];return e.parentNode&&e.parentNode.insertBefore(t,e),t.appendChild(e),new h(t)})},unwrap:function(){return this.each(function(t){t=new h(t);return t.replaceWith(t.contents())})},replaceWith:function(t){return this._inject(t,function(t,e){for(var i=document.createDocumentFragment(),n="string"==typeof t||"number"==typeof t?this.create(t):t instanceof Node?[t]:this._toArray(t),r=0;r<n.length;r++)i.appendChild(n[r]);t=i.childNodes[0];return e.parentNode&&e.parentNode.replaceChild(i,e),t})},remove:function(){return this.each(function(t){t.parentNode&&t.parentNode.removeChild(t)})},clone:function(i){var n=[];return this.each(function(t){var e=this._clone(t);i&&(e=this._cloneEvents(t,e)),n.push(e)}),new h(n)},show:function(){return this.each(function(t){var e,i,n,r;t.style&&this._hasDisplayNone(t)&&(e=t.getAttribute("domTargetShow"),i=!!t.classList&&t.classList.contains(o),n=!!t.classList&&t.classList.contains(a),i?(r=o,t.classList.remove(o)):n?(r=a,t.classList.remove(a)):t.style.display=e||"block",r&&t.setAttribute("domTargetHide",r),t.removeAttribute("domTargetShow"))}.bind(this))},hide:function(){return this.each(function(t){var e,i;t.style&&!this._hasDisplayNone(t)&&(e=t.style.display,(i=t.getAttribute("domTargetHide"))===o?t.classList.add(o):i===a?t.classList.add(a):("block"!==e&&t.setAttribute("domTargetShow",e),t.style.display="none"),t.removeAttribute("domTargetHide"))})},scrollTop:function(t){var e=this.get(),i=e===window,n=9===e.nodeType,e=n?document.scrollingElement||document.body.parentNode||document.body||document.documentElement:e;if(void 0===t)return n?void 0!==window.pageYOffset?window.pageYOffset:document.documentElement.scrollTop||document.body.scrollTop||0:i?window.pageYOffset:e.scrollTop;i?window.scrollTo(0,t):e.scrollTop=t},offset:function(){return this._getDim("Offset")},position:function(){return this._getDim("Position")},width:function(t,e){return this._getSize("width","Width",t,e)},height:function(t,e){return this._getSize("height","Height",t,e)},outerWidth:function(){return this._getInnerOrOuter("width","outer")},outerHeight:function(){return this._getInnerOrOuter("height","outer")},innerWidth:function(){return this._getInnerOrOuter("width","inner")},innerHeight:function(){return this._getInnerOrOuter("height","inner")},click:function(){return this._triggerEvent("click")},focus:function(){return this._triggerEvent("focus")},trigger:function(r){return this.each(function(t){for(var e=r.split(" "),i=0;i<e.length;i++){var n;try{n=new window.CustomEvent(e[i],{bubbles:!0,cancelable:!0})}catch(t){(n=document.createEvent("CustomEvent")).initCustomEvent(e[i],!0,!0)}t.dispatchEvent(n)}})},on:function(s,o,a){return this.each(function(t){for(var e=s.split(" "),i=0;i<e.length;i++){var n=this._getEventName(e[i]),r=this._getEventNamespace(e[i]);o=a?this._getOneHandler(o,s):o,t.addEventListener(n,o),t._e=t._e||{},t._e[r]=t._e[r]||{},t._e[r][n]=t._e[r][n]||[],t._e[r][n].push(o)}})},one:function(t,e){return this.on(t,e,!0)},off:function(s,o){function a(t,e,i){return t===i}function l(t,e,i,n){return e===n}function c(t,e,i,n){return t===i&&e===n}function e(){return!0}return void 0===s?this.each(function(t){this._offEvent(t,!1,!1,o,e)}):this.each(function(t){for(var e=s.split(" "),i=0;i<e.length;i++){var n=this._getEventName(e[i]),r=this._getEventNamespace(e[i]);"_events"===r?this._offEvent(t,n,r,o,a):n||"_events"===r?this._offEvent(t,n,r,o,c):this._offEvent(t,n,r,o,l)}})},serialize:function(t){for(var e={},i=this.get().elements,n=0;n<i.length;n++){var r=i[n];if((!/(checkbox|radio)/.test(r.type)||r.checked)&&(r.name&&!r.disabled&&"file"!==r.type)){if("select-multiple"===r.type)for(var s=0;s<r.options.length;s++){var o=r.options[s];o.selected&&(e[r.name]=o.value)}e[r.name]=this._isNumber(r.value)?parseFloat(r.value):this._getBooleanFromStr(r.value)}}return t?e:this._toParams(e)},ajax:function(t,e){if(void 0!==n){var i=this.attr("method")||"post",e={url:this.attr("action"),data:this.serialize(),success:t,error:e};return new n(i,e)}},_queryContext:function(t,e){return 3!==(e=this._getContext(e)).nodeType&&"function"==typeof e.querySelectorAll?e.querySelectorAll(t):[]},_query:function(t,e){if(e)return this._queryContext(t,e);if(/^[.#]?[\w-]*$/.test(t)){if("#"!==t[0])return"."===t[0]?document.getElementsByClassName(t.slice(1)):document.getElementsByTagName(t);e=document.getElementById(t.slice(1));return e?[e]:[]}return document.querySelectorAll(t)},_getContext:function(t){return(t="string"==typeof t?document.querySelector(t):t)&&t.sdom?t.get():t||document},_inject:function(t,e){for(var i=this.nodes.length,n=[];i--;){var r="function"==typeof t?t.call(this,this.nodes[i]):t,r=0===i?r:this._clone(r),r=e.call(this,r,this.nodes[i]);r&&(r.sdom?n.push(r.get()):n.push(r))}return new h(n)},_cloneEvents:function(t,e){var i=t._e;if(i)for(var n in(e._e=i)._events)for(var r=0;r<i._events[n].length;r++)e.addEventListener(n,i._events[n][r]);return e},_clone:function(t){if(void 0!==t)return"string"==typeof t?t:t instanceof Node||t.nodeType?t.cloneNode(!0):"length"in t?[].map.call(this._toArray(t),function(t){return t.cloneNode(!0)}):void 0},_slice:function(t){return t&&0!==t.length?t.length?[].slice.call(t.nodes||t):[t]:[]},_eachClass:function(t,i){return this.each(function(e){t&&t.split(" ").forEach(function(t){e.classList&&e.classList[i](t)})})},_triggerEvent:function(t){var e=this.get();return e&&3!==e.nodeType&&e[t](),this},_getOneHandler:function(t,e){var i=this;return function(){t.apply(this,arguments),i.off(e)}},_getEventNamespace:function(t){var e=t.split("."),t=e[1]||"_events";return e[2]?t+e[2]:t},_getEventName:function(t){return t.split(".")[0]},_offEvent:function(t,e,i,n,r){for(var s in t._e)for(var o in t._e[s])if(r(o,s,e,i))for(var a=t._e[s][o],l=0;l<a.length;l++)void 0!==n&&a[l].toString()!==n.toString()||(t.removeEventListener(o,a[l]),t._e[s][o].splice(l,1),0===t._e[s][o].length&&delete t._e[s][o],0===Object.keys(t._e[s]).length&&delete t._e[s])},_getInnerOrOuter:function(t,e){return this[t](void 0,e)},_getDocSize:function(t,e){var i=t.body,t=t.documentElement;return Math.max(i["scroll"+e],i["offset"+e],t["client"+e],t["scroll"+e],t["offset"+e])},_getSize:function(e,t,i,n){if(void 0!==i)return this.each(function(t){i=parseFloat(i),i+=this._adjustResultHeightOrWidth(e,t,n||"normal"),new h(t).css(e,i+"px")}.bind(this));var r=this.get();return i=3===r.nodeType?0:9===r.nodeType?this._getDocSize(r,t):r===window?window["inner"+t]:this._getHeightOrWidth(e,r,n||"normal"),Math.round(i)},_getHeightOrWidth:function(t,e,i){if(!e)return 0;var n,r,s=t.charAt(0).toUpperCase()+t.slice(1),o=0,a=getComputedStyle(e,null),l=new h(e),c=l.parents().filter(function(t){return 1===t.nodeType&&"none"===getComputedStyle(t,null).display&&t});return"none"===a.display&&c.add(e),0!==c.length?(n="visibility: hidden !important; display: block !important;",r=[],c.each(function(t){var e=new h(t),t=e.attr("style");null!==t&&r.push(t),e.attr("style",null!==t?t+";"+n:n)}),o=l.get()["offset"+s]-this._adjustResultHeightOrWidth(t,e,i),c.each(function(t,e){t=new h(t);void 0===r[e]?t.removeAttr("style"):t.attr("style",r[e])})):o=e["offset"+s]-this._adjustResultHeightOrWidth(t,e,i),o},_adjustResultHeightOrWidth:function(t,e,i){if(!e||!1===i)return 0;var n=0,r=getComputedStyle(e,null),e="border-box"===r.boxSizing;return"height"===t?(("inner"===i||"normal"===i&&e)&&(n+=(parseFloat(r.borderTopWidth)||0)+(parseFloat(r.borderBottomWidth)||0)),"outer"===i&&(n-=(parseFloat(r.marginTop)||0)+(parseFloat(r.marginBottom)||0))):(("inner"===i||"normal"===i&&e)&&(n+=(parseFloat(r.borderLeftWidth)||0)+(parseFloat(r.borderRightWidth)||0)),"outer"===i&&(n-=(parseFloat(r.marginLeft)||0)+(parseFloat(r.marginRight)||0))),n},_getDim:function(t){var e=this.get();return 3===e.nodeType?{top:0,left:0}:this["_get"+t](e)},_getPosition:function(t){return{top:t.offsetTop,left:t.offsetLeft}},_getOffset:function(t){var e=t.getBoundingClientRect(),i=t.ownerDocument,t=i.documentElement,i=i.defaultView;return{top:e.top+i.pageYOffset-t.clientTop,left:e.left+i.pageXOffset-t.clientLeft}},_getSibling:function(e,i){var n,r=(e=e&&e.sdom?e.get():e)&&e.nodeType;return this.each(function(t){for(;t=t[i];)if(r&&t===e||new h(t).is(e))return void(n=t)}),new h(n)},_toArray:function(t){if(t instanceof NodeList){for(var e=[],i=0;i<t.length;i++)e[i]=t[i];return e}return void 0===t?[]:t.sdom?t.nodes:t},_toParams:function(t){var e,i="";for(e in t)i+="&"+this._encodeUri(e)+"="+this._encodeUri(t[e]);return i.replace(/^&/,"")},_toObject:function(t){return new Function("return "+t)()},_encodeUri:function(t){return encodeURIComponent(t).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")},_isNumber:function(t){return!isNaN(t)&&!isNaN(parseFloat(t))},_isObjectString:function(t){return-1!==t.search(/^{/)},_getBooleanFromStr:function(t){return"true"===t||"false"!==t&&t},_hasDisplayNone:function(t){return"none"===t.style.display||"none"===(t.currentStyle||getComputedStyle(t,null)).display}};var u=0;f.app=[],f.version="3.5.2",f.options={},f.modules={},f.services={},f.classes={},f.plugins={},f.mixins={},f.modals={},f.lang={},f.dom=function(t,e){return new h(t,e)},f.ajax=i,f.Dom=h,f.keycodes={BACKSPACE:8,DELETE:46,UP:38,DOWN:40,ENTER:13,SPACE:32,ESC:27,TAB:9,CTRL:17,META:91,SHIFT:16,ALT:18,RIGHT:39,LEFT:37},f.env={plugin:"plugins",module:"modules",service:"services",class:"classes",mixin:"mixins"},void 0!==jQuery&&(jQuery.fn.redactor=function(t){return l(this.toArray(),t,[].slice.call(arguments,1))});var l=function(t,e,i){for(var n="redactor",r=Array.isArray(t)?t:t&&t.nodeType?[t]:document.querySelectorAll(t),s="string"==typeof e||"function"==typeof e,o=[],a=0;a<r.length;a++){var l,c,h=r[a],d=f.dom(h);(c=d.dataget(n))||s||(c=new p(h,e,u),d.dataset(n,c),f.app[u]=c,u++),c&&s&&(void 0!==(h="function"==typeof(e=(l="destroy"===e)?"stop":e)?e.apply(c,i):(i.unshift(e),c.api.apply(c,i)))&&o.push(h),l&&d.dataset(n,!1))}return 0===o.length||1===o.length?0===o.length?c:o[0]:o};f.add=function(t,e,i){if(void 0!==f.env[t])if(i.translations&&(f.lang=f.extend(!0,{},f.lang,i.translations)),i.modals&&(f.modals=f.extend(!0,{},f.modals,i.modals)),"mixin"===t)f[f.env[t]][e]=i;else{function n(){}if((n.prototype=i).mixins)for(var r=0;r<i.mixins.length;r++)f.inherit(n,f.mixins[i.mixins[r]]);f[f.env[t]][e]=n}},f.addLang=function(t,e){void 0===f.lang[t]&&(f.lang[t]={}),f.lang[t]=f.extend(f.lang[t],e)},f.create=function(t){var e=t.split("."),i=[].slice.call(arguments,1),n="classes";void 0!==f.env[e[0]]&&(n=f.env[e[0]],t=e.slice(1).join("."));n=new f[n][t];if(n.init){i=n.init.apply(n,i);return i||n}return n},f.inherit=function(t,e){function i(){}i.prototype=e;var n,r=new i;for(n in t.prototype)t.prototype.__lookupGetter__(n)?r.__defineGetter__(n,t.prototype.__lookupGetter__(n)):r[n]=t.prototype[n];return t.prototype=r,t.prototype.super=e,t},f.error=function(t){throw t},f.extend=function(){var i={},n=!1,t=0,e=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(n=arguments[0],t++);for(;t<e;t++)!function(t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(n&&"[object Object]"===Object.prototype.toString.call(t[e])?i[e]=f.extend(!0,i[e],t[e]):i[e]=t[e])}(arguments[t]);return i},f.opts={animation:!0,lang:"en",direction:"ltr",spellcheck:!0,structure:!1,scrollTarget:!1,styles:!0,stylesClass:"redactor-styles",placeholder:!1,source:!0,showSource:!1,inline:!1,breakline:!1,markup:"p",enterKey:!0,clickToEdit:!1,clickToSave:!1,clickToCancel:!1,focus:!1,focusEnd:!1,minHeight:!1,maxHeight:!1,maxWidth:!1,plugins:[],callbacks:{},preClass:!1,preSpaces:4,tabindex:!1,tabAsSpaces:!1,tabKey:!0,autosave:!1,autosaveName:!1,autosaveData:!1,autosaveMethod:"post",toolbar:!0,toolbarFixed:!0,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarExternal:!1,toolbarContext:!0,air:!1,formatting:["p","blockquote","pre","h1","h2","h3","h4","h5","h6"],formattingAdd:!1,formattingHide:!1,buttons:["html","format","bold","italic","deleted","lists","image","file","link"],buttonsTextLabeled:!1,buttonsAdd:[],buttonsAddFirst:[],buttonsAddAfter:!1,buttonsAddBefore:!1,buttonsHide:[],buttonsHideOnMobile:[],imageUpload:!1,imageUploadParam:"file",imageData:!1,imageEditable:!0,imageCaption:!0,imageLink:!0,imagePosition:!1,imageResizable:!1,imageFloatMargin:"10px",imageFigure:!0,imageObserve:!0,imageSrcData:!1,fileUpload:!1,fileUploadParam:"file",fileData:!1,fileAttachment:!1,uploadData:!1,dragUpload:!0,multipleUpload:!0,clipboardUpload:!0,uploadBase64:!1,linkTarget:!1,linkTitle:!1,linkNewTab:!0,linkNofollow:!1,linkSize:30,linkValidation:!0,cleanOnEnter:!0,cleanInlineOnEnter:!1,paragraphize:!0,removeScript:!0,removeNewLines:!1,removeComments:!0,replaceTags:{b:"strong",i:"em",strike:"del"},pastePlainText:!1,pasteLinkTarget:!1,pasteImages:!0,pasteLinks:!0,pasteClean:!0,pasteKeepStyle:[],pasteKeepClass:[],pasteKeepAttrs:["td","th"],pasteBlockTags:["pre","h1","h2","h3","h4","h5","h6","table","tbody","thead","tfoot","th","tr","td","ul","ol","li","blockquote","p","figure","figcaption"],pasteInlineTags:["a","img","br","strong","ins","code","del","span","samp","kbd","sup","sub","mark","var","cite","small","b","u","em","i","abbr"],activeButtons:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",u:"underline"},activeButtonsAdd:{},activeButtonsObservers:{},autoparse:!0,autoparseStart:!0,autoparsePaste:!0,autoparseLinks:!0,autoparseImages:!0,autoparseVideo:!0,autoparseHttps:!1,shortcodes:{"p.":{format:"p"},"quote.":{format:"blockquote"},"pre.":{format:"pre"},"h1.":{format:"h1"},"h2.":{format:"h2"},"h3.":{format:"h3"},"h4.":{format:"h4"},"h5.":{format:"h5"},"h6.":{format:"h6"},"*.":{format:"ul"}},shortcodesAdd:!1,shortcuts:{"ctrl+shift+m, meta+shift+m":{api:"module.inline.clearformat"},"ctrl+b, meta+b":{api:"module.inline.format",args:"b"},"ctrl+i, meta+i":{api:"module.inline.format",args:"i"},"ctrl+u, meta+u":{api:"module.inline.format",args:"u"},"ctrl+h, meta+h":{api:"module.inline.format",args:"sup"},"ctrl+l, meta+l":{api:"module.inline.format",args:"sub"},"ctrl+k, meta+k":{api:"module.link.open"},"ctrl+alt+0, meta+alt+0":{api:"module.block.format",args:"p"},"ctrl+alt+1, meta+alt+1":{api:"module.block.format",args:"h1"},"ctrl+alt+2, meta+alt+2":{api:"module.block.format",args:"h2"},"ctrl+alt+3, meta+alt+3":{api:"module.block.format",args:"h3"},"ctrl+alt+4, meta+alt+4":{api:"module.block.format",args:"h4"},"ctrl+alt+5, meta+alt+5":{api:"module.block.format",args:"h5"},"ctrl+alt+6, meta+alt+6":{api:"module.block.format",args:"h6"},"ctrl+shift+7, meta+shift+7":{api:"module.list.toggle",args:"ol"},"ctrl+shift+8, meta+shift+8":{api:"module.list.toggle",args:"ul"}},shortcutsAdd:!1,grammarly:!0,notranslate:!1,bufferLimit:100,emptyHtml:"<p></p>",markerChar:"\ufeff",imageTypes:["image/png","image/jpeg","image/gif"],imageAttrs:["alt","title","src","class","width","height","srcset"],inlineTags:["a","span","strong","strike","b","u","em","i","code","del","ins","samp","kbd","sup","sub","mark","var","cite","small","abbr"],blockTags:["pre","ul","ol","li","p","h1","h2","h3","h4","h5","h6","dl","dt","dd","div","table","tbody","thead","tfoot","tr","th","td","blockquote","output","figcaption","figure","address","section","header","footer","aside","article","iframe"],regex:{youtube:/^https?\:\/\/(?:www\.youtube(?:\-nocookie)?\.com\/|m\.youtube\.com\/|youtube\.com\/)?(?:ytscreeningroom\?vi?=|youtu\.be\/|vi?\/|user\/.+\/u\/\w{1,2}\/|embed\/|watch\?(?:.*\&)?vi?=|\&vi?=|\?(?:.*\&)?vi?=)([^#\&\?\n\/<>"']*)/gi,vimeo:/(http|https)?:\/\/(?:www.|player.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:\/[a-zA-Z0-9_-]+)?/gi,imageurl:/((https?|www)[^\s]+\.)(jpe?g|png|gif)(\?[^\s-]+)?/gi,url:/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z\u00F0-\u02AF0-9()!@:%_+.~#?&//=]*)/gi,aurl1:/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,aurl2:/(^|[^\/])(www\.[\S]+(\b|$))/gim},input:!0,zindex:!1,modes:{inline:{pastePlainText:!0,pasteImages:!1,enterKey:!1,toolbar:!1,autoparse:!1,source:!1,showSource:!1,styles:!1,air:!1},original:{styles:!1}}},f.lang.en={format:"Format",image:"Image",file:"File",link:"Link",bold:"Bold",italic:"Italic",deleted:"Strikethrough",underline:"Underline",superscript:"Superscript",subscript:"Subscript","bold-abbr":"B","italic-abbr":"I","deleted-abbr":"S","underline-abbr":"U","superscript-abbr":"Sup","subscript-abbr":"Sub",lists:"Lists","link-insert":"Insert Link","link-edit":"Edit Link","link-in-new-tab":"Open link in new tab",unlink:"Unlink",cancel:"Cancel",close:"Close",insert:"Insert",save:"Save",delete:"Delete",text:"Text",edit:"Edit",title:"Alt",paragraph:"Normal text",quote:"Quote",code:"Code",heading1:"Heading 1",heading2:"Heading 2",heading3:"Heading 3",heading4:"Heading 4",heading5:"Heading 5",heading6:"Heading 6",filename:"Name",optional:"optional",unorderedlist:"Unordered List",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",horizontalrule:"Line",upload:"Upload","upload-label":"Drop files here or click to upload","accessibility-help-label":"Rich text editor",caption:"Caption",bulletslist:"Bullets",numberslist:"Numbers","image-position":"Position",none:"None",left:"Left",right:"Right",center:"Center",undo:"Undo",redo:"Redo"},f.buttons={html:{title:"HTML",icon:!0,api:"module.source.toggle"},undo:{title:"## undo ##",icon:!0,api:"module.buffer.undo"},redo:{title:"## redo ##",icon:!0,api:"module.buffer.redo"},format:{title:"## format ##",icon:!0,dropdown:{p:{title:"## paragraph ##",api:"module.block.format",args:{tag:"p"}},blockquote:{title:"## quote ##",api:"module.block.format",args:{tag:"blockquote"}},pre:{title:"## code ##",api:"module.block.format",args:{tag:"pre"}},h1:{title:"## heading1 ##",api:"module.block.format",args:{tag:"h1"}},h2:{title:"## heading2 ##",api:"module.block.format",args:{tag:"h2"}},h3:{title:"## heading3 ##",api:"module.block.format",args:{tag:"h3"}},h4:{title:"## heading4 ##",api:"module.block.format",args:{tag:"h4"}},h5:{title:"## heading5 ##",api:"module.block.format",args:{tag:"h5"}},h6:{title:"## heading6 ##",api:"module.block.format",args:{tag:"h6"}}}},bold:{title:"## bold-abbr ##",icon:!0,tooltip:"## bold ##",api:"module.inline.format",args:{tag:"b"}},italic:{title:"## italic-abbr ##",icon:!0,tooltip:"## italic ##",api:"module.inline.format",args:{tag:"i"}},deleted:{title:"## deleted-abbr ##",icon:!0,tooltip:"## deleted ##",api:"module.inline.format",args:{tag:"del"}},underline:{title:"## underline-abbr ##",icon:!0,tooltip:"## underline ##",api:"module.inline.format",args:{tag:"u"}},sup:{title:"## superscript-abbr ##",icon:!0,tooltip:"## superscript ##",api:"module.inline.format",args:{tag:"sup"}},sub:{title:"## subscript-abbr ##",icon:!0,tooltip:"## subscript ##",api:"module.inline.format",args:{tag:"sub"}},lists:{title:"## lists ##",icon:!0,observe:"list",dropdown:{observe:"list",unorderedlist:{title:"&bull; ## unorderedlist ##",api:"module.list.toggle",args:"ul"},orderedlist:{title:"1. ## orderedlist ##",api:"module.list.toggle",args:"ol"},outdent:{title:"< ## outdent ##",api:"module.list.outdent"},indent:{title:"> ## indent ##",api:"module.list.indent"}}},ul:{title:"&bull; ## bulletslist ##",icon:!0,api:"module.list.toggle",observe:"list",args:"ul"},ol:{title:"1. ## numberslist ##",icon:!0,api:"module.list.toggle",observe:"list",args:"ol"},outdent:{title:"## outdent ##",icon:!0,api:"module.list.outdent",observe:"list"},indent:{title:"## indent ##",icon:!0,api:"module.list.indent",observe:"list"},image:{title:"## image ##",icon:!0,api:"module.image.open"},file:{title:"## file ##",icon:!0,api:"module.file.open"},link:{title:"## link ##",icon:!0,observe:"link",dropdown:{observe:"link",link:{title:"## link-insert ##",api:"module.link.open"},unlink:{title:"## unlink ##",api:"module.link.unlink"}}},line:{title:"## horizontalrule ##",icon:!0,api:"module.line.insert"}};var p=function(t,e,i){this.module={},this.plugin={},this.instances={},this.started=!1,this.stopped=!1,this.uuid=i,this.rootElement=t,this.rootOpts=e,this.dragInside=!1,this.dragComponentInside=!1,this.keycodes=f.keycodes,this.namespace="redactor",this.$win=f.dom(window),this.$doc=f.dom(document),this.$body=f.dom("body"),this.editorReadOnly=!1,this.opts=f.create("service.options",e,t),this.lang=f.create("service.lang",this),this.buildServices(),this.buildModules(),this.buildPlugins(),this.start()};p.prototype={start:function(){this.stopped=!1,this.broadcast("start"),this.broadcast("startcode"),this.opts.clickToEdit?this.broadcast("startclicktoedit"):(this.broadcast("enable"),this.opts.showSource&&this.broadcast("startcodeshow"),this.broadcast("enablefocus")),this.broadcast("started"),this.started=!0},stop:function(){this.started=!1,this.stopped=!0,this.broadcast("stop"),this.broadcast("disable"),this.broadcast("stopped")},isStarted:function(){return this.started},isStopped:function(){return this.stopped},buildServices:function(){var t,e=["options","lang"],i=["uuid","keycodes","opts","lang","$win","$doc","$body"],n=[];for(t in f.services)-1===e.indexOf(t)&&(this[t]=f.create("service."+t,this),n.push(t),i.push(t));for(var r=0;r<n.length;r++)for(var s=n[r],o=0;o<i.length;o++){var a=i[o];s!==a&&(this[s][a]=this[a])}},buildModules:function(){for(var t in f.modules)this.module[t]=f.create("module."+t,this),this.instances[t]=this.module[t]},buildPlugins:function(){for(var t=this.opts.plugins,e=0;e<t.length;e++){var i=t[e];void 0!==f.plugins[i]&&(this.plugin[i]=f.create("plugin."+i,this),this.instances[i]=this.plugin[i])}},isDragInside:function(){return this.dragInside},setDragInside:function(t){this.dragInside=t},isDragComponentInside:function(){return this.dragComponentInside},setDragComponentInside:function(t){this.dragComponentInside=t},getDragComponentInside:function(){return this.dragComponentInside},isReadOnly:function(){return this.editorReadOnly},enableReadOnly:function(){this.editorReadOnly=!0,this.broadcast("enablereadonly"),this.component.clearActive(),this.toolbar.disableButtons()},disableReadOnly:function(){this.editorReadOnly=!1,this.broadcast("disablereadonly"),this.toolbar.enableButtons()},callMessageHandler:function(t,e,i){var n,r=e.split(".");return 1===r.length?"function"==typeof t["on"+e]&&(n=t["on"+e].apply(t,i)):(r[0]="on"+r[0],"function"==typeof(r=this.utils.checkProperty(t,r))&&(n=r.apply(t,i))),n},broadcast:function(t){var e,i,n=[].slice.call(arguments,1);for(i in this.instances){var r=this.callMessageHandler(this.instances[i],t,n);void 0!==r&&(e=r)}var s=this.callback.trigger(t,n);return void 0!==e?e:s},on:function(t,e){this.callback.add(t,e)},off:function(t,e){this.callback.remove(t,e)},api:function(t){if((this.isStarted()||"start"===t)&&(!this.isReadOnly()||"disableReadOnly"===t)){this.broadcast("state");var e=[].slice.call(arguments,1),i=t.split("."),n=1===i.length,r="on"===i[0]||"off"===i[0],s=!r&&2===i.length,o="plugin"===i[0],a="module"===i[0];if(n){if("function"==typeof this[i[0]])return this.callInstanceMethod(this,i[0],e)}else{if(r)return"on"===i[0]?this.on(i[1],e[0]):this.off(i[1],e[0]||void 0);if(s){if(this.isInstanceExists(this,i[0]))return this.callInstanceMethod(this[i[0]],i[1],e);f.error(new Error('Service "'+i[0]+'" not found'))}else if(o){if(this.isInstanceExists(this.plugin,i[1]))return this.callInstanceMethod(this.plugin[i[1]],i[2],e);f.error(new Error('Plugin "'+i[1]+'" not found'))}else if(a){if(this.isInstanceExists(this.module,i[1]))return this.callInstanceMethod(this.module[i[1]],i[2],e);f.error(new Error('Module "'+i[1]+'" not found'))}}}},isInstanceExists:function(t,e){return void 0!==t[e]},callInstanceMethod:function(t,e,i){if("function"==typeof t[e])return t[e].apply(t,i)}},f.add("mixin","formatter",{buildArgs:function(t){this.args={class:t.class||!1,style:t.style||!1,attr:t.attr||!1},this.args.class||this.args.style||this.args.attr||(this.args=!1)},applyArgs:function(t,e){return t=this.args?this[this.type](this.args,!1,t,e):this._clearAll(t,e)},clearClass:function(t,e){this.selection.save();t=e?f.dom(e):this.getElements(t,!0);return t.removeAttr("class"),e=this._unwrapSpanWithoutAttr(t.getAll()),this.selection.restore(),e},clearStyle:function(t,e){this.selection.save();t=e?f.dom(e):this.getElements(t,!0);return t.removeAttr("style"),e=this._unwrapSpanWithoutAttr(t.getAll()),this.selection.restore(),e},clearAttr:function(t,e){this.selection.save();t=e?f.dom(e):this.getElements(t,!0);return this._removeAllAttr(t),e=this._unwrapSpanWithoutAttr(t.getAll()),this.selection.restore(),e},set:function(t,e,i,n){!1!==n&&this.selection.save();e=i?f.dom(i):this.getElements(e);return t.class&&(e.removeAttr("class"),e.addClass(t.class)),t.style&&(e.removeAttr("style"),e.css(t.style),e.each(function(t){t=f.dom(t);t.attr("data-redactor-style-cache",t.attr("style"))})),t.attr&&(this._removeAllAttr(e),e.attr(t.attr)),!1!==n&&this.selection.restore(),e.getAll()},toggle:function(t,e,i,n){!1!==n&&this.selection.save();var s,e=i?f.dom(i):this.getElements(e);return t.class&&(e.toggleClass(t.class),e.each(function(t){""===t.className&&t.removeAttribute("class")})),t.style&&(s=t.style,e.each(function(t){var e,i=f.dom(t);for(e in s){var n=s[e],r=i.css(e),r=this.utils.isRgb(r)?this.utils.rgb2hex(r):r.replace(/"/g,""),n=this.utils.isRgb(n)?this.utils.rgb2hex(n):n.replace(/"/g,"");r=this.utils.hex2long(r),("string"==typeof(n=this.utils.hex2long(n))?n.toLowerCase():n)===("string"==typeof r?r.toLowerCase():r)?i.css(e,""):i.css(e,n)}this._convertStyleQuotes(i),this.utils.removeEmptyAttr(t,"style")?i.removeAttr("data-redactor-style-cache"):i.attr("data-redactor-style-cache",i.attr("style"))}.bind(this))),t.attr&&(s=t.attr,e.each(function(t){var e,i=f.dom(t);for(e in s)i.attr(e)?i.removeAttr(e):i.attr(e,s[e])})),!1!==n&&this.selection.restore(),e.getAll()},add:function(t,e,i,n){!1!==n&&this.selection.save();var r,e=i?f.dom(i):this.getElements(e);return t.class&&e.addClass(t.class),t.style&&(r=t.style,e.each(function(t){t=f.dom(t);t.css(r),t.attr("data-redactor-style-cache",t.attr("style")),this._convertStyleQuotes(t)}.bind(this))),t.attr&&e.attr(t.attr),!1!==n&&this.selection.restore(),e.getAll()},remove:function(t,e,i,n){!1!==n&&this.selection.save();var r,e=i?f.dom(i):this.getElements(e);return t.class&&(e.removeClass(t.class),e.each(function(t){""===t.className&&t.removeAttribute("class")})),t.style&&(r=t.style,e.each(function(t){var e=f.dom(t);e.css(r,""),this.utils.removeEmptyAttr(t,"style")?e.removeAttr("data-redactor-style-cache"):e.attr("data-redactor-style-cache",e.attr("style"))}.bind(this))),t.attr&&e.removeAttr(t.attr),i=this._unwrapSpanWithoutAttr(e.getAll()),!1!==n&&this.selection.restore(),i},_removeAllAttr:function(t){t.each(function(t){for(var e=t.attributes.length;0<e--;){var i=t.attributes[e],n=i.name;"style"!==n&&"class"!==n&&t.removeAttributeNode(i)}})},_convertStyleQuotes:function(t){var e=t.attr("style");e&&t.attr("style",e.replace(/"/g,"'"))},_clearAll:function(t,e){!1!==e&&this.selection.save();for(var i=0;i<t.length;i++)for(var n=t[i];0<n.attributes.length;)n.removeAttribute(n.attributes[0].name);return t=this._unwrapSpanWithoutAttr(t),!1!==e&&this.selection.restore(),t},_unwrapSpanWithoutAttr:function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i];n.attributes.length<=0&&3!==n.nodeType&&"SPAN"===n.tagName?f.dom(n).unwrap():e.push(n)}return e}}),f.add("mixin","dom",f.Dom.prototype),f.add("mixin","component",{get cmnt(){return!0}}),f.add("service","options",{init:function(t,e){var i=f.dom(e),i=f.extend({},f.opts,e?i.data():{},f.options);return i=f.extend(!0,i,t)}}),f.add("service","lang",{init:function(t){this.app=t,this.opts=t.opts,this.vars=this._build(this.opts.lang)},rebuild:function(t){this.opts.lang=t,this.vars=this._build(t)},extend:function(t){this.vars=f.extend(this.vars,t)},parse:function(t){if(void 0===t)return"";var e=t.match(/## (.*?) ##/g);if(e)for(var i=0;i<e.length;i++){var n=e[i].replace(/^##\s/g,"").replace(/\s##$/g,"");t=t.replace(e[i],this.get(n))}return t},get:function(t){var e="";return void 0!==this.vars[t]?e=this.vars[t]:"en"!==this.opts.lang&&void 0!==f.lang.en[t]&&(e=f.lang.en[t]),e},_build:function(t){var e=f.lang.en;return"en"!==t&&(e=void 0!==f.lang[t]?f.lang[t]:e),e}}),f.add("service","callback",{init:function(t){this.app=t,this.opts=t.opts,this.callbacks={},this.opts.callbacks&&this._set(this.opts.callbacks,"")},stop:function(){this.callbacks={}},add:function(t,e){this.callbacks[t]||(this.callbacks[t]=[]),this.callbacks[t].push(e)},remove:function(t,e){if(void 0===e)delete this.callbacks[t];else{for(var i=0;i<this.callbacks[t].length;i++)this.callbacks[t].splice(i,1);0===Object.keys(this.callbacks[t]).length&&delete this.callbacks[t]}},trigger:function(t,e){t=this._loop(t,e,this.callbacks);return void 0===t&&e&&!1!==e[0]?e[0]:t},_set:function(t,e){for(var i in t){var n=""===e?i:e+"."+i;"object"==typeof t[i]?this._set(t[i],n):(this.callbacks[n]=[],this.callbacks[n].push(t[i]))}},_loop:function(t,e,i){var n,r;for(r in i)if(t===r)for(var s=0;s<i[r].length;s++)n=i[r][s].apply(this.app,e);return n}}),f.add("service","animate",{init:function(t){this.animationOpt=t.opts.animation},start:function(t,e,i,n){var r={duration:!1,iterate:!1,delay:!1,timing:!1,prefix:"redactor-"},r="function"==typeof i?r:f.extend(r,i);return new f.AnimatePlay(t,e,r,n="function"==typeof i?i:n,this.animationOpt)},stop:function(t){this.$el=f.dom(t),this.$el.removeClass("redactor-animated");t=this.$el.attr("redactor-animate-effect");this.$el.removeClass(t),this.$el.removeAttr("redactor-animate-effect");t=this.$el.attr("redactor-animate-hide");t&&this.$el.addClass(t).removeAttr("redactor-animate-hide"),this.$el.off("animationend webkitAnimationEnd")}}),(f.AnimatePlay=function(t,e,i,n,r){return this.hidableEffects=["fadeOut","flipOut","slideUp","zoomOut","slideOutUp","slideOutRight","slideOutLeft"],this.prefixes=["","-webkit-"],this.$el=f.dom(t),this.$body=f.dom("body"),this.callback=n,this.animation=r?e:this.buildAnimationOff(e),this.defaults=i,"slideUp"===this.animation&&this.$el.height(this.$el.height()),this.isInanimate()?this.inanimate():this.animate()}).prototype={buildAnimationOff:function(t){return this.isHidable(t)?"hide":"show"},buildHideClass:function(){return"redactor-animate-hide"},isInanimate:function(){return"show"===this.animation||"hide"===this.animation},isAnimated:function(){return this.$el.hasClass("redactor-animated")},isHidable:function(t){return-1!==this.hidableEffects.indexOf(t)},inanimate:function(){var t;return this.defaults.timing="linear","show"===this.animation?(t=this.buildHideClass(),this.$el.attr("redactor-animate-hide",t),this.$el.removeClass(t)):(t=this.$el.attr("redactor-animate-hide"),this.$el.addClass(t).removeAttr("redactor-animate-hide")),"function"==typeof this.callback&&this.callback(this),this},animate:function(){var t=this.defaults.delay||0;return setTimeout(function(){var t;this.$body.addClass("no-scroll-x"),this.$el.addClass("redactor-animated"),this.$el.attr("redactor-animate-hide")||(t=this.buildHideClass(),this.$el.attr("redactor-animate-hide",t),this.$el.removeClass(t)),this.$el.addClass(this.defaults.prefix+this.animation),this.$el.attr("redactor-animate-effect",this.defaults.prefix+this.animation),this.set(this.defaults.duration+"s",this.defaults.iterate,this.defaults.timing),this.complete()}.bind(this),1e3*t),this},set:function(t,e,i){for(var n=this.prefixes.length;n--;)!1===t&&""!==t||this.$el.css(this.prefixes[n]+"animation-duration",t),!1===e&&""!==e||this.$el.css(this.prefixes[n]+"animation-iteration-count",e),!1===i&&""!==i||this.$el.css(this.prefixes[n]+"animation-timing-function",i)},clean:function(){this.$body.removeClass("no-scroll-x"),this.$el.removeClass("redactor-animated"),this.$el.removeClass(this.defaults.prefix+this.animation),this.$el.removeAttr("redactor-animate-effect"),this.set("","","")},complete:function(){this.$el.one("animationend webkitAnimationEnd",function(){var t;this.$el.hasClass(this.defaults.prefix+this.animation)&&this.clean(),this.isHidable(this.animation)&&(t=this.$el.attr("redactor-animate-hide"),this.$el.addClass(t).removeAttr("redactor-animate-hide")),"slideUp"===this.animation&&this.$el.height(""),"function"==typeof this.callback&&this.callback(this.$el)}.bind(this))}},f.add("service","caret",{init:function(t){this.app=t},setStart:function(t){this._setCaret("Start",t)},setEnd:function(t){this._setCaret("End",t)},setBefore:function(t){this._setCaret("Before",t)},setAfter:function(t){this._setCaret("After",t)},isStart:function(t){return this._isStartOrEnd(t,"First")},isEnd:function(t){return this._isStartOrEnd(t,"Last")},setAtEnd:function(t){var e=this.inspector.parse(t).getTag(),i=document.createRange();this._isInPage(t)&&("a"===e?(e=this.utils.createInvisibleChar(),f.dom(t).after(e),i.selectNodeContents(e),i.collapse(!0)):(i.selectNodeContents(t),i.collapse(!1)),this.selection.setRange(i))},setAtStart:function(t){var e=document.createRange(),i=this.inspector.parse(t);this._isInPage(t)&&(e.setStart(t,0),e.collapse(!0),i.isInline()&&(i=this.utils.createInvisibleChar(),e.insertNode(i),e.selectNodeContents(i),e.collapse(!1)),this.selection.setRange(e))},setAtBefore:function(t){var e=this.inspector.parse(t),i=document.createRange();this._isInPage(t)&&(i.setStartBefore(t),i.collapse(!0),e.isInline()&&(e=this.utils.createInvisibleChar(),t.parentNode.insertBefore(e,t),i.selectNodeContents(e),i.collapse(!1)),this.selection.setRange(i))},setAtAfter:function(t){var e=document.createRange();this._isInPage(t)&&(e.setStartAfter(t),e.collapse(!0),t=this.utils.createInvisibleChar(),e.insertNode(t),e.selectNodeContents(t),e.collapse(!1),this.selection.setRange(e))},setAtPrev:function(t){t=t.previousSibling;(t=t&&(3===t.nodeType&&this._isEmptyTextNode(t)?t.previousElementSibling:t))&&this.setEnd(t)},setAtNext:function(t){t=t.nextSibling;(t=t&&(3===t.nodeType&&this._isEmptyTextNode(t)?t.nextElementSibling:t))&&this.setStart(t)},_setCaret:function(t,e){var i=this.inspector.parse(e),e=i.getNode();e&&(this.component.clearActive(),this["_set"+t](e,i,i.getTag()))},_setStart:function(t,e,i){if(e.isText())return this.editor.focus(),this.setAtStart(t);if("ul"===i||"ol"===i){t=e.findFirstNode("li");var n=this.utils.getFirstElement(t),r=this.inspector.parse(n);if(n&&r.isComponent())return this.setStart(r.getComponent())}else if("dl"===i)t=e.findFirstNode("dt");else{if("br"===i||"hr"===i)return this.setBefore(t);if("td"===i||"th"===i){var s=e.getFirstElement(t);if(s)return this.setStart(s)}else{if("table"===i||"tr"===i)return this.setStart(e.findFirstNode("th, td"));if(e.isComponentType("code")&&!e.isFigcaption()){s=e.findLastNode("pre, code");return this.editor.focus(),this.setAtStart(s)}if("figure"===i&&e.isComponentType("table")){i=e.getTable(),i=this.inspector.parse(i);return this.setStart(i.findFirstNode("th, td"))}if(!e.isComponentType("table")&&e.isComponent()&&!e.isFigcaption())return this.component.setActive(t)}}this.editor.focus(),this._setInline(t,"Start")||this.setAtStart(t)},_setEnd:function(t,e,i){if(e.isText())return this.editor.focus(),this.setAtEnd(t);if("ul"===i||"ol"===i){t=e.findLastNode("li");var n=this.utils.getLastElement(t),r=this.inspector.parse(n);if(n&&r.isComponent())return this.setEnd(r.getComponent())}else if("dl"===i)t=e.findLastNode("dd");else{if("br"===i||"hr"===i)return this.setAfter(t);if("td"===i||"th"===i){var s=e.getLastElement();if(s)return this.setEnd(s)}else{if("table"===i||"tr"===i)return this.setEnd(e.findLastNode("th, td"));if(e.isComponentType("code")&&!e.isFigcaption()){s=e.findLastNode("pre, code");return this.editor.focus(),this.setAtEnd(s)}if("figure"===i&&e.isComponentType("table")){i=e.getTable(),i=this.inspector.parse(i);return this.setEnd(i.findLastNode("th, td"))}if(!e.isComponentType("table")&&e.isComponent()&&!e.isFigcaption())return this.component.setActive(t)}}if(this.editor.focus(),!this._setInline(t,"End")){if(this.utils.isEmpty(t))return this.setStart(t);this.setAtEnd(t)}},_setBefore:function(t,e,i){return 3===t.nodeType||e.isInline()?this.setAtBefore(t):e.isFirstTableCell()?this.setAtPrev(e.getComponent()):"td"===i||"th"===i?this.setAtPrev(t):e.isFirstListItem()?this.setAtPrev(e.getList()):e.isFigcaption()?this.setStart(e.getComponent()):!e.isComponentType("table")&&e.isComponent()?this.setAtPrev(e.getComponent()):e.isBlock()?this.setAtPrev(t):(this.editor.focus(),void this.setAtBefore(t))},_setAfter:function(t,e,i){return 3===t.nodeType||e.isInline()?this.setAtAfter(t):e.isLastTableCell()?this.setAtNext(e.getComponent()):"td"===i||"th"===i?this.setAtNext(t):e.isFirstListItem()?this.setAtNext(e.getList()):!e.isComponentType("table")&&e.isComponent()?this.setAtNext(e.getComponent()):e.isBlock()?this.setAtNext(t):(this.editor.focus(),void this.setAtAfter(t))},_setInline:function(t,e){t=this._hasInlineChild(t,"Start"===e?"first":"last");if(t)return"Start"===e?this.setStart(t):this.setEnd(t),!0},_isStartOrEnd:function(t,e){var i=this.utils.getNode(t);if(!i)return!1;var n=this.inspector.parse(i);if((i=this._getStartEndNode(i,n,e))&&3!==i.nodeType&&"LI"!==i.tagName){t=3===i.nodeType?i.textContent:i.innerHTML;if(""===(t=this.utils.trimSpaces(t)))return!0}if(!n.isFigcaption()&&n.isComponent()&&!n.isComponentEditable())return!0;n=this.offset.get(i,!0);return!!n&&("First"===e?0===n.start:n.end===this.offset.size(i,!0))},_isInPage:function(t){return!(!t||!t.nodeType)&&(t!==document.body&&document.body.contains(t))},_hasInlineChild:function(t,e){t=this.inspector.parse(t),e="first"===e?t.getFirstNode():t.getLastNode(),t=f.dom(e);if(e&&3!==e.nodeType&&this.inspector.isInlineTag(e.tagName)&&!t.hasClass("redactor-component")&&!t.hasClass("non-editable"))return e},_isEmptyTextNode:function(t){t=t.textContent.trim().replace(/\n/,"");return""===(t=this.utils.removeInvisibleChars(t))},_getStartEndNode:function(t,e,i){return e.isFigcaption()?t=e.getFigcaption():e.isTable()?t=e["find"+i+"Node"]("th, td"):e.isList()?t=e["find"+i+"Node"]("li"):e.isComponentType("code")&&(t=e.findLastNode("pre, code")),t}});var c=function(t){return document.getSelection().containsNode(t,!0)};"containsNode"in Selection.prototype||(c=function(t){var e=document.getSelection(),i=e.anchorNode.parentNode,n=e.focusNode.parentNode,r=e.getRangeAt(0).getBoundingClientRect(),e=t.getBoundingClientRect();return!!f.dom(i).closest(t).length||(!!f.dom(n).closest(t).length||r.top<e.top&&r.height>e.height)}),f.add("service","selection",{init:function(t){this.app=t},is:function(){var t=this.get();if(t){t=t.anchorNode;return 0!==f.dom(t).closest(".redactor-in-"+this.uuid).length||t===this.editor.getElement().get()}return!1},isCollapsed:function(){var t=this.get(),e=this.getRange();return!(!t||!t.isCollapsed)||!(!e||0!==e.toString().length)},isBackwards:function(){var t,e=!1,i=this.get();return i&&!i.isCollapsed&&((t=document.createRange()).setStart(i.anchorNode,i.anchorOffset),t.setEnd(i.focusNode,i.focusOffset),e=t.collapsed,t.detach()),e},isIn:function(t){var e=f.dom(t).get(),t=this.getCurrent();return!(!t||!e)&&e.contains(t)},isText:function(){var t=this.get();if(t){var e=t.anchorNode,t=this.getBlock(e),e=this.getBlocks();if(t&&this.inspector.isTableCellTag(t.tagName)||!1===t&&0===e.length)return!0}return!1},isAll:function(t){var e=this.utils.getNode(t);if(!e)return!1;var i=this.editor.isEditor(e),t=this.inspector.parse(e);if(!t.isFigcaption()&&this.component.isNonEditable(e)&&this.component.isActive(e))return!0;if(i){var n=this.editor.getElement().html().replace(/<p><\/p>$/i,"");if(this.getHtml(!1).length!==n.length)return!1}if(i&&this.editor.isEmpty()||this.isCollapsed())return!1;n=this.offset.get(e,!0),e=this.offset.size(e,!0);return!i&&t.isComponentType("code")&&(e=this.getText().trim().length),!(!n||0!==n.start||n.end!==e)},hasNonEditable:function(){var t=this.getHtml(),t=f.dom("<div>").html(t);return!this.isCollapsed()&&0!==t.find(".non-editable").length},setRange:function(t){var e=window.getSelection();e.removeAllRanges(),e.addRange(t)},setAll:function(t){var e,i,n=this.utils.getNode(t);n&&(i=this.inspector.parse(n),this.component.clearActive(),this.editor.focus(),this.editor.saveScroll(),this.editor.disableNonEditables(),n&&"TABLE"===n.tagName?(e=i.findFirstNode("td, th"),t=i.findLastNode("td, th"),f.dom(e).prepend(this.marker.build("start")),f.dom(t).append(this.marker.build("end")),this.restoreMarkers()):!i.isFigcaption()&&this.component.isNonEditable(n)?this.component.setActive(n):(i.isComponentType("code")&&(n=i.getComponentCodeElement()).focus(),(i=document.createRange()).selectNodeContents(n),this.setRange(i)),this.editor.enableNonEditables(),this.editor.restoreScroll())},get:function(){var t=window.getSelection();return 0<t.rangeCount?t:null},getRange:function(){var t=this.get();return t&&t.getRangeAt(0)?t.getRangeAt(0):null},getTextBeforeCaret:function(t){t=void 0===t?1:t;var e=this.editor.getElement().get(),i=this.getRange(),n=!1;return i&&((i=i.cloneRange()).collapse(!0),i.setStart(e,0),n=i.toString().slice(-t)),n},getTextAfterCaret:function(t){t=void 0===t?1:t;var e,i=this.editor.getElement().get(),n=this.getRange(),r=!1;return n&&((e=n.cloneRange()).selectNodeContents(i),e.setStart(n.endContainer,n.endOffset),r=e.toString().slice(0,t)),r},getPosition:function(){var t,e=this.getRange(),i={top:0,left:0,width:0,height:0};return window.getSelection&&e.getBoundingClientRect&&(t=(e=e.cloneRange()).startOffset-1,e.setStart(e.startContainer,t<0?0:t),i={top:(e=e.getBoundingClientRect()).top,left:e.left,width:e.right-e.left,height:e.bottom-e.top}),i},getCurrent:function(){var t=!1,e=this.get(),i=this.component.getActive();return i?t=i:e&&this.is()&&(t=e.anchorNode!==this.editor.getElement().get()&&e.anchorNode),t},getParent:function(){var t=!1,e=this.getCurrent();return e&&(t=(e=e.parentNode)!==this.editor.getElement().get()&&e),t},getElement:function(t){for(var e=t||this.getCurrent();e;){var i=this.inspector.parse(e);if(i.isElement()&&i.isInEditor())return e;e=e.parentNode}return!1},getInline:function(t){for(var e=t||this.getCurrent(),i=!1;e;)this._isInlineNode(e)&&(i=e),e=e.parentNode;return i},getInlineFirst:function(t){for(var e=t||this.getCurrent();e;){if(this._isInlineNode(e))return e;e=e.parentNode}return!1},getInlineAll:function(t){for(var e=t||this.getCurrent(),i=[];e;)this._isInlineNode(e)&&i.push(e),e=e.parentNode;return i},getBlock:function(t){for(var e=t||this.getCurrent();e;){var i=this.inspector.parse(e);if(this.inspector.isBlockTag(e.tagName)&&i.isInEditor(e))return e;e=e.parentNode}return!1},getInlinesAllSelected:function(t){if(this.isAll())return[];var e=this.getInlines({all:!0,inside:!0}),i=this.getText().replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"),n=[];if(""===i)n=e;else if(1<e.length)for(var r=0;r<e.length;r++)this._isTextSelected(e[r],i)&&n.push(e[r]);else 1===e.length&&this._isTextSelected(e[0],i)&&(n=e);return n=t&&t.tags?this._filterNodesByTags(n,t.tags):n},getInlines:function(t){for(var e,i=this.getNodes(),n=[],r=0;r<i.length;r++)if(t&&t.all)for(e=i[r];e;)this._isInlineNode(e)&&!this._isInNodesArray(n,e)&&n.push(e),e=e.parentNode;else(e=this.getInline(i[r]))&&!this._isInNodesArray(n,e)&&n.push(e);return n=t&&t.tags?this._filterNodesByTags(n,t.tags):n,n=t&&t.inside?this._filterInlinesInside(n,t):n},getBlocks:function(t){for(var e=this.getNodes(),i=this.getBlock(),e=0===e.length&&i?[i]:e,n=[],r=0;r<e.length;r++){var s=this.getBlock(e[r]);f.dom(s).hasClass("non-editable")||s&&!this._isInNodesArray(n,s)&&n.push(s)}return n=t&&t.tags?this._filterNodesByTags(n,t.tags):n,n=t&&t.first?this._filterBlocksFirst(n,t):n},getElements:function(t){for(var e=this.getNodes({textnodes:!1}),i=this.getBlock(),e=0===e.length&&i?[i]:e,n=[],r=0;r<e.length;r++)this._isInNodesArray(n,e[r])||n.push(e[r]);return n=t&&t.tags?this._filterNodesByTags(n,t.tags):n},getNodes:function(t){var e,i=[],n=this.component.getActive();return n?i=this._getNodesComponent(n):this.isCollapsed()?i=(e=this.getCurrent())?[e]:[]:this.is()&&!n&&(i=this._getRangeSelectedNodes()),i=this._filterServicesNodes(i),i=this._filterEditor(i),i=t&&t.tags?this._filterNodesByTags(i,t.tags):i,i=t&&t.textnodes?this._filterNodesTexts(i,t):i,i=t&&!t.textnodes?this._filterNodesElements(i):i},getText:function(){var t=this.get();return t?this.utils.removeInvisibleChars(t.toString()):""},getHtml:function(t){var e="",i=this.get();if(i){for(var n=document.createElement("div"),r=i.rangeCount,s=0;s<r;++s)n.appendChild(i.getRangeAt(s).cloneContents());e=n.innerHTML,e=(e=!1!==t?this.cleaner.output(e):e).replace(/<p><\/p>$/i,"")}return e},clear:function(){this.component.clearActive(),this.get().removeAllRanges()},collapseToStart:function(){var t=this.get();t&&!t.isCollapsed&&t.collapseToStart()},collapseToEnd:function(){var t=this.get();t&&!t.isCollapsed&&t.collapseToEnd()},saveActiveComponent:function(){var t=this.component.getActive();return!!t&&(this.savedComponent=t,!0)},restoreActiveComponent:function(){return!!this.savedComponent&&(this.component.setActive(this.savedComponent),!0)},save:function(){this._clearSaved();var t=this.getElement();!t||-1===["TD","TH","P","DIV","PRE","H1","H2","H3","H4","H5","H6","LI","BLOCKQUOTE"].indexOf(t.tagName)||""!==t.innerHTML&&"<br>"!==t.innerHTML?this.saveActiveComponent()||(this.saved=this.offset.get()):this.savedElement=t},restore:function(){(this.saved||this.savedComponent||this.savedElement)&&(this.editor.saveScroll(),this.savedElement?this.caret.setStart(this.savedElement):this.restoreActiveComponent()||this.offset.set(this.saved),this._clearSaved(),this.editor.restoreScroll())},saveMarkers:function(){this._clearSaved(),this.saveActiveComponent()||this.marker.insert()},restoreMarkers:function(){this.editor.saveScroll(),this.restoreActiveComponent()||this.marker.restore(),this._clearSaved(),this.editor.restoreScroll()},_getNextNode:function(t){if(t.hasChildNodes())return t.firstChild;for(;t&&!t.nextSibling;)t=t.parentNode;return t?t.nextSibling:null},_getNodesComponent:function(t){var e=this.getCurrent(),e=this.inspector.parse(e);return e.isFigcaption()?[e.getFigcaption()]:[t]},_getRangeSelectedNodes:function(){var t=[],e=this.getRange(),i=e.startContainer,n=e.startContainer,r=e.endContainer,s=this.editor.getElement();if(n===s.get()&&this.isAll())t=this.utils.getChildNodes(s);else if(i===r)t=[i];else{for(;i&&i!==r;)t.push(i=this._getNextNode(i));for(i=e.startContainer;i&&i!==e.commonAncestorContainer;)t.unshift(i),i=i.parentNode}return t},_isInNodesArray:function(t,e){return-1!==t.indexOf(e)},_filterEditor:function(t){for(var e=[],i=0;i<t.length;i++)this.inspector.parse(t[i]).isInEditor()&&e.push(t[i]);return e},_filterServicesNodes:function(t){for(var e=[],i=0;i<t.length;i++){var n=f.dom(t[i]),r=!1;t[i]&&3===t[i].nodeType&&this.utils.isEmpty(t[i])&&(r=!0),(n.hasClass("redactor-script-tag")||n.hasClass("redactor-component-caret")||n.hasClass("redactor-selection-marker")||n.hasClass("non-editable"))&&(r=!0),r||e.push(t[i])}return e},_filterNodesTexts:function(t,e){for(var i=[],n=0;n<t.length;n++)(3===t[n].nodeType||e.keepbr&&"BR"===t[n].tagName)&&(this.getInline(t[n])&&e&&!1===e.inline||i.push(t[n]));return i},_filterNodesElements:function(t){for(var e=[],i=0;i<t.length;i++)3!==t[i].nodeType&&e.push(t[i]);return e},_filterNodesByTags:function(t,e,i){for(var n,r=[],s=0;s<t.length;s++)i&&3===t[s].nodeType?r.push(t[s]):3!==t[s].nodeType&&(n=t[s].tagName.toLowerCase(),-1!==e.indexOf(n.toLowerCase())&&r.push(t[s]));return r},_filterBlocksFirst:function(t){for(var e=[],i=0;i<t.length;i++){var n=f.dom(t[i]),r=n.parent().get(),n=n.parent().hasClass("redactor-in"),r=r&&("TD"===r.tagName||"TH"===r.tagName);(n||r)&&e.push(t[i])}return e},_filterInlinesInside:function(t){for(var e=[],i=0;i<t.length;i++)c(t[i],!0)&&e.push(t[i]);return e},_isTextSelected:function(t,e){t=9!==t.nodeType?this.utils.removeInvisibleChars(t.textContent):"";return e===t||-1!==t.search(e)||-1!==e.search(new RegExp("^"+this.utils.escapeRegExp(t)+"$"))},_isInlineNode:function(t){var e=this.inspector.parse(t);return this.inspector.isInlineTag(t.tagName)&&e.isInEditor()},_clearSaved:function(){this.saved=!1,this.savedComponent=!1,this.savedElement=!1}}),f.add("service","element",{init:function(t){this.app=t,this.rootElement=t.rootElement,this.$element={},this.type="inline"},start:function(){this._build(),this._buildType()},isType:function(t){return t===this.type},getType:function(){return this.type},getElement:function(){return this.$element},_build:function(){this.$element=f.dom(this.rootElement)},_buildType:function(){var t=this.$element.get().tagName;this.type="TEXTAREA"===t?"textarea":this.type,this.type="DIV"===t?"div":this.type,this.type=this.opts.inline?"inline":this.type}}),f.add("service","editor",{init:function(t){this.app=t,this.scrolltop=!1,this.pasting=!1},start:function(){this._build()},focus:function(){this.isFocus()||this._isContenteditableFocus()||(this.saveScroll(),this.$editor.focus(),this.restoreScroll())},startFocus:function(){this.caret.setStart(this.getFirstNode())},endFocus:function(){this.caret.setEnd(this.getLastNode())},isPasting:function(){return this.pasting},enablePasting:function(){this.pasting=!0},disablePasting:function(){this.pasting=!1},saveScroll:function(){this.scrolltop=this._getScrollTarget().scrollTop(),this.opts.maxHeight&&(this.scrolltopin=this.$editor.scrollTop())},restoreScroll:function(){!1!==this.scrolltop&&(this._getScrollTarget().scrollTop(this.scrolltop),this.scrolltop=!1),this.scrolltopin&&(this.$editor.scrollTop(this.scrolltopin),this.scrolltopin=!1)},disableNonEditables:function(){this.$noneditables=this.$editor.find("[contenteditable=false]"),this.$noneditables.attr("contenteditable",!0)},enableNonEditables:function(){this.$noneditables&&setTimeout(function(){this.$noneditables.attr("contenteditable",!1)}.bind(this),1)},getFirstNode:function(){return this.$editor.contents()[0]},getLastNode:function(){var t=this.$editor.contents();return t[t.length-1]},isSourceMode:function(){return this.source.getElement().hasClass("redactor-source-open")},isEditor:function(t){return f.dom(t).get()===this.$editor.get()},isEmpty:function(t){return this.utils.isEmptyHtml(this.$editor.html(),!1,t)},isFocus:function(){var t=f.dom(document.activeElement);return 0!==this.$editor.find(".redactor-component-active").length||0!==t.closest(".redactor-in-"+this.uuid).length},setEmpty:function(){this.$editor.html(this.opts.emptyHtml)},getElement:function(){return this.$editor},_build:function(){var t=this.element.getElement(),t=this.element.isType("textarea")?"<div>":t.get();this.$editor=f.dom(t)},_getScrollTarget:function(){var t=this.$doc;return t=this.opts.toolbarFixedTarget!==document?f.dom(this.opts.toolbarFixedTarget):this.opts.scrollTarget?f.dom(this.opts.scrollTarget):t},_isContenteditableFocus:function(){var t=this.selection.getBlock();return 0!==(t?f.dom(t).closest("[contenteditable=true]").not(".redactor-in"):[]).length}}),f.add("service","container",{init:function(t){this.app=t},start:function(){this._build()},getElement:function(){return this.$container},_build:function(){var t=this.element.isType("inline")?"<span>":"<div>";this.$container=f.dom(t)}}),f.add("service","source",{init:function(t){this.app=t,this.$source={},this.content=""},start:function(){this._build(),this._buildName(),this._buildStartedContent()},getElement:function(){return this.$source},getCode:function(){return this.$source.val()},getName:function(){return this.$source.attr("name")},getStartedContent:function(){return this.content},setCode:function(t){return this.insertion.set(t,!0,!1)},isNameGenerated:function(){return this.name},rebuildStartedContent:function(){this._buildStartedContent()},_build:function(){var t=this.element.getElement(),t=this.element.isType("textarea")?t.get():"<textarea>";this.$source=f.dom(t)},_buildName:function(){var t=this.element.getElement();this.name=t.attr("name"),this.$source.attr("name",this.name||"content-"+this.uuid)},_buildStartedContent:function(){var t=this.element.getElement(),t=this.element.isType("textarea")?t.val():t.html();this.content=t.trim()}}),f.add("service","statusbar",{init:function(t){this.app=t,this.$statusbar={},this.items=[]},start:function(){this.$statusbar=f.dom("<ul>"),this.$statusbar.attr("dir",this.opts.direction)},add:function(t,e){return this.update(t,e)},update:function(t,e){var i;return void 0!==this.items[t]?i=this.items[t]:(i=f.dom("<li>"),this.$statusbar.append(i),this.items[t]=i),i.html(e)},get:function(t){return this.items[t]||!1},remove:function(t){this.items[t]&&(this.items[t].remove(),delete this.items[t])},getItems:function(){return this.items},removeItems:function(){this.items={},this.$statusbar.html("")},getElement:function(){return this.$statusbar}}),f.add("service","toolbar",{init:function(t){this.app=t,this.buttons=[],this.dropdownOpened=!1,this.buttonsObservers={}},start:function(){this.is()&&(this.opts.activeButtons=this.opts.activeButtonsAdd?this._extendActiveButtons():this.opts.activeButtons,this.create())},stopObservers:function(){this.buttonsObservers={}},create:function(){this.$wrapper=f.dom("<div>"),this.$toolbar=f.dom("<div>")},observe:function(){if(this.is()){var t,e,i;for(i in this.setButtonsInactive(),this.buttonsObservers)e=this.buttonsObservers[i],t=this.getButton(i),this.app.broadcast("button."+e+".observe",t);var n=this.opts.activeButtons,r=this.selection.getInlinesAllSelected(),s=this.selection.getInline(),o=this.selection.getInlineAll();this.selection.isCollapsed()&&(s&&r.push(s),0!==o.length&&(r=r.concat(o)));var a,l=this._inlinesToTags(r);for(a in n)-1!==l.indexOf(a)&&(t=this.getButton(n[a]))&&t.setActive()}},is:function(){return!(!this.opts.toolbar||this.detector.isMobile()&&this.opts.air)},isAir:function(){return!!this.is()&&this.$toolbar.hasClass("redactor-air")},isFixed:function(){return!!this.is()&&this.$toolbar.hasClass("redactor-toolbar-fixed")},isContextBar:function(){return this.$body.find("#redactor-context-toolbar-"+this.uuid).hasClass("open")},isTarget:function(){return this.opts.toolbarFixedTarget!==document},getElement:function(){return this.$toolbar},getWrapper:function(){return this.$wrapper},getDropdown:function(){return this.dropdownOpened},getTargetElement:function(){return f.dom(this.opts.toolbarFixedTarget)},getButton:function(t){t=this._findButton(".re-"+t);return 0!==t.length&&t.dataget("data-button-instance")},getButtons:function(){var e=[];return this._findButtons().each(function(t){t=f.dom(t);e.push(t.dataget("data-button-instance"))}),e},getButtonsKeys:function(){var e=[];return this._findButtons().each(function(t){t=f.dom(t);e.push(t.attr("data-re-name"))}),e},addButton:function(t,e,i,n,r){i=i||"end";var s=f.create("toolbar.button",this.app,t,e);return e.observe&&(this.opts.activeButtonsObservers[t]={observe:e.observe,button:s}),this.is()&&("first"===i?this.$toolbar.prepend(s):"after"===i?n.after(s):"before"===i?n.before(s):(t=this.opts.buttons.indexOf(t),!0!==r&&-1!==t?0===t?this.$toolbar.prepend(s):0<(t=this._findButtons().eq(t-1)).length?t.after(s):this.$toolbar.append(s):this.$toolbar.append(s))),s},addButtonFirst:function(t,e){return this.addButton(t,e,"first")},addButtonAfter:function(t,e,i){t=this.getButton(t);return t?this.addButton(e,i,"after",t):this.addButton(e,i)},addButtonBefore:function(t,e,i){t=this.getButton(t);return t?this.addButton(e,i,"before",t):this.addButton(e,i)},addButtonObserver:function(t,e){this.buttonsObservers[t]=e},setButtons:function(t){this.buttons=t},setDropdown:function(t){this.dropdownOpened=t},setButtonsInactive:function(){for(var t=this.getButtons(),e=0;e<t.length;e++)t[e].setInactive()},setButtonsActive:function(){for(var t=this.getButtons(),e=0;e<t.length;e++)t[e].setActive()},disableButtons:function(){for(var t=this.getButtons(),e=0;e<t.length;e++)t[e].disable()},enableButtons:function(){for(var t=this.getButtons(),e=0;e<t.length;e++)t[e].enable()},_findButton:function(t){return this.is()?this.$toolbar.find(t):f.dom()},_findButtons:function(){return this.is()?this.$toolbar.find(".re-button"):f.dom()},_extendActiveButtons:function(){return f.extend({},this.opts.activeButtons,this.opts.activeButtonsAdd)},_inlinesToTags:function(t){for(var e=[],i=0;i<t.length;i++)e.push(t[i].tagName.toLowerCase());return e}}),f.add("class","toolbar.button",{mixins:["dom"],init:function(t,e,i){this.app=t,this.opts=t.opts,this.lang=t.lang,this.$body=t.$body,this.toolbar=t.toolbar,this.detector=t.detector,this.obj=i,this.name=e,this.dropdown=!1,this.tooltip=!1,this._init()},isActive:function(){return this.hasClass("redactor-button-active")},isDisabled:function(){return this.hasClass("redactor-button-disabled")},hasIcon:function(){return this.obj.icon&&!this.opts.buttonsTextLabeled},setDropdown:function(t){this.obj.dropdown=t,this.obj.message=!1,this.dropdown=f.create("toolbar.dropdown",this.app,this.name,this.obj.dropdown),this.attr("data-dropdown",!0)},setMessage:function(t,e){this.obj.message=t,this.obj.args=e,this.obj.dropdown=!1},setApi:function(t,e){this.obj.api=t,this.obj.args=e,this.obj.dropdown=!1},setTitle:function(t){this.obj.title=this.lang.parse(t),this.obj.tooltip=this.obj.title,this.attr({alt:this.obj.tooltip,"aria-label":this.obj.tooltip}),this.attr("data-re-icon")||this.html(this.obj.title)},setTooltip:function(t){this.obj.tooltip=this.lang.parse(t),this.attr({alt:this.obj.tooltip,"aria-label":this.obj.tooltip})},setIcon:function(t){this.opts.buttonsTextLabeled||(this.obj.icon=!0,this.$icon=f.dom(t),this.html(""),this.append(this.$icon),this.attr("data-re-icon",!0),this.addClass("re-button-icon"),this.setTooltip(this.obj.title),this._buildTooltip())},setActive:function(){this.addClass("redactor-button-active")},setInactive:function(){this.removeClass("redactor-button-active")},hideTooltip:function(){this.$body.find(".re-button-tooltip").remove()},getDropdown:function(){return this.dropdown},disable:function(){this.addClass("redactor-button-disabled")},enable:function(){this.removeClass("redactor-button-disabled")},toggle:function(t){t&&t.preventDefault(),this.isDisabled()||(this.obj.dropdown?this.dropdown.toggle(t):this.obj.api?this.app.api(this.obj.api,this.obj.args,this.name):this.obj.message&&this.app.broadcast(this.obj.message,this.obj.args,this.name),this.hideTooltip())},_init:function(){this._parseTitle(),this._parseTooltip(),this._build(),this._buildCallback(),this._buildAttributes(),this._buildObserver(),this.hasIcon()?(this._buildIcon(),this._buildTooltip()):this.html(this.obj.title)},_parseTooltip:function(){this.obj.tooltip=this.obj.tooltip?this.lang.parse(this.obj.tooltip):this.obj.title},_parseTitle:function(){this.obj.title=this.lang.parse(this.obj.title)},_build:function(){this.parse("<a>"),this.addClass("re-button re-"+this.name),this.attr("data-re-name",this.name),this.dataset("data-button-instance",this),this.obj.dropdown&&this.setDropdown(this.obj.dropdown)},_buildCallback:function(){this.on("click",this.toggle.bind(this))},_buildAttributes:function(){var t={href:"#",alt:this.obj.tooltip,rel:this.name,role:"button","aria-label":this.obj.tooltip,tabindex:"-1"};this.attr(t)},_buildObserver:function(){void 0!==this.obj.observe&&this.toolbar.addButtonObserver(this.name,this.obj.observe)},_buildIcon:function(){var t=this.obj.icon,e=/(<([^>]+)>)/gi.test(t);this.$icon=f.dom(e?t:"<i>"),e||this.$icon.addClass("re-icon-"+this.name),this.append(this.$icon),this.attr("data-re-icon",!0),this.addClass("re-button-icon")},_buildTooltip:function(){this.detector.isDesktop()&&(this.tooltip=f.create("toolbar.button.tooltip",this.app,this))}}),f.add("class","toolbar.button.tooltip",{mixins:["dom"],init:function(t,e){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.$body=t.$body,this.toolbar=t.toolbar,this.$button=e,this.created=!1,this._init()},open:function(){var t,e,i;this.$button.hasClass("redactor-button-disabled")||this.$button.hasClass("redactor-button-active")||(this.created=!0,this.parse("<span>"),this.addClass("re-button-tooltip re-button-tooltip-"+this.uuid),this.$body.append(this),this.html(this.$button.attr("alt")),t=this.$button.offset(),e=this.$button.height(),i=this.$button.width(),this.css({top:t.top+e+4+"px",left:t.left+i/2-this.width()/2+"px",position:"absolute"}),this.show())},close:function(){this.created&&!this.$button.hasClass("redactor-button-disabled")&&(this.remove(),this.created=!1)},_init:function(){this.$button.on("mouseover",this.open.bind(this)),this.$button.on("mouseout",this.close.bind(this))}}),f.add("class","toolbar.dropdown",{mixins:["dom"],init:function(t,e,i){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.$win=t.$win,this.$doc=t.$doc,this.$body=t.$body,this.animate=t.animate,this.toolbar=t.toolbar,this.name=e,this.started=!1,this.items="format"===e?f.extend({},!0,i):i,this.$items=[]},toggle:function(t){this.started||this._build(),this.isOpened()&&this.isActive()?this.close(!1):this.open(t)},isOpened:function(){var t=this.$body.find(".redactor-dropdown-"+this.uuid+".open");return 0!==t.length&&t.attr("data-re-name")===this.name},isActive:function(){return 0!==this.$body.find("#redactor-dropdown-"+this.uuid+"-"+this.name+".open").length},getName:function(){return this.attr("data-re-name")},getItem:function(t){return this.$items[t]},getItemsByClass:function(t){var e,i=[];for(e in this.$items){var n=this.$items[e];"object"==typeof n&&n.attr("data-re-name")&&n.hasClass(t)&&i.push(n)}return i},open:function(t){this._closeAll(),this.$btn=this.toolbar.getButton(this.name),this.app.broadcast("dropdown.open",t,this,this.$btn),this.toolbar.setDropdown(this),this.show(),this.removeClass("redactor-animate-hide"),this.addClass("open"),this._observe(),this.$btn.hideTooltip(),this.$btn.setActive(),this.$doc.on("keyup.redactor.dropdown-"+this.uuid,this._handleKeyboard.bind(this)),this.$doc.on("click.redactor.dropdown-"+this.uuid,this.close.bind(this)),this.updatePosition(),this.app.broadcast("dropdown.opened",t,this,this.$btn)},close:function(t,e){if(t){var i=f.dom(t.target);if(this._isButton(t)||i.hasClass("redactor-dropdown-not-close")||i.hasClass("redactor-dropdown-item-disabled"))return void t.preventDefault()}this.app.broadcast("dropdown.close",this,this.$btn),this.toolbar.setDropdown(!1),this.$btn.setInactive(),!1===e?this._close():this.animate.start(this,"fadeOut",this._close.bind(this))},updatePosition:function(){this.toolbar.isFixed(),this.toolbar.isTarget();var t=this.$btn.height(),e=this.$btn.width(),i=this.$btn.offset(),n=i.left+0,r=parseFloat(this.css("width")),e=n-(this.$win.width()<n+r?r-e:0),t=i.top+t+2,e=e<0?4:e;this.css({maxHeight:"",position:"absolute",top:t+"px",left:e+"px"});t=this.$win.height()-(t-this.$doc.scrollTop())-10;this.css("max-height",t+"px")},_build:function(){this.parse("<div>"),this.attr("dir",this.opts.direction),this.attr("id","redactor-dropdown-"+this.uuid+"-"+this.name),this.attr("data-re-name",this.name),this.addClass("redactor-dropdown redactor-dropdown-"+this.uuid+" redactor-dropdown-"+this.name),this.dataset("data-dropdown-instance",this),this.items.sdom||"string"==typeof this.items?this._buildDom():this._buildItems(),this.$body.append(this),this.started=!0},_buildDom:function(){this.html("").append(f.dom(this.items))},_buildItems:function(){for(var t in this.items="format"===this.name?this._buildFormattingItems():this.items,this.items){var e=this.items[t];"observe"===t?this.attr("data-observe",this.items[t]):(e=f.create("toolbar.dropdown.item",this.app,t,e,this),this.$items[t]=e,this.append(e))}},_buildFormattingItems:function(){for(var t in this.items)-1===this.opts.formatting.indexOf(t)&&delete this.items[t];if(this.opts.formattingHide)for(var t in this.items)-1!==this.opts.formattingHide.indexOf(t)&&delete this.items[t];if(this.opts.formattingAdd)for(var t in this.opts.formattingAdd)this.items[t]=this.opts.formattingAdd[t];return this.items},_handleKeyboard:function(t){27===t.which&&this.close()},_isButton:function(t){return f.dom(t.target).closest(".re-button").get()===this.$btn.get()},_close:function(){this.$btn.setInactive(),this.$doc.off(".redactor.dropdown-"+this.uuid),this.removeClass("open"),this.addClass("redactor-animate-hide"),this.app.broadcast("dropdown.closed",this,this.$btn)},_closeAll:function(){this.$body.find(".redactor-dropdown-"+this.uuid+".open").each(function(t){f.dom(t).dataget("data-dropdown-instance")._close()})},_observe:function(){var t=this.attr("data-observe");t&&this.app.broadcast("dropdown."+t+".observe",this)}}),f.add("class","toolbar.dropdown.item",{mixins:["dom"],init:function(t,e,i,n){this.app=t,this.lang=t.lang,this.dropdown=n,this.name=e,this.obj=i,this._init()},setTitle:function(t){this.$span.html(t)},getTitle:function(){return this.$span.html()},enable:function(){this.removeClass("redactor-dropdown-item-disabled")},disable:function(){this.addClass("redactor-dropdown-item-disabled")},toggle:function(t){t&&t.preventDefault(),this.hasClass("redactor-dropdown-item-disabled")||(this.obj.message?this.app.broadcast(this.obj.message,this.obj.args,this.name):this.obj.api&&this.app.api(this.obj.api,this.obj.args,this.name))},_init:function(){this.parse("<a>"),this.attr("href","#"),this.addClass("redactor-dropdown-item-"+this.name),this.obj.classname&&this.addClass(this.obj.classname),this.attr("data-re-name",this.name),this.on("click",this.toggle.bind(this)),this.$span=f.dom("<span>"),this.append(this.$span),this.setTitle(this.lang.parse(this.obj.title))}}),f.add("service","cleaner",{init:function(t){this.app=t,this.opts=t.opts,this.storedComponents=[],this.storedComments=[],this.storedImages=[],this.storedLinks=[],this.deniedTags=["font","html","head","link","title","body","meta","applet"],this.convertRules={},this.unconvertRules={},this.reComments=/<!--[\s\S]*?-->\n?/g,this.reSpacedEmpty=/^(||\s||<br\s?\/?>||&nbsp;)$/i,this.reScriptTag=/<script(.*?[^>]?)>([\w\W]*?)<\/script>/gi},addConvertRules:function(t,e){this.convertRules[t]=e},addUnconvertRules:function(t,e){this.unconvertRules[t]=e},input:function(t,e,i){t=t.replace(/¤t/gi,"&current");var n=[];t=this.storeComments(t,n),t=this.encodeCode(t);var r=this.utils.buildWrapper(t);r.find("a, b, i, strong, em, img, svg, details, audio").removeAttr("onload onerror ontoggle onwheel onmouseover oncopy"),r.find("a, iframe, embed").each(function(t){var e=f.dom(t),i=e.attr("href"),t=e.attr("src");i&&-1!==i.trim().search(/^data|javascript:/i)&&e.attr("href",""),t&&-1!==t.trim().search(/^data|javascript:/i)&&e.attr("src","")});var s=["alt","title","src","class","width","height","srcset","style","usemap"];return r.find("img").each(function(t){if(0<t.attributes.length)for(var e=t.attributes,i=e.length-1;0<=i;i--){var n=-1===e[i].name.search(/^data-/)&&-1===s.indexOf(e[i].name),r="src"===e[i].name&&-1!==e[i].value.search(/^data|javascript:/i);this.opts.imageSrcData&&(r=!1),(n||r)&&t.removeAttribute(e[i].name)}}.bind(this)),t=(t=(t=this.utils.getWrapperHtml(r)).replace(/\$/g,"&#36;")).replace(/&amp;/g,"&"),t=f.create("cleaner.figure",this.app).convert(t,this.convertRules),t=this.storeComponents(t),t=this.replaceTags(t,this.opts.replaceTags),t=this._setSpanAttr(t),t=this._setStyleCache(t),t=this.removeTags(t,this.deniedTags),t=this.opts.removeScript?this._removeScriptTag(t):this._replaceScriptTag(t),t=this.opts.removeComments?this.removeComments(t):t,t=this._isSpacedEmpty(t)?this.opts.emptyHtml:t,t=this.restoreComponents(t),t=this._cleanWrapped(t),t=this.restoreComments(t,n),t=e?this.paragraphize(t):t},output:function(t,e){return t=this.removeInvisibleSpaces(t),this.opts.breakline&&(t=(t=t.replace(/<\/(span|strong|b|i|em)><br\s?\/?><\/div>/gi,"</$1></div>")).replace(/<br\s?\/?><\/(span|strong|b|i|em)><\/div>/gi,"</$1></div>")),t=t.replace(/&#36;/g,"$"),this._isSpacedEmpty(t)||this._isParagraphEmpty(t)?"":(t=this.removeServiceTagsAndAttrs(t,e),t=this.storeComponents(t),t=this.removeSpanWithoutAttributes(t),t=this.removeFirstBlockBreaklineInHtml(t),t=this.opts.removeScript?t:this._unreplaceScriptTag(t),t=this.opts.preClass?this._setPreClass(t):t,t=this.opts.linkNofollow?this._setLinkNofollow(t):t,t=this.opts.removeNewLines?this.cleanNewLines(t):t,t=this.restoreComponents(t),t=f.create("cleaner.figure",this.app).unconvert(t,this.unconvertRules),t=this.removeEmptyAttributes(t,["style","class","rel","alt","title"]),t=this.cleanSpacesInPre(t),t=(t=this.tidy(t)).replace(/&amp;/g,"&"),this.opts.breakline&&(t=(t=t.replace(/<br\s?\/?>/gi,"<br>\n")).replace(/<br\s?\/?>\n+/gi,"<br>\n")),t=""===t.replace(/\n/g,"")?"":t)},paste:function(t){t=(t=this.storeComponents(t)).replace(/<!--[\s\S]*?-->/g,"");var e=this.deniedTags.concat(["iframe"]);t=(t=(t=(t=this.removeTags(t,e)).replace(new RegExp("<!doctype([\\s\\S]+?)>","gi"),"")).replace(new RegExp("<style([\\s\\S]+?)</style>","gi"),"")).replace(new RegExp("</p><br /><p","gi"),"</p><p");var i=this._isHtmlMsWord(t);if(t=i?t:this._cleanGDocs(t),t=i?this._cleanMsWord(t):t,!this.opts.pasteClean)return t=this.restoreComponents(t);if(this.opts.pastePlainText)return t=this.restoreComponents(t),this.pastePlainText(t);var n=this.utils.buildWrapper(t);n.find("*").removeAttr("style"),n.find("[data-redactor-tag]").each(function(t){var e=f.dom(t);e.removeAttr("data-redactor-tag"),(this.utils.isEmptyHtml(e.html())?e.html("<br>"):t.lastChild&&"BR"===t.lastChild.tagName?e:e.append("<br>")).unwrap()}.bind(this)),t=(t=(t=this.utils.getWrapperHtml(n)).replace(/<br\s?\/?>$/,"")).replace(/<br\s?\/?><\/(td|th)>/,"</$1>");var r=this.opts.pasteBlockTags.concat(this.opts.pasteInlineTags);t=this.removeTagsExcept(t,r),t=this.opts.pasteLinks?t:this.removeTags(t,["a"]),t=this.opts.pasteImages?t:this.removeTags(t,["img"]);e=(n=this.utils.buildWrapper(t)).find("*"),r=0!==this.opts.pasteKeepStyle.length?","+this.opts.pasteKeepStyle.join(","):"";e.not("[data-redactor-style-cache]"+r).removeAttr("style");r=0!==this.opts.pasteKeepClass.length?","+this.opts.pasteKeepClass.join(","):"";e.not("[data-redactor-style-cache], span.redactor-component"+r).removeAttr("class");r=0!==this.opts.pasteKeepAttrs.length?","+this.opts.pasteKeepAttrs.join(","):"";e.not("img, a, span.redactor-component, [data-redactor-style-cache]"+r).each(function(t){for(var e=t.attributes,i=e.length-1;0<=i;i--)"class"!==t.attributes[i].name&&"dir"!==t.attributes[i].name&&t.removeAttribute(e[i].name)}),this.opts.pasteLinks&&!1!==this.opts.pasteLinkTarget&&n.find("a").attr("target",this.opts.pasteLinkTarget),n.find("[data-redactor-style-cache]").each(function(t){var e=t.getAttribute("data-redactor-style-cache");t.setAttribute("style",e)});var s=this.opts.imageAttrs;return n.find("img").each(function(t){if(0<t.attributes.length)for(var e=t.attributes,i=e.length-1;0<=i;i--)-1===s.indexOf(e[i].name)&&t.removeAttribute(e[i].name)}),n.find("span").each(function(t){0===t.attributes.length&&f.dom(t).unwrap()}),n.find(this.opts.inlineTags.join(",")).each(function(t){0===t.attributes.length&&this.utils.isEmptyHtml(t.innerHTML)&&f.dom(t).unwrap()}.bind(this)),n.find("ul, ol").each(function(t){var e=t.previousSibling;e&&"LI"===e.tagName&&((e=f.dom(e)).find("p").unwrap(),e.append(t))}),t=(t=(t=(t=(t=this.utils.getWrapperHtml(n)).replace(/<li><p>/gi,"<li>")).replace(/<\/p><\/li>/gi,"</li>")).replace(/^<li/gi,"<ul><li")).replace(/<\/li>$/gi,"</li></ul>"),this.opts.breakline&&(t=t.replace(/\n/g,"<br>")),t=(t=t.replace(/<p>&nbsp;<\/p>/gi,"<p></p>")).replace(/<p><br\s?\/?><\/p>/gi,"<p></p>"),i&&(t=(t=(t=t.replace(/<p><\/p>/gi,"")).replace(/<p>\s<\/p>/gi,"")).replace(/<td\n/gi,"<td ")),t=this.restoreComponents(t)},pastePlainText:function(t){return t=this.opts.pasteLinks?this.storeLinks(t):t,t=this.opts.pasteImages?this.storeImages(t):t,t=this.getPlainText(t),t=this._replaceNlToBr(t),t=this.opts.pasteLinks?this.restoreLinks(t):t,t=this.opts.pasteImages?this.restoreImages(t):t},tidy:function(t){return t},paragraphize:function(t){return t=f.create("cleaner.paragraphize",this.app).convert(t)},storeComments:function(t,e){var i=t.match(new RegExp("\x3c!--([\\w\\W]*?)--\x3e","gi"));if(null!==i)for(var n=0;n<i.length;n++)t=t.replace(i[n],"#####xstarthtmlcommentzz"+n+"xendhtmlcommentzz#####"),e.push(i[n]);return t},restoreComments:function(t,e){for(var i=0;i<e.length;i++)t=t.replace("#####xstarthtmlcommentzz"+i+"xendhtmlcommentzz#####",e[i]);return t},getFlatText:function(t){var e=f.dom("<div>");return t.nodeType||t.dom?e.append(t):(t=(t=t.toString()).trim(),e.html(t)),void 0===(t=e.get().textContent||e.get().innerText||"")?"":t},getPlainText:function(t){t=(t=(t=(t=(t=(t=t.replace(/<!--[\s\S]*?-->/gi,"")).replace(/<style[\s\S]*?style>/gi,"")).replace(/<p><\/p>/g,"")).replace(/<\/div>|<\/li>|<\/td>/gi,"\n")).replace(/<\/p>/gi,"\n\n")).replace(/<\/H[1-6]>/gi,"\n\n");var e=document.createElement("div");return e.innerHTML=t,(t=e.textContent||e.innerText).trim()},replaceTags:function(t,e){var i,n,r;return e&&(i=this,n=Object.keys(e),(r=this.utils.buildWrapper(t)).find(n.join(",")).each(function(t){i.utils.replaceToTag(t,e[t.tagName.toLowerCase()])}),t=this.utils.getWrapperHtml(r)),t},replaceNbspToSpaces:function(t){return t.replace("&nbsp;"," ")},replaceBlocksToBr:function(t){return t=(t=(t=t.replace(/<div[^>]*><\/div>/gi,"")).replace(/<td[^>]*><\/td>/gi,"")).replace(/<\/div>|<\/li>|<\/td>|<\/p>|<\/H[1-6]>/gi,"<br>")},cleanNewLines:function(t){return t.replace(/\r?\n/g,"")},cleanSpacesInPre:function(t){return t.replace("&nbsp;&nbsp;&nbsp;&nbsp;","    ")},removeInvisibleSpaces:function(t){return t=(t=this.utils.removeInvisibleChars(t)).replace(/&#65279;/gi,"")},removeNl:function(t){return t=(t=t.replace(/\n/g," ")).replace(/\s+/g,"s")},removeBrAtEnd:function(t){return t=(t=t.replace(/<br\s?\/?>$/gi," ")).replace(/<br\s?\/?><li/gi,"<li")},removeTags:function(t,i){var e=i?/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi:/(<([^>]+)>)/gi,n=i?function(t,e){return-1===i.indexOf(e.toLowerCase())?t:""}:"";return t.replace(e,n)},removeTagsExcept:function(t,i){if(void 0===i)return t.replace(/(<([^>]+)>)/gi,"");return t.replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(t,e){return-1===i.indexOf(e.toLowerCase())?"":t})},removeComments:function(t){return t.replace(this.reComments,"")},removeServiceTagsAndAttrs:function(t,e){var t=this.utils.buildWrapper(t),i=this;return!1!==e&&t.find(".redactor-selection-marker").each(function(t){t=f.dom(t);return""===i.utils.removeInvisibleChars(t.text())?t.remove():t.unwrap()}),t.find("[data-redactor-style-cache]").removeAttr("data-redactor-style-cache"),this.utils.getWrapperHtml(t)},removeSpanWithoutAttributes:function(t){t=this.utils.buildWrapper(t);return t.find("span").removeAttr("data-redactor-span data-redactor-style-cache").each(function(t){0===t.attributes.length&&f.dom(t).unwrap()}),this.utils.getWrapperHtml(t)},removeFirstBlockBreaklineInHtml:function(t){return t.replace(new RegExp("</li><br\\s?/?>","gi"),"</li>")},removeEmptyAttributes:function(t,e){for(var i=this.utils.buildWrapper(t),n=0;n<e.length;n++)i.find("["+e[n]+'=""]').removeAttr(e[n]);return this.utils.getWrapperHtml(i)},encodeHtml:function(t){return t=(t=(t=(t=(t=(t=t.replace(/<br\s?\/?>/g,"\n")).replace(/&nbsp;/g," ")).replace(/”/g,'"')).replace(/“/g,'"')).replace(/‘/g,"'")).replace(/’/g,"'"),t=(t=this.encodeEntities(t)).replace(/\$/g,"&#36;"),this.opts.preSpaces&&(t=t.replace(/\t/g,new Array(this.opts.preSpaces+1).join(" "))),t},encodeCode:function(t){return t=(t=(t=(t=(t=(t=(t=(t=this.encodeAttrSings(t)).replace(/<\s/gi,"&lt; ")).replace(/<([^>]+)</gi,"&lt;$1<")).replace(/<(.*?)>/gi,"xtagstartz$1xtagendz")).replace(/xtagstartzpre(.*?)xtagendz/g,"<pre$1>")).replace(/xtagstartzcode(.*?)xtagendz/g,"<code$1>")).replace(/xtagstartz\/codextagendz/g,"</code>")).replace(/xtagstartz\/prextagendz/g,"</pre>"),t=(t=(t=this._encodeCode(t)).replace(/xtagstartz([\w\W]*?)xtagendz/g,"<$1>")).replace(/xtagstartz\/(.*?)xtagendz/g,"</$1>"),t=this.decodeAttrSings(t)},_encodeCode:function(t){t=this.utils.buildWrapper(t);return t.find("pre code, pre, code").each(this._encodeNode.bind(this)),this.utils.getWrapperHtml(t)},_encodeNode:function(t){var e=t.firstChild,i=t.innerHTML;"PRE"===t.tagName&&e&&"CODE"===e.tagName||(i=(i=i.replace(/xtagstartz/g,"<")).replace(/xtagendz/g,">"),i=this.decodeEntities(i),t.textContent=this._encodeNodeHtml(i))},_encodeNodeHtml:function(t){return t=t.replace(/&nbsp;/g," ").replace(/<br\s?\/?>/g,"\n"),t=this.opts.preSpaces?t.replace(/\t/g,new Array(this.opts.preSpaces+1).join(" ")):t},encodeAttrSings:function(t){var e=t.match(/="(.*?)"/g);if(null!==e)for(var i,n=0;n<e.length;n++)-1===e[n].search(/^"</)&&-1===e[n].search(/>"$/)&&(i=(i=e[n].replace(">","xmoresignz")).replace("<","xlesssignz"),t=t.replace(e[n],i));return t},encodeEntities:function(t){return t=(t=this.decodeEntities(t)).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},encodePhpCode:function(t){return t=(t=(t=t.replace("<?php","&lt;?php")).replace("<?","&lt;?")).replace("?>","?&gt;")},decodeAttrSings:function(t){return t=(t=t.replace(/xmoresignz/gi,">")).replace(/xlesssignz/gi,"<")},decodeEntities:function(t){return String(t).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},storeComponents:function(t){var e=this.utils.getElementsFromHtml(t,"figure","table");return this._storeMatched(t,e,"Components","figure")},restoreComponents:function(t){return this._restoreMatched(t,"Components","figure")},storeLinks:function(t){var e=this.utils.getElementsFromHtml(t,"a");return this._storeMatched(t,e,"Links","a")},storeImages:function(t){var e=this.utils.getElementsFromHtml(t,"img");return this._storeMatched(t,e,"Images","img")},restoreLinks:function(t){return this._restoreMatched(t,"Links","a")},restoreImages:function(t){return this._restoreMatched(t,"Images","img")},_cleanWrapped:function(t){return t=t.replace(new RegExp("<p><figure([\\w\\W]*?)</figure></p>","gi"),"<figure$1</figure>")},_cleanGDocs:function(t){return t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2")).replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3")).replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?bold|font-weight:\s?bold;\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$2</i></b>")).replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?600|font-weight:\s?600;\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$2</i></b>")).replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?700|font-weight:\s?700;\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$2</i></b>")).replace(/<span[^>]*font-style:\s?italic[^>]*>([\w\W]*?)<\/span>/gi,"<i>$1</i>")).replace(/<span[^>]*font-weight:\s?bold[^>]*>([\w\W]*?)<\/span>/gi,"<b>$1</b>")).replace(/<span[^>]*font-weight:\s?700[^>]*>([\w\W]*?)<\/span>/gi,"<b>$1</b>")).replace(/<span[^>]*font-weight:\s?600[^>]*>([\w\W]*?)<\/span>/gi,"<b>$1</b>")},_cleanMsWord:function(t){t=(t=(t=(t=(t=t.replace(/<!--[\s\S]+?-->/gi,"")).replace(/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|img|meta|link|style|\w:\w+)(?=[\s\/>]))[^>]*>/gi,"")).replace(/<(\/?)s>/gi,"<$1strike>")).replace(/&nbsp;/gi," ")).replace(/<span\s+style\s*=\s*"\s*mso-spacerun\s*:\s*yes\s*;?\s*"\s*>([\s\u00a0]*)<\/span>/gi,function(t,e){return 0<e.length?e.replace(/./," ").slice(Math.floor(e.length/2)).split("").join(" "):""});var e=this.utils.buildWrapper(t);e.find(".MsoFootnoteText").each(function(t){var e=f.dom(t),t=e.parent();0!==t.length&&-1!==t.attr("style").search(/mso-element:footnote/)&&e.find("a").attr("id","_"+t.attr("id"))}),e.find(".MsoFootnoteReference").each(function(t){t=f.dom(t).parent();0!==t.length&&"A"===t.get().tagName&&t.attr("id",t.attr("name"))}),e.find("p").each(function(t){var e=f.dom(t),t=e.attr("style"),t=/mso-list:\w+ \w+([0-9]+)/.exec(t);t&&e.attr("data-listLevel",parseInt(t[1],10))}),this._parseWordLists(e),e.find("[align]").removeAttr("align"),e.find("[name]").removeAttr("name"),e.find("span").each(function(t){var e=f.dom(t),t=e.attr("style");/mso-list:Ignore/.exec(t)?e.remove():e.unwrap()}),e.find("[style]").removeAttr("style"),e.find("[class^='Mso']").removeAttr("class"),e.find("a").filter(function(t){return!t.hasAttribute("href")}).unwrap();for(var i="",n=(t=(t=(t=(t=(t=this.utils.getWrapperHtml(e)).replace(/<p[^>]*><\/p>/gi,"")).replace(/<li>·/gi,"<li>")).trim()).replace(/\/(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)>\s+<(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)/gi,"/$1>\n<$2")).split(/\n/),r=0;r<n.length;r++){var s=""!==n[r]&&-1===n[r].search(/>$/)?" ":"\n";i+=n[r]+s}return i},_parseWordLists:function(t){var s,o=0,a=null,l=null;t.find("p").each(function(t){var e=f.dom(t),i=e.attr("data-listLevel");if(null===i&&e.hasClass("MsoListParagraphCxSpMiddle")&&(i=1),null!==i){t=e.text(),t=/^\s*\w+\./.test(t)?"<ol></ol>":"<ul></ul>";if(e.hasClass("MsoListParagraphCxSpFirst")||e.hasClass("MsoNormal")?(l=f.dom(t),e.before(l)):o<i&&0!==o&&(s=f.dom(t),a.append(s),l=s),i<o)for(var n=o-i+1,r=0;r<n;r++)l=l.parent();e.find("span").first().unwrap(),a=f.dom("<li>"+e.html().trim()+"</li>"),null===l&&(e.before(t),l=e.prev()),l.append(a),e.remove(),o=i}else l=null,o=0})},_isSpacedEmpty:function(t){return-1!==t.search(this.reSpacedEmpty)},_isParagraphEmpty:function(t){return-1!==t.search(/^<p><\/p>$/i)},_isHtmlMsWord:function(t){return t.match(/class="?Mso|style="[^"]*\bmso-|style='[^'']*\bmso-|w:WordDocument/i)},_setSpanAttr:function(t){t=this.utils.buildWrapper(t);return t.find("span").attr("data-redactor-span",!0),this.utils.getWrapperHtml(t)},_setStyleCache:function(t){t=this.utils.buildWrapper(t);return t.find("[style]").each(function(t){t=f.dom(t);t.attr("data-redactor-style-cache",t.attr("style"))}),this.utils.getWrapperHtml(t)},_setPreClass:function(t){t=this.utils.buildWrapper(t);return t.find("pre").addClass(this.opts.preClass),this.utils.getWrapperHtml(t)},_setLinkNofollow:function(t){t=this.utils.buildWrapper(t);return t.find("a").attr("rel","nofollow"),this.utils.getWrapperHtml(t)},_replaceScriptTag:function(t){return t.replace(this.reScriptTag,'<script class="redactor-script-tag" $1>$2<\/script>')},_unreplaceScriptTag:function(t){return t.replace(/<script class="redactor-script-tag"(.*?[^>]?)>([\w\W]*?)<\/script>/gi,"<script$1>$2<\/script>")},_replaceNlToBr:function(t){return t.replace(/\n/g,"<br />")},_removeScriptTag:function(t){return t.replace(this.reScriptTag,"")},_storeMatched:function(t,e,i,n){if(this["stored"+i]=[],e)for(var r=0;r<e.length;r++)this["stored"+i][r]=e[r],t=t.replace(e[r],"####"+n+r+"####");return t},_restoreMatched:function(t,e,i){if(this["stored"+e])for(var n=0;n<this["stored"+e].length;n++)t=t.replace("####"+i+n+"####",this["stored"+e][n]);return t}}),f.add("class","cleaner.figure",{init:function(t){this.app=t,this.opts=t.opts,this.utils=t.utils,this.detector=t.detector},convert:function(t,e){t=this.utils.buildWrapper(t);return t.find("img").each(this._convertImage.bind(this)),t.find("hr").each(this._convertLine.bind(this)),t.find("iframe").each(this._convertIframe.bind(this)),t.find("table").each(this._convertTable.bind(this)),t.find("form").each(this._convertForm.bind(this)),t.find("figure pre").each(this._convertCode.bind(this)),t.find("[data-redactor-type=variable]").addClass("redactor-component"),t.find("figure").not(".redactor-component, .redactor-figure-code").each(this._convertWidget.bind(this)),t.find("figure pre").each(this._setContenteditableCode.bind(this)),t.find(".redactor-component, .non-editable").attr("contenteditable",!1),this.detector.isIe()&&t.find("[data-redactor-type=table]").removeAttr("contenteditable"),t.find("figcaption, td, th").attr("contenteditable",!0),t.find(".redactor-component, figcaption").attr("tabindex","-1"),this._acceptExtraRules(t,e),this.utils.getWrapperHtml(t)},unconvert:function(t,e){t=(t=t.replace(/<\/([^>]+)><div data-redactor-tag/g,"</$1>\n<div data-redactor-tag")).replace(/<\/([^>]+)><p/g,"</$1>\n<p");var i=this.utils.buildWrapper(t);return i.find("th, td, figcaption, figure, pre, code, .redactor-component").removeAttr("contenteditable tabindex"),i.find("figure").removeClass("redactor-component redactor-component-active redactor-uploaded-figure"),i.find("[data-redactor-type=variable]").removeClass("redactor-component redactor-component-active"),i.find("figure[data-redactor-type=line]").unwrap(),i.find("figure[data-redactor-type=widget]").each(this._unconvertWidget.bind(this)),i.find("figure[data-redactor-type=form]").each(this._unconvertForm.bind(this)),i.find("figure[data-redactor-type=table]").each(this._unconvertTable.bind(this)),i.find("figure[data-redactor-type=image]").removeAttr("rel").each(this._unconvertImages.bind(this)),i.find("img").removeAttr("data-redactor-type").removeClass("redactor-component"),i.find(".non-editable").removeAttr("contenteditable"),i.find("figure").each(this._removeTypes.bind(this)),i.find("span.redactor-component-caret").remove(),i=this._unconvertBreakTag(i),this._acceptExtraRules(i,e),t=(t=(t=this.utils.getWrapperHtml(i)).replace(/<br\s?\/?>$/,"")).replace(/<br\s?\/?><\/(td|th)>/,"</$1>")},_convertImage:function(t){var e,i,n=f.dom(t);this._isNonEditable(n)||(this.opts.imageObserve&&!n.attr("data-image")&&n.attr("data-image",this.utils.getRandomId()),e=n.closest("a"),0===(i=n.closest("figure")).children().not("a, img, br, figcaption").length&&(0===i.length?(t=(0!==e.length?e:n).closest("p"),!1===this.opts.imageFigure&&0!==t.length?(i=this.utils.replaceToTag(t,"figure")).addClass("redactor-replace-figure"):(0!==t.length&&t.unwrap(),i=(0!==e.length?e:n).wrap("<figure>"))):i.hasClass("redactor-uploaded-figure")?i.removeClass("redactor-uploaded-figure"):i.addClass("redactor-keep-figure"),this._setFigure(i,"image")))},_convertTable:function(t){this._isNonEditable(t)||(t=this._wrapFigure(t),this._setFigure(t,"table"))},_convertLine:function(t){this._isNonEditable(t)||(t=this._wrapFigure(t),this._setFigure(t,"line"))},_convertForm:function(t){this._isNonEditable(t)||(t=this.utils.replaceToTag(t,"figure"),this._setFigure(t,"form"))},_convertIframe:function(t){var e;this._isNonEditable(t)||0===f.dom(t).closest(".redactor-component").length&&(e=(e=t.getAttribute("src"))&&(e.match(this.opts.regex.youtube)||e.match(this.opts.regex.vimeo)),t=this._wrapFigure(t),e&&this._setFigure(t,"video"))},_convertCode:function(t){this._isNonEditable(t)||(t=this._wrapFigure(t),this._setFigure(t,"code"))},_convertWidget:function(t){var e;this._isNonEditable(t)||((e=f.dom(t)).addClass("redactor-component"),e.attr("data-redactor-type","widget"),e.attr("data-widget-code",encodeURI(t.innerHTML.trim())))},_unconvertBreakTag:function(t){return t.find("[data-redactor-tag]").each(function(t){var e,i=f.dom(t);i.removeAttr("data-redactor-tag"),0===t.attributes.length?(t.lastChild&&"BR"===t.lastChild.tagName||0!==(e=i.nextElement()).length&&e.attr("data-redactor-tag")&&t.appendChild(document.createElement("br")),i.unwrap()):t.lastChild&&"BR"===t.lastChild.tagName&&f.dom(t.lastChild).remove()}.bind(this)),t},_unconvertForm:function(t){this.utils.replaceToTag(t,"form")},_unconvertTable:function(t){f.dom(t).unwrap()},_unconvertWidget:function(t){t=f.dom(t);t.html(decodeURI(t.attr("data-widget-code"))),t.removeAttr("data-widget-code")},_unconvertImages:function(t){var e=f.dom(t);e.removeClass("redactor-component");var i=0!==e.closest("li").length,n=0!==e.closest("table").length,r=0!==e.find("figcaption").length,s=e.attr("style"),t=!(null===s||""===s),s=""!==e.attr("class");!i&&(!n||r||t||s)||e.unwrap()},_removeTypes:function(t){var e=f.dom(t),t=e.attr("data-redactor-type");t&&-1!==["image","widget","line","video","code","form","table"].indexOf(t)&&e.removeAttr("data-redactor-type"),e.hasClass("redactor-keep-figure")?e.removeClass("redactor-keep-figure"):"image"===t&&!1===this.opts.imageFigure&&(0!==e.find("figcaption").length||(e.hasClass("redactor-replace-figure")&&e.removeClass("redactor-replace-figure"),this.utils.replaceToTag(e,"p"))),e.removeClass("redactor-replace-figure")},_wrapFigure:function(t){var e=f.dom(t),t=e.closest("figure");return 0===t.length?e.wrap("<figure>"):t},_setFigure:function(t,e){t.addClass("redactor-component"),t.attr("data-redactor-type",e)},_setContenteditableCode:function(t){var e;this._isNonEditable(t)||(0!==(t=(e=f.dom(t)).children("code").first()).length?t:e).attr("contenteditable",!0).attr("tabindex","-1")},_acceptExtraRules:function(t,e){for(var i in e)"function"==typeof e[i]&&e[i](t)},_isNonEditable:function(t){return 0!==f.dom(t).closest(".non-editable").length}}),f.add("class","cleaner.paragraphize",{init:function(t){this.app=t,this.opts=t.opts,this.utils=t.utils,this.cleaner=t.cleaner,this.element=t.element,this.stored=[],this.remStart="#####replace",this.remEnd="#####",this.paragraphizeTags=["table","div","pre","form","ul","ol","h1","h2","h3","h4","h5","h6","dl","blockquote","figcaption","address","section","header","footer","aside","article","object","style","script","iframe","select","input","textarea","button","option","map","area","math","hr","fieldset","legend","hgroup","nav","figure","details","menu","summary","p"]},convert:function(t){var e=!0===(e=this._isConverted(t))?this._convert(t):e;return e=this._convertTable(e)},_convert:function(t,e){var i=this.opts.breakline||e?"sdivtag":this.opts.markup,n=e?"tbr":"br";t=this._storeTags(t);var r=[];t=(t=this.cleaner.storeComments(t,r)).trim(),t=this._trimLinks(t);e=this.opts.inlineTags.join("|");t=(t=(t=(t=(t=t.replace(new RegExp("<("+e+")(.*?[^>]?)>\n</("+e+")>","gi"),"<$1$2></$3>")).replace(/xparagraphmarkerz(?:\r\n|\r|\n)$/g,"")).replace(/xparagraphmarkerz$/g,"")).replace(/xparagraphmarkerz(?:\r\n|\r|\n)/g,"\n")).replace(/xparagraphmarkerz/g,"\n");for(var s="",o=(t=this.opts.breakline?(t=(t=t.replace(/<br\s?\/?>(?:\r\n|\r|\n)/gi,"xbreakmarkerz\n")).replace(/<br\s?\/?>/gi,"xbreakmarkerz\n")).replace(/xbreakmarkerz\n<\//gi,"xbreakmarkerz</"):t.replace(/[\n]+/g,"\n")).split("\n"),a=0;a<o.length;a++)s+="<"+i+">"+o[a]+"</"+i+">\n";return t=(t=(t=(t=s.replace(/\n$/,"")).replace(new RegExp("<"+i+">\\s+#####","gi"),"#####")).replace(new RegExp("<"+i+">#####","gi"),"#####")).replace(new RegExp("#####</"+i+">","gi"),"#####"),t=this.opts.breakline?t.replace(/xbreakmarkerz/gi,"<br>"):t,t=this._restoreTags(t),t=this.cleaner.restoreComments(t,r),this.opts.breakline&&(t=t.replace(new RegExp("<"+i+"></"+i+">","gi"),"<"+i+"><br></"+i+">")),t=(t=(t=t.replace(new RegExp("<sdivtag>","gi"),'<div data-redactor-tag="'+n+'">')).replace(new RegExp("sdivtag","gi"),"div")).replace(/<\/([^>]+)><div data-redactor-tag/g,"</$1>\n<div data-redactor-tag")},_convertTable:function(t){var e=this.utils.buildWrapper(t);return e.find("td, th").each(this._convertCell.bind(this)),t=this.utils.getWrapperHtml(e)},_convertCell:function(t){var e=f.dom(t);this.stored=[];t=this._convert(e.html(),!0);e.html(t)},_storeTags:function(t){var i=this,t=this.utils.buildWrapper(t);return t.find(this.paragraphizeTags.join(", ")).each(function(t,e){e=document.createTextNode(i.remStart+e+i.remEnd+"xparagraphmarkerz");i.stored.push(t.outerHTML),t.parentNode.replaceChild(e,t)}),this.utils.getWrapperHtml(t)},_restoreTags:function(t){for(var e=0;e<this.stored.length;e++)this.stored[e]=this.stored[e].replace(/\$/g,"&#36;"),t=t.replace(this.remStart+e+this.remEnd,this.stored[e]);return t},_trimLinks:function(t){var e=this.utils.buildWrapper(t);return e.find("a").each(this._trimLink.bind(this)),t=this.utils.getWrapperHtml(e)},_trimLink:function(t){t=f.dom(t);t.html(t.html().trim())},_isConverted:function(t){return this._isDisabled(t)?t:!this._isEmptyHtml(t)||this.opts.emptyHtml},_isDisabled:function(){return!1===this.opts.paragraphize||this.element.isType("inline")},_isEmptyHtml:function(t){return""===t||"<p></p>"===t||"<div></div>"===t}}),f.add("service","detector",{init:function(t){this.app=t,this.userAgent=navigator.userAgent.toLowerCase()},isWebkit:function(){return/webkit/.test(this.userAgent)},isFirefox:function(){return-1<this.userAgent.indexOf("firefox")},isIe:function(t){if(document.documentMode||/Edge/.test(navigator.userAgent))return"edge";t=RegExp("msie"+(isNaN(t)?"":"\\s"+t),"i").test(navigator.userAgent);return t=t||!!navigator.userAgent.match(/Trident.*rv[ :]*11\./)},isMobile:function(){return/(iPhone|iPod|Android)/.test(navigator.userAgent)},isDesktop:function(){return!/(iPhone|iPod|iPad|Android)/.test(navigator.userAgent)},isIpad:function(){return/iPad/.test(navigator.userAgent)}}),f.add("service","offset",{init:function(t){this.app=t},get:function(t,e){var i={start:0,end:0},n=this.utils.getNode(t);if(!n)return!1;var r=this.editor.isEditor(n),s=!!r||this.selection.isIn(n),t=this.selection.getRange();return r||s?this.selection.is()&&s&&(r=f.dom(t.startContainer).hasClass("redactor-component")?t.startOffset:0,(s=t.cloneRange()).selectNodeContents(n),s.setEnd(t.startContainer,t.startOffset),t=this._getString(t,e),i.start=this._getString(s,e).length-r,i.end=i.start+t.length+r):i=!1,i},set:function(t,e){if(!this._setComponentOffset(e)){this.component.clearActive();var i=this.utils.getNode(e);if(i){var e=this.size(i),n=0,r=document.createRange();t.end=t.end>e?e:t.end,r.setStart(i,0),r.collapse(!0);for(var s=[i],o=!1,a=!1;!a&&(i=s.pop());)if(3===i.nodeType){var l=n+i.length;!o&&!this._isFigcaptionNext(i)&&t.start>=n&&t.start<=l&&(r.setStart(i,t.start-n),o=!0),o&&t.end>=n&&t.end<=l&&(r.setEnd(i,t.end-n),a=!0),n=l}else for(var c=i.childNodes.length;c--;)s.push(i.childNodes[c]);this.selection.setRange(r)}}},size:function(t,e){var i=this.utils.getNode(t);if(i){t=document.createRange().cloneRange();return t.selectNodeContents(i),this._getString(t,e).length}return 0},_getString:function(t,e){t=t.toString(),t=this.editor.isEmpty()?t.replace(/\uFEFF/g,""):t;return t=e?t.trim():t},_setComponentOffset:function(t){return!!this.component.isNonEditable(t)&&this.component.setActive(t)},_isFigcaptionNext:function(t){var e=t.nextSibling;return""===t.nodeValue.trim()&&e&&"FIGCAPTION"===e.tagName}}),f.add("service","inspector",{init:function(t){this.app=t},parse:function(t){return f.create("inspector.parser",this.app,this,t)},isText:function(t){if("string"==typeof t&&!/^\s*<(\w+|!)[^>]*>/.test(t))return!0;t=f.dom(t).get();return t&&3===t.nodeType},isInlineTag:function(t,e){e=this._extendTags(this.opts.inlineTags,e);return this._isTag(t)&&-1!==e.indexOf(t.toLowerCase())},isBlockTag:function(t,e){e=this._extendTags(this.opts.blockTags,e);return this._isTag(t)&&-1!==e.indexOf(t.toLowerCase())},isTableCellTag:function(t){return-1!==["td","th"].indexOf(t.toLowerCase())},isHeadingTag:function(t){return-1!==["h1","h2","h3","h4","h5","h6"].indexOf(t.toLowerCase())},_isTag:function(t){return void 0!==t&&t},_extendTags:function(t,e){if(t=t.concat(t),e)for(var i=0;i<e.length;i++)t.push(e[i]);return t}}),f.add("class","inspector.parser",{init:function(t,e,i){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.utils=t.utils,this.editor=t.editor,this.selection=t.selection,this.inspector=e;e=this.editor.getElement();this.el=i,this.$el=f.dom(this.el,e),this.node=this.$el.get(),this.node&&8===this.node.nodeType&&(this.node=!1),this.$component=this.$el.closest(".redactor-component",e)},isEditor:function(){return this.node===this.editor.getElement().get()},isInEditor:function(){return 0!==this.$el.parents(".redactor-in-"+this.uuid).length},isComponent:function(){return 0!==this.$component.length},isComponentType:function(t){return this.getComponentType()===t},isComponentActive:function(){return this.isComponent()&&this.$component.hasClass("redactor-component-active")},isComponentEditable:function(){var t=this.getComponentType();return this.isComponent()&&-1!==["code","table"].indexOf(t)},isFigcaption:function(){return this.getFigcaption()},isPre:function(){return this.getPre()},isCode:function(){var t=this.$el.closest("code"),e=t.parent("pre");return 0!==t.length&&0===e.length},isList:function(){return this.getList()},isFirstListItem:function(){return this._getLastOrFirstListItem("first")},isLastListItem:function(){return this._getLastOrFirstListItem("last")},isFirstTableCell:function(){return this._getLastOrFirstTableCell("first")},isLastTableCell:function(){return this._getLastOrFirstTableCell("last")},isTable:function(){return this.isComponentType("table")||this.getTable()},isHeading:function(){return this.getHeading()},isBlockquote:function(){return this.getBlockquote()},isDl:function(){return this.getDl()},isParagraph:function(){return this.getParagraph()},isLink:function(){return this.getLink()},isFile:function(){return this.getFile()},isText:function(){return this.inspector.isText(this.el)},isInline:function(){var t=this.opts.inlineTags;return!!this.isElement()&&-1!==t.indexOf(this.node.tagName.toLowerCase())},isBlock:function(){var t=this.opts.blockTags;return!!this.isElement()&&-1!==t.indexOf(this.node.tagName.toLowerCase())},isElement:function(){return this.node&&this.node.nodeType&&3!==this.node.nodeType},hasParent:function(t){return 0!==this.$el.closest(t.join(",")).length},getNode:function(){return this.node},getTag:function(){return!!this.isElement()&&this.node.tagName.toLowerCase()},getComponent:function(){return!!this.isComponent()&&this.$component.get()},getComponentType:function(){return!!this.isComponent()&&this.$component.attr("data-redactor-type")},getFirstNode:function(){return this.utils.getFirstNode(this.node)},getLastNode:function(){return this.utils.getLastNode(this.node)},getFirstElement:function(){return this.utils.getFirstElement(this.node)},getLastElement:function(){return this.utils.getLastElement(this.node)},getFigcaption:function(){return this._getClosestNode("figcaption")},getPre:function(){return this._getClosestNode("pre")},getCode:function(){return this._getClosestNode("code")},getList:function(){return this._getClosestNode("ul, ol")},getParentList:function(){return this._getClosestUpNode("ul, ol")},getListItem:function(){return this._getClosestNode("li")},getTable:function(){return this.getComponentType("table")?this.$component.find("table").get():this._getClosestNode("table")},getTableCell:function(){var t=this.$el.closest("td, th");return 0!==t.length&&t.get()},getComponentCodeElement:function(){return!!this.isComponentType("code")&&this.$component.find("pre code, pre").last().get()},getImageElement:function(){return!!this.isComponentType("image")&&this.$component.find("img").get()},getParagraph:function(){return this._getClosestNode("p")},getHeading:function(){return this._getClosestNode("h1, h2, h3, h4, h5, h6")},getDl:function(){return this._getClosestNode("dl")},getBlockquote:function(){return this._getClosestNode("blockquote")},getLink:function(){var t=this.isComponent()&&!this.isFigcaption();if(!this.isComponentType("table")&&t)return!1;t=this._getClosestElement("a");return!(!t||t.attr("data-file"))&&t.get()},getFile:function(){var t=this.isComponent();if(!this.isComponentType("table")&&t)return!1;t=this._getClosestElement("a");return!(!t||!t.attr("data-file"))&&t.get()},findFirstNode:function(t){return this.$el.find(t).first().get()},findLastNode:function(t){return this.$el.find(t).last().get()},_getLastOrFirstListItem:function(t){var e=this.getList(),i=this.getTag();if(e&&"li"===i){t=f.dom(e).find("li")[t]().get();if(t&&this.node===t)return!0}return!1},_getLastOrFirstTableCell:function(t){var e=this.getTable(),i=this.getTag();if(e&&("td"===i||"th"===i)){t=f.dom(e).find("td, th")[t]().get();if(t&&this.node===t)return!0}return!1},_getClosestUpNode:function(t){var e=this.editor.getElement(),e=this.$el.parents(t,e).last();return 0!==e.length&&e.get()},_getClosestNode:function(t){var e=this.editor.getElement(),e=this.$el.closest(t,e);return 0!==e.length&&e.get()},_getClosestElement:function(t){var e=this.editor.getElement(),e=this.$el.closest(t,e);return 0!==e.length&&e}}),f.add("service","marker",{init:function(t){this.app=t},build:function(t,e){var i=document.createElement("span");return i.id="selection-marker-"+this._getPos(t),i.className="redactor-selection-marker",i.innerHTML=this.opts.markerChar,e?i.outerHTML:i},buildHtml:function(t){return this.build(t,!0)},insert:function(t){this.remove();var e="both"!==t&&("start"===t||this.selection.isCollapsed());this.selection.is()||this.editor.focus();var i=this.selection.getRange();if(i){var n=this.build("start"),r=this.build("end"),t=i.cloneRange();return e||(t.collapse(!1),t.insertNode(r)),t.setStart(i.startContainer,i.startOffset),t.collapse(!0),t.insertNode(n),i.setStartAfter(n),e||i.setEndBefore(r),this.selection.setRange(i),n}},find:function(t,e){var i=this.editor.getElement(),t=(e||i).find("span#selection-marker-"+this._getPos(t));return 0!==t.length&&t.get()},restore:function(){var t,e,i=this.find("start"),n=this.find("end"),r=this.selection.getRange();r&&this.selection.is()||(this.editor.focus(),r=document.createRange()),i&&(t=!!n&&n.previousSibling,e=(!(e=i.nextSibling)||3!==e.nodeType||""!==e.textContent.replace(/[\n\t]/g,""))&&e,n?e&&"selection-marker-end"===e.id?this._restoreInject(r,i):t&&e?(r.selectNodeContents(t),r.collapse(!1),r.setStart(e,0)):t&&!e?(r.selectNodeContents(t),r.collapse(!1),r.setStartAfter(i)):(r.setStartAfter(i),r.setEndBefore(n)):e?(r.selectNodeContents(e),r.collapse(!0)):this._restoreInject(r,i),this.selection.setRange(r),i&&i.parentNode.removeChild(i),n&&n.parentNode.removeChild(n))},remove:function(){var t=this.find("start"),e=this.find("end");t&&t.parentNode.removeChild(t),e&&e.parentNode.removeChild(e)},_getPos:function(t){return void 0===t?"start":t},_restoreInject:function(t,e){var i=this.utils.createInvisibleChar();f.dom(e).after(i),t.selectNodeContents(i),t.collapse(!1)}}),f.add("service","component",{init:function(t){this.app=t,this.activeClass="redactor-component-active"},create:function(t,e){return f.create(t+".component",this.app,e)},build:function(t){var e,i=f.dom(t).attr("data-redactor-type");return i&&(e=this.create(i,t)),e||t},remove:function(t,e){var i=f.dom(t).closest(".redactor-component"),n=i.attr("data-redactor-type"),r=i.parent(),s=this.inspector.parse(r),t=this.utils.findSiblings(i,"prev"),r=this.utils.findSiblings(i,"next");!1!==this.app.broadcast(n+".delete",i)&&(i.remove(),this.app.broadcast(n+".deleted",i),this.app.broadcast("contextbar.close"),this.app.broadcast("imageresizer.stop"),!1!==e&&((s=s.getTableCell())&&this.utils.isEmptyHtml(s.innerHTML)?this.caret.setStart(s):r?this.caret.setStart(r):t?this.caret.setEnd(t):this.editor.startFocus()),this.editor.isEmpty()&&(this.editor.setEmpty(),this.editor.startFocus(),this.app.broadcast("empty")))},isNonEditable:function(t){t=this.inspector.parse(t);return t.isComponent()&&!t.isComponentEditable()},isActive:function(t){if(t){t=this.inspector.parse(t);return f.dom(t.getComponent()).hasClass(this.activeClass)}return 0!==this._find().length},getActive:function(t){var e=this._find();return 0!==e.length&&(t?e:e.get())},setActive:function(t){this.clearActive(),this.editor.focus();var e=this.inspector.parse(t),t=e.getComponent(),t=f.dom(t);e.isFigcaption()||(0===(e=t.find(".redactor-component-caret")).length&&(e=this._buildCaret(),t.prepend(e)),this.caret.setAtStart(e.get())),t.addClass(this.activeClass)},clearActive:function(){var t=this._find();t.removeClass(this.activeClass),t.find(".redactor-component-caret").remove(),this.app.broadcast("imageresizer.stop")},setOnEvent:function(t,e){this.clearActive();var i=this.inspector.parse(t.target);i.isFigcaption()||i.isComponentEditable()||i.isComponent()&&(this.setActive(t.target),!0!==e&&t.preventDefault())},executeScripts:function(t){if(void 0===t){t=this.editor.getElement().find("[data-redactor-type]").find("script").getAll();this.executeScripts.call(this,t)}else for(var e=0;e<t.length;e++)if(""!==t[e].src){var i=t[e].src;this.$doc.find('head script[src="'+i+'"]').remove();var n=f.dom("<script>");n.attr("src",i),n.attr("async defer"),n.get().onload=function(){-1!==i.search("instagram")&&window.instgrm.Embeds.process(),this.executeScripts(t.slice(e+1))}.bind(this);var r=document.getElementsByTagName("head")[0];r&&r.appendChild(n.get());break}},_find:function(){return this.editor.getElement().find("."+this.activeClass)},_buildCaret:function(){var t=f.dom("<span>");return t.addClass("redactor-component-caret"),t.attr("contenteditable",!0),t}}),f.add("service","insertion",{init:function(t){this.app=t},set:function(t,e,i){return null===t&&(t=""),t=!1!==e?this.cleaner.input(t):t,t=!1!==e?this.cleaner.paragraphize(t):t,this.editor.getElement().html(t),!1!==i&&this.editor.endFocus(),t},insertNode:function(t,e){this.editor.focus();t=this.utils.isFragment(t)?t:this.utils.createFragment(t);return this._collapseSelection(),this._insertFragment(t),this._setCaret(e,t),this._sendNodes(t.nodes)},insertBreakLine:function(){return this.insertNode(document.createElement("br"),"after")},insertNewline:function(){return this.insertNode(document.createTextNode("\n"),"after")},insertText:function(t){return this.insertHtml(this.cleaner.getFlatText(t))},insertChar:function(t){return this.insertNode(t,"after")},insertRaw:function(t){return this.insertHtml(t,!1)},insertToEnd:function(t,e){t&&(3===t.nodeType&&-1!==t.nodeValue.search(/^\n/)&&(t=t.previousElementSibling),(t=f.dom(t)).attr("data-redactor-type")===e&&(e=this.opts.breakline?"<br>":"<p>",e=f.dom(e),t.after(e),this.caret.setStart(e)))},insertPoint:function(t){var e,i,n=this.marker.build("start"),r=!1,s=t.clientX,o=t.clientY;return document.caretPositionFromPoint?(i=document.caretPositionFromPoint(s,o),t=document.getSelection(),this.inspector.parse(i.offsetNode).isInEditor()&&((e=t.getRangeAt(0)).setStart(i.offsetNode,i.offset),e.collapse(!0),e.insertNode(n),r=!0)):document.caretRangeFromPoint&&(e=document.caretRangeFromPoint(s,o),this.inspector.parse(e.startContainer).isInEditor()&&(e.insertNode(n),r=!0)),r},insertToPoint:function(t,e,i,n){return!0===i||this.insertPoint(t)||(t=this.editor.getLastNode(),f.dom(t).after(this.marker.build("start"))),this.component.clearActive(),this.selection.restoreMarkers(),this.insertHtml(e,n)},insertToOffset:function(t,e){return this.offset.set({start:t,end:t}),this.insertHtml(e)},insertHtml:function(t,e){if(this.opts.input){var i=this.utils.parseHtml(t);if(this.selection.isAll())return this._insertToAllSelected(i);this.selection.is()||(h=f.dom("<p>"),this.editor.getElement().append(h),this.caret.setStart(h));var n=this.selection.isCollapsed(),r=this.selection.isText(),s=this.selection.getCurrent(),o=this.selection.getBlock(),a=this.inspector.parse(s);this._collapseSelection(),i=this._getCleanedInput(i,a,e);var l,c=this._isFigure(i.html),t=this._isComponentSpan(i.html),h=this.inspector.isText(i.html);if(this.editor.isEmpty())return this._insertToEmptyEditor(i.html);if(a.isComponent()&&!a.isComponentEditable())return this._insertToWidget(s,a,i.html);if(t)return this.insertNode(i.nodes,"end");if(c&&!r&&!a.isList())return a.isInline()?this._insertToInline(s,i):(l=this.utils.createFragment(i.html),this.utils.splitNode(s,l),this.caret.setEnd(l.last),this._sendNodes(l.nodes));if(a.isCode())return this._insertToCode(i,s,e);if(a.isPre())return this._insertToPre(i,e);if(a.isHeading()||a.isFigcaption())return i.html=!1!==e?this.cleaner.removeTagsExcept(i.html,["a"]):i.html,i.html=!1!==e?this.cleaner.replaceNbspToSpaces(i.html):i.html,l=this.utils.createFragment(i.html),this.insertNode(l,"end");if(this.opts.breakline&&o&&"DIV"===o.tagName){if(this._isPlainHtml(i.html))return this.insertNode(i.nodes,"end");i.html=!1!==e?this.cleaner.paragraphize(i.html):i.html,l=this.utils.createFragment(i.html);o=this.selection.getRange();return o&&!this.selection.isCollapsed()&&o.deleteContents(),this.utils.splitNode(s,l),this.caret.setEnd(l.last),this._sendNodes(l.nodes)}if(h)return!r&&"br"!==this.opts.markup&&this._hasBlocksAndImages(i.nodes)?(i.html=!1!==e?this.cleaner.paragraphize(i.html):i.html,l=this.utils.createFragment(i.html),this.utils.splitNode(s,l),this.caret.setEnd(l.last),this._sendNodes(l.nodes)):(i.html=!1!==e?i.html.replace(/\n/g,"<br>"):i.html,l=this.utils.createFragment(i.html),this.insertNode(l.nodes,"end"));if(!n&&!c)return this._isPlainHtml(i.html)?this.insertNode(i.nodes,"end"):(i.html=!1!==e?this.cleaner.paragraphize(i.html):i.html,l=this.utils.createFragment(i.html),this.insertNode(l,"end"));if(a.isInline()&&!this._isPlainHtml(i.html))return this._insertToInline(s,i);if(a.isBlockquote()||a.isDl())return(d=this.opts.inlineTags).concat(["br"]),i.html=!1!==e?this.cleaner.replaceBlocksToBr(i.html):i.html,i.html=!1!==e?this.cleaner.removeTagsExcept(i.html,d):i.html,l=this.utils.createFragment(i.html),this.insertNode(l,"end");if(a.isParagraph())return this._isPlainHtml(i.html)?this.insertNode(i.nodes,"end"):(i.html=!1!==e?this.cleaner.paragraphize(i.html):i.html,l=this.utils.createFragment(i.html),this.utils.splitNode(s,l),this.caret.setEnd(l.last),this._sendNodes(l.nodes));if(a.isList()&&(d=(d=this.opts.inlineTags).concat(["br","li","ul","ol","img"]),i.html=!1!==e?this.cleaner.replaceBlocksToBr(i.html):i.html,i.html=!1!==e?this.cleaner.removeTagsExcept(i.html,d):i.html,i.html=!1!==e?this.cleaner.removeBrAtEnd(i.html):i.html,l=this.utils.createFragment(i.html),i.nodes=l.nodes,this._containsTags(i.html,["ul","ol","li"]))){var d=this.selection.getElement(s);if(d&&"LI"===d.tagName&&this.caret.isStart(d)){i.nodes=f.dom(l.nodes).unwrap("ul, ol").getAll(),f.dom(d).before(i.nodes);e=i.nodes[i.nodes.length-1];return this.caret.setEnd(e),this._sendNodes(i.nodes)}return this._isPlainHtml(i.html)?this.insertNode(l,"end"):(l=this._buildList(i,d,l),this.utils.splitNode(s,l,!0),this.caret.setEnd(l.last),this._sendNodes(l.nodes))}return this.insertNode(i.nodes,"end")}},_insertToAllSelected:function(t){t=this.set(t.html),t=this.utils.parseHtml(t);return this._sendNodes(t.nodes)},_insertToEmptyEditor:function(t){t=this.cleaner.paragraphize(t);var e=this.utils.createFragment(t),t=this.editor.getElement();return t.html(""),t.append(e.frag),this.caret.setEnd(e.last),this._sendNodes(e.nodes)},_insertToInline:function(t,e){e=this.utils.createFragment(e.html);return this.utils.splitNode(t,e,!1,!0),this.caret.setEnd(e.last),this._sendNodes(e.nodes)},_insertToCode:function(t,e,i){t.html=!1!==i?this.cleaner.encodeHtml(t.html):t.html,t.html=!1!==i?this.cleaner.removeNl(t.html):t.html;t=this.utils.createFragment(t.html),t=this.insertNode(t,"end");return this.utils.normalizeTextNodes(e),t},_insertToPre:function(t,e){t.html=!1!==e?this.cleaner.encodeHtml(t.html):t.html;t=this.utils.createFragment(t.html);return this.insertNode(t,"end")},_insertToWidget:function(t,e,i){i=this._isComponentSpan(i)?i:this.cleaner.paragraphize(i);i=this.utils.createFragment(i),e=e.getComponent(),e=f.dom(e);return e.after(i.frag),e.remove(),this.caret.setEnd(i.last),this._sendNodes(i.nodes)},_insertFragment:function(t){var e,i=this.selection.getRange();i&&(this.selection.isCollapsed()?3!==(e=i.startContainer).nodeType&&"BR"===e.tagName&&(this.caret.setAfter(e),e.parentNode.removeChild(e)):i.deleteContents(),i.insertNode(t.frag))},_sendNodes:function(t){for(var e=0;e<t.length;e++){var i=t[e],n=3!==i.nodeType&&"function"==typeof i.getAttribute&&i.getAttribute("data-redactor-type");n&&this.app.broadcast(n+".inserted",this.component.build(i))}return this.detector.isIe()&&this.editor.getElement().find("[data-redactor-type=table]").attr("contenteditable",!0),this.app.broadcast("inserted",t),this.component.executeScripts(),t},_setCaret:function(t,e){var i=this._isLastInline(e);t?(t=i&&"end"===t?"after":t,this.caret["set"+this.utils.ucfirst(t)](e.last)):!1!==t&&i&&this.caret.setAfter(e.last)},_isLastInline:function(t){return!!t.last&&this.inspector.parse(t.last).isInline()},_getCleanedInput:function(t,e,i){e=e.isCode()||e.isPre();return t.html=t.html.replace(/&nbsp;/g," "),t.html=e||!1===i?t.html:this.cleaner.input(t.html),t=e||!1===i?t:this.utils.parseHtml(t.html)},_getContainer:function(t){return f.dom(this.utils.createTmpContainer(t))},_buildList:function(t,e,i){t=t.nodes[0];if(t&&3!==t.nodeType&&"li"===t.tagName){e=f.dom(e).get().tagName.toLowerCase(),e=f.dom("<"+e+" />");return e.append(i.nodes),this.utils.createFragment(e.get().outerHTML)}return i},_containsTags:function(t,e){return 0!==this._getContainer(t).find(e.join(",")).length},_collapseSelection:function(){},_hasFigureOrTable:function(t){return 0!==this._getContainer(t).find("figure, table").length},_hasBlocks:function(t){return 0!==this._getContainer(t).find(this.opts.blockTags.join(",")).length},_hasBlocksAndImages:function(t){return 0!==this._getContainer(t).find(this.opts.blockTags.join(",")+",img").length},_isPlainHtml:function(t){return 0===this._getContainer(t).find(this.opts.blockTags.join(",")+", img").length},_isFigure:function(t){if(this._isHtmlString(t))return 0!==f.dom(t).closest("figure").length},_isComponentSpan:function(t){if(this._isHtmlString(t))return 0!==f.dom(t).closest("span.redactor-component").length},_isHtmlString:function(t){return!("string"==typeof t&&!/^\s*<(\w+|!)[^>]*>/.test(t))}}),f.add("service","block",{init:function(t){this.app=t,this.tags=["p","div","blockquote","pre","h1","h2","h3","h4","h5","h6"]},format:function(t){return this.params={args:!1},this.params.type=t.type||"set",this.params.tag="string"==typeof t?t:t.tag||this.opts.markup,this.params.tag=this.params.tag.toLowerCase(),this.params.args={class:t.class||!1,style:t.style||!1,attr:t.attr||!1},t.class||t.style||t.attr||(this.params.args=!1),this._format()},add:function(t,e,i){return this._apply("add",t,e,!0,i)},set:function(t,e){return this._apply("set",t,e)},toggle:function(t,e){return this._apply("toggle",t,e)},remove:function(t,e){return this._apply("remove",t,e)},clearFormat:function(t){return this._clear(t,"all")},clearStyle:function(t){return this._clear(t,"style")},clearClass:function(t){return this._clear(t,"class")},clearAttr:function(t){return this._clear(t,"attr")},_format:function(){this.collapsed=this.selection.isCollapsed(),this.selection.save();this.selection.getBlock();var t=this._getBlocks(),e=this._isToggleFormatType(t)?"toggle":"set",e=this._getReplacedTag(e),i=this._replaceBlocks(t,e);return i=this._buildNodes(i),this._restoreSelection(i),i},_clear:function(t,e,i,n){!1!==i&&this.selection.save();t=this._getElements(t,n);return"all"===e?this._removeAllAttr(t,!1):"style"===e?(t.removeAttr("style"),t.removeAttr("data-redactor-style-cache")):"class"===e?t.removeAttr("class"):"attr"===e&&this._removeAllAttr(t),n=t.getAll(),!1!==i&&this._restoreSelection(n),n},_getElements:function(t,e){return f.dom(e||this._getBlocks(t))},_getBlocks:function(t){for(var e=this.selection.getBlocks({tags:t||this.tags}),i=[],n=0;n<e.length;n++)"DIV"===e[n].tagName&&!e[n].getAttribute("data-redactor-tag")||i.push(e[n]);return i},_getReplacedTag:function(t){return this.opts.breakline?"toggle"===t||"p"===this.params.tag?"div":this.params.tag:"toggle"===t?this.opts.markup:this.params.tag},_isStandardParagraph:function(){return!this.opts.breakline&&"p"===this.opts.markup},_isStandardDiv:function(){return!this.opts.breakline&&"div"===this.opts.markup},_isBreaklineBlock:function(t){return t&&"DIV"===t.tagName&&"br"===t.getAttribute("data-redactor-tag")},_isToggleFormatType:function(t){for(var e=0,i=t.length,n=0;n<i;n++)t[n]&&this.params.tag===t[n].tagName.toLowerCase()&&e++;return e===i},_isCurrentBlockOneAndEmpty:function(t){return this.collapsed&&1===t.length&&this.utils.isEmpty(t[0])},_buildNodes:function(t){return 0<t.length&&(t=this._applyArgs(t,!1),t=this._combinePre(t),t=this._cleanBlocks(t)),t},_replaceBlocks:function(t,e){for(var i=[],n=0;n<t.length;n++){var r=this.utils.replaceToTag(t[n],e);i.push(r.get())}return i},_combinePre:function(t){for(var e=[],i=0;i<t.length;i++){var n,r,s=t[i].nextElementSibling;s&&"PRE"===t[i].tagName&&"PRE"===s.tagName&&(n=f.dom(t[i]),r=f.dom(s),s=document.createTextNode("\n"),n.append(s),n.append(r),r.unwrap("pre")),e.push(t[i])}return e},_cleanBlocks:function(t){for(var e=["h1","h2","h3","h4","h5","h6"],i=this.opts.inlineTags,n=0;n<t.length;n++){var r=t[n].tagName.toLowerCase(),s=f.dom(t[n]);-1!==e.indexOf(r)?s.find("span").not(".redactor-component, .non-editable, .redactor-selection-marker").unwrap():"pre"===r&&s.find(i.join(",")).not(".redactor-selection-marker").unwrap(),!1===this.params.args&&"p"===this.params.tag&&s.removeAttr("class"),this.opts.breakline&&"div"===r?s.attr("data-redactor-tag","br"):s.removeAttr("data-redactor-tag"),this.utils.normalizeTextNodes(t[n])}return t},_cleanEmptyClass:function(t){t.each(function(t){""===t.className&&t.removeAttribute("class")})},_cleanEmptyStyle:function(t){this.utils.removeEmptyAttr(t.get(),"style")?t.removeAttr("data-redactor-style-cache"):t.attr("data-redactor-style-cache",t.attr("style"))},_apply:function(t,e,i,n,r){!1!==n&&this.selection.save();var s,o,i=this._getElements(i,r);return e.class&&("set"===t?(i.removeAttr("class"),i.addClass(e.class)):"add"===t?i.addClass(e.class):"toggle"===t?i.toggleClass(e.class):"remove"===t&&i.removeClass(e.class),this._cleanEmptyClass(i)),e.attr&&("set"===t?(this._removeAllAttr(i),i.attr(e.attr)):"add"===t?i.attr(e.attr):"toggle"===t?(s=e.attr,i.each(function(t){var e,i=f.dom(t);for(e in s)i.attr(e)?i.removeAttr(e):i.attr(e,s[e])})):"remove"===t&&i.removeAttr(e.attr)),e.style&&("set"===t?(i.removeAttr("style"),i.css(e.style),i.each(function(t){t=f.dom(t);t.attr("data-redactor-style-cache",t.attr("style"))})):"add"===t?(s=e.style,i.each(function(t){t=f.dom(t);t.css(s),t.attr("data-redactor-style-cache",t.attr("style")),this._convertStyleQuotes(t)}.bind(this))):"toggle"===t?(s=e.style,i.each(function(t){var e,i=f.dom(t);for(e in s){var n=s[e],r=i.css(e),r=this.utils.isRgb(r)?this.utils.rgb2hex(r):r.replace(/"/g,""),n=this.utils.isRgb(n)?this.utils.rgb2hex(n):n.replace(/"/g,"");r=this.utils.hex2long(r),("string"==typeof(n=this.utils.hex2long(n))?n.toLowerCase():n)===("string"==typeof r?r.toLowerCase():r)?i.css(e,""):i.css(e,n)}this._convertStyleQuotes(i),this._cleanEmptyStyle(i)}.bind(this))):"remove"===t&&(o=e.style,i.each(function(t){t=f.dom(t);t.css(o,""),this._cleanEmptyStyle(t)}.bind(this)))),r=i.getAll(),!1!==n&&this._restoreSelection(r),r},_applyArgs:function(t){return t=this.params.args?this._apply(this.params.type,this.params.args,!1,!1,t):this._clear(!1,"all",!1,t)},_removeAllAttr:function(t,s){t.each(function(t){var e=["data-redactor-tag","data-redactor-style-cache"];!1===s&&(e.push("style"),e.push("class"));for(var i=t.attributes.length;0<i--;){var n=t.attributes[i],r=n.name;-1===e.indexOf(r)&&t.removeAttributeNode(n)}})},_restoreSelection:function(t){this._isCurrentBlockOneAndEmpty(t)?this.caret.setStart(t[0]):setTimeout(function(){this.selection.restore()}.bind(this),1)},_convertStyleQuotes:function(t){var e=t.attr("style");e&&t.attr("style",e.replace(/"/g,"'"))}}),f.add("service","inline",{mixins:["formatter"],init:function(t){this.app=t,this.count=0},format:function(t){if(!this._isFormat())return[];this.type=t.type||"set",this.tag="string"==typeof t?t:t.tag,this.tag=this.tag.toLowerCase(),this.tag=this.arrangeTag(this.tag),"string"==typeof t?this.args=!1:this.buildArgs(t),this.detector.isIe()||this.editor.disableNonEditables();t=this.selection.isCollapsed()?this.formatCollapsed():this.formatUncollapsed();return this.detector.isIe()||this.editor.enableNonEditables(),t},_isFormat:function(){var t=this.selection.getCurrent(),e=this.inspector.parse(t),i=e.isComponent()&&!e.isComponentType("table")&&!e.isFigcaption();return!(!1!==t||!this.selection.isAll())||!(!t||e.isPre()||e.isCode()||i)},arrangeTag:function(t){var e,i=this.opts.replaceTags;for(e in i)t===e&&(t=i[e]);return t},formatCollapsed:function(){var t,e,i=[],n=this.selection.getInlineFirst(),r=this.selection.getInlines({all:!0}),s=f.dom(n);if(n){var o=this.inspector.parse(n),a=this.utils.isEmptyHtml(n.innerHTML);if(a)n.tagName.toLowerCase()===this.tag?this.hasSameArgs(n)?(this.caret.setAfter(n),s.remove(),a=this.selection.getElement(),this.utils.normalizeTextNodes(a)):"span"===this.tag?(i=this.applyArgs([n],!1),this.caret.setStart(n)):i=this.insertInline(i):o.hasParent([this.tag])?(e=(t=s.closest(this.tag)).get(),this.hasSameArgs(e)?(t.unwrap(),this.caret.setStart(n)):i=this.insertInline(i)):i=this.insertInline(i);else if(n.tagName.toLowerCase()===this.tag)this.hasSameArgs(n)?(h=this.utils.extractHtmlFromCaret(n),d=f.dom("<"+this.tag+" />"),d=this.utils.cloneAttributes(n,d),s.after(d.append(h)),""===d.html().trim()&&d.remove(),this.caret.setAfter(n)):i=this.insertInline(i);else if(o.hasParent([this.tag]))if(e=(t=s.closest(this.tag)).get(),this.hasSameArgs(e)){var l,c,h=this.utils.extractHtmlFromCaret(e,e),d=f.dom("<"+this.tag+" />");d=this.utils.cloneAttributes(e,d);for(var u=0,r=r.reverse(),p=0;p<r.length;p++)r[p]!==e&&(c=f.dom("<"+r[p].tagName.toLowerCase()+">"),0===u?l=c:l.append(c),u++);t.after(d.append(h)),t.after(l),this.caret.setStart(c)}else i=this.insertInline(i);else i=this.insertInline(i)}else i=this.insertInline(i);return i},insertInline:function(t){var e=document.createElement(this.tag);return t=this.insertion.insertNode(e,"start"),this.applyArgs(t,!1)},hasSameArgs:function(t){if(0===t.attributes.length&&!1===this.args)return!0;var e=!0;if(this.args){var i,n=0;for(i in this.args){var r=f.dom(t),s=this.args[i],o=this.utils.toParams(s),a=r.attr(i);if(s)if("style"===i){o=o.trim().replace(/;$/,"");for(var s=this.utils.styleToObj(r.attr("style")),l=o.split(";"),c=0,h=0;h<l.length;h++){var d=l[h].split(":"),u=d[0].trim(),p=d[1].trim();-1!==u.search(/color/)?!(d=r.css(u))||d!==p&&this.utils.rgb2hex(d)!==p||c++:r.css(u)===p&&c++}c===l.length&&Object.keys(s).length===l.length&&n++}else a===o&&n++;else a&&""!==a||n++}e=n===Object.keys(this.args).length}return e},formatUncollapsed:function(){var t=this.selection.getInlines({all:!0,inside:!0});this.detector.isIe()?this.selection.saveMarkers():this.selection.save(),this._convertTags("u"),this._convertTags("del"),this._convertToStrike(t),this.detector.isIe()?this.selection.restoreMarkers():this.selection.restore(),document.execCommand("strikethrough"),this._clearDecoration(),this.selection.save();for(var e=this._revertToInlines(),e=this.applyArgs(e,!1),i=0;i<e.length;i++){var n=e[i],r=n.tagName.toLowerCase(),s=n.attributes.length;r===this.tag&&0===s&&this.args&&(f.dom(n).unwrap(),e.splice(i,1))}return this.selection.restore(),this._clearEmptyStyle(),e=this._normalizeBlocks(e)},_convertTags:function(e){this.tag!==e&&this.editor.getElement().find(e).each(function(t){this.utils.replaceToTag(t,"span").addClass("redactor-convertable-"+e)}.bind(this))},_revertTags:function(e){this.editor.getElement().find("span.redactor-convertable-"+e).each(function(t){t=this.utils.replaceToTag(t,e);t.removeClass("redactor-convertable-"+e),this.utils.removeEmptyAttr(t,"class")&&t.removeAttr("class")}.bind(this))},_convertToStrike:function(t){for(var e=this.selection.getText().replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"),i=0;i<t.length;i++){var n=this.arrangeTag(t[i].tagName.toLowerCase()),r=t[i],s=f.dom(r),o=this.hasSameArgs(r);if(n===this.tag)if("span"===this.tag&&this._isTextSelected(r,e))s.addClass("redactor-convertable-apply");else if(o&&"a"!==this.tag)this._replaceToStrike(s);else if("span"===this.tag){if(this.args&&this.args.style)for(var a in this.args.style)s.css(a,"");this.utils.removeEmptyAttr(s.get(),"style")?s.addClass("redactor-convertable-apply"):s.addClass("redactor-unconvertable-apply")}else o||s.addClass("redactor-convertable-apply")}},_replaceToStrike:function(t){t.replaceWith(function(){return f.dom("<strike>").append(t.contents())})},_revertToInlines:function(){var i=[],t=this.editor.getElement();return"u"!==this.tag&&t.find("u").unwrap(),t.find(".redactor-convertable-u").each(function(t){i.push(t)}),t.find(".redactor-convertable-apply").each(function(t){var e=f.dom(t);e.find("strike").unwrap(),this._forceRemoveClass(e,"redactor-convertable-apply"),i.push(t)}.bind(this)),t.find("span.redactor-unconvertable-apply").each(function(t){t=f.dom(t);this._forceRemoveClass(t,"redactor-unconvertable-apply")}.bind(this)),t.find("strike").each(function(t){t=this.utils.replaceToTag(t,this.tag);i.push(t.get())}.bind(this)),this._revertTags("u"),this._revertTags("del"),i},_normalizeBlocks:function(e){var t=this.opts.inlineTags,i=this.selection.getBlocks();if(i)for(var n=0;n<i.length;n++)"PRE"===i[n].tagName&&f.dom(i[n]).find(t.join(",")).not(".redactor-selection-marker").each(function(t){-1!==e.indexOf(t)&&(e=this.utils.removeFromArrayByValue(e,t)),f.dom(t).unwrap()}.bind(this));return e},_clearDecoration:function(){this.editor.getElement().find(this.opts.inlineTags.join(",")).each(function(t){"line-through"!==t.style.textDecoration&&"line-through"!==t.style.textDecorationLine||((t=f.dom(t)).css("textDecorationLine",""),t.css("textDecoration",""),t.wrap("<strike>"))})},_clearEmptyStyle:function(){for(var t=this.getInlines(),e=0;e<t.length;e++){this._clearEmptyStyleAttr(t[e]);var i=t[e].childNodes;if(i)for(var n=0;n<i.length;n++)this._clearEmptyStyleAttr(i[n])}},_clearEmptyStyleAttr:function(t){3!==t.nodeType&&this.utils.removeEmptyAttr(t,"style")&&(t.removeAttribute("style"),t.removeAttribute("data-redactor-style-cache"))},_forceRemoveClass:function(t,e){t.removeClass(e),this.utils.removeEmptyAttr(t,"class")&&t.removeAttr("class")},_isTextSelected:function(t,e){t=this.utils.removeInvisibleChars(t.textContent);return e===t||-1!==e.search(new RegExp("^"+this.utils.escapeRegExp(t)+"$"))},getInlines:function(t){return t?this.selection.getInlines({tags:t,all:!0}):this.selection.getInlines({all:!0})},getElements:function(t){return f.dom(this.getInlines(t))},clearFormat:function(){this.selection.save();for(var t=this.selection.getInlines({all:!0}),e=0;e<t.length;e++){var i=f.dom(t[e]);this.selection.getInline(t[e])&&i.unwrap()}this.selection.restore()}}),f.add("service","autoparser",{init:function(t){this.app=t,this.cleaner=this.app.cleaner},observe:function(){var t=this.editor.getElement().find(".redactor-autoparser-object").each(function(t){t=f.dom(t);t.removeClass("redactor-autoparser-object"),""===t.attr("class")&&t.removeAttr("class")});0<t.length&&t.each(function(t){var e,i,n=t.tagName;"A"===n?e="link":"IMG"===n?e="image":"IFRAME"===n&&(e="video"),e&&(i=f.create(e+".component",this.app,t),this.app.broadcast(e+".inserted",i),this.app.broadcast("autoparse",e,i))}.bind(this))},format:function(t,e){this._isKey(e)&&this._format(e===this.keycodes.ENTER)},parse:function(t){var e=["figure","html","form","pre","object","video","iframe","code","a","img"],i=[],n=0,r=[];t=this.cleaner.storeComments(t,r),t=(t=(t=this.cleaner.encodeCode(t)).replace(/\$/g,"&#36;")).replace(/&amp;/g,"&");for(var s,o,a,l=0;l<e.length;l++){var c="img"===e[l]?"<"+e[l]+"[^>]*>":"<"+e[l]+"([\\w\\W]*?)</"+e[l]+">";if(null!==(u=t.match(new RegExp(c,"gi"))))for(var h=0;h<u.length;h++)t=t.replace(u[h],"#####replaceparse"+n+"#####"),i.push(u[h]),n++}if(this.opts.autoparseImages&&t.match(this.opts.regex.imageurl))for(var d=t.match(this.opts.regex.imageurl),l=0;l<d.length;l++)t=t.replace(d[l],'<img class="redactor-autoparser-object" src="'+d[l]+'">');this.opts.autoparseVideo&&(t.match(this.opts.regex.youtube)||t.match(this.opts.regex.vimeo))&&(o=this.opts.autoparseHttps?"https:":"",t.match(this.opts.regex.youtube)?(a=o+"//www.youtube.com/embed/$1",s=this.opts.regex.youtube):t.match(this.opts.regex.vimeo)&&(a=o+"//player.vimeo.com/video/$2",s=this.opts.regex.vimeo),a=this.component.create("video",'<iframe width="500" height="281" src="'+a+'" frameborder="0" allowfullscreen></iframe>'),t=t.replace(s,a.get().outerHTML));for(l=0;l<e.length;l++){var u,c="img"===e[l]?"<"+e[l]+"[^>]*>":"<"+e[l]+"([\\w\\W]*?)</"+e[l]+">";if(null!==(u=t.match(new RegExp(c,"gi"))))for(h=0;h<u.length;h++)t=t.replace(u[h],"#####replaceparse"+n+"#####"),i.push(u[h]),n++}return this.opts.autoparseLinks&&t.match(this.opts.regex.url)&&(t=this._formatLinks(t)),t=this._restoreReplaced(i,t),t=this._restoreReplaced(i,t),t=this.cleaner.restoreComments(t,r)},_isKey:function(t){return t===this.keycodes.ENTER||t===this.keycodes.SPACE},_format:function(t){var e,i,n,r,s,o=this.selection.getParent(),a=f.dom(o);o&&0!==a.closest("figure, pre, code, img, a, iframe").length||!this.selection.isCollapsed()||(e=this.utils.createInvisibleChar(),this.selection.getRange().insertNode(e),s=this.selection.getCurrent(),o=this.inspector.parse(s),a=f.dom(s),e.parentNode.removeChild(e),s&&3===s.nodeType&&(s=s.textContent,this.opts.autoparseImages&&s.match(this._convertToRegExp(this.opts.regex.imageurl))?(i=o.isList(),o=s.match(this.opts.regex.imageurl),i=i?void 0:"<figure><img></figure>",(i=this.component.create("image",i)).setSrc(o[0]),i.addClass("redactor-autoparser-object"),s=s.replace(o[0],i.get().outerHTML),i="image"):this.opts.autoparseVideo&&(s.match(this._convertToRegExp(this.opts.regex.youtube))||s.match(this._convertToRegExp(this.opts.regex.vimeo)))?(s.match(this.opts.regex.youtube)?(r="//www.youtube.com/embed/$1",n=this.opts.regex.youtube):s.match(this.opts.regex.vimeo)&&(r="//player.vimeo.com/video/$2",n=this.opts.regex.vimeo),(r=this.component.create("video",'<iframe width="500" height="281" src="'+r+'" frameborder="0" allowfullscreen></iframe>')).addClass("redactor-autoparser-object"),s=s.replace(n,r.get().outerHTML),i="video"):this.opts.autoparseLinks&&s.match(this._convertToRegExp(this.opts.regex.url))&&(s=this._formatLinks(s,t),i="link"),i&&(t?(this.selection.save(),a.replaceWith(s),this.selection.restore()):a.replaceWith(s),s=this.editor.getElement().find(".redactor-autoparser-object").removeClass("redactor-autoparser-object"),s="link"===i?f.create("link.component",this.app,s):s,"link"===i?(t||this.caret.setAfter(s),this.app.broadcast("link.inserted",s)):(this.caret.setAfter(s),t=s.clone(),s.remove(),s=this.insertion.insertHtml(t),s=this.component.build(s)),this.app.broadcast("autoparse",i,s))))},_formatLinks:function(t){var n=!1!==this.opts.pasteLinkTarget?' target="'+this.opts.pasteLinkTarget+'"':"",r=' class="redactor-autoparser-object"',s=this;return t=(t=t.replace(this.opts.regex.aurl1,function(t){return'<a href="'+t+'"'+n+r+">"+s._subLinkText(t)+"</a>"})).replace(this.opts.regex.aurl2,function(t,e,i){return e+'<a href="http://'+i+'"'+n+r+">"+s._subLinkText(i)+"</a>"})},_subLinkText:function(t){return t=-1===(t=t.length>this.opts.linkSize?t.substring(0,this.opts.linkSize)+"...":t).search("%")?decodeURIComponent(t):t},_restoreReplaced:function(t,e){for(var i=0;i<t.length;i++)e=e.replace("#####replaceparse"+i+"#####",t[i]);return e},_convertToRegExp:function(t){return new RegExp(String(t).replace(/^\//,"").replace(/\/ig$/,"").replace(/\/gi$/,"")+"$","gi")}}),f.add("service","storage",{init:function(t){this.app=t,this.data=[]},observeImages:function(){this.opts.imageObserve&&this.editor.getElement().find("[data-image]").each(this._addImage.bind(this))},observeFiles:function(){this.editor.getElement().find("[data-file]").each(this._addFile.bind(this))},setStatus:function(t,e){this.data[t].status=e},getChanges:function(){var t,e=this.editor.getElement();for(t in this.data){var i=this.data[t],n=e.find("[data-"+i.type+'="'+i.id+'"]');this.setStatus(i.id,0!==n.length)}return this.data},add:function(t,e){var i=f.dom(e),e=i.attr("data-"+t);this.data[e]={type:t,status:!0,node:i.get(),id:i.attr("data-"+t)}},_addImage:function(t){this.add("image",t)},_addFile:function(t){this.add("file",t)}}),f.add("service","utils",{init:function(t){this.app=t},isEmpty:function(t){var e=!1;return(t=f.dom(t).get())&&(e=3===t.nodeType?""===t.textContent.trim().replace(/\n/,""):""===t.innerHTML),e},isEmptyHtml:function(t,e,i){return t=(t=(t=(t=(t=(t=this.removeInvisibleChars(t)).replace(/&nbsp;/gi,"")).replace(/<\/?br\s?\/?>/g,e?"br":"")).replace(/\s/g,"")).replace(/^<p>[^\W\w\D\d]*?<\/p>$/i,"")).replace(/^<div>[^\W\w\D\d]*?<\/div>$/i,""),i&&(t=(t=t.replace(/<ul(.*?[^>])>$/i,"ul")).replace(/<ol(.*?[^>])>$/i,"ol")),""===(t=(t=(t=(t=(t=(t=t.replace(/<hr(.*?[^>])>$/i,"hr")).replace(/<iframe(.*?[^>])>$/i,"iframe")).replace(/<source(.*?[^>])>$/i,"source")).replace(/<[^\/>][^>]*><\/[^>]+>/gi,"")).replace(/<[^\/>][^>]*><\/[^>]+>/gi,"")).trim())},trimSpaces:function(t){return this.removeInvisibleChars(t.trim())},createInvisibleChar:function(){return document.createTextNode(this.opts.markerChar)},searchInvisibleChars:function(t){return t.search(/^\uFEFF$/g)},removeInvisibleChars:function(t){return t.replace(/\uFEFF/g,"")},trimInvisibleChars:function(t){var e,i;this.selection.isCollapsed()&&(i=this.selection.getCurrent(),e="left"===t?this.selection.getTextBeforeCaret():this.selection.getTextAfterCaret(),i&&3===i.nodeType&&0===this.searchInvisibleChars(e)&&("left"===t?f.dom(i).replaceWith(i.textContent.trim()):(i=this.offset.get(),this.offset.set({start:i.start+1,end:i.end+1}))))},buildWrapper:function(t){return f.dom("<div>").html(t)},getWrapperHtml:function(t){var e=t.html();return t.remove(),e},createTmpContainer:function(t){var e=f.dom("<div>");return"string"==typeof t?e.html(t):e.append(f.dom(t).clone(!0)),e.get()},createFragment:function(t){for(var e,i,n=this.createTmpContainer(t),r=document.createDocumentFragment(),s=[],o=0;a=n.firstChild;){o++;var a=r.appendChild(a);1===o&&(e=a),s.push(a),i=a}return{frag:r,first:e,last:i,nodes:s}},isFragment:function(t){return"object"==typeof t&&t.frag},parseHtml:function(t){t=this.createTmpContainer(t);return{html:t.innerHTML,nodes:t.childNodes}},splitNode:function(t,e,i,n){var r;e=this.isFragment(e)?e.frag:e,r=n?this.inspector.isInlineTag(t.tagName)?t:this.selection.getInline(t):this.inspector.isBlockTag(t.tagName)?t:this.selection.getBlock(t);var s=f.dom(r);if(!n&&this.isEmptyHtml(r.innerHTML,!0))return s.after(e),s.remove(),e;var o=s.get().tagName.toLowerCase(),a=this.caret.isEnd(r),t=this.caret.isStart(r);if(a||t||(n=this.extractHtmlFromCaret(n),o=f.dom("<"+o+" />"),o=this.cloneAttributes(r,o),s.after(o.append(n))),t)return s.before(e);if(i)return s.append(e);e=s.after(e);i=s.html();return""===(i=(i=this.removeInvisibleChars(i)).replace(/&nbsp;/gi,""))&&s.remove(),e},extractHtmlFromCaret:function(t,e){var i=this.selection.getRange();if(i&&(e=e||(t?this.selection.getInline():this.selection.getBlock()))){t=i.cloneRange();return t.selectNodeContents(e),t.setStart(i.endContainer,i.endOffset),t.extractContents()}},createMarkup:function(t){var e=document.createElement(this.opts.markup);this.opts.breakline&&e.setAttribute("data-redactor-tag","br"),f.dom(t).after(e),this.caret.setStart(e)},createMarkupBefore:function(t){var e=document.createElement(this.opts.markup);this.opts.breakline&&e.setAttribute("data-redactor-tag","br"),f.dom(t).before(e),this.caret.setEnd(e)},getNode:function(t){var e=f.dom(t).get(),i=this.editor.getElement().get();return void 0===t?i:e||!1},findSiblings:function(t,e){for(t=f.dom(t).get(),e="next"===e?"nextSibling":"previousSibling";t=t[e];)if((3!==t.nodeType||""!==t.textContent.trim())&&"BR"!==t.tagName)return t;return!1},getElementsFromHtml:function(t,e,i){var n=document.createElement("div");n.innerHTML=t;e=n.querySelectorAll(e);return function(t,e){if("number"==typeof this.length&&"function"==typeof t){var i=[];if("object"==typeof this)for(var n=0;n<this.length;n++){if(!(n in this))return;i[n]=t.call(e||this,this[n],n,this)}return i}}.call(e,function(t){var e=t.getAttribute("data-redactor-type");if(!i||!e||e!==i)return t.outerHTML})},getChildNodes:function(t,e,i){var n=(t=t&&t.nodeType&&11===t.nodeType?t:f.dom(t).get()).childNodes,r=[];if(n)for(var s,o=0;o<n.length;o++)!0===i&&3===n[o].nodeType||3===n[o].nodeType&&this.isEmpty(n[o])||(r.push(n[o]),!1===e||0<(s=this.getChildNodes(n[o],i)).length&&(r=r.concat(s)));return r},getChildElements:function(t){return this.getChildNodes(t,!0,!0)},getFirstNode:function(t){return this._getFirst(this.getChildNodes(t,!1))},getLastNode:function(t){return this._getLast(this.getChildNodes(t,!1))},getFirstElement:function(t){return this._getFirst(this.getChildNodes(t,!1,!0))},getLastElement:function(t){return this._getLast(this.getChildNodes(t,!1,!0))},replaceToTag:function(t,r){return f.dom(t).replaceWith(function(t){var e=f.dom("<"+r+">").append(f.dom(t).contents());if(t.attributes)for(var i=t.attributes,n=0;n<i.length;n++)e.attr(i[n].nodeName,i[n].value);return e})},ucfirst:function(t){return t.charAt(0).toUpperCase()+t.slice(1)},removeFromArrayByValue:function(t,e){for(var i,n=arguments,r=n.length;1<r&&t.length;)for(e=n[--r];-1!==(i=t.indexOf(e));)t.splice(i,1);return t},removeEmptyAttr:function(t,e){t=f.dom(t);return void 0===t.attr(e)||null===t.attr(e)||""===t.attr(e)&&(t.removeAttr(e),!0)},cloneAttributes:function(t,e){t=f.dom(t).get(),e=f.dom(e);for(var i=t.attributes,n=i.length;n--;){var r=i[n];e.attr(r.name,r.value)}return e},toParams:function(t){if("object"!=typeof t)return t;var e=Object.keys(t);if(!e.length)return"";for(var i="",n=0;n<e.length;n++){var r=e[n];i+=r+":"+t[r]+";"}return i},styleToObj:function(t){var e={};if(t)for(var i=t.replace(/;$/,"").split(";"),n=0;n<i.length;n++){var r=i[n].split(":");e[r[0].trim()]=r[1].trim()}return e},checkProperty:function(t){for(var e=arguments[1]&&Array.isArray(arguments[1])?arguments[1]:[].slice.call(arguments,1),i=0;i<e.length;i++){if(!t||void 0===t[e[i]])return!1;t=t[e[i]]}return t},extendData:function(r,t){for(var e in t)"elements"===e?f.dom(t[e]).each(function(t){var e=f.dom(t);if("FORM"===t.tagName){var i,n=e.serialize(!0);for(i in n)r=this._setData(r,i,n[i])}else{t=e.attr("name")?e.attr("name"):e.attr("id");r=this._setData(r,t,e.val())}}.bind(this)):r=this._setData(r,e,t[e]);return r},_setData:function(t,e,i){return t instanceof FormData?t.append(e,i):t[e]=i,t},normalizeTextNodes:function(t){(t=f.dom(t).get())&&t.normalize()},isRgb:function(t){return 0===t.search(/^rgb/i)},rgb2hex:function(t){return(t=t.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i))&&4===t.length?"#"+("0"+parseInt(t[1],10).toString(16)).slice(-2)+("0"+parseInt(t[2],10).toString(16)).slice(-2)+("0"+parseInt(t[3],10).toString(16)).slice(-2):""},hex2long:function(t){return-1!==t.search(/^#/)&&4===t.length&&(t="#"+t[1]+t[1]+t[2]+t[2]+t[3]+t[3]),t},escapeRegExp:function(t){return t.replace(/[-\/\\^$*~+?.()|[\]{}]/g,"\\$&")},getRandomId:function(){for(var t="",e="abcdefghijklmnopqrstuvwxyz0123456789",i=0;i<12;i++)t+=e.charAt(Math.floor(Math.random()*e.length));return t},_getFirst:function(t){return 0!==t.length&&t[0]},_getLast:function(t){return 0!==t.length&&t[t.length-1]}}),f.add("service","progress",{init:function(t){this.app=t,this.$box=null,this.$bar=null},show:function(){this._is()||this._build(),this.$box.show()},hide:function(){this._is()&&this.animate.start(this.$box,"fadeOut",this._destroy.bind(this))},update:function(t){this.show(),this.$bar.css("width",t+"%")},_is:function(){return null!==this.$box},_build:function(){this.$bar=f.dom("<span />"),this.$box=f.dom('<div id="redactor-progress" />'),this.$box.append(this.$bar),this.$body.append(this.$box)},_destroy:function(){this._is()&&this.$box.remove(),this.$box=null,this.$bar=null}}),f.add("module","starter",{init:function(t){this.app=t,this.opts=t.opts,this.plugin=t.plugin,this.module=t.module},onstart:function(){this._startStop("start",this.app,["element","container","source","editor","statusbar","toolbar"]),this._startStop("start",this.module,["element","container","source","editor","statusbar","contextbar","input"])},onstop:function(){this._startStop("stop",this.module,["observer","element","container","source","editor","contextbar"])},onenable:function(){var t=this.opts.plugins;this._startStop("start",this.module,["observer","toolbar"]),this._startStop("start",this.plugin,t)},ondisable:function(){var t=this.opts.plugins;this._startStop("stop",this.module,["observer","toolbar"]),this._startStop("stop",this.plugin,t)},_startStop:function(t,e,i){for(var n=0;n<i.length;n++)void 0!==e[i[n]]&&this.app.callInstanceMethod(e[i[n]],t)}}),f.add("module","element",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.namespace=t.namespace,this.element=t.element,this.rootOpts=f.extend({},!0,f.options,t.rootOpts)},start:function(){this._build(),this._buildModes(),this._buildMarkup()},stop:function(){this.element.getElement().removeData(this.namespace+"-uuid")},_build:function(){this.element.getElement().data(this.namespace+"-uuid",this.uuid)},_buildModes:function(){var t=this.element.getType();"inline"===t&&this._redefineOptions(this.opts.modes.inline),"div"===t&&this._redefineOptions(this.opts.modes.original),"inline"!==t&&(this._isRootOption("styles")&&this.rootOpts.styles&&(this.opts.styles=!0),this._isRootOption("source")&&!this.rootOpts.source&&(this.opts.showSource=!1))},_buildMarkup:function(){"inline"===this.element.getType()?this.opts.emptyHtml="":this.opts.breakline?(this.opts.markup="div",this.opts.emptyHtml='<div data-redactor-tag="br">'+this.opts.markerChar+"</div>"):this.opts.emptyHtml="<"+this.opts.markup+"></"+this.opts.markup+">"},_redefineOptions:function(t){for(var e in t)this.opts[e]=t[e]},_isRootOption:function(){return void 0!==this.rootOpts.styles}}),f.add("module","editor",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.editor=t.editor,this.source=t.source,this.element=t.element,this.component=t.component,this.container=t.container,this.inspector=t.inspector,this.autoparser=t.autoparser,this.placeholder=!1,this.events=!1},onenable:function(){this.enable()},ondisable:function(){this.disable()},onenablefocus:function(){this._enableFocus()},oncontextmenu:function(t){this.component.setOnEvent(t,!0)},onclick:function(t){this.component.setOnEvent(t)},onkeyup:function(t){this.inspector.parse(t.target).isComponent()||this.component.clearActive()},onenablereadonly:function(){this._enableReadOnly()},ondisablereadonly:function(){this._disableReadOnly()},onautoparseobserve:function(){this.autoparser.observe()},onplaceholder:{build:function(){this._buildPlaceholder()},toggle:function(){this._togglePlacehodler()}},start:function(){this._build(),this._buildEvents(),this._buildOptions(),this._buildAccesibility()},stop:function(){var t=this.editor.getElement(),e=this.container.getElement(),i=["redactor-in","redactor-in-"+this.uuid,"redactor-structure","redactor-placeholder","notranslate"];""!==this.opts.stylesClass&&i.push(this.opts.stylesClass);t.removeAttr("spellcheck"),t.removeAttr("dir"),t.removeAttr("contenteditable"),t.removeAttr("placeholder"),t.removeAttr("data-gramm_editor"),t.removeClass(i.join(" ")),e.removeClass(["redactor-focus","redactor-blur","redactor-over","redactor-styles-on","redactor-styles-off","redactor-toolbar-on","redactor-text-labeled-on","redactor-source-view"].join(" ")),this._destroyEvents(),0===t.get().classList.length&&t.removeAttr("class")},enable:function(){var t=this.editor.getElement(),e=this.container.getElement();t.addClass("redactor-in redactor-in-"+this.uuid),t.attr({contenteditable:!0}),this.opts.structure&&t.addClass("redactor-structure"),!this.opts.toolbar||this.opts.air||this.opts.toolbarExternal||e.addClass("redactor-toolbar-on"),this._disableBrowsersEditing()},disable:function(){var t=this.editor.getElement(),e=this.container.getElement();t.removeClass("redactor-in redactor-in-"+this.uuid),t.removeClass("redactor-structure"),t.removeAttr("contenteditable"),e.addClass("redactor-toolbar-on")},_build:function(){var t=this.editor.getElement(),e=this.element.getElement(),i=this.container.getElement();i.addClass("redactor-blur"),this.opts.grammarly||t.attr("data-gramm_editor",!1),this.opts.notranslate&&t.addClass("notranslate"),this.opts.styles?(t.addClass(this.opts.stylesClass),i.addClass("redactor-styles-on")):i.addClass("redactor-styles-off"),this.opts.buttonsTextLabeled&&i.addClass("redactor-text-labeled-on"),this.element.isType("textarea")&&e.before(t)},_buildEvents:function(){this.events=f.create("editor.events",this.app)},_buildOptions:function(){var t=this.editor.getElement();t.attr("dir",this.opts.direction),this.opts.spellcheck||t.attr("spellcheck",!1),this.opts.tabindex&&t.attr("tabindex",this.opts.tabindex),this.opts.minHeight&&t.css("min-height",this.opts.minHeight),this.opts.maxHeight&&t.css("max-height",this.opts.maxHeight),this.opts.maxWidth&&t.css({"max-width":this.opts.maxWidth,margin:"auto"})},_buildAccesibility:function(){this.editor.getElement().attr({"aria-labelledby":"redactor-voice-"+this.uuid,role:"presentation"})},_buildPlaceholder:function(){this.placeholder=f.create("editor.placeholder",this.app)},_enableFocus:function(){this.opts.showSource?this._enableFocusSource():this._enableFocusEditor()},_enableFocusSource:function(){var t=this.source.getElement();this.opts.focus?(t.focus(),t.get().setSelectionRange(0,0)):this.opts.focusEnd&&t.focus()},_enableFocusEditor:function(){this.opts.focus?setTimeout(this.editor.startFocus.bind(this.editor),100):this.opts.focusEnd&&setTimeout(this.editor.endFocus.bind(this.editor),100)},_togglePlacehodler:function(){this.placeholder&&this.placeholder.toggle()},_disableBrowsersEditing:function(){try{document.execCommand("enableObjectResizing",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1),document.execCommand("AutoUrlDetect",!1,!1);var t=this.editor.getElement().get();t.addEventListener?t.addEventListener("mscontrolselect",function(t){t.preventDefault()}):t.attachEvent("oncontrolselect",function(t){t.returnValue=!1})}catch(t){}},_destroyEvents:function(){this.events&&this.events.destroy()},_enableReadOnly:function(){var t=this.editor.getElement();this._getEditables(t).removeAttr("contenteditable"),t.removeAttr("contenteditable"),t.addClass("redactor-read-only"),this.events&&this.events.destroy()},_disableReadOnly:function(){var t=this.editor.getElement();this._getEditables(t).attr({contenteditable:!0}),t.removeClass("redactor-read-only"),t.attr({contenteditable:!0}),this._buildEvents()},_getEditables:function(t){return t.find("figcaption, td, th")}}),f.add("class","editor.placeholder",{init:function(t){this.app=t,this.opts=t.opts,this.editor=t.editor,this.element=t.element,this.build()},build:function(){var t=this.element.getElement(),e=this.editor.getElement();!1===this.opts.placeholder&&!t.attr("placeholder")||(t=!1!==this.opts.placeholder?this.opts.placeholder:t.attr("placeholder"),e.attr("placeholder",t),this.toggle())},toggle:function(){return this.editor.isEmpty(!0)?this.show():this.hide()},show:function(){this.editor.getElement().addClass("redactor-placeholder")},hide:function(){this.editor.getElement().removeClass("redactor-placeholder")}}),f.add("class","editor.events",{init:function(t){this.app=t,this.opts=t.opts,this.$doc=t.$doc,this.uuid=t.uuid,this.source=t.source,this.editor=t.editor,this.cleaner=t.cleaner,this.container=t.container,this.insertion=t.insertion,this.inspector=t.inspector,this.selection=t.selection,this.component=t.component,this.blurNamespace=".redactor-blur."+this.uuid,this.eventsList=["paste","click","contextmenu","keydown","keyup","mouseup","touchstart","cut","copy","dragenter","dragstart","drop","dragover","dragleave"],this._init()},destroy:function(){this.editor.getElement().off(".redactor-focus"),this.$doc.off("keyup"+this.blurNamespace+" mousedown"+this.blurNamespace),this._loop("off")},focus:function(t){var e=this.container.getElement();this.editor.isPasting()||e.hasClass("redactor-focus")||(e.addClass("redactor-focus"),e.removeClass("redactor-blur"),this.app.broadcast("observe",t),this.app.broadcast("focus",t),this.isFocused=!0,this.isBlured=!1)},blur:function(t){var e=this.container.getElement(),i=f.dom(t.target),n=[".redactor-in-"+this.uuid,".redactor-toolbar",".redactor-dropdown",".redactor-context-toolbar",".redactor-modal-box","#redactor-image-resizer"];this.app.broadcast("originalblur",t),this.app.stopBlur||this.app.isStarted()&&!this.editor.isPasting()&&0===i.closest(n.join(",")).length&&(this.isBlured||e.hasClass("redactor-blur")||(e.removeClass("redactor-focus"),e.addClass("redactor-blur"),this.app.broadcast("blur",t),this.isFocused=!1,this.isBlured=!0))},cut:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e);this.app.broadcast("state",t),this.component.isNonEditable(e)&&(this._passSelectionToClipboard(t,i,!0),t.preventDefault())},copy:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e);this.app.broadcast("state",t),this.component.isNonEditable(e)&&(this._passSelectionToClipboard(t,i,!1),t.preventDefault())},drop:function(t){if((t=t.originalEvent||t).stopPropagation(),this._removeOverClass(),!1!==this.opts.dragUpload){if(this.app.isDragComponentInside()){var e=f.dom(this.app.getDragComponentInside()),i=e.clone(!0);return this.insertion.insertToPoint(t,i),e.remove(),this.app.setDragComponentInside(!1),this.app.broadcast("state",t),this.app.broadcast("drop",t),this.app.broadcast("image.observe",t),void t.preventDefault()}if(this.app.isDragInside()&&this.opts.input){this.insertion.insertPoint(t);i=t.dataTransfer.getData("text/html"),e=this.selection.getRange();if(e){var n=this.selection.getBlocks();e.deleteContents();for(var r=0;r<n.length;r++)""===n[r].innerHTML&&f.dom(n[r]).remove()}return f.create("input.paste",this.app,t,!0,i,!0),this.app.broadcast("state",t),this.app.broadcast("drop",t),this.app.setDragInside(!1),void t.preventDefault()}this.app.broadcast("state",t),this.app.broadcast("paste",t,t.dataTransfer),this.app.broadcast("drop",t)}else t.preventDefault()},dragenter:function(t){t.preventDefault()},dragstart:function(t){this.app.setDragComponentInside(!1),this.app.setDragInside(!1);var e=this.inspector.parse(t.target);!e.isComponent()||e.isComponentEditable()||e.isFigcaption()?this.selection.is()&&!this.selection.isCollapsed()&&(this.app.setDragInside(!0),this._setDragData(t)):this.app.setDragComponentInside(e.getComponent()),this.app.broadcast("dragstart",t)},dragover:function(t){this.app.broadcast("dragover",t)},dragleave:function(t){this.app.broadcast("dragleave",t)},paste:function(t){this.app.broadcast("paste",t)},contextmenu:function(t){},click:function(t){3===t.detail&&(t.preventDefault(),(e=this.selection.getBlock())&&((i=document.createRange()).selectNodeContents(e),this.selection.setRange(i)));var e,i,n=f.dom(t.target);n.hasClass("redactor-in")&&(e=n.offset().top,i=parseFloat(n.css("padding-bottom")),e+n.height()-2*i<t.pageY?this.app.broadcast("bottomclick",t):n.hasClass("redactor-placeholder")&&this.editor.startFocus(this.editor)),this.app.broadcast("state",t),this.app.broadcast("click",t)},keydown:function(t){if(this.app.broadcast("state",t),!1===this.app.broadcast("keydown",t))return t.preventDefault()},keyup:function(t){this.app.broadcast("keyup",t)},mouseup:function(t){this.app.broadcast("observe",t),this.app.broadcast("state",t)},touchstart:function(t){this.app.broadcast("observe",t),this.app.broadcast("state",t)},_init:function(){this.editor.getElement().on("focus.redactor-focus click.redactor-focus",this.focus.bind(this)),this.$doc.on("keyup"+this.blurNamespace+" mousedown"+this.blurNamespace,this.blur.bind(this)),this._loop("on")},_removeOverClass:function(){this.editor.getElement().removeClass("over")},_loop:function(t){for(var e=this.editor.getElement(),i=0;i<this.eventsList.length;i++){var n=this.eventsList[i]+".redactor-events",r=this.eventsList[i];e[t](n,this[r].bind(this))}},_passAllToClipboard:function(t){var e=t.clipboardData,t=this.source.getCode();e.setData("text/html",t),e.setData("text/plain",t.toString().replace(/\n$/,""))},_passSelectionToClipboard:function(t,e,i){var n=t.clipboardData,t=e.getComponent(),e=f.dom(t).clone();e.find(".redactor-component-caret").remove(),e.removeClass("redactor-component-active"),e.removeAttr("contenteditable"),e.removeAttr("tabindex");e=e.get().outerHTML;i&&this.component.remove(t),n.setData("text/html",e),n.setData("text/plain",e.toString().replace(/\n$/,""))},_setDragData:function(t){t=(t=t.originalEvent||t).dataTransfer;t.effectAllowed="move",t.setData("text/Html",this.selection.getHtml())}}),f.add("module","container",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.lang=t.lang,this.element=t.element,this.container=t.container},start:function(){this._build(),this._buildAccesibility()},stop:function(){var t=this.element.getElement(),e=this.container.getElement();e.after(t),e.remove(),t.show()},_build:function(){var t=this.element.getElement(),e=this.container.getElement();e.addClass("redactor-box"),e.attr("dir",this.opts.direction),this.element.isType("inline")&&e.addClass("redactor-inline"),t.after(e),e.append(t)},_buildAccesibility:function(){var t=this.container.getElement(),e=f.dom("<span />");e.addClass("redactor-voice-label"),e.attr({id:"redactor-voice-"+this.uuid,"aria-hidden":!1}),e.html(this.lang.get("accessibility-help-label")),t.prepend(e)}}),f.add("module","source",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.utils=t.utils,this.element=t.element,this.source=t.source,this.editor=t.editor,this.toolbar=t.toolbar,this.cleaner=t.cleaner,this.component=t.component,this.container=t.container,this.autoparser=t.autoparser,this.selection=t.selection,this.syncedHtml=""},onstartcode:function(){var t=this.source.getStartedContent(),e=this.editor.getElement(),i=this.source.getElement();this.opts.autoparse&&this.opts.autoparseStart&&(t=this.autoparser.parse(t));var n=this.cleaner.input(t,!0,!0),t=this.cleaner.output(n);e.html(n),i.val(t),this.syncedHtml=t,this.app.broadcast("placeholder.build"),this.app.broadcast("autoparseobserve"),this.component.executeScripts()},onstartcodeshow:function(){this.show()},ontrytosync:function(){this.sync()},onhardsync:function(){var t=this.editor.getElement().html(),t=this.app.broadcast("syncBefore",t);t=this.cleaner.output(t),this._syncing(t)},start:function(){this._build(),this._buildClasses()},stop:function(){var t=this.element.getElement(),e=this.source.getElement();t.removeClass("redactor-source redactor-source-open"),e.off("input.redactor-source"),e.removeAttr("data-gramm_editor"),0===e.get().classList.length&&e.removeAttr("class"),this.source.isNameGenerated()||t.removeAttr("name"),this.element.isType("textarea")||e.remove()},getCode:function(){return this.source.getCode()},toggle:function(){if(this.opts.source)return this.source.getElement().hasClass("redactor-source-open")?this.hide():this.show()},show:function(){var t,e,i,n,r;this.opts.source&&(n=this.editor.getElement(),t=this.source.getElement(),e=this.container.getElement(),r=t.val(),this.app.isStarted()&&(r=this.app.broadcast("source.open",r)),i=n.height(),n.hide(),t.height(i),t.val(r.trim()),t.show(),t.addClass("redactor-source-open"),t.on("input.redactor-source-events",this._onChangedSource.bind(this)),t.on("keydown.redactor-source-events",this._onTabKey.bind(this)),t.on("focus.redactor-source-events",this._onFocus.bind(this)),this.opts.source.hasOwnProperty("codemirror")?(n="object"==typeof this.opts.source.codemirror?this.opts.source.codemirror:{},r=void 0!==this.opts.source.codemirrorSrc?this.opts.source.codemirrorSrc:CodeMirror,this.codemirror=r.fromTextArea(t.get(),n),this.codemirror.setSize(null,i),this.codemirror.on("change",function(t,e){t.save()}),this.codemirror.on("change",this._onChangedSource.bind(this))):e.addClass("redactor-source-view"),setTimeout(function(){this._disableButtons(),this._setActiveSourceButton()}.bind(this),100),this.app.isStarted()&&this.app.broadcast("source.opened"))},hide:function(){var t,e,i,n;this.opts.source&&(t=this.editor.getElement(),e=this.source.getElement(),i=this.container.getElement(),n=e.val(),this.opts.source.hasOwnProperty("codemirror")&&(n=this.codemirror.getValue(),this.codemirror.toTextArea()),n=this.cleaner.input(n,!0),n=this.utils.isEmptyHtml(n)?this.opts.emptyHtml:n,n=this.app.broadcast("source.close",n),this._enableButtons(),this._setInactiveSourceButton(),e.hide(),e.removeClass("redactor-source-open"),e.off(".redactor-source-events"),t.show(),t.html(n),i.removeClass("redactor-source-view"),setTimeout(function(){this.editor.startFocus(),this.component.executeScripts()}.bind(this),0),this.app.broadcast("source.closed"))},sync:function(){var t=this,e=this.editor.getElement().html(),e=this.app.broadcast("syncBefore",e);e=this.cleaner.output(e),this._isSync(e)&&(this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(function(){t._syncing(e)},200))},_build:function(){var t=this.source.getElement(),e=this.element.getElement();t.hide(),this.opts.grammarly||t.attr("data-gramm_editor",!1),this.element.isType("textarea")||e.after(t)},_buildClasses:function(){this.source.getElement().addClass("redactor-source")},_syncing:function(t){t=this.app.broadcast("syncing",t),this.source.getElement().val(t),this.app.broadcast("synced",t),this.app.broadcast("changed",t)},_isSync:function(t){return this.syncedHtml!==t&&(this.syncedHtml=t,!0)},_onChangedSource:function(){var t=this.source.getElement().val();this.app.broadcast("changed",t),this.app.broadcast("source.changed",t)},_onTabKey:function(t){if(9!==t.keyCode)return!0;t.preventDefault();var e=this.source.getElement(),i=e.get(),t=i.selectionStart;e.val(e.val().substring(0,t)+"    "+e.val().substring(i.selectionEnd)),i.selectionStart=i.selectionEnd=t+4},_onFocus:function(){this.app.broadcast("sourcefocus")},_disableButtons:function(){this.toolbar.disableButtons()},_enableButtons:function(){this.toolbar.enableButtons()},_setActiveSourceButton:function(){var t=this.toolbar.getButton("html");t.enable(),t.setActive()},_setInactiveSourceButton:function(){this.toolbar.getButton("html").setInactive()}}),f.add("module","observer",{init:function(t){this.app=t,this.editor=t.editor,this.observerUnit=!1},start:function(){var t;window.MutationObserver&&(t=this.editor.getElement().get(),this.observerUnit=this._build(t),this.observerUnit.observe(t,{attributes:!0,subtree:!0,childList:!0,characterData:!0,characterDataOldValue:!0}))},stop:function(){this.observerUnit&&this.observerUnit.disconnect()},_build:function(e){var i=this;return new MutationObserver(function(t){i._observe(t[t.length-1],e)})},_observe:function(t,e){this.app.isReadOnly()||"attributes"===t.type&&t.target===e||(this.app.broadcast("observe"),this.app.broadcast("trytosync"),this.app.broadcast("placeholder.toggle"))}}),f.add("module","clicktoedit",{init:function(t){this.app=t,this.opts=t.opts,this.source=t.source,this.editor=t.editor,this.container=t.container,this.selection=t.selection},onstartclicktoedit:function(){this.start()},onenablereadonly:function(){this.opts.clickToEdit&&(this._isEnabled()||this.stop())},ondisablereadonly:function(){this.opts.clickToEdit&&(this._isEnabled()||this.start())},onstop:function(){this.stop()},start:function(){this._build()},stop:function(){this.buttonSave&&this.buttonSave.stop(),this.buttonCancel&&this.buttonCancel.stop(),this._destroy(),this.app.broadcast("disable")},enable:function(){this.app.broadcast("clickStart");var t=this.editor.isEmpty();t||this.selection.saveMarkers(),this._setFocus(),this._destroy(),this.app.broadcast("enable"),this.buttonSave.enable(),this.buttonCancel.enable(),t||this.selection.restoreMarkers(),t&&this.editor.focus(),this.container.getElement().addClass("redactor-clicktoedit-enabled"),this.source.rebuildStartedContent(),this.app.broadcast("startcode"),this.app.broadcast("image.observe")},save:function(t){t&&t.preventDefault();t=this.source.getCode();this.app.broadcast("disable"),this.app.broadcast("clickSave",t),this.app.broadcast("clickStop"),this.app.broadcast("toolbar.removeexternal"),this._build()},cancel:function(t){t&&t.preventDefault();t=this.saved;this.editor.getElement().html(t),this.saved="",this.app.broadcast("disable"),this.app.broadcast("clickCancel",t),this.app.broadcast("clickStop"),this.app.broadcast("toolbar.removeexternal"),this._build()},_build:function(){this.buttonSave=f.create("clicktoedit.button","save",this.app,this),this.buttonCancel=f.create("clicktoedit.button","cancel",this.app,this),this.buttonSave.stop(),this.buttonCancel.stop();var t=this.editor.getElement(),e=this.container.getElement();t.on("click.redactor-click-to-edit mouseup.redactor-click-to-edit",this.enable.bind(this)),e.addClass("redactor-over"),e.removeClass("redactor-clicktoedit-enabled")},_isEnabled:function(){return this.container.getElement().hasClass("redactor-clicktoedit-enabled")},_destroy:function(){var t=this.editor.getElement(),e=this.container.getElement();t.off(".redactor-click-to-edit"),e.removeClass("redactor-over redactor-clicktoedit-enabled")},_setFocus:function(){this.saved=this.source.getCode(),this.buttonSave.start(),this.buttonCancel.start()}}),f.add("class","clicktoedit.button",{init:function(t,e,i){this.app=e,this.opts=e.opts,this.toolbar=e.toolbar,this.context=i,this.type=t,this.name="save"===t?"clickToSave":"clickToCancel",this.objected=!1,this.enabled=!1,this.namespace=".redactor-click-to-edit",this._build()},enable:function(){var t;this.objected&&((t=this.opts[this.name]).api="module.clicktoedit."+this.type,this.toolbar.addButton(this.type,t),this.enabled=!0)},start:function(){this.objected||(this.$button.off(this.namespace),this.$button.show(),this.$button.on("click"+this.namespace,this.context[this.type].bind(this.context)))},stop:function(){!this.objected&&this.enabled&&this.$button.hide()},_build:function(){this.objected="object"==typeof this.opts[this.name],this.objected||(this.$button=f.dom(this.opts[this.name]),this.enabled=!0)}}),f.add("module","statusbar",{init:function(t){this.app=t,this.opts=t.opts,this.element=t.element,this.statusbar=t.statusbar,this.container=t.container},start:function(){var t,e;this.element.isType("inline")||(t=this.statusbar.getElement(),e=this.container.getElement(),t.addClass("redactor-statusbar"),e.append(t))}}),f.add("module","contextbar",{init:function(t){this.app=t,this.opts=t.opts,this.uuid=t.uuid,this.$win=t.$win,this.$doc=t.$doc,this.$body=t.$body,this.editor=t.editor,this.toolbar=t.toolbar,this.detector=t.detector,this.$target=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$body},onstop:function(){this.stop()},onenablereadonly:function(){this.stop()},ondisablereadonly:function(){this.start()},oncontextbar:{close:function(){this.close()}},start:function(){var t;this.opts.toolbarContext&&(t=this.editor.getElement(),this._build(),t.on("click.redactor-context mouseup.redactor-context",this.open.bind(this)),this.opts.scrollTarget?f.dom(this.opts.scrollTarget).on("scroll.redactor-context",this.close.bind(this)):!1!==this.opts.maxHeight&&t.on("scroll.redactor-context",this.close.bind(this)))},stop:function(){this.editor.getElement().off(".redactor-context"),this.$doc.off(".redactor-context"),this.$win.off(".redactor-context"),this.$contextbar&&this.$contextbar.remove(),this.opts.scrollTarget&&f.dom(this.opts.scrollTarget).off(".redactor-context")},is:function(){return this.$contextbar&&this.$contextbar.hasClass("open")},set:function(t,e,i,n){for(var r in this.$contextbar.html(""),this.$el=f.dom(e),i){var s=f.create("contextbar.button",this.app,i[r]);""!==s.html()&&this.$contextbar.append(s)}n=this._buildPosition(t,this.$el,n);this.$contextbar.css(n),this.$contextbar.show(),this.$contextbar.addClass("open"),this.$doc.on("click.redactor-context mouseup.redactor-context",this.close.bind(this)),this.$win.on("resize.redactor-context",this.close.bind(this))},open:function(t){setTimeout(function(){this.app.broadcast("contextbar",t,this)}.bind(this),0)},close:function(t){if(this.$contextbar){if(t){t=f.dom(t.target);if(this.$el&&0!==t.closest(this.$el).length)return}this.$contextbar.hide(),this.$contextbar.removeClass("open"),this.$doc.off(".redactor.context")}},_build:function(){this.$contextbar=f.dom("<div>"),this.$contextbar.attr("id","redactor-context-toolbar-"+this.uuid),this.$contextbar.attr("dir",this.opts.direction),this.$contextbar.addClass("redactor-context-toolbar"),this.$contextbar.hide(),this.$target.append(this.$contextbar)},_buildPosition:function(t,e,i){var n,r,s=this.toolbar.isTarget(),o=s?e.position():e.offset(),a=e.width(),l=e.height(),c=this.$contextbar.width(),h=this.$contextbar.height(),d=s?this.$target.scrollTop()+this.$doc.scrollTop():this.$doc.scrollTop(),u=this.$target.offset(),e=s?u.left:0,u=s?u.top:0;return i?"top"===i?(n=o.top-h,r=o.left+a/2-c/2):"bottom"===i&&(n=o.top+l,r=o.left+a/2-c/2):(n=t.clientY+d-h,r=t.clientX-c/2),r<0&&(r=0),{top:n-u+"px",left:r-e+"px"}}}),f.add("class","contextbar.button",{mixins:["dom"],init:function(t,e){this.app=t,this.obj=e,this._init()},_init:function(){var t;this.parse("<a>"),"string"!=typeof this.obj.title?(t=this.obj.title.attr("href"),this.attr("href",t),-1===t.search(/^#/)&&this.attr("target","_blank"),this.text(this.obj.html||t)):(this.attr("href","#"),this._buildTitle(),this._buildMessage())},_buildTitle:function(){this.html(this.obj.title)},_buildMessage:function(){void 0===this.obj.message&&void 0===this.obj.api||this.on("click",this._toggle.bind(this))},_toggle:function(t){t.preventDefault(),this.obj.message?this.app.broadcast(this.obj.message,this.obj.args):this.obj.api&&this.app.api(this.obj.api,this.obj.args)}}),f.add("module","toolbar",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.utils=t.utils,this.toolbar=t.toolbar,this.detector=t.detector,this.buttons=[],this.toolbarModule=!1},onsource:{open:function(){!this.toolbar.isAir()&&this.toolbar.isFixed()&&this.toolbarModule.resetPosition()},opened:function(){this.toolbar.isAir()&&this.toolbarModule&&this.toolbarModule.createSourceHelper(),setTimeout(function(){f.dom(".re-button-tooltip-"+this.uuid).remove()}.bind(this),100)},close:function(){this.toolbar.isAir()&&this.toolbarModule&&this.toolbarModule.destroySourceHelper()},closed:function(){this.toolbar.is()&&this.opts.air&&this.toolbarModule.openSelected()}},ontoolbar:{removeexternal:function(){!this.opts.air&&this.opts.toolbarExternal&&this.opts.clickToEdit&&f.dom(this.opts.toolbarExternal).html("")}},onobserve:function(){this.toolbar.is()&&this.toolbar.observe()},onfocus:function(){this._setExternalOnFocus()},onsourcefocus:function(){this._setExternalOnFocus()},onempty:function(){this.toolbar.isFixed()&&this.toolbarModule.resetPosition()},onenablereadonly:function(){this.toolbar.isAir()&&this.toolbarModule.close()},start:function(){this.toolbar.is()&&(this._buildButtons(),this._initToolbar(),this._initButtons())},stop:function(){this.toolbarModule&&this.toolbarModule.stop(),f.dom(".re-button-tooltip-"+this.uuid).remove(),f.dom(".redactor-dropdown-"+this.uuid).remove()},_buildButtons:function(){this.buttons=this.opts.buttons.concat(),this._buildImageButton(),this._buildFileButton(),this._buildSourceButton(),this._buildAdditionalButtons(),this._buildHiddenButtons()},_buildImageButton:function(){this.opts.imageUpload||this.opts.imageManagerJson||this.utils.removeFromArrayByValue(this.buttons,"image")},_buildFileButton:function(){this.opts.fileUpload||this.utils.removeFromArrayByValue(this.buttons,"file")},_buildSourceButton:function(){this.opts.source||this.utils.removeFromArrayByValue(this.buttons,"html")},_buildAdditionalButtons:function(){var t,e;if(0!==this.opts.buttonsAdd.length&&(this.opts.buttonsAdd=this._removeExistButtons(this.opts.buttonsAdd),this.buttons=this.buttons.concat(this.opts.buttonsAdd)),0!==this.opts.buttonsAddFirst.length&&(this.opts.buttonsAddFirst=this._removeExistButtons(this.opts.buttonsAddFirst),this.buttons.unshift(this.opts.buttonsAddFirst)),!1!==this.opts.buttonsAddAfter){t=this.buttons.indexOf(this.opts.buttonsAddAfter.after)+1,e=this.opts.buttonsAddAfter.buttons;for(var i=0;i<e.length;i++)this.buttons.splice(t+i,0,e[i])}if(!1!==this.opts.buttonsAddBefore){t=this.buttons.indexOf(this.opts.buttonsAddBefore.before)+1,e=this.opts.buttonsAddBefore.buttons;for(i=0;i<e.length;i++)this.buttons.splice(t-(1-i),0,e[i])}},_buildHiddenButtons:function(){if(0!==this.opts.buttonsHide.length)for(var t=this.opts.buttonsHide,e=0;e<t.length;e++)this.utils.removeFromArrayByValue(this.buttons,t[e]);if(this.detector.isMobile()&&0!==this.opts.buttonsHideOnMobile.length)for(t=this.opts.buttonsHideOnMobile,e=0;e<t.length;e++)this.utils.removeFromArrayByValue(this.buttons,t[e])},_removeExistButtons:function(t){for(var e=0;e<t.length;e++)-1!==this.opts.buttons.indexOf(t[e])&&this.utils.removeFromArrayByValue(t,t[e]);return t},_setExternalOnFocus:function(){!this.opts.air&&this.opts.toolbarExternal&&this.toolbarModule.setExternal()},_initToolbar:function(){this.toolbarModule=this.opts.air?f.create("toolbar.air",this.app):f.create("toolbar.standard",this.app)},_initButtons:function(){this.toolbar.setButtons(this.buttons);for(var t=0;t<this.buttons.length;t++){var e=this.buttons[t];f.buttons[e]&&this.toolbar.addButton(e,f.extend(!0,{},f.buttons[e]),!1,!1,!0)}}}),f.add("class","toolbar.air",{init:function(t){this.app=t,this.uuid=t.uuid,this.$doc=t.$doc,this.$win=t.$win,this.utils=t.utils,this.editor=t.editor,this.animate=t.animate,this.toolbar=t.toolbar,this.container=t.container,this.inspector=t.inspector,this.selection=t.selection,this.clicks=0,this._init()},stop:function(){this.toolbar.getWrapper().remove(),this.editor.getElement().off(".redactor-air-trigger-"+this.uuid),this.$doc.off(".redactor-air-"+this.uuid),this.$doc.off(".redactor-air-trigger-"+this.uuid),this.toolbar.stopObservers()},createSourceHelper:function(){this.$airHelper=f.dom("<span>"),this.$airHelper.addClass("redactor-air-helper"),this.$airHelper.html('<i class="re-icon-html"></i>'),this.$airHelper.on("click",function(t){t.preventDefault(),this.app.api("module.source.hide")}.bind(this)),this.container.getElement().append(this.$airHelper)},destroySourceHelper:function(){this.$airHelper&&this.$airHelper.remove()},openSelected:function(){setTimeout(function(){this._isSelection()&&this._open(!1)}.bind(this),0)},close:function(){this.$doc.off(".redactor-air-"+this.uuid);var t=this.toolbar.getElement();t.removeClass("open"),t.hide()},_init:function(){this.toolbar.create();var t=this.toolbar.getWrapper(),e=this.toolbar.getElement(),i=this.editor.getElement(),n=this.container.getElement();t.addClass("redactor-toolbar-wrapper-air"),e.addClass("redactor-air"),e.hide(),t.append(e),n.prepend(t),this.openSelected(),this.$doc.on("mouseup.redactor-air-trigger-"+this.uuid,this._open.bind(this)),i.on("keyup.redactor-air-trigger-"+this.uuid,this._openCmd.bind(this))},_isSelection:function(){return this.selection.is()&&!this.selection.isCollapsed()},_isOpened:function(){return this.toolbar.getElement().hasClass("open")},_open:function(t){var e,i=!!t&&t.target,n=!!t&&f.dom(t.target),r=this.inspector.parse(i),s=r.isComponent()&&!r.isComponentType("table"),o=r.isFigcaption(),i=n&&0!==n.closest(".redactor-modal").length,r=t&&0!==n.closest(".re-button").length;t&&0!==n.closest(".redactor-dropdown").length||r||i||o||s||this.toolbar.isContextBar()||!this._isSelection()||(e=this.selection.getPosition(),setTimeout(function(){this.app.isReadOnly()||this._isSelection()&&this._doOpen(e)}.bind(this),1))},_openCmd:function(){var t,e;this.selection.isAll()&&(t=this.toolbar.getElement(),(e=this.selection.getPosition()).top=e.top<20?0:e.top-t.height(),e.height=0,this._doOpen(e))},_doOpen:function(t){var e=this.toolbar.getWrapper(),i=this.toolbar.getElement(),n=this.container.getElement().offset(),r=0,s=this.$win.width(),o=i.width();s<t.left+o&&(r=o-this.selection.getPosition().width),e.css({left:t.left-n.left-r+"px",top:t.top-n.top+t.height+this.$doc.scrollTop()+"px"}),this.app.broadcast("airOpen"),i.addClass("open"),i.show(),this.$doc.on("click.redactor-air-"+this.uuid,this._close.bind(this)),this.$doc.on("keydown.redactor-air-"+this.uuid,this._close.bind(this)),this.app.broadcast("airOpened")},_close:function(t){var e=!!t&&f.dom(t.target),i=t&&0!==e.closest("[data-dropdown], .redactor-dropdown-not-close").length;(!i&&t&&0!==e.closest(".re-button").length||!i&&this._isOpened())&&(this.app.broadcast("airClose"),this.close(),this.app.broadcast("airClosed"))}}),f.add("class","toolbar.fixed",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.$doc=t.$doc,this.$win=t.$win,this.editor=t.editor,this.toolbar=t.toolbar,this.detector=t.detector,this.container=t.container,this._init()},stop:function(){this.$fixedTarget.off(".redactor-toolbar-"+this.uuid),this.$win.off(".redactor-toolbar-"+this.uuid)},reset:function(){var t=this.toolbar.getElement();this.toolbar.getWrapper().css("height",""),t.removeClass("redactor-toolbar-fixed"),t.css({position:"",top:"",left:"",width:""});t=this.toolbar.getDropdown();t&&t.updatePosition()},_init:function(){this.$fixedTarget=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$win,this._doFixed(),this.toolbar.isTarget()&&(this.$win.on("scroll.redactor-toolbar-"+this.uuid,this._doFixed.bind(this)),this.$win.on("resize.redactor-toolbar-"+this.uuid,this._doFixed.bind(this))),this.$fixedTarget.on("scroll.redactor-toolbar-"+this.uuid,this._doFixed.bind(this)),this.$fixedTarget.on("resize.redactor-toolbar-"+this.uuid,this._doFixed.bind(this))},_doFixed:function(){var t,e,i,n,r,s=this.editor.getElement(),o=this.container.getElement(),a=this.toolbar.getElement(),l=this.toolbar.getWrapper();this.editor.isSourceMode()||0===o.parents().filter(function(t){return"none"===getComputedStyle(t,null).display&&t}).length&&(n=s.height()<100,i=this.editor.isEmpty(),n||i?this.reset():this.editor.isSourceMode()||(t=a.height(),r=(e=(this.toolbar.isTarget()?o.position():o.offset()).top)+o.height()-60,s=this.$fixedTarget.scrollTop()+this.opts.toolbarFixedTopOffset,n=this.toolbar.isTarget()?this.$fixedTarget.offset().top-this.$win.scrollTop():0,this.toolbar.isTarget()&&"fixed"===this.$fixedTarget.css("position")&&(i=this.$fixedTarget.hasClass("modal")&&this.$fixedTarget.hasClass("fade")?o.closest(".modal-dialog").position().top:0,n=this.$fixedTarget.scrollTop()-i),e<s&&s<r?(r=this.detector.isDesktop()?"fixed":"absolute",n=this.detector.isDesktop()?n:s-e,this.detector.isMobile()&&(this.fixedScrollTimeout&&clearTimeout(this.fixedScrollTimeout),a.hide(),this.fixedScrollTimeout=setTimeout(function(){a.show()},250)),l.height(t),a.addClass("redactor-toolbar-fixed"),o.hasClass("redactor-box-fullscreen")?a.css({position:r,top:"0px",width:o.width()+"px"}):a.css({position:r,top:n+this.opts.toolbarFixedTopOffset+"px",width:o.width()+"px"}),(o=this.toolbar.getDropdown())&&o.updatePosition(),this.app.broadcast("toolbar.fixed")):(this.reset(),this.app.broadcast("toolbar.unfixed"))))}}),f.add("class","toolbar.standard",{init:function(t){this.app=t,this.opts=t.opts,this.uuid=t.uuid,this.$body=t.$body,this.toolbar=t.toolbar,this.container=t.container,this.isExternalMultiple=!1,this.toolbarFixed=!1,this._init()},stop:function(){this.toolbar.getWrapper().remove(),this.toolbarFixed&&this.toolbarFixed.stop(),this.opts.toolbarExternal&&this._findToolbars(),this.toolbar.stopObservers(),this.$body.find(".re-button-tooltip-"+this.uuid).remove()},setExternal:function(){this._findToolbars(),this.isExternalMultiple&&(this.$toolbars.hide(),this.$external.find(".redactor-toolbar-external-"+this.uuid).show())},resetPosition:function(){this.toolbarFixed&&this.toolbarFixed.reset()},_init:function(){this._build(),this.opts.toolbarExternal?this._buildExternal():(this._buildFixed(),this.toolbar.getElement().show())},_build:function(){this.toolbar.create();var t=this.toolbar.getWrapper(),e=this.toolbar.getElement();t.addClass("redactor-toolbar-wrapper"),e.addClass("redactor-toolbar"),e.hide(),t.append(e),this.opts.toolbarExternal||this.container.getElement().prepend(t)},_buildExternal:function(){this._initExternal(),this._findToolbars(),this.isExternalMultiple?this._hideToolbarsExceptFirst():this.toolbar.getElement().show()},_buildFixed:function(){this.opts.toolbarFixed&&(this.toolbarFixed=f.create("toolbar.fixed",this.app))},_initExternal:function(){var t=this.toolbar.getElement(),e=this.toolbar.getElement();t.addClass("redactor-toolbar-external redactor-toolbar-external-"+this.uuid),this.$external=f.dom(this.opts.toolbarExternal),this.$external.append(e)},_findToolbars:function(){this.$toolbars=this.$external.find(".redactor-toolbar-external"),this.isExternalMultiple=1<this.$toolbars.length},_hideToolbarsExceptFirst:function(){this.$toolbars.hide(),this.$toolbars.first().show()}}),f.add("module","line",{init:function(t){this.app=t,this.lang=t.lang,this.component=t.component,this.inspector=t.inspector,this.insertion=t.insertion},oncontextbar:function(t,e){var i,n=this.inspector.parse(t.target);n.isComponentType("line")&&(i=n.getComponent(),n={remove:{title:this.lang.get("delete"),api:"module.line.remove",args:i}},e.set(t,i,n,"bottom"))},insert:function(){var t=this.component.create("line");this.insertion.insertRaw(t)},remove:function(t){this.component.remove(t)}}),f.add("class","line.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},_init:function(t){var e,i,n;void 0!==t&&("HR"===(t=(n=f.dom(t)).get()).tagName?i=t:"FIGURE"===t.tagName&&(e=t,i=n.find("hr").get())),this._buildWrapper(e),this._buildElement(i),this._initWrapper()},_buildElement:function(t){t?this.$element=f.dom(t):(this.$element=f.dom("<hr>"),this.append(this.$element))},_buildWrapper:function(t){t=t||"<figure>",this.parse(t)},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"line",tabindex:"-1",contenteditable:!1})}}),f.add("module","link",{modals:{link:'<form action="">                 <div class="form-item">                     <label for="modal-link-url">URL <span class="req">*</span></label>                     <input type="text" id="modal-link-url" name="url">                 </div>                 <div class="form-item">                     <label for="modal-link-text">## text ##</label>                     <input type="text" id="modal-link-text" name="text">                 </div>                 <div class="form-item form-item-title">                     <label for="modal-link-title">## title ##</label>                     <input type="text" id="modal-link-title" name="title">                 </div>                 <div class="form-item form-item-target">                     <label class="checkbox">                         <input type="checkbox" name="target"> ## link-in-new-tab ##                     </label>                 </div>             </form>'},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.caret=t.caret,this.utils=t.utils,this.inline=t.inline,this.editor=t.editor,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection,this.isCurrentLink=!1,this.currentText=!1},onmodal:{link:{open:function(t,e){this._setFormData(e,t)},opened:function(t,e){this._setFormFocus(e)},update:function(t,e){var i=e.getData();this._validateData(e,i)&&this._update(i)},insert:function(t,e){var i=e.getData();this._validateData(e,i)&&this._insert(i)},unlink:function(){this._unlink()}}},onbutton:{link:{observe:function(t){this._observeButton(t)}}},ondropdown:{link:{observe:function(t){this._observeUnlink(t),this._observeEdit(t)}}},oncontextbar:function(t,e){var i,n=this._getCurrent(),r=this.inspector.parse(n);(r.isLink()||r.isFile())&&(i=r.isFile()?r.getFile():r.getLink(),n=f.dom(i),r=f.dom("<a>"),n=n.attr("href"),r.text(this._truncateText(n)),r.attr("href",n),r.attr("target","_blank"),n={link:{title:r,html:this._truncateText(n)},edit:{title:this.lang.get("edit"),api:"module.link.open"},unlink:{title:this.lang.get("unlink"),api:"module.link.unlink"}},e.set(t,i,n,"bottom"))},open:function(){this.$link=this._buildCurrent(),this.app.api("module.modal.build",this._getModalData())},insert:function(t){this._insert(t)},update:function(t){this._update(t)},unlink:function(){this._unlink()},_observeButton:function(t){var e=this.selection.getCurrent(),e=this.inspector.parse(e);e.isPre()||e.isCode()?t.disable():t.enable()},_observeUnlink:function(t){t=t.getItem("unlink");0===this._getLinks().length?t.disable():t.enable()},_observeEdit:function(t){var e=this._getCurrent(),t=t.getItem("link"),e=this.inspector.parse(e),e=e.isLink()||e.isFile()?this.lang.get("link-edit"):this.lang.get("link-insert");t.setTitle(e)},_unlink:function(){this.app.api("module.modal.close");var t=[],e=this._getLinks();this.selection.save();for(var i=0;i<e.length;i++){var n=f.create("link.component",this.app,e[i]);t.push(this.selection.getElement(e[i])),n.unwrap(),this.app.broadcast("link.deleted",n)}this.selection.restore();for(i=0;i<t.length;i++){var r=t[i]||this.editor.getElement();this.utils.normalizeTextNodes(r)}this._resetCurrent()},_update:function(t){this.app.api("module.modal.close");var e=this._getLinks();this._setLinkData(e,t,"updated"),this._resetCurrent(),this.app.broadcast("link.changed",e)},_insert:function(t){this.app.api("module.modal.close");var e=this._getLinks();this._insertSingle(e,t)||(this._removeInSelection(e),this._insertMultiple(t)),this._resetCurrent()},_removeInSelection:function(t){this.selection.save();for(var e=0;e<t.length;e++){var i=f.create("link.component",this.app,t[e]),n=i.clone();i.unwrap(),this.app.broadcast("link.deleted",n)}this.selection.restore()},_insertMultiple:function(t){var e=this.selection.getRange();e&&this._isCurrentTextChanged(t)&&this._deleteContents(e);e=this.inline.format({tag:"a"});this._setLinkData(e,t,"inserted")},_insertSingle:function(t,e){var i=this.selection.getInline();if(1===t.length&&(t[0].textContext===this.selection.getText()||i&&"A"===i.tagName)){t=f.create("link.component",this.app,t[0]);return t.setData(e),this.caret.setAfter(t),this.app.broadcast("link.inserted",t),!0}return!1},_setLinkData:function(t,e,i){e.text=""===e.text.trim()?this._truncateText(e.url):e.text;var n=!this.currentText||this.currentText!==e.text;this.selection.save();for(var r=0;r<t.length;r++){var s=f.create("link.component",this.app,t[r]),o={};e.text&&n&&(o.text=e.text),e.url&&(o.url=e.url),void 0!==e.title&&(o.title=e.title),void 0!==e.target&&(o.target=e.target),s.setData(o),this.app.broadcast("link."+i,s)}setTimeout(this.selection.restore.bind(this.selection),0)},_deleteContents:function(t){var e=this.selection.getHtml(),e=this.utils.parseHtml(e).nodes[0];e&&3!==e.nodeType?(e=e.tagName.toLowerCase(),e=document.createElement(e),this.insertion.insertNode(e,"start")):t.deleteContents()},_getModalData:function(){var t=this._isLink()?{update:{title:this.lang.get("save")},unlink:{title:this.lang.get("unlink"),type:"danger"},cancel:{title:this.lang.get("cancel")}}:{insert:{title:this.lang.get("insert")},cancel:{title:this.lang.get("cancel")}};return{name:"link",title:this._isLink()?this.lang.get("link-edit"):this.lang.get("link-insert"),handle:this._isLink()?"update":"insert",commands:t}},_isLink:function(){return this.currentLink},_isCurrentTextChanged:function(t){return this.currentText&&this.currentText!==t.text},_buildCurrent:function(){var t,e=this._getCurrent(),e=this.inspector.parse(e);return e.isLink()||e.isFile()?(this.currentLink=!0,t=e.isFile()?e.getFile():e.getLink(),t=f.create("link.component",this.app,t)):(this.currentLink=!1,t=f.create("link.component",this.app),e={text:this.selection.getText()},t.setData(e)),t},_getCurrent:function(){return this.selection.getInlinesAllSelected({tags:["a"]})[0]},_getLinks:function(){for(var t=this.selection.getInlines({all:!0,tags:["a"]}),e=[],i=0;i<t.length;i++){var n=this.inspector.parse(t[i]);(n.isLink()||n.isFile())&&e.push(t[i])}return e},_resetCurrent:function(){this.isCurrentLink=!1,this.currentText=!1},_truncateText:function(t){return t&&t.length>this.opts.linkSize?t.substring(0,this.opts.linkSize)+"...":t},_validateData:function(t,e){return""!==e.url.trim()||t.setError("url")},_setFormFocus:function(t){t.getField("url").focus()},_setFormData:function(t,e){var i=this.$link.getData(),i={url:i.url,text:i.text,title:i.title,target:this.opts.linkTarget||i.target};this.opts.linkNewTab||e.find(".form-item-target").hide(),this.opts.linkTitle||e.find(".form-item-title").hide(),t.setData(i),this.currentText=t.getField("text").val()}}),f.add("class","link.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,this.opts=t.opts,this.reUrl=/^(?:(?:(?:https?|ftp):)?\/\/)?(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:[/?#]\S*)?$/i,e&&void 0!==e.cmnt?e:this._init(e)},setData:function(t){for(var e in t)this._set(e,t[e])},getData:function(){for(var t=["url","text","target","title"],e={},i=0;i<t.length;i++)e[t[i]]=this._get(t[i]);return e},_init:function(t){var e=f.dom(t);void 0===t?this.parse("<a>"):this.parse(e)},_set:function(t,e){this["_set_"+t](e)},_get:function(t){return this["_get_"+t]()},_get_target:function(){return!!this.attr("target")&&this.attr("target")},_get_url:function(){return this.attr("href")},_get_title:function(){return this.attr("title")},_get_text:function(){return this._getContext().text()},_getContext:function(){return this._findDeepestChild(this).element},_set_target:function(t){!1===t?this.removeAttr("target"):t&&this.attr("target",!0===t?"_blank":t)},_set_text:function(t){t=this._escapeHtml(t),this._getContext().html(t)},_set_title:function(t){t&&""!==t?this.attr("title",t):this.removeAttr("title")},_set_url:function(t){this.opts.linkValidation&&(t=this._cleanUrl(t),this._isMailto(t)?t="mailto:"+t.replace("mailto:",""):this._isUrl(t)&&-1===t.search(/^(ftp|https?)/i)&&(t="http://"+t.replace(/(ftp|https?):\/\//i,""))),this.attr("href",t)},_isMailto:function(t){return-1!==t.search("@")&&!1===/(ftp|https?):\/\//i.test(t)},_isUrl:function(t){return this.reUrl.test(t)},_cleanUrl:function(t){return(t=this._escapeHtml(t)).trim().replace(/[^\W\w\D\d+&\'@#/%?=~_|!:,.;\(\)]/gi,"")},_escapeHtml:function(t){return t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},_findDeepestChild:function(i){var n={depth:0,element:i};return i.children().each(function(t){var e=f.dom(t);t.outerHTML!==i.html()||(e=this._findDeepestChild(e)).depth+1>n.depth&&(n={depth:1+e.depth,element:e.element})}.bind(this)),n}}),f.add("module","modal",{init:function(t){this.app=t,this.uuid=t.uuid,this.lang=t.lang,this.$doc=t.$doc,this.$win=t.$win,this.$body=t.$body,this.utils=t.utils,this.editor=t.editor,this.animate=t.animate,this.detector=t.detector,this.selection=t.selection,this.$box=!1,this.$modal=!1,this.selectionMarkers=!1,this.defaults={name:!1,url:!1,title:!1,width:"600px",height:!1,handle:!1,commands:!1}},build:function(t){this._open(t)},close:function(){this._close()},onstop:function(){this.$body.find("#redactor-modal-"+this.uuid).remove(),this.$body.find("#redactor-overlay-"+this.uuid).remove()},stop:function(){this.$box&&(this.$box.remove(),this.$box=!1,this.$modal=!1),this.$overlay&&this.$overlay.remove(),this.$doc.off(".redactor.modal"),this.$win.off(".redactor.modal")},resize:function(){this.$modal.setWidth(this.p.width),this.$modal.updatePosition()},_isOpened:function(){return this.$modal&&this.$modal.hasClass("open")},_open:function(t){this._buildDefaults(t),this.p.url?this._openUrl():this._openTemplate()},_openUrl:function(){f.ajax.post({url:this.p.url,success:this._doOpen.bind(this)})},_openTemplate:function(){var t;void 0!==f.modals[this.p.name]&&(t=this.lang.parse(f.modals[this.p.name]),this._doOpen(t))},_doOpen:function(t){this.stop(),this.selection.isCollapsed()?(this.selection.save(),this.selectionMarkers=!1):(this.selection.saveMarkers(),this.selectionMarkers=!0),this.detector.isDesktop()||document.activeElement.blur(),this._createModal(t),this._buildModalBox(),this._buildOverlay(),this._buildModal(),this._buildModalForm(),this._buildModalCommands(),this._broadcast("open"),this.$modal.updatePosition(),this._buildModalTabs(),this.animate.start(this.$box,"fadeIn",this._opened.bind(this)),this.animate.start(this.$overlay,"fadeIn")},_opened:function(){this.$modal.addClass("open"),this.$box.on("mousedown.redactor.modal",this._close.bind(this)),this.$doc.on("keyup.redactor.modal",this._handleEscape.bind(this)),this.$win.on("resize.redactor.modal",this.resize.bind(this)),this.$modal.getBody().find("input[type=text],input[type=url],input[type=email]").on("keydown.redactor.modal",this._handleEnter.bind(this)),window.jQuery&&window.jQuery(document).off("focusin.modal"),this._broadcast("opened")},_close:function(t){if(this.$box&&this._isOpened()){if(t){if(!this._needToClose(t.target))return;t.stopPropagation(),t.preventDefault()}this.selectionMarkers?this.selection.restoreMarkers():this.selection.restore(),this.selectionMarkers=!1,this._broadcast("close"),this.animate.start(this.$box,"fadeOut",this._closed.bind(this)),this.animate.start(this.$overlay,"fadeOut")}},_closed:function(){this.$modal.removeClass("open"),this.$box.off(".redactor.modal"),this.$doc.off(".redactor.modal"),this.$win.off(".redactor.modal"),this._broadcast("closed")},_createModal:function(t){this.$modal=f.create("modal.element",this.app,t)},_broadcast:function(t){this.app.broadcast("modal."+t,this.$modal,this.$modalForm),this.app.broadcast("modal."+this.p.name+"."+t,this.$modal,this.$modalForm)},_buildDefaults:function(t){this.p=f.extend({},this.defaults,t)},_buildModalBox:function(){this.$box=f.dom("<div>"),this.$box.attr("id","redactor-modal-"+this.uuid),this.$box.addClass("redactor-modal-box redactor-animate-hide"),this.$box.html(""),this.$body.append(this.$box)},_buildOverlay:function(){this.$overlay=f.dom("#redactor-overlay-"+this.uuid),0===this.$overlay.length&&(this.$overlay=f.dom("<div>"),this.$overlay.attr("id","redactor-overlay-"+this.uuid),this.$overlay.addClass("redactor-overlay redactor-animate-hide"),this.$body.prepend(this.$overlay))},_buildModal:function(){this.$box.append(this.$modal),this.$modal.setTitle(this.p.title),this.$modal.setHeight(this.p.height),this.$modal.setWidth(this.p.width)},_buildModalCommands:function(){if(this.p.commands){var t,e=this.p.commands,i=this.$modal.getFooter();for(t in e){var n=f.dom("<button>");n.html(e[t].title),n.attr("data-command",t),"cancel"===t&&(n.attr("data-action","close"),n.addClass("redactor-button-unstyled")),void 0!==e[t].type&&"danger"===e[t].type&&n.addClass("redactor-button-danger"),n.on("click",this._handleCommand.bind(this)),i.append(n)}}},_buildModalTabs:function(){var t=this.$modal.getBody(),e=t.find(".redactor-modal-tab"),n=t.find(".redactor-modal-tabs");1<e.length&&((n=0===n.length?f.dom("<div>"):n.html("")).addClass("redactor-modal-tabs"),e.each(function(t,e){var i=f.dom(t),t=f.dom("<a>");t.attr("href","#"),t.attr("rel",e),t.text(i.attr("data-title")),t.on("click",this._showTab.bind(this)),0===e&&t.addClass("active"),n.append(t)}.bind(this)),t.prepend(n)),1===e.length&&e.show()},_buildModalForm:function(){this.$modalForm=f.create("modal.form",this.app,this.$modal.getForm())},_showTab:function(t){t.preventDefault();var e=f.dom(t.target),i=e.attr("rel"),n=this.$modal.getBody(),t=n.find(".redactor-modal-tab");t.hide(),t.eq(i).show(),n.find(".redactor-modal-tabs a").removeClass("active"),e.addClass("active")},_needToClose:function(t){var e=f.dom(t);return!("close"!==e.attr("data-action")&&!this.$modal.isCloseNode(t)&&0!==e.closest(".redactor-modal").length)},_handleCommand:function(t){var e=f.dom(t.target).closest("button").attr("data-command");"cancel"!==e&&t.preventDefault(),this._broadcast(e)},_handleEnter:function(t){13===t.which&&this.p.handle&&(t.preventDefault(),this._broadcast(this.p.handle))},_handleEscape:function(t){27===t.which&&this._close()}}),f.add("class","modal.element",{mixins:["dom"],init:function(t,e){this.app=t,this.opts=t.opts,this.$win=t.$win,this._init(e)},getForm:function(){return this.find("form")},getHeader:function(){return this.$modalHeader},getBody:function(){return this.$modalBody},getFooter:function(){return this.$modalFooter},setTitle:function(t){t&&this.$modalHeader.html(t)},setWidth:function(t){t=parseInt(t)>=this.$win.width()?"96%":t,this.css("max-width",t)},setHeight:function(t){!1!==t&&this.$modalBody.css("height",t)},updatePosition:function(){var t=this.width();this.css({left:"50%","margin-left":"-"+t/2+"px"});var e=this.$win.height(),i=this.height(),t=e/2-i/2;i<e&&0!=t&&this.css("margin-top",t+"px")},isCloseNode:function(t){return t===this.$modalClose.get()},_init:function(t){this._build(),this._buildClose(),this._buildHeader(),this._buildBody(),this._buildFooter(),this._buildTemplate(t)},_build:function(){this.parse("<div>"),this.addClass("redactor-modal"),this.attr("dir",this.opts.direction)},_buildClose:function(){this.$modalClose=f.dom("<span>"),this.$modalClose.addClass("redactor-close"),this.append(this.$modalClose)},_buildHeader:function(){this.$modalHeader=f.dom("<div>"),this.$modalHeader.addClass("redactor-modal-header"),this.append(this.$modalHeader)},_buildBody:function(){this.$modalBody=f.dom("<div>"),this.$modalBody.addClass("redactor-modal-body"),this.append(this.$modalBody)},_buildFooter:function(){this.$modalFooter=f.dom("<div>"),this.$modalFooter.addClass("redactor-modal-footer"),this.append(this.$modalFooter)},_buildTemplate:function(t){this.$modalBody.html(t)}}),f.add("class","modal.form",{mixins:["dom"],init:function(t,e){this.app=t,this.build(e)},build:function(t){this.parse(t)},getData:function(){var e={};return this.find("[name]").each(function(t){t=f.dom(t);e[t.attr("name")]=t.val()}),e},setData:function(n){this.find("[name]").each(function(t){var e=f.dom(t),i=e.attr("name");n.hasOwnProperty(i)&&(t.type&&"checkbox"===t.type?t.checked=n[i]:e.val(n[i]))})},getField:function(t){return this.find("[name="+t+"]")},setError:function(t){t=this.getField(t);return t.addClass("error"),t.one(this._getFieldEventName(t.get()),this._clearError),!1},_clearError:function(){return f.dom(this).removeClass("error")},_getFieldEventName:function(t){return"SELECT"===t.tagName||"checkbox"===t.type||"radio"===t.type?"change":"keyup"}}),f.add("module","block",{init:function(t){this.app=t,this.block=t.block},format:function(t){t=this.block.format(t);this.app.broadcast("format","block",t)},clearformat:function(){this.block.clearFormat()},clearstyle:function(){this.block.clearStyle()},clearclass:function(){this.block.clearClass()},clearattr:function(){this.block.clearAttr()},add:function(t,e){this.block.add(t,e)},toggle:function(t,e){this.block.toggle(t,e)},set:function(t,e){this.block.set(t,e)},remove:function(t,e){this.block.remove(t,e)}}),f.add("module","inline",{init:function(t){this.app=t,this.inline=t.inline},format:function(t){t=this.inline.format(t);this.app.broadcast("format","inline",t)},clearformat:function(){this.inline.clearFormat()},clearstyle:function(){this.inline.clearStyle()},clearclass:function(){this.inline.clearClass()},clearattr:function(){this.inline.clearAttr()},add:function(t,e){this.inline.add(t,e)},toggle:function(t,e){this.inline.toggle(t,e)},set:function(t,e){this.inline.set(t,e)},remove:function(t,e){this.inline.remove(t,e)}}),f.add("module","autosave",{init:function(t){this.app=t,this.opts=t.opts,this.utils=t.utils,this.source=t.source},onsynced:function(){this.opts.autosave&&this._send()},_send:function(){var e=this.opts.autosaveName||this.source.getName(),i={};i[e]=this.source.getCode(),i=this.utils.extendData(i,this.opts.autosaveData),f.ajax.request(this.opts.autosaveMethod,{url:this.opts.autosave,data:i,success:function(t){this._complete(t,e,i)}.bind(this)})},_complete:function(t,e,i){var n=t&&t.error?"autosaveError":"autosave";this.app.broadcast(n,e,i,t)}}),f.add("module","input",{init:function(t){this.app=t,this.opts=t.opts,this.utils=t.utils,this.editor=t.editor,this.keycodes=t.keycodes,this.element=t.element,this.selection=t.selection,this.insertion=t.insertion,this.inspector=t.inspector,this.autoparser=t.autoparser,this.lastShiftKey=!1},onpaste:function(t,e){if(this.opts.input)return f.create("input.paste",this.app,t,e)},onkeydown:function(t){if(this.opts.input){var e=t.which;if(!f.create("input.shortcut",this.app,t).is()){if((t.ctrlKey||t.metaKey)&&!t.altKey&&65===e)return t.preventDefault(),this._selectAll();var i=[this.keycodes.ENTER,this.keycodes.SPACE,this.keycodes.BACKSPACE,this.keycodes.DELETE],n=[this.keycodes.UP,this.keycodes.DOWN,this.keycodes.LEFT,this.keycodes.RIGHT],r=-1!==i.indexOf(e),s=-1!==n.indexOf(e),i=(t.ctrlKey||t.metaKey)&&88===e,n=!t.ctrlKey&&!t.metaKey&&(48<=e&&e<=57||65<=e&&e<=90);if(this.selection.isAll()&&s&&(i||!t.ctrlKey&&!t.metaKey&&!t.altKey&&!t.shiftKey)){if(i)return this.editor.disableNonEditables(),void this.app.broadcast("empty");if(this._isArrowKey(e))return!0;if(r&&t.preventDefault(),this.element.isType("inline")?(this.editor.getElement().html(""),this.editor.startFocus()):this.insertion.set(this.opts.emptyHtml),r)return;this.app.broadcast("empty")}if(this.opts.autoparse&&this.autoparser.format(t,e),!n||!this.selection.hasNonEditable())return e===this.keycodes.ENTER?f.create("input.enter",this.app,t,e):t.metaKey&&219===e?(t.preventDefault(),void this.app.api("module.list.outdent")):e===this.keycodes.TAB||t.metaKey&&221===e?f.create("input.tab",this.app,t,e):e===this.keycodes.SPACE?f.create("input.space",this.app,t,e,this.lastShiftKey):this._isDeleteKey(e)?f.create("input.delete",this.app,t,e):this._isArrowKey(e)?f.create("input.arrow",this.app,t,e):void 0;t.preventDefault()}}},onkeyup:function(t){if(this.opts.input){var e=t.which;if(this.lastShiftKey=t.shiftKey,this.app.broadcast("contextbar.close"),!f.create("input.shortcode",this.app,t,e).is()){if(e===this.keycodes.BACKSPACE){e=this.editor.getElement(),e=this.utils.trimSpaces(e.html());if(""===(e=(e=e.replace(/<br\s?\/?>/g,"")).replace(/<div><\/div>/,"")))return t.preventDefault(),this.editor.setEmpty(),void this.editor.startFocus()}this.editor.isEmpty()&&this.app.broadcast("empty")}}},start:function(){this.opts.shortcutsAdd&&(this.opts.shortcuts=f.extend({},!0,this.opts.shortcuts,this.opts.shortcutsAdd))},_selectAll:function(){var t,e=this.selection.getCurrent(),e=this.inspector.parse(e);return e.isComponentType("table")?(t=e.getTable(),void this.selection.setAll(t)):e.isComponentType("code")?(t=e.getComponentCodeElement(),void this.selection.setAll(t)):void this.selection.setAll()},_isArrowKey:function(t){return-1!==[this.keycodes.UP,this.keycodes.DOWN,this.keycodes.RIGHT,this.keycodes.LEFT].indexOf(t)},_isDeleteKey:function(t){return t===this.keycodes.BACKSPACE||t===this.keycodes.DELETE}}),f.add("class","input.arrow",{init:function(t,e,i){this.app=t,this.opts=t.opts,this.utils=t.utils,this.caret=t.caret,this.offset=t.offset,this.marker=t.marker,this.editor=t.editor,this.keycodes=t.keycodes,this.component=t.component,this.inspector=t.inspector,this.selection=t.selection,this.key=i,this._init(e)},_init:function(t){if(!this._isRightLeftKey()||!this._isExitVariable(t)){if(this._isRightDownKey()){if(this._isExitOnDownRight(t))return;if(this._selectComponent(t,"End","next"))return}if(this._isLeftUpKey()){if(this._isExitOnUpLeft(t))return;if(this._selectComponent(t,"Start","prev"))return}this.key===this.keycodes.LEFT?this.utils.trimInvisibleChars("left"):this.key===this.keycodes.RIGHT&&this.utils.trimInvisibleChars("right")}},_isRightDownKey:function(){return-1!==[this.keycodes.DOWN,this.keycodes.RIGHT].indexOf(this.key)},_isLeftUpKey:function(){return-1!==[this.keycodes.UP,this.keycodes.LEFT].indexOf(this.key)},_isRightLeftKey:function(){return-1!==[this.keycodes.RIGHT,this.keycodes.LEFT].indexOf(this.key)},_isExitVariable:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e),e=i.getComponent();i.isComponentType("variable")&&i.isComponentActive()&&(t.preventDefault(),t=this.key===this.keycodes.LEFT?"setBefore":"setAfter",this.caret[t](e))},_isExitOnUpLeft:function(t){var e=this.selection.getCurrent(),i=this.selection.getBlock(e),n=this.inspector.parse(e),r=i.previousElementSibling,e=this.caret.isStart(i);if(e&&r&&"TABLE"===r.tagName)return t.preventDefault(),this.caret.setEnd(r),!0;if(n.isFigcaption()){i=n.getFigcaption(),e=this.caret.isStart(i);r=f.dom(i).closest(".redactor-component");if(e&&0!==r.length)return t.preventDefault(),this.caret.setEnd(r),!0}else{if(n.isTable()&&e)return t.preventDefault(),this.caret.setEnd(i.previousElementSibling),!0;if(!n.isComponentEditable()&&n.isComponent()&&!n.isComponentType("variable")){i=n.getComponent();return i.previousElementSibling?i.previousElementSibling?(t.preventDefault(),this.component.clearActive(),this.caret.setEnd(i.previousElementSibling),!0):void 0:(t.preventDefault(),this.component.clearActive(),this._exitPrevElement(t,n.getComponent()))}}},_isExitOnDownRight:function(t){var e,i=this.editor.getElement(),n=this.selection.getCurrent(),r=this.inspector.parse(n),s=this.caret.isEnd();if(r.isTable()){if(e=r.getTable(),(l=this.caret.isEnd(e))||s)return this._exitNextElement(t,r.getComponent())}else if(r.isFigcaption()){if(e=r.getFigcaption(),(l=this.caret.isEnd(e))||s)return this._exitNextElement(t,r.getComponent())}else if(r.isComponentType("code")){var o=r.getComponent(),a=f.dom(r.getComponentCodeElement()).closest("pre"),l=this.caret.isEnd(e),a=a&&a.get().nextElementSibling;if(l&&!a)return this._exitNextElement(t,o)}else if(r.isPre()||r.isBlockquote()||r.isDl()){if(s)return r.isPre()?this._exitNextElement(t,r.getPre()):r.isBlockquote()?this._exitNextElement(t,r.getBlockquote()):r.isDl()?this._exitNextElement(t,r.getDl()):void 0}else if(r.isList()){i=f.dom(n).parents("ul, ol",i).last();if((l=this.caret.isEnd(i))||s)return this._exitNextElement(t,i.get())}else if(r.isComponent()&&!r.isComponentType("variable")&&"span"!==r.getTag())return this.component.clearActive(),this._exitNextElement(t,r.getComponent())},_exitPrevElement:function(t,e){return t.preventDefault(),e.previousElementSibling?this.caret.setEnd(e.previousElementSibling):this.utils.createMarkupBefore(e),!0},_exitNextElement:function(t,e){return t.preventDefault(),e.nextElementSibling?this.caret.setStart(e.nextElementSibling):this.utils.createMarkup(e),!0},_selectComponent:function(t,e,i){var n=this.selection.getCurrent(),r=this.selection.getBlock(n),s=this.utils.findSiblings(n,i),i=this.utils.findSiblings(r,i);s&&this.caret["is"+e](n)?this._selectComponentItem(t,s,e):i&&this.caret["is"+e](r)&&this._selectComponentItem(t,i,e)},_selectComponentItem:function(t,e,i){if(this.component.isNonEditable(e))return t.preventDefault(),this.caret["set"+i](e),!0}}),f.add("class","input.delete",{init:function(t,e,i){this.app=t,this.opts=t.opts,this.caret=t.caret,this.utils=t.utils,this.editor=t.editor,this.marker=t.marker,this.keycodes=t.keycodes,this.component=t.component,this.inspector=t.inspector,this.selection=t.selection,this.insertion=t.insertion,this.key=i,this._init(e)},_init:function(t){if(!this._removeActiveComponent(t)&&!this._removeAllSelectedTable(t)){if(this.key===this.keycodes.BACKSPACE){var e=this.editor.getElement();if(this.utils.trimSpaces(e.html())===this.opts.emptyHtml)return void t.preventDefault()}if(this._detectVariableOrNonEditable()||this.selection.hasNonEditable())t.preventDefault();else{if(this.selection.isAll())return t.preventDefault(),void this.insertion.set(this.opts.emptyHtml);this.selection.isCollapsed()&&(this.key===this.keycodes.BACKSPACE?this._traverseBackspace(t):this.key===this.keycodes.DELETE&&this._traverseDelete(t)),this.key===this.keycodes.BACKSPACE&&this.utils.trimInvisibleChars("left"),this._removeUnwantedStyles(),this._removeEmptySpans(),this._removeSpanTagsInHeadings(),this._removeInlineTagsInPre()}}},_detectVariableOrNonEditable:function(){var t,e=this.selection.getBlock(),i=this.caret.isStart(e),n=this.caret.isEnd(e);if(this.key===this.keycodes.BACKSPACE&&i){if(t=e.previousSibling,this._isNonEditable(t))return!0}else if(this.key===this.keycodes.DELETE&&n&&(t=e.nextSibling,this._isNonEditable(t)))return!0;var r=this.selection.getCurrent(),s=this.caret.isStart(r),i=this.caret.isEnd(r),n=""===this.selection.getTextBeforeCaret().trim(),e=""===this.selection.getTextAfterCaret().trim();return this.key===this.keycodes.BACKSPACE&&s&&!n?(t=r.previousSibling,this._isVariable(t)?(this.caret.setEnd(t),!0):!!this._isNonEditable(t)||void 0):this.key===this.keycodes.DELETE&&i&&!e?(t=r.nextSibling,this._isVariable(t)?(this.caret.setStart(t),!0):!!this._isNonEditable(t)||void 0):void 0},_isVariable:function(t){return 0!==f.dom(t).closest('[data-redactor-type="variable"]').length},_isNonEditable:function(t){return 0!==f.dom(t).closest(".non-editable").length},_getBlock:function(){var t=this.editor.getElement(),e=this.selection.getBlock(),i=this.inspector.parse(e),e=i.isList()?f.dom(e).parents("ul, ol",t).last().get():e;return e=i.isDl()?i.getDl():e,e=i.isTable()?i.getTable():e},_traverseDelete:function(t){var e,i=this.selection.getCurrent(),n=this.inspector.parse(i);if(n.isFigcaption()){if(l=n.getFigcaption(),e=this.caret.isEnd(l))return void t.preventDefault()}else if(n.isComponentType("code")&&(l=n.getComponent(),e=this.caret.isEnd(l)))return void t.preventDefault();l=this._getBlock();var r,s,o,a,l,c=this.utils.findSiblings(l,"next");c&&(e=this.caret.isEnd(l),o=this.inspector.parse(c),r="P"===c.tagName||"DIV"===c.tagName,e&&o.isComponentType("table")?(t.preventDefault(),this.caret.setStart(c)):e&&o.isComponentEditable()?(t.preventDefault(),this.component.remove(c,!1)):e&&o.isComponent()?(t.preventDefault(),this.caret.setStart(c),this.utils.isEmptyHtml(l.innerHTML)&&f.dom(l).remove()):e&&o.isList()?(s=f.dom(l),a=f.dom(c),n.isList()?(t.preventDefault(),s.append(a),a.unwrap()):0!==(o=(i=a.children("li").first()).find("ul, ol")).length&&(t.preventDefault(),a.prepend(o),o.unwrap(),s.append(i),i.unwrap())):!e||n.isList()||n.isTable()||!r||this.utils.isEmptyHtml(l.innerHTML)||(t.preventDefault(),l=f.dom(l),a=f.dom(c),l.append(a),a.unwrap()))},_traverseBackspace:function(t){var e,i=this.selection.getCurrent(),n=this.inspector.parse(i);if(n.isFigcaption()){if(o=n.getFigcaption(),e=this.caret.isStart(o))return void t.preventDefault()}else if(n.isComponentType("code")&&(o=n.getComponent(),(e=this.caret.isStart(o))&&o.previousElementSibling))return t.preventDefault(),this.caret.setEnd(o.previousElementSibling),!0;o=this._getBlock();var r,s,o,a,l=this.utils.findSiblings(o,"prev");l?(e=this.caret.isStart(o),s=this.inspector.parse(l),r="P"===l.tagName||"DIV"===l.tagName,e&&s.isComponentType("code")?(t.preventDefault(),this.component.remove(l,!1)):e&&s.isComponentType("table")?(t.preventDefault(),this.caret.setEnd(l)):e&&s.isComponent()?(t.preventDefault(),this.caret.setStart(l),this.utils.isEmptyHtml(o.innerHTML)&&f.dom(o).remove()):e&&n.isList()?(t.preventDefault(),i=f.dom(o),a=f.dom(l),s.isList()?(i.children("li").first().prepend(this.marker.build("start")),a.append(i),i.unwrap(),this.selection.restoreMarkers()):(s=(n=i.children("li").first()).get(),n=n.find("ul, ol"),s=this.utils.replaceToTag(s,this.opts.markup),this.opts.breakline&&s.attr("data-redactor-tag","br"),i.before(s),this.caret.setStart(s),0!==n.length&&(i.prepend(n),n.unwrap()))):e&&r&&(t.preventDefault(),this.utils.isEmpty(l)?(a=f.dom(l)).remove():(t=this.utils.createInvisibleChar(),o=f.dom(o),a=f.dom(l),this.caret.setEnd(a),o.prepend(t),a.append(o.contents()),o.remove()))):setTimeout(this._replaceBlock.bind(this),1)},_replaceBlock:function(){var t,e=this.selection.getBlock(),i=f.dom(e);"p"===this.opts.markup&&e&&this._isNeedToReplaceBlock(e)&&(t=document.createElement(this.opts.markup),i.replaceWith(t),this.caret.setStart(t)),this.opts.breakline&&e&&"DIV"===e.tagName&&i.attr("data-redactor-tag","br")},_isNeedToReplaceBlock:function(t){return"DIV"===t.tagName&&this.utils.isEmptyHtml(t.innerHTML)},_removeActiveComponent:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e),e=i.getComponent();if(i.isComponent()&&this.component.isActive(e))return t.preventDefault(),this.component.remove(e),!0},_removeAllSelectedTable:function(t){var e=this.selection.getCurrent(),e=this.inspector.parse(e).getTable();if(e&&this.selection.isAll(e))return t.preventDefault(),this.component.remove(e),!0},_removeUnwantedStyles:function(){var t=this.editor.getElement();setTimeout(function(){t.find("*[style]").not("img, figure, figcaption, iframe, [data-redactor-style-cache], [data-redactor-span]").removeAttr("style")},0)},_removeEmptySpans:function(){var t=this.editor.getElement();setTimeout(function(){t.find("span").each(function(t){0===t.attributes.length&&f.dom(t).replaceWith(t.childNodes)})},0)},_removeSpanTagsInHeadings:function(){var t=this.editor.getElement();setTimeout(function(){t.find("h1, h2, h3, h4, h5, h6").each(function(t){t=f.dom(t);0===t.closest("figure").length&&t.find("span").not(".redactor-component, .non-editable, .redactor-selection-marker, [data-redactor-style-cache], [data-redactor-span]").unwrap()})},1)},_removeInlineTagsInPre:function(){var t=this.editor.getElement(),e=this.opts.inlineTags;setTimeout(function(){t.find("pre").each(function(t){t=f.dom(t);0===t.closest("figure").length&&t.find(e.join(",")).not("code, .redactor-selection-marker").unwrap()})},1)}}),f.add("class","input.enter",{init:function(t,e){this.app=t,this.opts=t.opts,this.utils=t.utils,this.caret=t.caret,this.editor=t.editor,this.keycodes=t.keycodes,this.detector=t.detector,this.insertion=t.insertion,this.selection=t.selection,this.inspector=t.inspector,this._init(e)},_init:function(t){return this.opts.enterKey?!1===this.app.broadcast("enter",t)?t.preventDefault():this.selection.hasNonEditable()?void t.preventDefault():t.ctrlKey||t.shiftKey?this._insertBreak(t):void(this._isExit(t)||this._traverse(t)):this._disable(t)},_disable:function(t){t.preventDefault();t=this.selection.getRange();t&&!t.collapsed&&t.deleteContents()},_insertBreak:function(t){t.preventDefault();var e=this.selection.getCurrent(),i=this.selection.getBlock(),t=this.inspector.parse(e);t.isHeading()&&this.caret.isStart(i)?(i=(e=f.dom(i)).clone().html(""),e.before(i),this.caret.setStart(e)):t.isComponent()&&!t.isComponentEditable()||t.isCode()||(t.isPre()?this.insertion.insertNewline():this.insertion.insertBreakLine())},_isExit:function(t){var e=this.editor.getElement(),i=this.selection.getBlock(),n=this.inspector.parse(i),r=this.caret.isEnd(i),s=this.selection.getCurrent(),o=s.previousSibling;if(n.isBlockquote()){var a=r&&this._isExitableBlock(i,"P"),l=r&&this._isExitableDblBreak(o);if(a||l)return this._exitFromElement(t,l?o:i,n.getBlockquote())}else if(!n.isComponentType("code")&&n.isPre()){if(r){l=i.innerHTML;if(null!==(l=this.utils.removeInvisibleChars(l)).match(/(\n\n\n)$/))return f.dom(o.previousSibling.previousSibling).remove(),this._exitFromElement(t,o,i)}}else if(n.isDl()){if(r&&this._isExitableBlock(i,"DT"))return this._exitFromElement(t,i,n.getDl())}else if(n.isList()){e=f.dom(s).parents("ul, ol",e).last();if((r=this.caret.isEnd(e))&&this._isExitableBlock(i,"LI"))return this._exitFromElement(t,i,e)}else if(n.isComponent()&&n.isComponentActive()&&!n.isFigcaption()&&!n.isComponentEditable())return this._exitFromElement(t,!1,n.getComponent())},_isExitableDblBreak:function(t){var e=!!t&&t.nextSibling;if(e){t=this.utils.removeInvisibleChars(e.textContent);return 3===e.nodeType&&""===t.trim()}},_isExitableBlock:function(t,e){return t&&t.tagName===e&&this.utils.isEmptyHtml(t.innerHTML)},_exitFromElement:function(t,e,i){return t.preventDefault(),e&&f.dom(e).remove(),this.utils.createMarkup(i),!0},_exitNextElement:function(t,e){return t.preventDefault(),e.nextSibling?this.caret.setStart(e.nextSibling):this.utils.createMarkup(e),!0},_traverse:function(t){var e=this.selection.getCurrent(),i=this.selection.isText(),n=this.selection.getBlock(),r=this.inspector.parse(e),s=!!n&&n.tagName.toLowerCase(),o=f.dom(e).closest("[data-redactor-type=variable]");if(0!==o.length&&this.caret.setAfter(o),r.isPre())return t.preventDefault(),this.insertion.insertNewline();if(r.isBlockquote()){if((n=this.selection.getBlock(e))&&"BLOCKQUOTE"===n.tagName)return t.preventDefault(),this.insertion.insertBreakLine()}else if(r.isFigcaption()){n=r.getFigcaption();o=this.caret.isEnd(n),n=this.caret.isEnd();if(o||n)return this._exitNextElement(t,r.getComponent());t.preventDefault()}else{if(r.isDl())return t.preventDefault(),this._traverseDl(e);if(this.opts.breakline&&"div"===s)setTimeout(this._replaceBlock.bind(this),1);else{if(i)return t.preventDefault(),this.insertion.insertBreakLine();r.isList()||(r=this.detector.isDesktop()?50:1,setTimeout(this._replaceBlock.bind(this),r))}}},_traverseDl:function(t){var e=this.selection.getBlock(t),i=this.inspector.parse(e).getTag(),n=f.dom(e),r=n.get().nextSibling||!1,s=f.dom(r),t=r&&s.is("dd"),s=r&&s.is("dt"),e=this.caret.isEnd(e);if("dt"===i&&!t&&e){t=document.createElement("dd");return n.after(t),void this.caret.setStart(t)}if("dd"!==i||s||!e)return this.insertion.insertBreakLine();e=document.createElement("dt");return n.after(e),void this.caret.setStart(e)},_replaceBlock:function(){var t,e=this.selection.getBlock(),i=f.dom(e);"p"===this.opts.markup&&e&&this._isNeedToReplaceBlock(e)?(t=document.createElement(this.opts.markup),i.replaceWith(t),this.caret.setStart(t)):e&&(this.utils.isEmptyHtml(e.innerHTML)?this._clearBlock(i,e):(t=this.utils.getFirstNode(e))&&"BR"===t.tagName&&(f.dom(t).remove(),this.caret.setStart(e))),i.removeAttr("id"),e&&this._isNeedToCleanBlockStyle(e)&&this.opts.cleanOnEnter&&i.removeAttr("class style"),this.opts.breakline&&e&&e.tagName},_clearBlock:function(t,e){"DIV"===e.tagName&&t.find("br").remove(),!this.opts.cleanInlineOnEnter&&"<br>"!==e.innerHTML||t.html(""),this.caret.setStart(e)},_isNeedToReplaceBlock:function(t){return"DIV"===t.tagName&&this.utils.isEmptyHtml(t.innerHTML)},_isNeedToCleanBlockStyle:function(t){return"P"===t.tagName&&this.utils.isEmptyHtml(t.innerHTML)}}),f.add("class","input.paste",{init:function(t,e,i,n,r){this.app=t,this.opts=t.opts,this.editor=t.editor,this.cleaner=t.cleaner,this.container=t.container,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection,this.autoparser=t.autoparser,this.pasteHtml=n,this.pointInserted=r,this.dataTransfer=i,this._init(e)},_init:function(t){var e=this.dataTransfer||t.clipboardData,i=this.selection.getCurrent(),i=this.inspector.parse(i);if(this.dropPasted=this.dataTransfer,this.isRawCode=i.isPre()||i.isCode(),this.editor.enablePasting(),this.editor.saveScroll(),this.dropPasted||this.selection.saveMarkers(),this.isRawCode||!e){var n=this.isRawCode||e||!window.clipboardData?e.getData("text/plain"):window.clipboardData.getData("text");t.preventDefault(),this._insert(t,n)}else if(this.pasteHtml)t.preventDefault(),this._insert(t,this.pasteHtml);else{i=e.getData("URL"),n=this._isPlainText(e)?this.cleaner.encodeEntities(e.getData("text/plain")):e.getData("text/html"),n=i&&""!==i?i:n;if(null!==e.files&&0<e.files.length&&""===n){for(var r=[],s=0;s<e.files.length;s++){var o=e.files[s]||e.items[s].getAsFile();o&&r.push(o)}if(0<r.length)return t.preventDefault(),void this._insertFiles(t,r)}t.preventDefault(),this._insert(t,n)}},_isPlainText:function(t){var e=t.getData("text/plain"),i=t.getData("text/html");if(!e||!i)return null!==e;t=document.createElement("div");return t.innerHTML=i,t.textContent===e?!t.querySelector(":not(meta)"):void 0},_restoreSelection:function(){this.editor.restoreScroll(),this.editor.disablePasting(),this.dropPasted||this.selection.restoreMarkers()},_insert:function(t,e){var i,n=this.app.broadcast("pasteBefore",e);e=(e=void 0===n?e:n).trim(),e=(e=this.isRawCode?e:this.cleaner.paste(e)).trim(),e=this.isRawCode?this.cleaner.encodePhpCode(e):e,e=void 0===(n=this.app.broadcast("pasting",e))?e:n,this._restoreSelection(),this.opts.input&&(this.app.broadcast("state",!1),i=[],this.isRawCode?(e=e.replace("&lt;?php","<?php"),n=document.createTextNode(e),i=this.insertion.insertNode(n,"after"),this.app.broadcast("pasted",i)):(this.opts.autoparse&&this.opts.autoparsePaste&&(e=this.autoparser.parse(e)),i=this.dropPasted?this.insertion.insertToPoint(t,e,this.pointInserted):this.insertion.insertHtml(e),this.app.broadcast("pasted",i),this.app.broadcast("autoparseobserve")))},_insertFiles:function(t,e){this._restoreSelection();var i=-1!==this.opts.imageTypes.indexOf(e[0].type),n=void 0===this.dropPasted;i?this.app.broadcast("dropimage",t,e,n):this.app.broadcast("dropfile",t,e,n)}}),f.add("class","input.shortcode",{init:function(t,e,i){this.app=t,this.opts=t.opts,this.utils=t.utils,this.marker=t.marker,this.keycodes=t.keycodes,this.selection=t.selection,this.worked=!1,i===this.keycodes.SPACE&&this._init()},is:function(){return this.worked},_init:function(){var t=this.selection.getCurrent();if(t&&3===t.nodeType){var e,i=this.utils.removeInvisibleChars(t.textContent),n=this.opts.shortcodes;for(e in n){var r=new RegExp("^"+this.utils.escapeRegExp(e)),s=i.match(r);if(null!==s&&void 0!==n[e].format)return this._format(n[e].format,t,r)}}},_format:function(t,e,i){var n=(e=this.marker.insert("start").previousSibling).textContent;n=(n=this.utils.trimSpaces(n)).replace(i,""),e.textContent=n;n="ul"===t||"ol"===t?"module.list.toggle":"module.block.format";this.app.api(n,t),this.selection.restoreMarkers(),this.worked=!0}}),f.add("class","input.shortcut",{init:function(t,e){this.app=t,this.opts=t.opts,this.worked=!1,this.hotkeys={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},this.hotkeysShiftNums={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"},this._init(e)},is:function(){return this.worked},_init:function(t){if(!1!==this.opts.shortcuts)for(var e in this.opts.shortcuts)this._build(t,e,this.opts.shortcuts[e]);else!t.ctrlKey&&!t.metaKey||66!==t.which&&73!==t.which||t.preventDefault()},_build:function(t,e,i){for(var n=e.split(","),r=n.length,s=0;s<r;s++)"string"==typeof n[s]&&this._handler(t,n[s].trim(),i)},_handler:function(t,e,i){e=e.toLowerCase().split(" ");for(var n=this.hotkeys[t.keyCode],r=String.fromCharCode(t.which).toLowerCase(),s="",o={},a=["meta","ctrl","alt","shift"],l=0;l<a.length;l++){var c=a[l];t[c+"Key"]&&n!==c&&(s+=c+"+")}n&&(o[s+n]=!0),r&&(o[s+r]=!0,o[s+this.hotkeysShiftNums[r]]=!0,"shift+"===s&&(o[this.hotkeysShiftNums[r]]=!0));for(var h=e.length,l=0;l<h;l++)if(o[e[l]])return t.preventDefault(),this.worked=!0,void(i.message?(this.app.broadcast(i.message,i.args),this.app.broadcast("buffer.trigger")):i.api&&(this.app.api(i.api,i.args),this.app.broadcast("buffer.trigger")))}}),f.add("class","input.space",{init:function(t,e,i,n){this.app=t,this.keycodes=t.keycodes,this.insertion=t.insertion,this.selection=t.selection,this.key=i,this.lastShiftKey=n,this._init(e)},_init:function(t){this.selection.hasNonEditable()?t.preventDefault():this.lastShiftKey||this.key!==this.keycodes.SPACE||!t.ctrlKey&&!t.shiftKey||t.metaKey||(t.preventDefault(),this.insertion.insertChar("&nbsp;"))}}),f.add("class","input.tab",{init:function(t,e){this.app=t,this.opts=t.opts,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection,this._init(e)},_init:function(t){if(this.opts.tabKey){if(!1===this.app.broadcast("tab",t))return t.preventDefault();this._traverse(t)}},_traverse:function(t){var e=this.selection.getCurrent(),e=this.inspector.parse(e);return!e.isComponent()&&t.shiftKey?this._insertHardTab(t,4):e.isList()?(t.preventDefault(),this.app.api("module.list.indent")):e.isPre()||e.isComponentType("code")&&!e.isFigcaption()?this._tabCode(t):!1!==this.opts.tabAsSpaces?this._insertHardTab(t,this.opts.tabAsSpaces):void 0},_insertHardTab:function(t,e){t.preventDefault();e=document.createTextNode(Array(e+1).join(" "));return this.insertion.insertNode(e,"end")},_tabCode:function(t){t.preventDefault();t=this.opts.preSpaces?document.createTextNode(Array(this.opts.preSpaces+1).join(" ")):document.createTextNode("\t");return this.insertion.insertNode(t,"end")}}),f.add("module","upload",{init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.utils=t.utils,this.editor=t.editor,this.progress=t.progress,this.defaults={event:!1,element:!1,name:!1,files:!1,url:!1,data:!1,paramName:!1}},build:function(t){this.p=f.extend(this.defaults,t),this.$el=f.dom(this.p.element),"INPUT"===this.$el.get().tagName?this._buildInput():this._buildBox()},send:function(t){this.p=f.extend(this.defaults,t),this.$uploadbox=this.editor.getElement(),this._send(this.p.event,this.p.files)},complete:function(t,e){this._complete(t,e)},_buildInput:function(){this.box=!1,this.prefix="",this.$uploadbox=f.dom('<div class="upload-redactor-box" />'),this.$el.hide(),this.$el.after(this.$uploadbox),this.opts.multipleUpload?this.$el.attr("multiple","multiple"):this.$el.removeAttr("multiple"),"file"!==this.p.name&&this.$el.attr("accept","image/*"),this._buildPlaceholder(),this._buildEvents()},_buildBox:function(){this.box=!0,this.prefix="box-",this.$uploadbox=this.$el,this.$uploadbox.attr("ondragstart","return false;"),this.$uploadbox.on("drop.redactor.upload",this._onDropBox.bind(this)),this.$uploadbox.on("dragover.redactor.upload",this._onDragOver.bind(this)),this.$uploadbox.on("dragleave.redactor.upload",this._onDragLeave.bind(this))},_buildPlaceholder:function(){this.$placeholder=f.dom('<div class="upload-redactor-placeholder" />'),this.$placeholder.html(this.lang.get("upload-label")),this.$uploadbox.append(this.$placeholder)},_buildEvents:function(){this.$el.on("change.redactor.upload",this._onChange.bind(this)),this.$uploadbox.on("click.redactor.upload",this._onClick.bind(this)),this.$uploadbox.on("drop.redactor.upload",this._onDrop.bind(this)),this.$uploadbox.on("dragover.redactor.upload",this._onDragOver.bind(this)),this.$uploadbox.on("dragleave.redactor.upload",this._onDragLeave.bind(this))},_onClick:function(t){t.preventDefault(),this.$el.click()},_onChange:function(t){this._send(t,this.$el.get().files)},_onDrop:function(t){t.preventDefault(),this._clear(),this._setStatusDrop(),this._send(t)},_onDragOver:function(t){return t.preventDefault(),this._setStatusHover(),!1},_onDragLeave:function(t){return t.preventDefault(),this._removeStatusHover(),!1},_onDropBox:function(t){t.preventDefault(),this._clear(),this._setStatusDrop(),this._send(t)},_removeStatusHover:function(){this.$uploadbox.removeClass("upload-redactor-"+this.prefix+"hover")},_setStatusDrop:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"drop")},_setStatusHover:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"hover")},_setStatusError:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"error")},_setStatusSuccess:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"success")},_clear:function(){for(var t=["drop","hover","error","success"],e=0;e<t.length;e++)this.$uploadbox.removeClass("upload-redactor-"+this.prefix+t[e]);this.$uploadbox.removeAttr("ondragstart")},_send:function(t,e){t=t.originalEvent||t,e=e||t.dataTransfer.files;var i=new FormData,n=this._getUploadParam(),i=this._buildData(n,e,i);i=this.utils.extendData(i,this.p.data),!1!==this.app.broadcast("upload.start",t,i,e)&&this._sendData(i,e,t)},_sendData:function(t,e,n){this.progress.show(),"function"==typeof this.p.url?(e=this.p.url(t,e,n,this))instanceof Promise||this._complete(e,n):f.ajax.post({url:this.p.url,data:t,before:function(t){return this.app.broadcast("upload.beforeSend",t)}.bind(this),success:function(t){this._complete(t,n)}.bind(this),error:function(t,e,i){this._complete(t,n,i)}.bind(this)})},_getUploadParam:function(){return this.p.paramName||"file"},_buildData:function(t,e,i){if(1===e.length)i.append(t+"[]",e[0]);else if(1<e.length&&!1!==this.opts.multipleUpload)for(var n=0;n<e.length;n++)i.append(t+"[]",e[n]);return i},_complete:function(t,e,i){this._clear(),this.progress.hide(),t&&t.error?(this._setStatusError(),this.app.broadcast("upload."+this.p.name+".error",t,e,i),this.app.broadcast("upload.error",t,i)):(this._setStatusSuccess(),this.app.broadcast("upload."+this.p.name+".complete",t,e),this.app.broadcast("upload.complete",t),setTimeout(this._clear.bind(this),500))}}),f.add("class","code.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},_init:function(t){var e;void 0!==t?(0!==(e=f.dom(t).closest("figure")).length?this.parse(e):(this.parse("<figure>"),this.append(t)),e=this.find("pre code, pre").last()):(e=f.dom("<pre>"),this.parse("<figure>"),this.append(e)),this._initElement(e),this._initWrapper()},_initElement:function(t){t.attr({tabindex:"-1",contenteditable:!0})},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"code",tabindex:"-1",contenteditable:!1})}}),f.add("module","form",{init:function(t){this.app=t,this.lang=t.lang,this.component=t.component,this.inspector=t.inspector},onform:{remove:function(t){this._remove(t)}},oncontextbar:function(t,e){var i,n=this.inspector.parse(t.target);n.isComponentType("form")&&(i=n.getComponent(),n={remove:{title:this.lang.get("delete"),api:"module.form.remove",args:i}},e.set(t,i,n,"top"))},_remove:function(t){this.component.remove(t)}}),f.add("class","form.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,this.utils=t.utils,e&&void 0!==e.cmnt?e:this._init(e)},_init:function(t){var e;void 0!==t?0!==f.dom(t).closest("form").length?(e=this.utils.replaceToTag(t,"figure"),this.parse(e)):(this.parse("<figure>"),this.append(t)):this.parse("<figure>"),this._initWrapper()},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"form",tabindex:"-1",contenteditable:!1})}}),f.add("module","image",{modals:{image:'<div class="redactor-modal-tab redactor-modal-tab-upload" data-title="## upload ##"><form action="">                 <input type="file" name="file">             </form></div>',imageedit:'<div class="redactor-modal-group">                 <div id="redactor-modal-image-preview" class="redactor-modal-side"></div>                 <form action="" class="redactor-modal-area">                     <div class="form-item">                         <label for="modal-image-title"> ## title ##</label>                         <input type="text" id="modal-image-title" name="title" />                     </div>                     <div class="form-item form-item-caption">                         <label for="modal-image-caption">## caption ##</label>                         <input type="text" id="modal-image-caption" name="caption" aria-label="## caption ##" />                     </div>                     <div class="form-item form-item-align">                         <label>## image-position ##</label>                         <select name="align" aria-label="## image-position ##">                             <option value="none">## none ##</option>                             <option value="left">## left ##</option>                             <option value="center">## center ##</option>                             <option value="right">## right ##</option>                         </select>                     </div>                     <div class="form-item form-item-link">                         <label for="modal-image-url">## link ##</label>                         <input type="text" id="modal-image-url" name="url" aria-label="## link ##" />                     </div>                     <div class="form-item form-item-link">                         <label class="checkbox"><input type="checkbox" name="target" aria-label="## link-in-new-tab ##"> ## link-in-new-tab ##</label>                     </div>                 </form>             </div>'},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.caret=t.caret,this.utils=t.utils,this.editor=t.editor,this.storage=t.storage,this.component=t.component,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection,this.justResized=!1},oninsert:function(){this._observeImages()},onstarted:function(){this.storage.observeImages(),this.opts.imageResizable&&(this.resizer=f.create("image.resize",this.app)),this._observeImages()},ondropimage:function(t,e,i){this.opts.imageUpload&&(e={url:this.opts.imageUpload,event:!i&&t,files:e,name:"imagedrop",data:this.opts.imageData,paramName:this.opts.imageUploadParam},this.app.api("module.upload.send",e))},onstop:function(){this.resizer&&this.resizer.stop()},onbottomclick:function(){this.insertion.insertToEnd(this.editor.getLastNode(),"image")},onimageresizer:{stop:function(){this.resizer&&this.resizer.hide()}},onsource:{open:function(){this.resizer&&this.resizer.hide()},closed:function(){this._observeImages(),this.resizer&&this.resizer.rebuild()}},onupload:{complete:function(){this._observeImages()},image:{complete:function(t){this._insert(t),this.app.broadcast("state",!1)},error:function(t){this._uploadError(t)}},imageedit:{complete:function(t){this._change(t)},error:function(t){this._uploadError(t)}},imagedrop:{complete:function(t,e){this._insert(t,e)},error:function(t){this._uploadError(t)}},imagereplace:{complete:function(t){this._change(t,!1)},error:function(t){this._uploadError(t)}}},onmodal:{image:{open:function(t,e){this._setUpload(t,e)}},imageedit:{open:function(t,e){this._setFormData(t,e)},opened:function(t,e){this._setFormFocus(e)},remove:function(){this._remove(this.$image)},save:function(t,e){this._save(t,e)}}},onimage:{observe:function(){this._observeImages()},resized:function(){this.justResized=!0}},oncontextbar:function(t,e){var i,n;this.justResized?this.justResized=!1:(i=this.selection.getCurrent(),n=this.inspector.parse(i),i=f.dom(i).closest("img"),(!n.isFigcaption()&&n.isComponentType("image")||0!==i.length)&&(i=0!==i.length?i.get():n.getComponent(),n={edit:{title:this.lang.get("edit"),api:"module.image.open"},remove:{title:this.lang.get("delete"),api:"module.image.remove",args:i}},e.set(t,i,n)))},open:function(){this.$image=this._getCurrent(),this.app.api("module.modal.build",this._getModalData())},insert:function(t){this._insert(t)},remove:function(t){this._remove(t)},_getModalData:function(){var t=this._isImage()&&this.opts.imageEditable?{name:"imageedit",width:"800px",title:this.lang.get("edit"),handle:"save",commands:{save:{title:this.lang.get("save")},remove:{title:this.lang.get("delete"),type:"danger"},cancel:{title:this.lang.get("cancel")}}}:{name:"image",title:this.lang.get("image")};return t},_isImage:function(){return this.$image},_getCurrent:function(){var t=this.selection.getCurrent(),e=this.inspector.parse(t),t=f.dom(t).closest("img");return 0!==t.length?this.component.create("image",t):!(!e.isComponentType("image")||!e.isComponentActive())&&this.component.create("image",e.getComponent())},_insert:function(t,e){if(this.app.api("module.modal.close"),Array.isArray(t)){for(var i={},n=0;n<t.length;n++)i=f.extend(i,t[n]);t=i}else"string"==typeof t&&(t={file:{url:t}});if("object"==typeof t){var r,s=0;for(r in t)"object"==typeof t[r]&&s++;1<s?this._insertMultiple(t,e):this._insertSingle(t,e)}},_insertSingle:function(t,e){for(var i in t){var n;"object"==typeof t[i]&&(n=this._createImageAndStore(t[i]),n=e?this.insertion.insertToPoint(e,n,!1,!1):this.insertion.insertHtml(n,!1),this._removeSpaceBeforeFigure(n[0]),this.component.setActive(n[0]),this.app.broadcast("image.uploaded",n[0],t))}},_insertMultiple:function(t,e){var i,n,r,s=0,o=[];for(n in t)"object"==typeof t[n]&&(s++,r=this._createImageAndStore(t[n]),1===s?o=e?this.insertion.insertToPoint(e,r,!1,!1):this.insertion.insertHtml(r,!1):(f.dom(o[0]).after(r),o=[r.get()],this.app.broadcast("image.inserted",r)),i=o[0],this._removeSpaceBeforeFigure(o[0]),this.app.broadcast("image.uploaded",o[0],t));this.component.setActive(i)},_createImageAndStore:function(t){var e=this.component.create("image");return e.addClass("redactor-uploaded-figure"),e.setData({src:t.url,id:t.id||this.utils.getRandomId()}),this.storage.add("image",e.getElement()),e},_removeSpaceBeforeFigure:function(t){var e,i,n;t&&(e=t.previousSibling,i=t.nextSibling,n=f.dom(e),t=f.dom(i),this.opts.breakline&&(i&&"br"===t.attr("data-redactor-tag")&&t.find("br").first().remove(),e&&"br"===n.attr("data-redactor-tag")&&n.find("br").last().remove()),e&&(this._removeInvisibleSpace(e),this._removeInvisibleSpace(e.previousSibling)))},_removeInvisibleSpace:function(t){t&&3===t.nodeType&&-1!==this.utils.searchInvisibleChars(t.textContent)&&t.parentNode.removeChild(t)},_save:function(t,e){var i=e.getData(),e={title:i.title};this.opts.imageLink&&(e.link={url:i.url,target:i.target}),this.opts.imageCaption&&(e.caption=i.caption),this.opts.imagePosition&&(e.align=i.align),this.$image.setData(e),this.resizer&&this.resizer.rebuild(),this.app.broadcast("image.changed",this.$image),this.app.api("module.modal.close")},_change:function(t,e){if("string"==typeof t&&(t={file:{url:t}}),"object"==typeof t){var i,n;for(n in t)if("object"==typeof t[n]){(i=f.dom("<img>")).attr("src",t[n].url),this.$image.changeImage(t[n]),this.app.broadcast("image.changed",this.$image,t),this.app.broadcast("image.uploaded",this.$image,t),this.app.broadcast("hardsync");break}!1!==e&&i.on("load",function(){this.$previewBox.html(i)}.bind(this))}},_uploadError:function(t){this.app.broadcast("image.uploadError",t)},_remove:function(t){this.app.api("module.modal.close"),this.component.remove(t)},_observeImages:function(){var t=this.editor.getElement(),i=this;t.find("img").each(function(t){var e=f.dom(t);e.off(".drop-to-replace"),e.on("dragover.drop-to-replace dragenter.drop-to-replace",function(t){t.preventDefault()}),e.on("drop.drop-to-replace",function(t){if(!i.app.isDragComponentInside())return i._setReplaceUpload(t,e)})})},_setFormData:function(t,e){this._buildPreview(t),this._buildPreviewUpload();var i=this.$image.getData(),n={title:i.title};this.opts.imageCaption?n.caption=i.caption:t.find(".form-item-caption").hide(),this.opts.imagePosition?n.align=i.align:t.find(".form-item-align").hide(),this.opts.imageLink?i.link&&(n.url=i.link.url,i.link.target&&(n.target=!0)):t.find(".form-item-link").hide(),e.setData(n)},_setFormFocus:function(t){t.getField("title").focus()},_setReplaceUpload:function(t,e){(t=t.originalEvent||t).stopPropagation(),t.preventDefault(),this.opts.imageUpload&&(this.$image=this.component.create("image",e),t={url:this.opts.imageUpload,files:t.dataTransfer.files,name:"imagereplace",data:this.opts.imageData,paramName:this.opts.imageUploadParam},this.app.api("module.upload.send",t))},_setUpload:function(t,e){this.opts.imageUpload||t.getBody().find(".redactor-modal-tab-upload").remove();e={url:this.opts.imageUpload,element:e.getField("file"),name:"image",data:this.opts.imageData,paramName:this.opts.imageUploadParam};this.app.api("module.upload.build",e)},_buildPreview:function(t){this.$preview=t.find("#redactor-modal-image-preview");var e=this.$image.getData(),t=f.dom("<img>");t.attr("src",e.src),this.$previewBox=f.dom("<div>"),this.$previewBox.append(t),this.$preview.html(""),this.$preview.append(this.$previewBox)},_buildPreviewUpload:function(){var t;this.opts.imageUpload&&((t=f.dom('<div class="desc">')).html(this.lang.get("upload-change-label")),this.$preview.append(t),t={url:this.opts.imageUpload,element:this.$previewBox,name:"imageedit",data:this.opts.imageData,paramName:this.opts.imageUploadParam},this.app.api("module.upload.build",t))}}),f.add("class","image.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,this.opts=t.opts,this.selection=t.selection,e&&void 0!==e.cmnt?e:this._init(e)},setData:function(t){for(var e in t)this._set(e,t[e])},getData:function(){for(var t=["src","title","caption","align","link","id"],e={},i=0;i<t.length;i++)e[t[i]]=this._get(t[i]);return e},getElement:function(){return this.$element},changeImage:function(t){this.$element.attr("src",t.url)},_init:function(t){var e=f.dom(t),i=e.closest("figure");void 0===t?(this.$element=f.dom("<img>"),this.parse("<figure>"),this.append(this.$element)):0===i.length?(this.parse("<figure>"),this.$element=e,this.$element.wrap(this)):(this.parse(i),this.$element=this.find("img")),this._initWrapper()},_set:function(t,e){this["_set_"+t](e)},_get:function(t){return this["_get_"+t]()},_set_src:function(t){this.$element.attr("src",t)},_set_id:function(t){this.opts.imageObserve&&this.$element.attr("data-image",t)},_set_title:function(t){""===(t=t.trim().replace(/(<([^>]+)>)/gi,""))?this.$element.removeAttr("alt"):this.$element.attr("alt",t)},_set_caption:function(t){var e=this.find("figcaption");return 0===e.length&&((e=f.dom("<figcaption>")).attr("contenteditable","true"),this.append(e)),""===t?e.remove():e.html(t),e},_set_align:function(t){var e="",i="",n="",r=this.find("img"),s=this.find("figcaption");if("object"==typeof this.opts.imagePosition){var o,a=this.opts.imagePosition;for(o in a)this.removeClass(a[o]);var l=void 0!==a[t]&&a[t];l&&this.addClass(l)}else{r=r.width();switch(t){case"left":e="left",i=this.opts.imageFloatMargin;break;case"right":e="right",i=this.opts.imageFloatMargin;break;case"center":n="center",i="auto"}this.css({float:e,width:r+"px",maxWidth:r+"px","margin-left":i,"margin-right":i,"text-align":n}),this.attr("rel",this.attr("style")),"none"===t&&(this.css("max-width",""),this.css("width","")),"center"===t?(this.css("max-width",""),this.css("width",""),s.css("text-align","center")):s.css("text-align","")}},_set_link:function(t){var e=this._findLink();if(""!==t.url)return e||(e=f.dom("<a>"),this.$element.wrap(e)),e.attr("href",t.url),t.target?e.attr("target",!0===t.target?"_blank":t.target):e.removeAttr("target"),e;e&&e.unwrap()},_get_src:function(){return this.$element.attr("src")},_get_id:function(){return this.$element.attr("data-image")},_get_title:function(){var t=this.$element.attr("alt");return t||""},_get_caption:function(){var t=this.find("figcaption");return 0===t.length?"":t.html()},_get_align:function(){var t="";if("object"==typeof this.opts.imagePosition){t="none";var e,i=this.opts.imagePosition;for(e in i)if(this.hasClass(i[e])){t=e;break}}else t="center"===this.css("text-align")?"center":this.css("float");return t},_get_link:function(){var t=this._findLink();if(t){var e=!!t.attr("target");return{url:t.attr("href"),target:e}}},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"image",tabindex:"-1",contenteditable:!1})},_findLink:function(){var t=this.find("a").filter(function(t){return 0===f.dom(t).closest("figcaption").length});return 0!==t.length&&t}}),f.add("class","image.resize",{init:function(t){this.app=t,this.$doc=t.$doc,this.$win=t.$win,this.$body=t.$body,this.editor=t.editor,this.toolbar=t.toolbar,this.inspector=t.inspector,this.$target=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$body,this._init()},rebuild:function(){this._setResizerPosition()},hide:function(){this.$target.find("#redactor-image-resizer").remove()},stop:function(){this.editor.getElement().off(".redactor.image-resize"),this.$doc.off(".redactor.image-resize"),this.$win.off("resize.redactor.image-resize"),this.hide()},_init:function(){this.editor.getElement().on("click.redactor.image-resize",this._build.bind(this)),this.$win.on("resize.redactor.image-resize",this._setResizerPosition.bind(this))},_build:function(t){var e;this.$target.find("#redactor-image-resizer").remove(),this.app.isReadOnly()||(e=this.inspector.parse(t.target),t=this.editor.getElement(),e.isComponentType("image")&&(this.$resizableBox=t,this.$resizableImage=f.dom(e.getImageElement()),this.$resizer=f.dom("<span>"),this.$resizer.attr("id","redactor-image-resizer"),this.$target.append(this.$resizer),this._setResizerPosition(),this.$resizer.on("mousedown touchstart",this._set.bind(this))))},_setResizerPosition:function(){var t,e,i,n,r,s,o;this.$resizer&&(s=this.toolbar.isTarget(),o=this.$target.offset(),t=s?7-o.top+this.$target.scrollTop():7,e=s?7-o.left:7,i=this.$resizableImage.offset(),n=this.$resizableImage.width(),r=this.$resizableImage.height(),s=this.$resizer.width(),o=this.$resizer.height(),this.$resizer.css({top:Math.round(i.top+r-o+t)+"px",left:Math.round(i.left+n-s+e)+"px"}))},_set:function(t){t.preventDefault(),this.resizeHandle={x:t.pageX,y:t.pageY,el:this.$resizableImage,$figure:this.$resizableImage.closest("figure"),ratio:this.$resizableImage.width()/this.$resizableImage.height(),h:this.$resizableImage.height()},(t=t.originalEvent||t).targetTouches&&(this.resizeHandle.x=t.targetTouches[0].pageX,this.resizeHandle.y=t.targetTouches[0].pageY),this.app.broadcast("contextbar.close"),this.app.broadcast("image.resize",this.$resizableImage),this._start()},_start:function(){this.$doc.on("mousemove.redactor.image-resize touchmove.redactor.image-resize",this._move.bind(this)),this.$doc.on("mouseup.redactor.image-resize touchend.redactor.image-resize",this._stop.bind(this))},_stop:function(){this.$doc.off(".redactor.image-resize"),this.app.broadcast("image.resized",this.$resizableImage)},_move:function(t){t.preventDefault(),t=t.originalEvent||t;var e=this.resizeHandle.h;t.targetTouches?e+=t.targetTouches[0].pageY-this.resizeHandle.y:e+=t.pageY-this.resizeHandle.y;t=e*this.resizeHandle.ratio,t=Math.round(t);(e=Math.round(e))<20||t<100||this._getResizableBoxWidth()<=t||(0!==this.resizeHandle.$figure.length&&""!==this.resizeHandle.$figure.css("max-width")&&this.resizeHandle.$figure.css({width:t+"px","max-width":t+"px"}),this.resizeHandle.el.attr({width:t,height:e}),this.resizeHandle.el.width(t),this.resizeHandle.el.css("max-width",t+"px"),this.resizeHandle.el.height(e),this._setResizerPosition())},_getResizableBoxWidth:function(){return this.$resizableBox.width()-parseInt(this.$resizableBox.css("padding-left"))-parseInt(this.$resizableBox.css("padding-right"))}}),f.add("module","file",{modals:{file:'<div class="redactor-modal-tab" data-title="## upload ##"><form action="">                 <div class="form-item form-item-title">                     <label for="modal-file-title"> ## filename ## <span class="desc">(## optional ##)</span></label>                     <input type="text" id="modal-file-title" name="title" />                 </div>                 <input type="file" name="file">             </form></div>'},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.caret=t.caret,this.utils=t.utils,this.storage=t.storage,this.component=t.component,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection},onstarted:function(){this.storage.observeFiles()},ondropfile:function(t,e,i){this.opts.fileUpload&&(e={url:this.opts.fileUpload,event:!i&&t,files:e,name:"filedrop",data:this.opts.fileData},this.app.api("module.upload.send",e))},onmodal:{file:{open:function(t,e){this._setFormData(t,e),this._setUpload(e)},opened:function(t,e){this._setFormFocus(e),this.$form=e}}},onupload:{file:{complete:function(t){this._insert(t)},error:function(t){this._uploadError(t)}},filedrop:{complete:function(t,e){this._insert(t,e)},error:function(t){this._uploadError(t)}}},open:function(){this._open()},insert:function(t){this._insert(t)},remove:function(t){this._remove(t)},_open:function(){this.app.api("module.modal.build",this._getModalData())},_getModalData:function(){return{name:"file",title:this.lang.get("file")}},_insert:function(t,e){if(this.app.api("module.modal.close"),"object"==typeof t){if(Array.isArray(t)){for(var i={},n=0;n<t.length;n++)i=f.extend(i,t[n]);t=i}1<Object.keys(t).length?this._insertMultiple(t,e):this._insertSingle(t,e),this.$form=!1}},_insertSingle:function(t,e){var i,n=[];for(i in t){var r=this._createFileAndStore(t[i]),n=this.opts.fileAttachment?this._insertAsAttachment(r):e?this.insertion.insertToPoint(e,r):this.insertion.insertRaw(r);this.app.broadcast("file.uploaded",n[0],t)}},_insertMultiple:function(t,e){var i,n,r=0,s=[];for(n in t){r++;var o=this._createFileAndStore(t[n]);this.opts.fileAttachment?s=this._insertAsAttachment(o,t):1===r?s=e?this.insertion.insertToPoint(e,o):this.insertion.insertRaw(o):(f.dom(s[0]).after(o).after(" "),s=[o.get()],this.app.broadcast("file.inserted",o)),i=o,this.app.broadcast("file.uploaded",s[0],t)}this.opts.fileAttachment||this.caret.setAfter(i)},_insertAsAttachment:function(t,e){var i=f.dom(this.opts.fileAttachment),t=t.wrapAttachment();i.append(t);t=[t.get()];return this.app.broadcast("file.appended",t[0],e),t},_createFileAndStore:function(t){var e=!!this.$form&&this.$form.getData(),i=t.name||t.url,e=!this.opts.fileAttachment&&e&&""!==e.title?e.title:this._truncateUrl(i),i=this.component.create("file");return i.attr("href",t.url),i.attr("data-file",t.id||this.utils.getRandomId()),i.attr("data-name",t.name),i.html(e),this.storage.add("file",i),i},_remove:function(t){this.selection.save();t=this.component.create("file",t);!1!==this.app.broadcast("file.delete",t)?(t.unwrap(),this.selection.restore(),this.app.broadcast("file.deleted",t)):this.selection.restore()},_truncateUrl:function(t){return-1!==t.search(/^http/)&&20<t.length?t.substring(0,20)+"...":t},_setUpload:function(t){t={url:this.opts.fileUpload,element:t.getField("file"),name:"file",data:this.opts.fileData,paramName:this.opts.fileUploadParam};this.app.api("module.upload.build",t)},_setFormData:function(t,e){this.opts.fileAttachment?t.find(".form-item-title").hide():e.setData({title:this.selection.getText()})},_setFormFocus:function(t){t.getField("title").focus()},_uploadError:function(t){this.app.broadcast("file.uploadError",t)}}),f.add("class","file.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,this.opts=t.opts,e&&void 0!==e.cmnt?e:this._init(e)},wrapAttachment:function(){return this.$wrapper=f.dom('<span class="redactor-file-item">'),this.$remover=f.dom('<span class="redactor-file-remover">'),this.$remover.html("&times;"),this.$remover.on("click",this.removeAttachment.bind(this)),this.$wrapper.append(this),this.$wrapper.append(this.$remover),this.$wrapper},removeAttachment:function(t){t.preventDefault(),!1!==this.app.broadcast("file.delete",this,this.$wrapper)&&(this.$wrapper.remove(),this.app.broadcast("file.deleted",this),this.app.broadcast("file.removeAttachment",this))},_init:function(t){void 0===t?this.parse("<a>"):(t=f.dom(t).closest("a"),this.parse(t))}}),f.add("module","buffer",{init:function(t){this.app=t,this.opts=t.opts,this.editor=t.editor,this.offset=t.offset,this.keycodes=t.keycodes,this.selection=t.selection,this.state=!1,this.passed=!1,this.keyPressed=!1,this.undoStorage=[],this.redoStorage=[]},onkeydown:function(t){this._listen(t)},onsyncing:function(){this.keyPressed||this.trigger(),this.keyPressed=!1},onbuffer:{trigger:function(){this.trigger()}},onstate:function(t,e,i){t&&(t.ctrlKey||t.metaKey)||t&&(this._isUndo(t)||this._isRedo(t))||(this.passed=!1,this._saveState(e,i),!1===t&&this._setUndo())},onenable:function(){this.clear()},clear:function(){this.state=!1,this.undoStorage=[],this.redoStorage=[]},undo:function(){this._getUndo()},redo:function(){this._getRedo()},trigger:function(){this.state&&!1===this.passed&&this._setUndo()},_saveState:function(t,e){var i=this.editor.getElement();this.state={html:t||i.html(),offset:e||this.offset.get()}},_listen:function(t){var e=t.which,i=t.ctrlKey||t.metaKey,n=i||t.shiftKey||t.altKey,r=[this.keycodes.SPACE,this.keycodes.ENTER,this.keycodes.BACKSPACE,this.keycodes.DELETE,this.keycodes.TAB,this.keycodes.LEFT,this.keycodes.RIGHT,this.keycodes.UP,this.keycodes.DOWN];return this._isUndo(t)?(t.preventDefault(),void this.undo()):this._isRedo(t)?(t.preventDefault(),void this.redo()):((i||-1===r.indexOf(e))&&(!i||88!==e&&67!==e)||(n=!0,this.trigger()),n||this._hasUndo()||this.trigger(),void(this.keyPressed=!0))},_isUndo:function(t){var e=t.which;return(t.ctrlKey||t.metaKey)&&90===e&&!t.shiftKey&&!t.altKey},_isRedo:function(t){var e=t.which;return(t.ctrlKey||t.metaKey)&&(90===e&&t.shiftKey||89===e&&!t.shiftKey)&&!t.altKey},_setUndo:function(){var t=this.undoStorage[this.undoStorage.length-1];void 0!==t&&t[0]===this.state.html||(this.undoStorage.push([this.state.html,this.state.offset]),this._removeOverStorage())},_setRedo:function(){var t=this.editor.getElement(),e=this.offset.get(),t=t.html();this.redoStorage.push([t,e]),this.redoStorage=this.redoStorage.slice(0,this.opts.bufferLimit)},_getUndo:function(){var t,e;this._hasUndo()&&(this.passed=!0,t=this.editor.getElement(),e=this.undoStorage.pop(),this._setRedo(),t.html(e[0]),this.offset.set(e[1]),this._saveState(e[0],e[1]),this.app.broadcast("undo",e[0],e[1]))},_getRedo:function(){var t,e;this._hasRedo()&&(this.passed=!0,t=this.editor.getElement(),e=this.redoStorage.pop(),this._setUndo(),t.html(e[0]),this.offset.set(e[1]),this._saveState(e[0],e[1]),this.app.broadcast("redo",e[0],e[1]))},_removeOverStorage:function(){this.undoStorage.length>this.opts.bufferLimit&&(this.undoStorage=this.undoStorage.slice(0,this.undoStorage.length-this.opts.bufferLimit))},_hasUndo:function(){return 0!==this.undoStorage.length},_hasRedo:function(){return 0!==this.redoStorage.length}}),f.add("module","list",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.utils=t.utils,this.block=t.block,this.editor=t.editor,this.toolbar=t.toolbar,this.inspector=t.inspector,this.selection=t.selection},onbutton:{list:{observe:function(t){this._observeButton(t)}}},ondropdown:{list:{observe:function(t){this._observeDropdown(t)}}},toggle:function(t){var e=this._getBlocks(),i=this.selection.getBlock(),n=f.dom(i).parents("ul, ol",this.editor.getElement()).last();return 0===e.length&&0!==n.length&&(e=[n.get()]),!i||"TD"!==i.tagName&&"TH"!==i.tagName||(e=this.block.format("div")),this.selection.saveMarkers(),e=0!==e.length&&this._isUnformat(t,e)?this._unformat(t,e):this._format(t,e),this.selection.restoreMarkers(),e},indent:function(){var t=this.selection.isCollapsed(),e=this.selection.getCurrent(),i=this.inspector.parse(e),n=!!i.isList()&&i.getListItem(),r=f.dom(n),e=r.prevElement(),i=e.get();t&&n&&i&&"LI"===i.tagName&&(this.selection.saveMarkers(),n=(e=f.dom(i)).children("ul, ol"),i=r.closest("ul, ol"),0!==n.length?n.append(r):(i=i.get().tagName.toLowerCase(),(i=f.dom("<"+i+">")).append(r),e.append(i)),this.selection.restoreMarkers(),this.utils.isEmptyHtml(r.html())&&this.app.caret.setStart(r))},outdent:function(){var t=this.selection.isCollapsed(),e=this.selection.getCurrent(),i=this.inspector.parse(e),n=!!i.isList()&&i.getListItem(),r=f.dom(n);if(t&&n){var s,o,a=r.parent(),l=a.closest("li",".redactor-in-"+this.uuid),e=r.prevElement(),i=r.nextElement(),t=e.get(),n=i.get(),e=!1===t,i=!1!==t&&!1!==n,t=!e&&!1===n;if(this.selection.saveMarkers(),0!==l.length)if(i){s=this._getAllNext(r.get()),o=f.dom("<"+a.get().tagName.toLowerCase()+">");for(var c=0;c<s.length;c++)o.append(s[c]);l.after(r),r.append(o)}else l.after(r),0===a.children().length?a.remove():e&&r.append(a);else{n=this._createUnformatContainer(r),l=n.find("ul, ol").first();if(e)a.before(n);else if(t)a.after(n);else if(i){o=f.dom("<"+a.get().tagName.toLowerCase()+">"),s=this._getAllNext(r.get());for(c=0;c<s.length;c++)o.append(s[c]);a.after(n),n.after(o)}0!==l.length&&((i=n.nextElement().get())&&i.tagName===a.get().tagName?(f.dom(i).prepend(l),l.unwrap()):n.after(l)),r.remove()}this.selection.restoreMarkers()}},_getAllNext:function(t){for(var e=[];t;){if(!(t=f.dom(t).nextElement().get()))return e;e.push(t)}return e},_isUnformat:function(t,e){for(var i,n=0,r=0;r<e.length;r++)3!==e[r].nodeType&&((i=e[r].tagName.toLowerCase())!==t&&"figure"!==i||n++);return n===e.length},_format:function(t,e){var i,n=this._uniteBlocks(e,["p","div","blockquote","pre","h1","h2","h3","h4","h5","h6","ul","ol"]),r=[];for(i in n){for(var s,o,a=n[i],l=this._createList(t,n[i]),c=0;c<a.length;c++)3===a[c].nodeType||"UL"!==a[c].tagName&&"OL"!==a[c].tagName?((s=(o=this._createListItem(a[c])).get().lastChild)&&"BR"===s.tagName&&f.dom(s).remove(),this.utils.normalizeTextNodes(o),l.append(o)):(o=(s=f.dom(a[c])).contents(),l.append(o),this.utils.isEmpty(s)&&s.remove());r.push(l.get())}return r},_uniteBlocks:function(t,e){for(var i=0,n={0:[]},r=!1,s=0;s<t.length;s++){var o=f.dom(t[s]).closest("th, td");0!==o.length?(o.get()!==r&&(n[++i]=[]),this._isUniteBlock(t[s],e)&&n[i].push(t[s])):this._isUniteBlock(t[s],e)?n[i].push(t[s]):n[++i]=[],r=o.get()}return n},_isUniteBlock:function(t,e){return 3===t.nodeType||-1!==e.indexOf(t.tagName.toLowerCase())},_createList:function(t,e){e=e[e.length-1],e=f.dom(e),t=f.dom("<"+t+">");return e.after(t),t},_createListItem:function(t){var e=f.dom("<li>");return 3===t.nodeType?e.append(t):(t=f.dom(t),e.append(t.contents()),t.remove()),e},_unformat:function(t,e){if(1===e.length){var i=f.dom(e[0]),n=i.find("li"),r=this.selection.getNodes({tags:["li"]}),s=this.selection.getBlock(),s=f.dom(s).closest("li");if(0===r.length&&0!==s.length&&(r=[s.get()]),r.length===n.length)return this._unformatEntire(e[0]);s=this._getItemsPosition(n,r);if("Top"===s)return this._unformatAtSide("before",r,i);if("Bottom"===s)return r.reverse(),this._unformatAtSide("after",r,i);if("Middle"===s){var o=f.dom(r[r.length-1]),a=!1,l=!1,c=f.dom("<"+i.get().tagName.toLowerCase()+">");n.each(function(t){var e;a&&(0!==(e=f.dom(t)).closest(".redactor-split-item").length||!1!==l&&0!==e.closest(l).length||e.addClass("redactor-split-item"),l=e),t===o.get()&&(a=!0)}),n.filter(".redactor-split-item").each(function(t){f.dom(t).removeClass("redactor-split-item"),c.append(t)}),i.after(c),r.reverse();for(var h=0;h<r.length;h++){var d=f.dom(r[h]),u=this._createUnformatContainer(d);i.after(u),u.find("ul, ol").remove(),d.remove()}}}else for(h=0;h<e.length;h++)3!==e[h].nodeType&&e[h].tagName.toLowerCase()===t&&this._unformatEntire(e[h])},_unformatEntire:function(t){var i=f.dom(t);i.find("li").each(function(t){var e=f.dom(t),t=this._createUnformatContainer(e);e.remove(),i.before(t)}.bind(this)),i.remove()},_unformatAtSide:function(t,i,e){for(var n=0;n<i.length;n++){var r=f.dom(i[n]),s=this._createUnformatContainer(r);e[t](s);s=s.find("ul, ol").first();r.append(s),s.each(function(t){var e=f.dom(t),t=e.closest("li");t.get()===i[n]&&(e.unwrap(),t.addClass("r-unwrapped"))}),this.utils.isEmptyHtml(r.html())&&r.remove()}e.find(".r-unwrapped").each(function(t){t=f.dom(t);""===t.html().trim()?t.remove():t.removeClass("r-unwrapped")})},_getItemsPosition:function(t,e){var i="Middle",n=e[0],r=e[e.length-1],e=t.first().get(),t=t.last().get();return e===n&&t!==r?i="Top":e!==n&&t===r&&(i="Bottom"),i},_createUnformatContainer:function(t){var e=f.dom("<"+this.opts.markup+">");return this.opts.breakline&&e.attr("data-redactor-tag","br"),e.append(t.contents()),e},_getBlocks:function(){return this.selection.getBlocks({first:!0})},_observeButton:function(){var t=this.selection.getCurrent(),e=this.inspector.parse(t),t=e.isPre()||e.isCode()||e.isFigcaption();this._observeButtonsList(t,["lists","ul","ol","outdent","indent"]);e=this.toolbar.getButton("outdent"),t=this.toolbar.getButton("indent");this._observeIndent(t,e)},_observeDropdown:function(t){var e=t.getItem("outdent"),t=t.getItem("indent");this._observeIndent(t,e)},_observeIndent:function(t,e){var i=this.selection.isCollapsed(),n=this.selection.getCurrent(),r=this.inspector.parse(n),n=!!r.isList()&&r.getListItem(),r=f.dom(n).prevElement().get(),r=i&&n&&r&&"LI"===r.tagName;e&&(n&&i?e.enable():e.disable()),t&&(n&&r?t.enable():t.disable())},_observeButtonsList:function(t,e){for(var i=0;i<e.length;i++){var n=this.toolbar.getButton(e[i]);n&&(t?n.disable():n.enable())}}}),f.add("class","video.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},_init:function(t){var e;void 0!==t?0!==(e=f.dom(t).closest("figure")).length?this.parse(e):(this.parse("<figure>"),this.append(t)):this.parse("<figure>"),this._initWrapper()},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"video",tabindex:"-1",contenteditable:!1})}}),f.add("class","widget.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},getData:function(){return{html:this._getHtml()}},_init:function(t){var e;void 0!==t?0!==(e=f.dom(t).closest("figure")).length?this.parse(e):(this.parse("<figure>"),this.html(t)):this.parse("<figure>"),this._initWrapper()},_getHtml:function(){var t=f.dom("<div>");return t.html(this.html()),t.find(".redactor-component-caret").remove(),t.html()},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"widget",tabindex:"-1",contenteditable:!1})}});var t=f;window.Redactor=window.$R=f,window.addEventListener("load",function(){f("[data-redactor]")}),"object"==typeof module&&module.exports&&(module.exports=t,module.exports.Redactor=t)}(),function(s){s.add("plugin","table",{translations:{en:{table:"Table","insert-table":"Insert table","insert-row-above":"Insert row above","insert-row-below":"Insert row below","insert-column-left":"Insert column left","insert-column-right":"Insert column right","add-head":"Add head","delete-head":"Delete head","delete-column":"Delete column","delete-row":"Delete row","delete-table":"Delete table"}},init:function(t){this.app=t,this.lang=t.lang,this.opts=t.opts,this.caret=t.caret,this.editor=t.editor,this.toolbar=t.toolbar,this.component=t.component,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection},ondropdown:{table:{observe:function(t){this._observeDropdown(t)}}},onbottomclick:function(){this.insertion.insertToEnd(this.editor.getLastNode(),"table")},start:function(){var t={observe:"table","insert-table":{title:this.lang.get("insert-table"),api:"plugin.table.insert"},"insert-row-above":{title:this.lang.get("insert-row-above"),classname:"redactor-table-item-observable",api:"plugin.table.addRowAbove"},"insert-row-below":{title:this.lang.get("insert-row-below"),classname:"redactor-table-item-observable",api:"plugin.table.addRowBelow"},"insert-column-left":{title:this.lang.get("insert-column-left"),classname:"redactor-table-item-observable",api:"plugin.table.addColumnLeft"},"insert-column-right":{title:this.lang.get("insert-column-right"),classname:"redactor-table-item-observable",api:"plugin.table.addColumnRight"},"add-head":{title:this.lang.get("add-head"),classname:"redactor-table-item-observable",api:"plugin.table.addHead"},"delete-head":{title:this.lang.get("delete-head"),classname:"redactor-table-item-observable",api:"plugin.table.deleteHead"},"delete-column":{title:this.lang.get("delete-column"),classname:"redactor-table-item-observable",api:"plugin.table.deleteColumn"},"delete-row":{title:this.lang.get("delete-row"),classname:"redactor-table-item-observable",api:"plugin.table.deleteRow"},"delete-table":{title:this.lang.get("delete-table"),classname:"redactor-table-item-observable",api:"plugin.table.deleteTable"}},e={title:this.lang.get("table")},e=this.toolbar.addButtonBefore("link","table",e);e.setIcon('<i class="re-icon-table"></i>'),e.setDropdown(t)},insert:function(){for(var t=this.component.create("table"),e=0;e<2;e++)t.addRow(3);t=this.insertion.insertHtml(t),this.caret.setStart(t)},addRowAbove:function(){var t,e=this._getComponent();e&&(t=this.selection.getCurrent(),t=e.addRowTo(t,"before"),this.caret.setStart(t))},addRowBelow:function(){var t,e=this._getComponent();e&&(t=this.selection.getCurrent(),t=e.addRowTo(t,"after"),this.caret.setStart(t))},addColumnLeft:function(){var t,e=this._getComponent();e&&(t=this.selection.getCurrent(),this.selection.save(),e.addColumnTo(t,"left"),this.selection.restore())},addColumnRight:function(){var t,e=this._getComponent();e&&(t=this.selection.getCurrent(),this.selection.save(),e.addColumnTo(t,"right"),this.selection.restore())},addHead:function(){var t=this._getComponent();t&&(this.selection.save(),t.addHead(),this.selection.restore())},deleteHead:function(){var t,e=this._getComponent();e&&(t=this.selection.getCurrent(),0!==s.dom(t).closest("thead").length?(e.removeHead(),this.caret.setStart(e)):(this.selection.save(),e.removeHead(),this.selection.restore()))},deleteColumn:function(){var t,e,i,n=this._getComponent();n&&(t=this.selection.getCurrent(),e=(i=s.dom(t).closest("td, th")).nextElement().get(),i=i.prevElement().get(),n.removeColumn(t),e?this.caret.setStart(e):i?this.caret.setEnd(i):this.deleteTable())},deleteRow:function(){var t,e,i,n,r=this._getComponent();r&&(t=this.selection.getCurrent(),e=(n=s.dom(t).closest("tr")).nextElement().get(),i=n.prevElement().get(),n=s.dom(t).closest("thead"),r.removeRow(t),e?this.caret.setStart(e):i?this.caret.setEnd(i):0!==n.length?(r.removeHead(),this.caret.setStart(r)):this.deleteTable())},deleteTable:function(){var t=this._getTable();t&&this.component.remove(t)},_getTable:function(){var t=this.selection.getCurrent(),t=this.inspector.parse(t);if(t.isTable())return t.getTable()},_getComponent:function(){var t=this.selection.getCurrent(),t=this.inspector.parse(t);if(t.isTable()){t=t.getTable();return this.component.create("table",t)}},_observeDropdown:function(t){var e=this._getTable(),i=t.getItemsByClass("redactor-table-item-observable"),t=t.getItem("insert-table");e?(this._observeItems(i,"enable"),t.disable()):(this._observeItems(i,"disable"),t.enable())},_observeItems:function(t,e){for(var i=0;i<t.length;i++)t[i][e]()}})}(Redactor),function(s){s.add("class","table.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},addHead:function(){this.removeHead();var t=this.$element.find("tr").first().children("td, th").length,e=s.dom("<thead>"),t=this._buildRow(t,"<th>");e.append(t),this.$element.prepend(e)},addRow:function(t){t=this._buildRow(t);return this.$element.append(t),t},addRowTo:function(t,e){return this._addRowTo(t,e)},addColumnTo:function(t,i){var e=s.dom(t),t=e.closest("tr"),n=e.closest("td, th"),r=0;t.find("td, th").each(function(t,e){t===n.get()&&(r=e)}),this.$element.find("tr").each(function(t){var e=s.dom(t).find("td, th").get(r),t=s.dom(e),e=t.clone();e.html('<div data-redactor-tag="tbr"></div>'),"right"===i?t.after(e):t.before(e)})},removeHead:function(){var t=this.$element.find("thead");0!==t.length&&t.remove()},removeRow:function(t){s.dom(t).closest("tr").remove()},removeColumn:function(t){var e=s.dom(t),t=e.closest("tr"),i=e.closest("td, th"),n=0;t.find("td, th").each(function(t,e){t===i.get()&&(n=e)}),this.$element.find("tr").each(function(t){t=s.dom(t).find("td, th").get(n);s.dom(t).remove()})},_init:function(t){var e,i,n;void 0!==t&&(t=(n=s.dom(t)).get(),0!==(n=n.closest("figure")).length?i=(e=n).find("table").get():"TABLE"===t.tagName&&(i=t)),this._buildWrapper(e),this._buildElement(i),this._initWrapper()},_addRowTo:function(t,e){var i=s.dom(t).closest("tr");if(0!==i.length){t=i.children("td, th").length,t=this._buildRow(t);return i[e](t),t}},_buildRow:function(t,e){e=e||"<td>";for(var i=s.dom("<tr>"),n=0;n<t;n++){var r=s.dom(e);r.attr("contenteditable",!0),r.html('<div data-redactor-tag="tbr"></div>'),i.append(r)}return i},_buildElement:function(t){t?this.$element=s.dom(t):(this.$element=s.dom("<table>"),this.append(this.$element))},_buildWrapper:function(t){t=t||"<figure>",this.parse(t)},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"table",tabindex:"-1",contenteditable:!1}),this.app.detector.isIe()&&this.removeAttr("contenteditable")}})}(Redactor),function(d,n){function t(n){"use strict";var r=this;this.isRedactor=function(){return"redactor"===n.namespace},this.container=function(){return r.isRedactor()?d(n.container.getElement().get()):n.container()},this.val=function(){return r.isRedactor()&&!n.editor.isSourceMode()?r.api().api("module.source.getCode"):r.api().getValue()},this.sync=function(){r.isRedactor()&&!n.editor.isSourceMode()||this.api().save()},this.insert=function(t){var e,i;r.isRedactor()&&!n.editor.isSourceMode()?r.api().insertion.insertRaw(t):(i=(e=r.api().getDoc()).getCursor(),e.replaceRange(t,{line:i.line,ch:i.ch}))},this.api=function(){return r.isRedactor()?n.editor.isSourceMode()?n.container.getElement().find(".CodeMirror").get().CodeMirror:n:n.codemirror()}}function e(n){"use strict";var s,o,a,i=this,l=new t(n.editor),e=n.show_tickets||!1,r=n.show_organisations||!1,c=void 0===n.show_canned_responses||n.show_canned_responses,h={img:["src"],a:["href"]};this.appendMergeFields=function(t){return t.find(".sp-merge-fields").append(e?String()+'<div class="sp-w-full lg:sp-w-1/2"><strong class="sp-text-xl">'+Lang.choice("ticket.ticket",2)+"</strong><table><tr><td><strong>"+Lang.get("operator.strings")+'</strong></td></tr><tr><td><button type="button" data-mf="{{ ticket.id }}">'+Lang.get("general.id")+'</button></td></tr><tr><td><button type="button" data-mf="{{ ticket.number }}">'+Lang.get("general.number")+'</button></td></tr><tr><td><button type="button" data-mf="{{ ticket.token }}">'+Lang.get("core.token")+'</button></td></tr><tr><td><button type="button" data-mf="{{ ticket.subject }}">'+Lang.get("ticket.subject")+'</button></td></tr><tr><td><button type="button" data-mf="{{ formatDate(ticket.due_time) }}">'+Lang.get("ticket.due_time")+'</button></td></tr><tr><td><button type="button" data-mf="{{ formatDate(ticket.created_at) }}">'+Lang.get("ticket.created_time")+'</button></td></tr><tr><td><button type="button" data-mf="{{ formatDate(ticket.updated_at) }}">'+Lang.get("ticket.last_action")+'</button></td></tr><tr><td><button type="button" data-mf="{{ ticket.lastReply.purified_text|raw }}">'+Lang.get("ticket.last_message_text")+'</button></td></tr><tr><td><button type="button" data-mf="{{ ticket.frontend_url }}">'+Lang.get("operator.frontend_url")+'</button></td></tr><tr><td><button type="button" data-mf="{{ ticket.operator_url }}">'+Lang.get("operator.operator_url")+"</button></td></tr><tr><td><strong>"+Lang.choice("ticket.department",1)+'</strong></td></tr><tr><td><button type="button" data-mf="{{ ticket.department.id }}">'+Lang.get("general.id")+'</button></td></tr><tr><td><button type="button" data-mf="{{ ticket.department.frontend_name }}">'+Lang.get("general.name")+"</button></td></tr><tr><td><strong>"+Lang.choice("general.status",1)+'</strong></td></tr><tr><td><button type="button" data-mf="{{ ticket.status.id }}">'+Lang.get("general.id")+'</button></td></tr><tr><td><button type="button" data-mf="{{ ticket.status.name }}">'+Lang.get("general.name")+"</button></td></tr><tr><td><strong>"+Lang.choice("ticket.priority",1)+'</strong></td></tr><tr><td><button type="button" data-mf="{{ ticket.priority.id }}">'+Lang.get("general.id")+'</button></td></tr><tr><td><button type="button" data-mf="{{ ticket.priority.name }}">'+Lang.get("general.name")+"</button></td></tr><tr><td><strong>"+Lang.choice("ticket.sla_plan",1)+'</strong></td></tr><tr><td><button type="button" data-mf="{{ ticket.slaplan.name }}">'+Lang.get("general.name")+"</button></td></tr><tr><td><strong>"+Lang.get("operator.collections")+'</strong></td></tr><tr><td><button type="button" data-mf="{% for tag in ticket.tags %}{{ tag.name }}{% endfor %}">'+Lang.choice("ticket.tag",2)+'</button></td></tr><tr><td><button type="button" data-mf="{% for user in ticket.assigned %}{{ user.formatted_name }}{% endfor %}}">'+Lang.get("ticket.assigned_operator")+'</button></td></tr><tr><td><button type="button" data-mf="{% for field in ticket.customfields %}{{ field.id }}{% endfor %}">'+Lang.choice("customfield.customfield",2)+"</button></td></tr>"+(c?'<tr><td><br /></td></tr><tr><td><strong class="sp-text-xl">'+Lang.choice("ticket.cannedresponse",2)+'</strong></td></tr><tr><td><span class="sp-description">'+Lang.get("operator.merge_field_canned_desc")+"</span></td></tr>":"")+"</table></div>":"").append(String()+'<div class="sp-w-full sp-mt-6 lg:sp-w-1/2 lg:sp-mt-0"><strong class="sp-text-xl">'+Lang.choice("user.user",2)+"</strong><table><tr><td><strong>"+Lang.get("operator.strings")+'</strong></td></tr><tr><td><button type="button" data-mf="{{ user.id }}">'+Lang.get("general.id")+'</button></td></tr><tr><td><button type="button" data-mf="{{ user.formatted_name }}">'+Lang.get("user.formatted_name")+'</button></td></tr><tr><td><button type="button" data-mf="{{ user.firstname }}">'+Lang.get("user.firstname")+'</button></td></tr><tr><td><button type="button" data-mf="{{ user.lastname }}">'+Lang.get("user.lastname")+'</button></td></tr><tr><td><button type="button" data-mf="{{ user.email }}">'+Lang.get("general.email")+'</button></td></tr><tr><td><button type="button" data-mf="{{ user.confirmed }}">'+Lang.get("user.confirmed")+'</button></td></tr><tr><td><button type="button" data-mf="{{ user.active }}">'+Lang.get("user.account_active")+'</button></td></tr><tr><td><button type="button" data-mf="{{ user.country }}">'+Lang.get("user.country")+'</button></td></tr><tr><td><button type="button" data-mf="{{ user.language_code }}">'+Lang.choice("general.language",1)+'</button></td></tr><tr><td><button type="button" data-mf="{{ formatDate(user.created_at) }}">'+Lang.get("ticket.created_time")+"</button></td></tr>"+(r?"<tr><td><strong>"+Lang.choice("user.organisation",1)+'</strong></td></tr><tr><td><button type="button" data-mf="{{ user.organisation.name }}">'+Lang.get("general.name")+"</button></td></tr>":"")+"<tr><td><strong>"+Lang.get("operator.collections")+'</strong></td></tr><tr><td><button type="button" data-mf="{% for group in user.groups %}{{ group.name }}{% endfor %}">'+Lang.choice("user.group",2)+'</button></td></tr><tr><td><button type="button" data-mf="{% for field in ticket.customfields %}{{ field.id }}{% endfor %}">'+Lang.choice("customfield.customfield",2)+'</button></td></tr><tr><td><br /><strong class="sp-text-xl">'+Lang.choice("core.brand",1)+"</strong></td></tr><tr><td><strong>"+Lang.get("operator.strings")+'</strong></td></tr><tr><td><button type="button" data-mf="{{ brand.name }}">'+Lang.get("core.brand_name")+'</button></td></tr><tr><td><button type="button" data-mf="{{ brand.default_email }}">'+Lang.get("general.email_address")+'</button></td></tr><tr><td><button type="button" data-mf="{{ brand.frontend_url }}">'+Lang.get("operator.frontend_url")+"</button></td></tr></table></div>").find("button").on("click",function(){l.insert(d(this).data("mf")),d(this).trigger("mergefield:inserted")})},this.containsTwig=function(t){for(var e=(new DOMParser).parseFromString(t,"text/html").getElementsByTagName("*"),i=e.length;i--;){var n=e[i];if(h.hasOwnProperty(n.tagName.toLowerCase()))for(var r=h[n.tagName.toLowerCase()],s=r.length;s--;)n.hasAttribute(r[s])&&n.removeAttribute(r[s]);var o=n.innerHTML?n.outerHTML.slice(0,n.outerHTML.indexOf(n.innerHTML)):n.outerHTML;if(/<[^{>]*(\{\{(?:[^}]+|}(?!}))*}}|\{%(?:[^%]+|%(?!}))*%})[^>]*>/gi.test(o))return!0}return!1},this.containsSignature=function(t){/\{\{\s*operator\.signature(\|raw)?\s*}}/.test(t)?s.find(".twig-sig-warning").length||s.append(d("<div>",{class:"sp-alert sp-alert-warning sp-mt-3 sp-mb-0 twig-sig-warning",text:Lang.get("core.twig_operator_signature")})):s.find(".twig-sig-warning").remove()},this.editor=function(){return l},this.callback=function(t){l.sync(),i.containsSignature(t),i.containsTwig(t)?s.find(".twig-html-warning").length||s.append(d("<div>",{class:"sp-alert sp-alert-warning sp-mt-3 sp-mb-0 twig-html-warning",text:Lang.get("core.twig_html_warning")})):s.find(".twig-html-warning").remove()},this.showPreview=function(){function r(t){o.find("button:visible").prop("disabled",!1).trigger("click"),Swal.fire(Lang.get("messages.error"),t||Lang.get("messages.general_error"),"error")}var t=s.find(":first-child").outerHeight(!0);o.find("button.switch-view").prop("disabled",!0),a.html("").css("height",t).addClass("loadinggif").show();var e=s.parents("form").find(':input[name="brand_id"]').length?s.parents("form").find(':input[name="brand_id"]').val():s.parents(".form-row").data("brand"),i=s.parents("form").find(':input[name="ticket_id"]').length?s.parents("form").find(':input[name="ticket_id"]').val():null,t=s.parents(".sp-form-container").find(':input[name$="[language]"]').length?s.parents(".sp-form-container").find(':input[name$="[language]"]').val():Lang.locale();d.post(laroute.route("core.operator.emailtemplate.preview"),{template:l.val(),"redactor[]":l.isRedactor()?"template":null,locale:t,template_id:s.parents("form").data("templateId"),brand_id:e,ticket_id:i,is_email:n.syntaxEmailTemplate?1:0}).done(function(t){void 0!==t.data?a.html(t.data):r()}).fail(function(t,e,i){try{var n=JSON.parse(t.responseText);r(void 0!==n.message?n.message:i)}catch(t){r(i)}}).always(function(){o.find("button.switch-view").prop("disabled",!1),a.removeClass("loadinggif")})},this.showEditor=function(){a.hide()},this.container=function(){return s},this.init=function(){s=l.container().wrapAll('<div class="sp-editor-container"></div>').parent(),a=d('<div class="sp-editor-preview"></div>').hide(),s.append(a),o=d('<div class="sp-inline-block sp-mt-3"><button class="switch-view visual-preview" type="button">'+Lang.get("general.preview")+'</button><button class="switch-view code-editor sp-hidden" type="button">'+Lang.get("general.editor")+"</button></div>").on("click","button",function(t){t.preventDefault(),d(this).hasClass("visual-preview")?i.showPreview():i.showEditor(),s.find(".switch-view").toggle()}),s.append(o),l.api().on("change",function(t,e){i.callback(t.getValue())}),i.containsSignature(l.val())}}!function(t){"use strict";var e=t.prototype,i=e.parseFromString;try{if((new t).parseFromString("","text/html"))return}catch(t){}e.parseFromString=function(t,e){if(/^\s*text\/html\s*(?:;|$)/i.test(e)){e=n.implementation.createHTMLDocument("");return-1<t.toLowerCase().indexOf("<!doctype")?e.documentElement.innerHTML=t:e.body.innerHTML=t,e}return i.apply(this,arguments)}}(DOMParser),e.translations={en:{merge_fields:Lang.get("operator.merge_fields"),merge_fields_desc:Lang.get("operator.merge_fields_desc")}},e.icon='<i class="fas fa-database"></i>',e.modalContent='<section>                           <span class="sp-description">'+e.translations.en.merge_fields_desc+'</span>                           <br /><br />                           <div class="sp-merge-fields sp-flex sp-flex-wrap">                           </div>                         </section>',App.extend("mergefields",e)}($,(window,document)),Redactor.add("service","spdetector",{init:function(t){this.app=t},getShortcutKey:function(){return"CTRL"}}),Redactor.add("plugin","sp-fontawesome",{init:function(t){this.app=t,this.lang=t.lang,this.toolbar=t.toolbar,this.buttons={html:'<i class="fas fa-fw fa-code"></i>',bold:'<i class="fas fa-fw fa-bold"></i>'}},start:function(){for(var t in this.buttons){var e;this.buttons.hasOwnProperty(t)&&((e=this.toolbar.getButton(t))&&e.setIcon(this.buttons[t]))}}}),function(c){c.add("plugin","sp-fontformat",{translations:{en:{more_formatting:Lang.get("core.more_formatting"),clearformat:Lang.get("core.clearformat"),underline:Lang.get("core.underline"),italic:Lang.get("core.italic"),deleted:Lang.get("core.strikethrough"),fontcolor:Lang.get("core.font_color"),quote:Lang.get("core.quote"),code:Lang.get("core.code"),cancel:Lang.get("general.cancel")}},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.inline=t.inline,this.toolbar=t.toolbar,this.inspector=t.inspector,this.selection=t.selection,this.detector=t.spdetector,this.options={observe:"sp-fontformat",underline:{title:'<i class="fas fa-fw fa-underline"></i> <span class="sp-icon-name">'+this.lang.get("underline")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+U</span>",api:"module.inline.format",args:{tag:"u"}},italic:{title:'<i class="fas fa-fw fa-italic"></i> <span class="sp-icon-name">'+this.lang.get("italic")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+I</span>",api:"module.inline.format",args:{tag:"em"}},deleted:{title:'<i class="fas fa-fw fa-strikethrough"></i> <span class="sp-icon-name">'+this.lang.get("deleted")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+SHIFT+S</span>",api:"module.inline.format",args:{tag:"del"}},fontcolor:{title:'<i class="fas fa-fw fa-palette"></i> <span class="sp-icon-name">'+this.lang.get("fontcolor")+"</span>",api:"module.fontcolor.open"},blockquote:{title:'<i class="fas fa-fw fa-quote-left"></i> <span class="sp-icon-name">'+this.lang.get("quote")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+Q</span>",api:"module.block.format",args:{tag:"blockquote"}},pre:{title:'<i class="fas fa-fw fa-file-code"></i> <span class="sp-icon-name">'+this.lang.get("code")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+SHIFT+X</span>",api:"module.block.format",args:{tag:"pre"}},clear:{title:'<i class="fas fa-fw fa-remove-format"></i> <span class="sp-icon-name">'+this.lang.get("clearformat")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+\\</span>",api:"plugin.sp-fontformat.clearformat"}}},onclick:function(t){this._markSelected()},ondropdown:{"sp-fontformat":{observe:function(t){this._markSelectedItem()}}},start:function(){var t=this.toolbar.addButtonAfter("bold","sp-fontformat",{title:this.lang.get("more_formatting")});t.setIcon('<i class="fas fa-ellipsis-h"></i>'),t.setDropdown(this.options)},clearformat:function(){var t=this.selection.getCurrent(),t=this.inspector.parse(t);t.isPre()&&this.app.module.block.format({tag:"pre"}),t.isBlockquote()&&this.app.module.block.format({tag:"blockquote"}),this.app.module.inline.clearformat()},_markSelected:function(){var t=this.app.toolbar.getButton("sp-fontformat");t&&(this._getSelectedComponents().length?t.setActive():t.setInactive())},_markSelectedItem:function(){var t=this.app.toolbar.getButton("sp-fontformat").getDropdown();this._resetButtonState(),this._markSelected();for(var e=this._getSelectedComponents(),i=0;i<e.length;i++)t.getItem(e[i]).addClass("active")},_getSelectedComponents:function(){var t,e,i=this.selection.getCurrent(),n=this.inspector.parse(i),r=[];for(t in this.options)this.options.hasOwnProperty(t)&&void 0!==this.options[t].args&&(e=this.options[t].args.tag,n.getTag()===e&&r.push(t),$(n.$el.get()).closest(".redactor-in "+e).length&&r.push(t));return r},_resetButtonState:function(){var t,e=this.app.toolbar.getButton("sp-fontformat"),i=e.getDropdown();for(t in e.setInactive(),this.options)this.options.hasOwnProperty(t)&&i.getItem(t)&&i.getItem(t).removeClass("active")}}),c.add("module","fontcolor",{translations:{en:{fontcolor:"Font Color",textcolor:"Text Color",backgroundcolor:"Background Color"}},modals:{fontcolor:'<form action="">                       <table width="100%">                         <tr>                           <th width="50%">## backgroundcolor ##</th>                           <th width="50%">## textcolor ##</th>                         </tr>                         <tr class="re-fontcolor-cells">                           <td class="re-fontcolor-bg"></td>                           <td class="re-fontcolor-fg"></td>                         </tr>                       </table>                    </form>'},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.inline=t.inline,this.toolbar=t.toolbar,this.selection=t.selection,this.colors=this.opts.fontcolors||["#ffffff","#000000","#eeece1","#1f497d","#4f81bd","#c0504d","#9bbb59","#8064a2","#4bacc6","#f79646","#ffff00","#f2f2f2","#7f7f7f","#ddd9c3","#c6d9f0","#dbe5f1","#f2dcdb","#ebf1dd","#e5e0ec","#dbeef3","#fdeada","#fff2ca","#d8d8d8","#595959","#c4bd97","#8db3e2","#b8cce4","#e5b9b7","#d7e3bc","#ccc1d9","#b7dde8","#fbd5b5","#ffe694","#bfbfbf","#3f3f3f","#938953","#548dd4","#95b3d7","#d99694","#c3d69b","#b2a2c7","#b7dde8","#fac08f","#f2c314","#a5a5a5","#262626","#494429","#17365d","#366092","#953734","#76923c","#5f497a","#92cddc","#e36c09","#c09100","#7f7f7f","#0c0c0c","#1d1b10","#0f243e","#244061","#632423","#4f6128","#3f3151","#31859b","#974806","#7f6000"]},onmodal:{fontcolor:{open:function(t,e){e.find(".re-fontcolor-bg").append(this._buildPicker("backcolor")),e.find(".re-fontcolor-fg").append(this._buildPicker("textcolor")),this._setActiveColor(e,"background-color",".re-fontcolor-bg"),this._setActiveColor(e,"color",".re-fontcolor-fg")}}},open:function(){var t={name:"fontcolor",title:this.lang.get("fontcolor"),handle:"cancel",commands:{cancel:{title:this.lang.get("cancel")}}};this.app.api("module.modal.build",t)},_buildPicker:function(t){function e(t){t.preventDefault(),(t=c.dom(t.target)).is(".active")?(s._remove(t.data("rule")),i.find("span.active").removeClass("active")):(s._set(t.data("rule"),t.attr("rel")),i.find("span.active").removeClass("active"),t.addClass("active"))}for(var i=c.dom('<div class="re-dropdown-box-'+t+'">'),n="backcolor"==t?"background-color":"color",r=this.colors.length,s=this,o=0;o<r;o++){var a=this.colors[o],l=c.dom("<span>");l.attr({rel:a,"data-rule":n}),l.css({"background-color":a,"font-size":0,border:"2px solid #fff",width:"22px",height:"22px"}),l.on("mousedown",e),i.append(l)}return i},_set:function(t,e){var i={};i[t]=e;i={tag:"span",style:i,type:"toggle"};this.inline.format(i)},_remove:function(t){this.inline.remove({style:t})},_setActiveColor:function(t,e,i){var n=c.dom(this.selection.getCurrent()).attr("style"),e=new RegExp("(?:^|\\s*;\\s*)("+this._escapeRegExp(e)+")\\s*:\\s*([^;]+)\\s*;?","mg");if(matches=e.exec(n),matches&&1<matches.length)for(var r=this._rgbToHex(matches[2]),s=0;s<this.colors.length;s++)this.colors[s]===r&&t.find(i+' span[rel="'+r+'"]').addClass("active")},_rgbToHex:function(t){var e=t.replace("rgb(","").replace(")","").split(",");if(0===e.length)return null;var i=e[0].trim(),n=e[1].trim(),t=e[2].trim(),e=function(t){t=Number(t).toString(16);return t.length<2&&(t="0"+t),t};return"#"+e(i)+e(n)+e(t)},_escapeRegExp:function(t){return t.replace(/[|\\{}()[\]^$+*?.-]/g,"\\$&")}})}(Redactor),Object.keys||(Object.keys=function(){"use strict";var r=Object.prototype.hasOwnProperty,s=!{toString:null}.propertyIsEnumerable("toString"),o=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],a=o.length;return function(t){if("function"!=typeof t&&("object"!=typeof t||null===t))throw new TypeError("Object.keys called on non-object");var e,i,n=[];for(e in t)r.call(t,e)&&n.push(e);if(s)for(i=0;i<a;i++)r.call(t,o[i])&&n.push(o[i]);return n}}()),Redactor.add("plugin","sp-fontsize",{translations:{en:{format:Lang.get("core.format"),paragraph:Lang.get("core.paragraph"),heading1:Lang.get("core.heading1"),heading2:Lang.get("core.heading2"),heading3:Lang.get("core.heading3"),heading4:Lang.get("core.heading4"),heading5:Lang.get("core.heading5"),heading6:Lang.get("core.heading6")}},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.inline=t.inline,this.toolbar=t.toolbar,this.inspector=t.inspector,this.selection=t.selection,this.detector=t.spdetector,this.styles={h1:{"font-size":"3rem","font-weight":"400","line-height":"1.5"},h2:{"font-size":"2.25rem","font-weight":"400","line-height":"1.5"},h3:{"font-size":"1.875rem","font-weight":"400","line-height":"1.5"},h4:{"font-size":"1.5rem","font-weight":"400","line-height":"1.5"},h5:{"font-size":"1.25rem","font-weight":"400","line-height":"1.5"},h6:{"font-size":"1.125rem","font-weight":"400","line-height":"1.5"}},this.options={observe:"sp-fontsize",p:{title:'<span class="sp-icon-name" style="'+this._buildHeaderStyle("p")+'">'+this.lang.get("paragraph")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+ALT+0</span>",plain_title:this.lang.get("paragraph"),api:"plugin.sp-fontsize.set",args:{tag:"p"}},h1:{title:'<span class="sp-icon-name" style="'+this._buildHeaderStyle("h1")+'">'+this.lang.get("heading1")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+ALT+1</span>",plain_title:this.lang.get("heading1"),api:"plugin.sp-fontsize.set",args:{tag:"h1"}},h2:{title:'<span class="sp-icon-name" style="'+this._buildHeaderStyle("h2")+'">'+this.lang.get("heading2")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+ALT+2</span>",plain_title:this.lang.get("heading2"),api:"plugin.sp-fontsize.set",args:{tag:"h2"}},h3:{title:'<span class="sp-icon-name" style="'+this._buildHeaderStyle("h3")+'">'+this.lang.get("heading3")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+ALT+3</span>",plain_title:this.lang.get("heading3"),api:"plugin.sp-fontsize.set",args:{tag:"h3"}},h4:{title:'<span class="sp-icon-name" style="'+this._buildHeaderStyle("h4")+'">'+this.lang.get("heading4")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+ALT+4</span>",plain_title:this.lang.get("heading4"),api:"plugin.sp-fontsize.set",args:{tag:"h4"}},h5:{title:'<span class="sp-icon-name" style="'+this._buildHeaderStyle("h5")+'">'+this.lang.get("heading5")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+ALT+5</span>",plain_title:this.lang.get("heading5"),api:"plugin.sp-fontsize.set",args:{tag:"h5"}},h6:{title:'<span class="sp-icon-name" style="'+this._buildHeaderStyle("h6")+'">'+this.lang.get("heading6")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+ALT+6</span>",plain_title:this.lang.get("heading6"),api:"plugin.sp-fontsize.set",args:{tag:"h6"}}}},onclick:function(t){this._markSelected()},ondropdown:{"sp-fontsize":{observe:function(t){this._markSelectedItem()}}},start:function(){var t=this.toolbar.addButtonAfter("html","sp-fontsize",{title:this.lang.get("format")});this._setIcon(this.lang.get("paragraph")),t.setDropdown(this.options)},set:function(t){var e=JSON.parse(JSON.stringify(t));this._setIcon(this.options[t.tag].plain_title),e.attr={"data-redactor-span":!0,"data-fontformat-tag":t.tag},this.styles.hasOwnProperty(t.tag)&&(e.style=this.styles[t.tag]),this.opts.headers||-1===this._getHeaders().indexOf(t.tag)?this.app.module.block.format(e):(e.tag="div",this.app.module.inline.format(e))},_setIcon:function(t){var e=this.toolbar.getButton("sp-fontsize");e&&e.setIcon("<span>"+(this.app.detector.isMobile()?'<i class="fas fa-paragraph"></i>':t+'&nbsp;&nbsp;<i class="fas fa-caret-down"></i>')+"</span>")},_markSelected:function(){var t=this._getSelectedComponent();this._setIcon(this.options[t].plain_title)},_markSelectedItem:function(){var t=this.app.toolbar.getButton("sp-fontsize").getDropdown();this._resetDropdownState();var e=this._getSelectedComponent();t.getItem(e).addClass("active")},_getSelectedComponent:function(){var e,t=this.selection.getCurrent(),t=this.inspector.parse(t),i="p";return t.isHeading()&&(i=t.isHeading().tagName.toLowerCase()),t.isParagraph()&&(i="p"),(t.isText()||t.isElement())&&(e=this,$(t.$el.get()).parents(".redactor-in [data-fontformat-tag]").each(function(){var t=$(this).data("fontformat-tag");if(-1!==Object.keys(e.styles).indexOf(t))return i=t,!1})),i},_resetDropdownState:function(){var t,e=this.app.toolbar.getButton("sp-fontsize").getDropdown();for(t in this.options)this.options.hasOwnProperty(t)&&e.getItem(t)&&e.getItem(t).removeClass("active")},_getHeaders:function(){return Object.keys(this.styles)},_buildHeaderStyle:function(t){if(!this.styles.hasOwnProperty(t))return"";var e,i=[];for(e in this.styles[t])this.styles[t].hasOwnProperty(e)&&i.push(e+":"+this.styles[t][e]);return i.join(";")}}),Redactor.add("plugin","sp-group",{init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.inline=t.inline,this.toolbar=t.toolbar,this.rboundary=this.opts.groups||[]},start:function(){for(var t=0;t<this.rboundary.length;t++){var e=this.app.toolbar.getButton(this.rboundary[t]);e&&e.after('<div class="redactor-button-separator"></div>')}}}),function(s){s.add("plugin","imagemanager",{translations:{en:{image:Lang.get("core.insert_image"),insert_image:Lang.get("core.insert_image"),upload:Lang.get("core.upload"),"upload-label":Lang.get("core.upload_label")}},init:function(t){this.app=t,this.lang=t.lang,this.opts=t.opts,this.toolbar=t.toolbar,this.inspector=t.inspector,this.selection=t.selection},onmodal:{image:{open:function(t,e){this.opts.imageManagerJson&&this._load(t)}}},start:function(){this.toolbar.addButtonAfter("sp-lists","sp-image",{title:this.lang.get("insert_image"),api:"module.image.open"}).setIcon('<i class="fas fa-image"></i>')},markSelected:function(){var t=this.app.toolbar.getButton("sp-image"),e=this.selection.getCurrent(),e=this.inspector.parse(e);t&&(e.isLink()?t.setActive():t.setInactive())},_resetButtonState:function(){this.app.toolbar.getButton("sp-image").setInactive()},_parse:function(t){for(var e in t){var i,n,r=t[e];"object"==typeof r&&(i=s.dom("<img>"),n=r.thumb||r.url,i.attr("src",n),i.attr("data-params",encodeURI(JSON.stringify(r))),i.css({width:"96px",height:"72px",margin:"0 4px 2px 0",cursor:"pointer"}),i.on("click",this._insert.bind(this)),this.$box.append(i))}},_insert:function(t){t.preventDefault();t=s.dom(t.target),t=JSON.parse(decodeURI(t.attr("data-params")));this.app.api("module.image.insert",{image:t})}})}(Redactor),Redactor.add("plugin","limiter",{init:function(t){this.app=t,this.utils=t.utils,this.opts=t.opts,this.editor=t.editor,this.keycodes=t.keycodes,this.statusbar=t.statusbar},onpasting:function(t){var e;this.opts.limiter&&(t=this._removeInvisibleChars(t),e=this._getText(),e=t.length+e.length,this.opts.input=!(e>=this.opts.limiter))},start:function(){var t;this.opts.limiter&&(t=this.editor.getElement(),this.update(),t.on("keyup.redactor-plugin-limiter",this.update.bind(this)),t.on("keydown.redactor-plugin-limiter",this._limit.bind(this)),this.statusbar.getElement().show())},stop:function(){this.editor.getElement().off(".redactor-plugin-limiter"),this.opts.input=!0,this.statusbar.getElement().hide()},enable:function(){this.start()},disable:function(){this.stop()},update:function(){this.statusbar.add("chars",this._count()+"/"+this.opts.limiter)},_limit:function(t){var e=t.which,i=t.ctrlKey||t.metaKey;e===this.keycodes.BACKSPACE||e===this.keycodes.DELETE||e===this.keycodes.ESC||e===this.keycodes.SHIFT||i&&65===e||i&&88===e||i&&82===e||i&&116===e||-1!==[37,38,39,40].indexOf(e)||(this._exceedsLimit(t),this.update())},_count:function(){return this._getText().length},_exceedsLimit:function(t){if(this._count()>=this.opts.limiter)return t&&t.preventDefault(),this.opts.input=!1;this.opts.input=!0},_getText:function(){var t=this.editor.getElement().text();return this._removeInvisibleChars(t)},_removeInvisibleChars:function(t){return t.replace(/\uFEFF/g,"")}}),Redactor.add("plugin","sp-link",{translations:{en:{insert:Lang.get("core.insert_link"),link:Lang.get("core.insert_link"),"link-insert":Lang.get("core.insert_link"),"link-edit":Lang.get("core.edit_link"),unlink:Lang.get("core.unlink"),text:Lang.get("general.text"),edit:Lang.get("core.edit_link"),"link-in-new-tab":Lang.get("core.open_link_in_new_tab")}},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.inline=t.inline,this.toolbar=t.toolbar,this.inspector=t.inspector,this.selection=t.selection,this.detector=t.spdetector},onclick:function(t){this._markSelected()},start:function(){this.toolbar.addButtonAfter("sp-lists","sp-link",{title:this.lang.get("link")+'&nbsp;<span class="sp-icon-shortcut">('+this.detector.getShortcutKey()+"+K)</span>",api:"module.link.open"}).setIcon('<i class="fas fa-link"></i>')},_markSelected:function(){var t=this.app.toolbar.getButton("sp-link"),e=this.selection.getCurrent(),e=this.inspector.parse(e);t&&(e.isLink()?t.setActive():t.setInactive())},_resetButtonState:function(){this.app.toolbar.getButton("sp-link").setInactive()}}),Redactor.add("plugin","sp-lists",{translations:{en:{orderedlist:Lang.get("core.orderedlist"),unorderedlist:Lang.get("core.unorderedlist"),outdent:Lang.get("core.outdent"),indent:Lang.get("core.indent"),lists:Lang.get("core.lists")}},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.inline=t.inline,this.toolbar=t.toolbar,this.inspector=t.inspector,this.selection=t.selection,this.detector=t.spdetector,this.options={observe:"sp-lists",orderedlist:{title:'<i class="fas fa-fw fa-list-ol"></i> <span class="sp-icon-name">'+this.lang.get("orderedlist")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+.</span>",api:"module.list.toggle",args:"ol"},unorderedlist:{title:'<i class="fas fa-fw fa-list-ul"></i> <span class="sp-icon-name">'+this.lang.get("unorderedlist")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+/</span>",api:"module.list.toggle",args:"ul"},outdent:{title:'<i class="fas fa-fw fa-outdent"></i> <span class="sp-icon-name">'+this.lang.get("outdent")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+[</span>",api:"module.list.outdent"},indent:{title:'<i class="fas fa-fw fa-indent"></i> <span class="sp-icon-name">'+this.lang.get("indent")+'</span><span class="sp-icon-shortcut">'+this.detector.getShortcutKey()+"+]</span>",api:"module.list.indent"}}},onclick:function(t){this._markSelected()},ondropdown:{"sp-lists":{observe:function(t){this._markSelectedItem()}}},start:function(){var t=this.toolbar.addButtonAfter("sp-fontformat","sp-lists",{title:this.lang.get("lists")});t.setIcon('<i class="fas fa-list-ul"></i>'),t.setDropdown(this.options)},_markSelected:function(){var t=this.app.toolbar.getButton("sp-lists");t&&(this._getSelectedComponents().length?t.setActive():t.setInactive())},_markSelectedItem:function(){var t=this.app.toolbar.getButton("sp-lists").getDropdown();this._resetButtonState(),this._markSelected();for(var e=this._getSelectedComponents(),i=0;i<e.length;i++)t.getItem(e[i]).addClass("active")},_getSelectedComponents:function(){var t=this.selection.getCurrent(),e=this.inspector.parse(t),t=[];return e.isList()&&"ul"===e.isList().tagName.toLowerCase()&&t.push("unorderedlist"),e.isList()&&"ol"===e.isList().tagName.toLowerCase()&&t.push("orderedlist"),t},_resetButtonState:function(){var t,e=this.app.toolbar.getButton("sp-lists"),i=e.getDropdown();for(t in e.setInactive(),this.options)this.options.hasOwnProperty(t)&&i.getItem(t)&&i.getItem(t).removeClass("active")}}),Redactor.add("plugin","sp-mergefields",{translations:App.mergefields.translations,modals:{"sp-mergefields":App.mergefields.modalContent},init:function(t){this.app=t,this.lang=t.lang,this.utils=t.utils,this.opts=t.opts,this.toolbar=t.toolbar,this.editor=t.editor,this.insertion=t.insertion,this.element=t.element,this.container=t.container},onsource:{opened:function(){setTimeout(function(){this.toolbar.getButton("sp-mergefields").enable()}.bind(this),100)}},onchanged:function(t){this.mergeFields.callback(t)},onmodal:{"sp-mergefields":{open:function(t,e){var i=this;this.mergeFields.appendMergeFields($(t.get())).on("mergefield:inserted",function(){i.app.api("module.modal.close")})}}},start:function(){this.toolbar.addButtonAfter("sp-link","sp-mergefields",{title:this.lang.get("merge_fields"),api:"plugin.sp-mergefields.open"}).setIcon(App.mergefields.icon),this.mergeFields=new App.mergefields({editor:this.app,show_tickets:this.opts.mergeFields.tickets,show_organisations:this.opts.mergeFields.organisations,show_canned_responses:this.opts.mergeFields.canned_responses,syntaxEmailTemplate:this.opts.syntaxEmailTemplate}),this.mergeFields.init()},open:function(){var t={name:"sp-mergefields",title:this.lang.get("merge_fields"),handle:"cancel",commands:{cancel:{title:this.lang.get("cancel")}}};this.app.api("module.modal.build",t)}}),$(function(){function t(t,e){-1!=t?(i[e].checkbox.prop("disabled",!1).prop("checked",i[e].state),i[e].checkbox.parent().removeAttr("title")):(i[e].checkbox.prop("checked",!1).prop("disabled",!0),i[e].checkbox.parent().attr("title",Lang.get("ticket.department_template_disabled")))}var i={user:{checkbox:$('.message-form .send-user-email input[type="checkbox"]')},operator_reply:{checkbox:$('.message-form .send-operators-email input[type="checkbox"]')},operator_note:{checkbox:$('.notes-form .send-operators-email input[type="checkbox"]')}};$.each(i,function(t,e){e.state=e.checkbox.is(":checked"),e.checkbox.on("change",function(){e.state=$(this).is(":checked")}),e.checkbox.prop("disabled")&&e.checkbox.prop("checked",!1)}),$(document).on("change",'.message-form select[name="to_status"]',function(){$(this).val()==closedStatusId&&-1==departmentTemplates.user_ticket_reply?t(departmentTemplates.user_ticket_operatorclose,"user"):t(departmentTemplates.user_ticket_reply,"user")}),$('.message-form select[name="to_status"]').trigger("change"),$(".reply-type .option").on("click",function(){0==$(this).data("type")?t(departmentTemplates.operator_operator_ticket_reply,"operator_reply"):t(departmentTemplates.operator_ticket_note,"operator_note")}),$(document).on("click",".sp-reply-options-header",function(){$(this).next(".sp-reply-options-content").slideToggle(500),$(this).find(".fas").toggleClass("fa-chevron-down fa-chevron-up")}),$("input[name=add_canned]").on("change",function(){var t=$(this).parents(".sp-reply-option").find("div");this.checked?t.removeClass("sp-hidden"):t.addClass("sp-hidden")}),$(document).on("donetyping","input[name=cannedResponseSearch]",function(){var t=$(this),e=$(this).parents(".redactor-modal-body"),i=e.find(".canned-response-results");t.parent().addClass("sp-loading"),e.find(".canned-response-tags a").addClass("sp-disabled"),$.get(laroute.route("ticket.operator.cannedresponse.search",{term:t.val(),tags:Object.keys(r).join(","),order:$("select[name=cannedResponseOrder]").val(),locale:$("select[name=cannedResponseLang]").val(),start:0,ticket_id:ticket.parameters().ticketId,user_id:ticket.parameters().userId,brand_id:ticket.parameters().brandId})).done(function(t){i.empty(),(i=n(t,i,e)).show()}).always(function(){t.parent().removeClass("sp-loading"),e.find(".canned-response-tags a").removeClass("sp-disabled")})}),$(document).on("click",".canned-response-results a.load-more",function(){var e=$(this).parents("ul"),i=$(this).parents(".redactor-modal-body"),t=$(this).parent();$(this).replaceWith('<i class="fas fa-spinner fa-pulse fa-fw sp-description"></i>'),$.get(laroute.route("ticket.operator.cannedresponse.search",{term:$("input[name=cannedResponseSearch]").val(),tags:Object.keys(r).join(","),order:$("select[name=cannedResponseOrder]").val(),locale:$("select[name=cannedResponseLang]").val(),start:e.children("li.response-item").length,ticket_id:ticket.parameters().ticketId,user_id:ticket.parameters().userId,brand_id:ticket.parameters().brandId})).done(function(t){n(t,e,i)}).always(function(){t.remove()})}),$(document).on("change","select[name=cannedResponseOrder]",function(){var t=new Date;t.setTime(t.getTime()+31536e6),document.cookie="cannedResponseOrder="+$(this).val()+"; expires="+t.toUTCString(),$(this).parents(".redactor-modal-body").find("input[name=cannedResponseSearch]").trigger("donetyping")}),$(document).on("change","select[name=cannedResponseLang]",function(){$(this).parents(".redactor-modal-body").find("input[name=cannedResponseSearch]").trigger("donetyping")});var r={};function n(t,n,e){var i;return void 0===t.data.results||0===t.data.results.length&&0===n.children(".response-item").length?n.append('<li class="no-results sp-description">'+Lang.get("messages.no_results")+"</li>"):$.each(t.data.results,function(t,e){var i=$("<span>");e.tags.length&&$.each(e.tags,function(t,e){i.append('<span class="sp-tag">'+e.name+"</span>")}),n.append('<li class="response-item"><a data-id="'+e.id+'"><span class="sp-title">'+e.name+"</span>&nbsp;&nbsp;"+i.html()+'<div class="sp-description sp-truncate">'+$("<p>").html(e.text).text()+"</div></a></li>")}),void 0!==t.data.tags&&((i=e.find(".canned-response-tags")).empty(),0===t.data.tags.length?i.append('<li class="no-results sp-description">'+Lang.get("messages.no_results")+"</li>"):($.each(t.data.tags,function(t,e){i.append('<li class="sp-tag sp-table sp-mt-1"><a data-id="'+e.id+'">'+e.name+" ("+e.count+")</span></a></li>")}),$.each(r,function(t,e){$("li.sp-tag a[data-id="+t+"]").parent().addClass("sp-active")}))),t.count>n.children(".response-item").length&&n.append('<li class="sp-p-3 sp-text-center"><a class="load-more sp-button">'+Lang.get("general.load_more")+"</a></li>"),n}function s(t){for(var e=t+"=",i=document.cookie.split(";"),n=0;n<i.length;n++){for(var r=i[n];" "==r.charAt(0);)r=r.substring(1);if(0==r.indexOf(e))return r.substring(e.length,r.length)}return""}$(document).on("click","li.sp-tag a",function(){if($(this).parent().hasClass("sp-disabled"))return!1;var t=$(this).parents(".redactor-modal-body"),e=$(this).data("id");r.hasOwnProperty(e)?delete r[e]:r[e]=1,$(this).parent().toggleClass("sp-active"),t.find("input[name=cannedResponseSearch]").trigger("donetyping")}),Redactor.add("plugin","sp-cannedresponses",{translations:{en:{cannedresponses:Lang.choice("ticket.cannedresponse",2)}},init:function(t){this.app=t,this.lang=t.lang,this.toolbar=t.toolbar,this.selection=t.selection,this.insertion=t.insertion,this.detector=t.spdetector},modals:{"sp-cannedresponses":'<form action=""></form>'},onmodal:{"sp-cannedresponses":{open:function(t,e){e.append(this._getTemplate()),t.addClass("custom-redactor-plugin")},opened:function(t,e){$(document).off("click.cannedresponse").on("click.cannedresponse",".canned-response-results li a:not(.load-more)",this.insert.bind(this)),$(e.get()).find("input[name=cannedResponseSearch]").donetyping().trigger("donetyping").trigger("focus")}}},start:function(){this.toolbar.addButtonAfter("sp-lists","sp-cannedresponses",{title:this.lang.get("cannedresponses")+'&nbsp;<span class="sp-icon-shortcut">('+this.detector.getShortcutKey()+"+SHIFT+1)</span>",api:"plugin.sp-cannedresponses.show"}).setIcon('<i class="fas fa-comments"></i>')},show:function(){var t={name:"sp-cannedresponses",title:this.lang.get("cannedresponses"),width:$(document).width()/1.2+"px",handle:"cancel",commands:!1};this.selection.save(),this.app.api("module.modal.build",t)},insert:function(t){var e=this,t=t.target?$(t.target):$(t.srcElement),t=(t.is("a")?t:t.parents("a")).data("id");$.get(laroute.route("ticket.operator.cannedresponse.show",{id:t}),{ticket_id:ticket.parameters().ticketId,user_id:ticket.parameters().userId,brand_id:ticket.parameters().brandId,locale:$("select[name=cannedResponseLang]").val()},function(t){e.app.api("module.modal.close"),e.selection.restore(),"success"==t.status&&e.insertion.insertHtml(t.data),e.app.api("module.source.sync")},"json")},_getTemplate:function(){var t=0;""!=s("cannedResponseOrder")&&(t=s("cannedResponseOrder"));var e,i="",n=0;for(e in allLanguages)i+='<option value="'+e+'" '+(userLanguage==e?'selected="selected"':"")+">"+allLanguages[e]+"</option>",n++;return String()+'<section><div class="sp-flex"><div class="sp-flex-grow sp-relative sp-overflow-x-hidden"><input type="text" name="cannedResponseSearch" placeholder="'+Lang.get("ticket.search_canned")+'" /><div></div><ul class="canned-response-results redactor-search hide"></ul></div><div class="sp-flex-none sp-w-48 sp-ml-6 sp-text-secondary sp-hidden md:sp-block"><strong>'+Lang.get("general.sort_by")+'</strong><select name="cannedResponseOrder"><option value="0" '+(0==t?'selected="selected"':"")+">"+Lang.get("general.frequently_used")+'</option><option value="1" '+(1==t?'selected="selected"':"")+">"+Lang.get("general.recently_used")+'</option><option value="2" '+(2==t?'selected="selected"':"")+">"+Lang.get("general.recently_created")+"</option></select>"+(1<n?'<strong class="sp-block sp-mt-3">'+Lang.choice("general.language",1)+'</strong><select name="cannedResponseLang">'+i+"</select>":"")+'<strong class="sp-block sp-mt-3">'+Lang.choice("ticket.tag",2)+'</strong><ul class="canned-response-tags sp-list-none sp-p-0"><li class="sp-description"><i class="fas fa-spinner fa-pulse fa-fw"></i> '+Lang.get("ticket.loading_tags")+"...</li></ul></div></div></section>"}}),$(document).on("donetyping","input[name=selfServiceSearch]",function(){var t=$(this),i=$(this).parents(".redactor-modal-body").find(".self-service-results");i.empty(),t.val().length&&(t.parent().addClass("sp-loading"),$.get(laroute.route("selfservice.operator.article.search",{term:t.val(),brandId:ticket.parameters().brandId,userId:ticket.parameters().userId,locale:$(".selfServiceLang select").val()})).done(function(t){i.empty(),0==t.data.length?i.append('<li class="no-results">'+Lang.get("messages.no_results")+"</li>"):$.each(t.data,function(t,e){i.append('<li><a data-url="'+e.frontend_url+'"><span class="sp-title">'+e.title+'</span><br /><div class="sp-description sp-truncate">'+(e.excerpt||"")+"</div></a></li>")}),i.show()}).always(function(){t.parent().removeClass("sp-loading")}))}),$(document).on("change",".selfServiceLang select",function(){$("input[name=selfServiceSearch]").trigger("donetyping")}),Redactor.add("plugin","sp-selfservice",{translations:{en:{selfservice:Lang.get("ticket.add_selfservice_link")}},init:function(t){this.app=t,this.lang=t.lang,this.toolbar=t.toolbar,this.selection=t.selection,this.insertion=t.insertion,this.detector=t.spdetector},modals:{"sp-selfservice":'<form action=""></form>'},onmodal:{"sp-selfservice":{open:function(t,e){e.append(this._getTemplate()),t.addClass("custom-redactor-plugin")},opened:function(t,e){$(document).off("click.selfservice").on("click.selfservice",".self-service-results li a:not(.load-more)",this.insert.bind(this)),$("input[name=selfServiceSearch]").donetyping().trigger("focus")}}},start:function(){this.toolbar.addButtonAfter("sp-cannedresponses","sp-selfservice",{title:this.lang.get("selfservice")+'&nbsp;<span class="sp-icon-shortcut">('+this.detector.getShortcutKey()+"+SHIFT+2)</span>",api:"plugin.sp-selfservice.show"}).setIcon('<i class="fas fa-external-link-alt"></i>')},show:function(){var t={name:"sp-selfservice",title:this.lang.get("selfservice"),width:$(document).width()/1.2+"px",handle:"cancel",commands:!1};this.selection.save(),this.app.api("module.modal.build",t)},insert:function(t){var e,t=t.target?$(t.target):$(t.srcElement),t=t.is("a")?(e=t.data("url"),t.find(".sp-title").text()):(e=t.parents("a").data("url"),t.parents("a").find(".sp-title").text());void 0!==e&&(this.app.api("module.modal.close"),this.selection.restore(),this.insertion.insertHtml($("<div/>").append($("<a/>",{href:e,text:t})).html()),this.app.api("module.source.sync"))},_getTemplate:function(){var t,e="",i=0;for(t in allLanguages)e+='<option value="'+t+'" '+(userLanguage==t?'selected="selected"':"")+">"+allLanguages[t]+"</option>",i++;return String()+'<section><div class="sp-flex"><div class="sp-flex-grow sp-relative sp-overflow-x-hidden"><input type="text" name="selfServiceSearch" placeholder="'+Lang.get("ticket.search_selfservice")+'" /><div></div><ul class="self-service-results redactor-search sp-hidden"></ul></div>'+(1<i?'<div class="selfServiceLang sp-flex-none sp-w-48 sp-ml-6 sp-text-secondary sp-hidden md:sp-block"><strong>'+Lang.choice("general.language",1)+"</strong><select>"+e+"</select></div>":"")+"</div></section>"}})}),Redactor.add("plugin","sp-sourcemode",{init:function(t){this.app=t,this.toolbar=t.toolbar},start:function(){this.app.broadcast("startcodeshow"),this.toolbar.disableButtons(),this._hideButtons();var t=this;setTimeout(function(){t.toolbar.getButton("sp-mergefields").enable()},100)},_hideButtons:function(){this.toolbar.getElement().find("a:not(.re-sp-mergefields), .redactor-button-separator").hide()}}),function(t){t.add("plugin","sp-tooltips",{translations:{en:{html:Lang.get("core.edit_html"),bold:Lang.get("core.bold")}},init:function(t){this.app=t,this.lang=t.lang,this.toolbar=t.toolbar,this.detector=t.spdetector,this.tooltips=[{name:"html",tooltip:this.lang.get("html")},{name:"bold",tooltip:this.lang.get("bold")+'&nbsp;<span class="sp-icon-shortcut">('+this.detector.getShortcutKey()+"+B)</span>"}]},start:function(){for(var t=0;t<this.tooltips.length;t++)this.toolbar.getButton(this.tooltips[t].name).html_tooltip=this.tooltips[t].tooltip}}),t.add("class","toolbar.button.tooltip",{mixins:["dom"],init:function(t,e){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.$body=t.$body,this.toolbar=t.toolbar,this.$button=e,this.created=!1,this._init()},open:function(){var t,e,i;this.$button.hasClass("redactor-button-disabled")||this.$button.hasClass("redactor-button-active")||(this.created=!0,this.parse("<span>"),this.addClass("re-button-tooltip re-button-tooltip-"+this.uuid),this.$body.append(this),i=this.$button.html_tooltip||this.$button.attr("alt"),this.html(i),t=this.$button.offset(),e=this.$button.height(),i=this.$button.width(),this.css({top:t.top+e+4+"px",left:t.left+i/2-this.width()/2+"px",position:"absolute"}),this.show())},close:function(){this.created&&!this.$button.hasClass("redactor-button-disabled")&&(this.remove(),this.created=!1)},_init:function(){this.$button.on("mouseover",this.open.bind(this)),this.$button.on("mouseout",this.close.bind(this))}})}(Redactor);
//# sourceMappingURL=editor.min.js.map
